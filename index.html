<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Future Forms + First Conditional ‚Äî Streak to 25 (Manga Colors)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
:root{
  /* ===== Manga / pop palette ===== */
  --bg1:#05040d;
  --bg2:#0b0830;
  --bg3:#140a2b;

  --ink:#f7fbff;
  --mut:rgba(247,251,255,.72);

  --panel: rgba(18, 13, 34, .88);
  --stroke: rgba(255,255,255,.14);

  --pink:#ff2fb3;
  --cyan:#11e8ff;
  --yellow:#ffe04a;
  --lime:#7dff6a;
  --violet:#9b5cff;

  --shadow: 0 26px 80px rgba(0,0,0,.60);
  --focus: 0 0 0 5px rgba(17,232,255,.25);

  --wMax: 1200px;

  --wordFont: 16px;
  --chipMinW: 108px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:Montserrat,system-ui,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 520px at 15% 18%, rgba(255,47,179,.22), transparent 60%),
    radial-gradient(900px 520px at 85% 22%, rgba(17,232,255,.18), transparent 60%),
    radial-gradient(720px 420px at 55% 85%, rgba(255,224,74,.12), transparent 60%),
    linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}

/* ===== Layout ===== */
.container{
  width:min(var(--wMax), 100%);
  min-height: calc(100vh - 24px);
  max-height: 980px;
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);
  display:grid;
  grid-template-columns: 1fr 330px;
  grid-template-rows: auto auto 1fr auto;
  gap:12px;
  overflow:hidden;
}

.header{grid-column:1/2; grid-row:1/2; display:flex; gap:12px; align-items:center}
.logo{
  width:56px;height:56px;border-radius:16px;
  background:
    linear-gradient(135deg, rgba(255,47,179,.25), rgba(17,232,255,.22), rgba(255,224,74,.18));
  border:2px solid rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 14px 28px rgba(0,0,0,.30);
  position:relative;
}
.logo:after{
  content:"";
  position:absolute; inset:6px;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.20);
  pointer-events:none;
}
.title{margin:0;font-size:20px;color:#fff;letter-spacing:.2px}
.lead{margin:2px 0 0;font-size:13px;color:var(--mut)}

.topbar{
  grid-column:1/2; grid-row:2/3;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
  gap:10px;
  flex-wrap:wrap;
}
.statRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stat{
  border:2px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:8px 12px;
  font-weight:900;
  font-size:13px;
  background:rgba(0,0,0,.18);
}
.playerTag{font-size:13px;color:var(--mut)}
.playerTag strong{color:var(--ink)}

/* ===== Right panel ===== */
.controlsPanel{
  grid-column:2/3; grid-row:1/4;
  display:flex; flex-direction:column; gap:10px;
  padding:12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
  overflow:hidden;
}
.inputRow{display:flex;flex-direction:column;gap:6px}
.inputRow label{font-weight:900;font-size:13px;color:var(--ink)}
.inputRow input{
  border:2px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  border-radius:14px;
  padding:12px;
  font-size:14px;
  outline:none;
}
.inputRow input:focus{border-color: rgba(17,232,255,.80); box-shadow:var(--focus);}
.lockedHint{font-size:12px;color:var(--mut);margin-top:-4px}

.controlsBtns{display:flex;gap:10px}
.btnPrimary,.btnSecondary{
  width:50%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease;
}
.btnPrimary{
  border:2px solid rgba(255,255,255,.16);
  color:#06101a;
  background:linear-gradient(180deg,var(--yellow),#ffbf00);
  box-shadow:0 14px 28px rgba(255,224,74,.18);
}
.btnSecondary{
  border:2px solid rgba(255,255,255,.16);
  color:var(--ink);
  background:rgba(0,0,0,.18);
}
.btnPrimary:hover,.btnSecondary:hover{transform:translateY(-2px);filter:brightness(1.05)}
.btnPrimary:disabled,.btnSecondary:disabled{opacity:.6;cursor:not-allowed;transform:none}

.toggles{
  display:flex; gap:10px; flex-wrap:wrap;
  font-size:13px;color:var(--mut);
}
.toggles label{display:flex;gap:8px;align-items:center;cursor:pointer;user-select:none}

.tipBox{
  margin-top:auto;
  padding:12px;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.18);
  background:rgba(0,0,0,.15);
  font-size:12.7px;
  color:rgba(247,251,255,.88);
  line-height:1.35;
}
.bankStats{
  margin-top:10px;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--stroke);
  background:rgba(0,0,0,.16);
  color:rgba(247,251,255,.90);
  font-size:12.5px;
  line-height:1.35;
}

/* ===== Game ===== */
.game{
  grid-column:1/2; grid-row:3/4;
  overflow:hidden;
  display:flex;
  align-items:stretch;
  justify-content:center;
  position:relative;
}
.gameInner{
  width:100%;
  max-width:860px;
  height:100%;
  display:grid;
  grid-template-rows:
    minmax(140px, .44fr)
    minmax(54px, auto)
    minmax(240px, 1fr)
    auto
    auto;
  gap:10px;
  overflow:hidden;
}

/* prompt card */
#card{
  border-radius:18px;
  padding:12px;
  background:
    radial-gradient(circle at 20% 20%, rgba(17,232,255,.22), transparent 50%),
    radial-gradient(circle at 80% 25%, rgba(255,47,179,.22), transparent 55%),
    radial-gradient(circle at 55% 90%, rgba(255,224,74,.16), transparent 55%),
    linear-gradient(135deg, rgba(17,232,255,.16), rgba(255,47,179,.14), rgba(255,224,74,.10));
  border:2px solid rgba(255,255,255,.18);
  box-shadow:0 18px 48px rgba(0,0,0,.34);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;
  position:relative;
  overflow:hidden;
}
#card::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    repeating-linear-gradient(45deg,
      rgba(255,255,255,.08) 0 10px,
      rgba(255,255,255,.02) 10px 20px);
  transform:rotate(-10deg);
  pointer-events:none;
  opacity:.35;
}
#cardLabel{
  position:relative;
  font-size:13px;
  font-weight:900;
  color:#07111b;
  padding:8px 14px;
  border-radius:999px;
  background:linear-gradient(180deg, var(--cyan), #00c8dd);
  border:2px solid rgba(0,0,0,.35);
  margin:0 0 8px;
}
#cardText{
  position:relative;
  width:min(92%, 780px);
  padding:10px 12px;
  border-radius:14px;
  background:rgba(0,0,0,.22);
  border:2px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight:900;
  font-size:clamp(18px, 2.0vw, 30px);
  line-height:1.14;
  text-shadow:0 2px 14px rgba(0,0,0,.35);
  overflow-wrap:anywhere;
  word-break:break-word;
}

/* order box */
#orderBox{
  border:2px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:rgba(0,0,0,.18);
  padding:10px;
  min-height:54px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:var(--ink);
  overflow:hidden;
}

/* options container */
#options{
  width:100%;
  border-radius:16px;
  border:2px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  padding:10px;
  overflow:hidden;
}

/* multiple-choice */
#options.mode-multiple{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  align-content:stretch;
}
.choiceCard{
  border:2px solid rgba(0,0,0,.35);
  border-radius:18px;
  padding:14px 14px;
  color:#07101a;
  font-weight:900;
  cursor:pointer;
  text-align:left;
  display:flex;
  align-items:center;
  gap:12px;
  min-height:86px;
  box-shadow:0 16px 34px rgba(0,0,0,.24);
  transition:transform .12s ease, filter .12s ease;
  position:relative;
  overflow:hidden;
}
.choiceCard:focus-visible{outline:none; box-shadow: var(--focus), 0 18px 40px rgba(0,0,0,.30);}
.choiceCard::after{
  content:"";
  position:absolute; inset:-40%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), transparent 55%);
  transform:rotate(10deg);
  opacity:.7;
}
.choiceCard:hover{transform:translateY(-3px);filter:brightness(1.06)}
.choiceIcon{
  width:46px;height:46px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.45);
  border:2px solid rgba(0,0,0,.35);
  font-size:22px;
  z-index:1;
}
.choiceText{z-index:1; font-size:18px; line-height:1.12}
.choiceText small{display:block;font-size:13px;font-weight:800;opacity:.95;margin-top:3px}

.choiceWILL{background:linear-gradient(180deg, var(--yellow), #ffb703);}
.choiceGOING{background:linear-gradient(180deg, var(--pink), #ff5cc9); color:#0b0712;}
.choicePC{background:linear-gradient(180deg, var(--cyan), #00b6ca);}
.choicePS{background:linear-gradient(180deg, var(--lime), #56ff8b);}
.choiceCOND{background:linear-gradient(180deg, var(--violet), #b78bff);}

/* ordering */
#options.mode-order{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(var(--chipMinW), 1fr));
  gap:12px;
  align-content:start;
  grid-auto-rows: minmax(44px, auto);
}
.orderWord{
  border:2px solid rgba(0,0,0,.35);
  border-radius:16px;
  padding: 11px 12px;
  font-weight:900;
  font-size: var(--wordFont);
  cursor:pointer;
  color:#07101a;
  background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
  box-shadow:0 12px 22px rgba(0,0,0,.18);
  transition:transform .12s ease, filter .12s ease;
  text-align:center;
  white-space:nowrap;
}
.orderWord:hover{transform:translateY(-3px); filter:brightness(1.05);}
.orderWord:disabled{opacity:.55;cursor:not-allowed;transform:none !important}
.orderWord.chosen{
  color:#fff;
  border-color: rgba(0,0,0,.40);
  background:linear-gradient(180deg,#ef4444,#b91c1c);
}

/* selected chips */
.selChip{
  padding:8px 12px;
  border-radius:14px;
  background:rgba(17,232,255,.16);
  border:2px solid rgba(17,232,255,.26);
  font-weight:900;
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, filter .12s ease;
}
.selChip:hover{transform:translateY(-2px);filter:brightness(1.05)}

/* progress */
.progressWrap{
  width:100%;
  height:12px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, var(--lime), var(--cyan), var(--yellow), var(--pink), var(--lime));
  background-size:220% 100%;
  transition:width 350ms ease;
}
.progressBar.moving{ animation: prog 1.1s linear infinite; }
@keyframes prog{ 0%{background-position:0%} 100%{background-position:220%} }
.progressLabel{
  font-size:13px;
  color:rgba(247,251,255,.92);
  text-align:center;
  margin-top:-4px;
  font-weight:900;
}

/* bottom controls */
.controlsRow{
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
}
.smallBtn{
  border:2px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease, opacity .12s ease;
}
.smallBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.smallBtn:disabled{opacity:.55;cursor:not-allowed;transform:none !important}

/* footer */
.footer{
  grid-column:1/2; grid-row:4/5;
  display:flex; justify-content:space-between; align-items:center;
  color:var(--mut); font-size:13px;
  gap:10px;
  flex-wrap:wrap;
}

/* feedback overlay */
.fbOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(2,8,23,.62);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
  z-index:20;
}
.fbOverlay.show{ opacity:1; pointer-events:auto; }
.fbCard{
  width:min(640px, 94%);
  border-radius:18px;
  padding:18px 18px 16px;
  background:linear-gradient(180deg, rgba(20,14,36,.97), rgba(20,14,36,.93));
  border:2px solid rgba(255,255,255,.16);
  box-shadow:0 24px 70px rgba(0,0,0,.60);
  text-align:center;
}
.fbTop{display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900;}
.fbIcon{
  width:48px;height:48px;
  border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.10);
  border:2px solid rgba(255,255,255,.14);
  font-size:22px;
}
.fbTitle{font-size:22px; margin:0;}
.fbSub{
  margin:12px auto 0;
  font-size:16px;
  color:#ffffff;
  font-weight:900;
  line-height:1.32;
  max-width:600px;
}
.fbDetail{
  margin:10px auto 0;
  font-size:14.2px;
  color:rgba(247,251,255,.92);
  font-weight:800;
  line-height:1.38;
  max-width:600px;
  border-top:1px solid rgba(255,255,255,.12);
  padding-top:10px;
  white-space:pre-line;
}
.fbBtnRow{margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;}
.fbBtn{
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  border:2px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  transition:transform .12s ease, filter .12s ease;
}
.fbBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}

/* celebration */
.celebration-overlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(2,8,23,0.72);
  z-index:9999;
  padding:18px;
}
.celebration-card{
  width:min(780px, 96%);
  background:linear-gradient(180deg, rgba(20,14,36,.95), rgba(20,14,36,.90));
  border:2px solid rgba(255,255,255,.14);
  color:var(--ink);
  border-radius:18px;
  padding:26px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.60);
}
.celebration-title{font-size:34px;font-weight:900;color:#fff;margin-bottom:8px}
.celebration-sub{color:rgba(247,251,255,.88);font-weight:900; font-size:16px; margin-bottom:12px}
.celebration-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}

/* responsive */
@media (max-width: 1020px){
  .container{grid-template-columns:1fr; grid-template-rows:auto auto 1fr auto auto}
  .controlsPanel{grid-column:1/2; grid-row:5/6; flex-direction:row; flex-wrap:wrap; gap:10px}
  .inputRow{width:calc(50% - 5px)}
  .controlsBtns{width:100%}
  .tipBox{width:100%; margin-top:0}
  .bankStats{width:100%}
}
@media (max-width: 640px){
  .inputRow{width:100%}
  #options.mode-multiple{grid-template-columns:1fr}
}

/* ===== BIG CHECK (wins cascade) ===== */
#checkOrder.smallBtn{
  padding: 18px 32px !important;
  font-size: 19px !important;
  border-radius: 18px !important;
  min-width: 220px !important;
  border:2px solid rgba(0,0,0,.35) !important;
  color:#06101a !important;
  background: linear-gradient(180deg, var(--yellow), #ffb703) !important;
  box-shadow: 0 18px 38px rgba(255,224,74,.22) !important;
}
#checkOrder.smallBtn.checkAttention{
  animation: checkPulse 1.0s ease-in-out infinite;
}
@keyframes checkPulse{
  0%,100%{ transform: scale(1); filter: brightness(1); }
  50%{ transform: scale(1.07); filter: brightness(1.12); }
}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Future forms and first conditional game">

    <div class="header">
      <div class="logo" aria-hidden="true">‚ú¶</div>
      <div>
        <h1 class="title">Future Forms + First Conditional</h1>
        <p class="lead">Manga colors ‚Ä¢ adaptive practice ‚Ä¢ ordering never reveals the answer ‚Ä¢ win at <b>25 in a row</b></p>
      </div>
    </div>

    <div class="topbar">
      <div class="statRow">
        <div class="stat" id="scoreBox">Score: 0</div>
        <div class="stat" id="timerBox">Time: 0s</div>
        <div class="stat" id="streakBox">Streak: 0</div>
      </div>
      <div class="playerTag">Player: <strong id="playerName">‚Äî</strong></div>
    </div>

    <div class="controlsPanel">
      <div class="inputRow">
        <label for="studentName">Name</label>
        <input id="studentName" type="text" placeholder="E.g., Laura">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Target streak</label>
        <input id="targetStreak" type="number" value="25" disabled>
        <div class="lockedHint">Locked to 25 ‚úÖ</div>
      </div>

      <div class="controlsBtns">
        <button id="startBtn" class="btnPrimary">START</button>
        <button id="resetBtn" class="btnSecondary">RESET</button>
      </div>

      <div class="toggles">
        <label><input id="soundToggle" type="checkbox" checked> SFX</label>
        <label><input id="musicToggle" type="checkbox" checked> Music</label>
      </div>

      <div class="tipBox">
        <b>What students practice</b><br>
        ‚Ä¢ <b>will</b> (predictions / offers / promises)<br>
        ‚Ä¢ <b>be going to</b> (plans / intentions)<br>
        ‚Ä¢ <b>present continuous</b> (definite arrangements)<br>
        ‚Ä¢ <b>present simple</b> (timetables / schedules)<br>
        ‚Ä¢ <b>first conditional</b>: If + present, will + base verb<br><br>
        <b>How it works</b><br>
        ‚Ä¢ Multiple-choice rounds: choose the correct form.<br>
        ‚Ä¢ Ordering rounds: build the sentence from scrambled words, then press <b>CHECK</b>.
      </div>

      <div class="bankStats" id="bankStats">
        <b>Adaptive engine:</b> categories you miss appear more often.
      </div>
    </div>

    <div class="game" role="main" aria-live="polite">
      <div id="feedbackOverlay" class="fbOverlay" aria-hidden="true">
        <div class="fbCard" role="dialog" aria-modal="true" aria-label="Feedback popup">
          <div class="fbTop">
            <div class="fbIcon" id="fbIcon">‚úÖ</div>
            <h3 class="fbTitle" id="fbTitle">Nice!</h3>
          </div>
          <div class="fbSub" id="fbSub">Keep it going.</div>
          <div class="fbDetail" id="fbDetail"></div>
          <div class="fbBtnRow">
            <button class="fbBtn" id="fbCloseBtn" type="button">Close</button>
          </div>
        </div>
      </div>

      <div class="gameInner">
        <div id="card" role="region" aria-label="Prompt card">
          <div id="cardLabel">Ready</div>
          <div id="cardText">Press START to begin</div>
        </div>

        <div id="orderBox" aria-live="polite">Selected words will appear here (ordering rounds).</div>

        <div id="options" role="group" aria-label="Answer options"></div>

        <div class="progressWrap">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Goal progress: 0 / 25 (0%)</div>

        <div class="controlsRow">
          <button id="resetOrder" class="smallBtn" style="display:none">Reset order</button>
          <button id="checkOrder" class="smallBtn" style="display:none">CHECK</button>
          <button id="downloadReport" class="smallBtn" style="display:none">CSV</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Forms: will ‚Ä¢ going to ‚Ä¢ pres cont ‚Ä¢ pres simple ‚Ä¢ 1st conditional</div>
      <div>Goal: <span id="targetLabel">25</span> in a row</div>
    </div>

    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-title">Perfect streak! üèÜ</div>
        <div class="celebration-sub" id="celebrationSub">You reached 25 correct answers in a row.</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnPrimary" style="width:auto;padding:12px 18px">Download CSV</button>
          <button id="celebrationRestart" class="btnSecondary" style="width:auto;padding:12px 18px">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Background music (optional) -->
  <audio id="bgMusic" src="audio/koala.mp3" preload="auto" loop></audio>

<script>
/* ==========================================================
   GOAL
========================================================== */
const TARGET_STREAK = 25;

/* ==========================================================
   BANKS (‚â• 15 sentences each)
   - Vocabulary + structures from the page:
     places (aquarium, theme park, national park...)
     activities (kayaking, canyoning, white-water rafting...)
     recommendations key phrases
     future forms uses
     first conditional structure
========================================================== */
const BANKS = {
  WILL: [
    "I think it will be difficult to find a hotel at the last minute.",
    "Don‚Äôt worry ‚Äî I‚Äôll help you choose a national park to visit.",
    "I‚Äôm sure your best option will be the aquarium if it rains.",
    "I‚Äôll call the phone repair shop and ask about the price.",
    "Personally, I think the theme park will be amazing.",
    "Your best choice will probably be mountain biking this weekend.",
    "I‚Äôll send you the address of the botanical gardens.",
    "The parade will start soon, so let‚Äôs get a good place to watch.",
    "I think the tower will look fantastic at sunset.",
    "We‚Äôll meet you at the monument after lunch.",
    "I‚Äôll buy the tickets online tonight.",
    "It will be too windy for parasailing, I think.",
    "I‚Äôll recommend a restaurant near the wildlife reserve.",
    "I think the ancient site will be crowded tomorrow.",
    "I‚Äôll bring snacks for the trip."
  ],
  GOING_TO: [
    "We‚Äôre going to explore the national park on Saturday.",
    "I‚Äôm going to book a hotel near the botanical gardens.",
    "She‚Äôs going to try canyoning for the first time.",
    "They‚Äôre going to visit the aquarium after school.",
    "I‚Äôm going to ask for recommendations at the tourist office.",
    "We‚Äôre going to go sightseeing in the old town.",
    "He‚Äôs going to buy trainers before the trek.",
    "I‚Äôm going to take photos at the ancient site.",
    "They‚Äôre going to ride horses near the wildlife reserve.",
    "We‚Äôre going to eat at a small restaurant by the tower.",
    "She‚Äôs going to learn new vocabulary for the project.",
    "I‚Äôm going to plan a route to the monument.",
    "They‚Äôre going to watch the parade from the main square.",
    "We‚Äôre going to go scuba diving if the sea is calm.",
    "I‚Äôm going to recommend the theme park to my cousins."
  ],
  PRES_CONT: [
    "We‚Äôre meeting at the station at 8:00.",
    "I‚Äôm having lunch with my friend after the museum visit.",
    "She‚Äôs flying to Madrid tomorrow morning.",
    "They‚Äôre visiting the theme park this afternoon.",
    "I‚Äôm talking to a guide about the ancient site later.",
    "We‚Äôre staying in a hotel near the tower tonight.",
    "He‚Äôs going kayaking with his class on Friday.",
    "I‚Äôm taking my brother to the aquarium on Saturday.",
    "They‚Äôre going mountain biking after school.",
    "We‚Äôre going to the botanical gardens at 5:30.",
    "I‚Äôm seeing the teacher after class to ask a question.",
    "She‚Äôs meeting us at the monument entrance.",
    "They‚Äôre having a picnic in the national park tomorrow.",
    "We‚Äôre watching the parade from the bridge this evening.",
    "I‚Äôm calling you later to confirm the plan."
  ],
  PRES_SIMPLE: [
    "The train leaves at 3 p.m.",
    "The tour starts at 10:15.",
    "The aquarium opens at nine.",
    "The national park closes at six.",
    "The museum bus arrives every thirty minutes.",
    "The parade begins at noon.",
    "The ticket office shuts at 5:45.",
    "The boat departs from the harbour at 8:30.",
    "The theme park opens at 10:00 on weekends.",
    "The guided walk finishes at 2:00.",
    "The flight lands at 7:20.",
    "The lesson starts at 8:05.",
    "The coach stops near the monument at 11:10.",
    "The ferry leaves every hour.",
    "The show ends at 9:00."
  ],
  FIRST_COND: [
    "If the traffic is bad, we‚Äôll miss our flight.",
    "If it rains, we‚Äôll go to the aquarium instead.",
    "If you ask politely, they‚Äôll recommend a good hotel.",
    "If we leave early, we‚Äôll reach the national park before lunch.",
    "If you don‚Äôt book now, the theme park tickets will sell out.",
    "If the sea is rough, we won‚Äôt go scuba diving.",
    "If you try canyoning, you‚Äôll need a helmet.",
    "If you get lost, I‚Äôll send you the location.",
    "If the parade starts late, we‚Äôll wait near the tower.",
    "If you want advice, I‚Äôll recommend the botanical gardens.",
    "If she finishes her homework, she‚Äôll come sightseeing with us.",
    "If the bus doesn‚Äôt arrive, we‚Äôll take a taxi to the monument.",
    "If it‚Äôs too windy, we won‚Äôt go parasailing.",
    "If you don‚Äôt feel well, you‚Äôll stay at the hotel.",
    "If you practice the key phrases, you‚Äôll sound more confident."
  ]
};

const BANK_META = [
  { key:"WILL",        label:"Future form ‚Äî WILL",                hint:"predictions ‚Ä¢ offers ‚Ä¢ promises", icon:"üü®", css:"choiceWILL" },
  { key:"GOING_TO",    label:"Future form ‚Äî BE GOING TO",         hint:"plans ‚Ä¢ intentions",            icon:"üíó", css:"choiceGOING" },
  { key:"PRES_CONT",   label:"Future meaning ‚Äî PRESENT CONT.",    hint:"definite arrangements",         icon:"üü¶", css:"choicePC" },
  { key:"PRES_SIMPLE", label:"Future meaning ‚Äî PRESENT SIMPLE",   hint:"timetables ‚Ä¢ schedules",        icon:"üü©", css:"choicePS" },
  { key:"FIRST_COND",  label:"First conditional",                hint:"If + present, will + base",      icon:"üü™", css:"choiceCOND" },
];

/* ==========================================================
   STATE
========================================================== */
const el = (id)=>document.getElementById(id);

const state = {
  running:false,
  streak:0,
  score:0,
  seconds:0,
  timer:null,

  stats: Object.fromEntries(BANK_META.map(b => [b.key, {attempts:0, correct:0, wrong:0, recentWrong:0}])),

  remediation: { bankKey:null, remaining:0 },
  lastBankKey:null,

  round:null,        // {mode, bankKey, sentence, correctKey, targetWords, orderWords}
  orderSelected:[],

  log:[],

  recentByBank: Object.fromEntries(BANK_META.map(b => [b.key, []]))
};

/* ==========================================================
   AUDIO + SFX
========================================================== */
const bgMusic = el("bgMusic");

function blip(ok){
  if(!el("soundToggle").checked) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = "square";
    o.frequency.value = ok ? 740 : 220;
    g.gain.value = 0.05;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ok ? 95 : 150);
  }catch(e){}
}

/* ==========================================================
   UI
========================================================== */
function updateHeader(){
  el("scoreBox").textContent = `Score: ${state.score}`;
  el("timerBox").textContent = `Time: ${state.seconds}s`;
  el("streakBox").textContent = `Streak: ${state.streak}`;
  el("targetLabel").textContent = TARGET_STREAK;
}

function updateProgress(){
  const pct = Math.max(0, Math.min(100, Math.round((state.streak / TARGET_STREAK) * 100)));
  el("progressBar").style.width = `${pct}%`;
  el("progressLabel").textContent = `Goal progress: ${state.streak} / ${TARGET_STREAK} (${pct}%)`;

  if(state.running && state.streak > 0 && state.streak < TARGET_STREAK) el("progressBar").classList.add("moving");
  else el("progressBar").classList.remove("moving");
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function updateBankStats(){
  const arr = BANK_META.map(b=>{
    const s = state.stats[b.key];
    const acc = s.attempts ? (s.correct / s.attempts) : 1;
    const weightHint = (s.recentWrong*2) + (s.wrong) + (1-acc)*3;
    return { key:b.key, label:b.label, wrong:s.wrong, recentWrong:s.recentWrong, acc, weightHint };
  }).sort((a,b)=> b.weightHint - a.weightHint);

  const top = arr.slice(0,2).map(x=>{
    const a = Math.round(x.acc*100);
    return `‚Ä¢ <b>${escapeHtml(x.label)}</b> ‚Äî acc ${a}% (wrong ${x.wrong}, recent ${x.recentWrong})`;
  }).join("<br>");

  el("bankStats").innerHTML =
    `<b>Adaptive engine:</b><br>${top}<br><span style="color:rgba(247,251,255,.72)">Mistakes make that category appear more often.</span>`;
}

function setCard(label, text){
  el("cardLabel").textContent = label;
  el("cardText").textContent = text;
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function normalizeSentence(s){
  return String(s).trim().replace(/\s+/g," ");
}

/* ==========================================================
   NO-REPEAT sentence picker
========================================================== */
const RECENT_LIMIT = 8;
const REROLL_TRIES = 12;

function pickSentenceNoRepeat(bankKey){
  const bank = BANKS[bankKey];
  const recent = state.recentByBank[bankKey] || [];

  let chosen = bank[Math.floor(Math.random()*bank.length)];
  for(let t=0; t<REROLL_TRIES; t++){
    const candidate = bank[Math.floor(Math.random()*bank.length)];
    if(!recent.includes(candidate)){
      chosen = candidate; break;
    }
    chosen = candidate;
  }

  recent.push(chosen);
  while(recent.length > RECENT_LIMIT) recent.shift();
  state.recentByBank[bankKey] = recent;
  return chosen;
}

/* ==========================================================
   Adaptive bank picker
========================================================== */
function pickBankKey(){
  if(state.remediation.remaining > 0 && state.remediation.bankKey){
    state.remediation.remaining--;
    return state.remediation.bankKey;
  }

  const weights = BANK_META.map(b=>{
    const st = state.stats[b.key];
    const acc = st.attempts ? (st.correct / st.attempts) : 0.75;
    let w = 1.0;
    w += st.wrong * 0.35;
    w += st.recentWrong * 0.75;
    w += (1 - acc) * 2.2;
    if(st.attempts === 0) w += 1.2;
    if(state.lastBankKey === b.key) w *= 0.65;
    return { key:b.key, w };
  });

  const sum = weights.reduce((a,x)=>a+x.w,0);
  let r = Math.random() * sum;
  for(const x of weights){
    r -= x.w;
    if(r <= 0) return x.key;
  }
  return weights[weights.length-1].key;
}

/* ==========================================================
   Round builder
   - ordering frequency:
     streak < 12 ‚Üí 0.20
     streak ‚â• 12 ‚Üí 0.30
========================================================== */
function makeRound(){
  const bankKey = pickBankKey();
  const sentence = pickSentenceNoRepeat(bankKey);

  const orderChance = state.streak >= 12 ? 0.30 : 0.20;
  const mode = Math.random() < orderChance ? "order" : "multiple";

  state.lastBankKey = bankKey;

  if(mode === "multiple"){
    return { mode, bankKey, sentence, correctKey: bankKey };
  }

  const targetWords = normalizeSentence(sentence).split(" ");
  const orderWords = shuffle(targetWords);
  return { mode:"order", bankKey, sentence, targetWords, orderWords };
}

/* ==========================================================
   Render
========================================================== */
function clearOptions(){
  el("options").className = "";
  el("options").innerHTML = "";
}

function renderSelectedChips(){
  const box = el("orderBox");
  box.innerHTML = "";
  if(state.orderSelected.length === 0){
    box.textContent = "Tap words to build the sentence.";
    return;
  }
  state.orderSelected.forEach((it, i)=>{
    const chip = document.createElement("span");
    chip.className = "selChip";
    chip.textContent = it.word;
    chip.title = "Click to remove";
    chip.onclick = ()=> removeSelectedAt(i);
    box.appendChild(chip);
  });
}

function removeSelectedAt(i){
  if(!state.running) return;
  const removed = state.orderSelected.splice(i,1)[0];
  el("options").querySelectorAll(".orderWord").forEach(b=>{
    if(b.dataset.idx === String(removed.idx)){
      b.disabled = false;
      b.classList.remove("chosen");
    }
  });
  renderSelectedChips();
}

function pickWord(idx, word, btn){
  if(!state.running) return;
  btn.disabled = true;
  btn.classList.add("chosen");
  state.orderSelected.push({ idx, word });
  renderSelectedChips();
}

function resetOrder(){
  if(!state.running) return;
  state.orderSelected = [];
  el("options").querySelectorAll(".orderWord").forEach(b=>{
    b.disabled = false;
    b.classList.remove("chosen");
  });
  renderSelectedChips();
}

function buildChoices(correctKey){
  // choose 3 distractors from other banks
  const others = BANK_META.map(b=>b.key).filter(k=>k !== correctKey);
  const distractors = shuffle(others).slice(0,3);
  const all = shuffle([correctKey, ...distractors]);
  return all;
}

function renderRound(){
  clearOptions();
  state.orderSelected = [];
  updateBankStats();

  const meta = BANK_META.find(x=>x.key===state.round.bankKey);

  if(state.round.mode === "multiple"){
    // show sentence; student chooses which form it is
    setCard(meta.label, state.round.sentence);

    el("orderBox").textContent = "Ordering box is used only for ordering rounds.";
    el("resetOrder").style.display = "none";
    el("checkOrder").style.display = "none";
    el("checkOrder").classList.remove("checkAttention");

    el("options").classList.add("mode-multiple");

    const keys = buildChoices(state.round.correctKey);

    keys.forEach(k=>{
      const m = BANK_META.find(x=>x.key===k);
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = `choiceCard ${m.css}`;
      btn.innerHTML = `
        <div class="choiceIcon">${escapeHtml(m.icon)}</div>
        <div class="choiceText">${escapeHtml(m.label.replace("Future form ‚Äî ","").replace("Future meaning ‚Äî ",""))}
          <small>${escapeHtml(m.hint)}</small>
        </div>
      `;
      btn.onclick = ()=> submitMultiple(k);
      el("options").appendChild(btn);
    });

    el("downloadReport").style.display = state.running ? "inline-flex" : "none";
    return;
  }

  // ordering mode (do NOT show the exact sentence)
  setCard(meta.label, "Build the sentence from the scrambled words below.");

  el("orderBox").textContent = "Tap words to build the sentence. Tap a chip to remove it.";
  el("resetOrder").style.display = "inline-flex";
  el("checkOrder").style.display = "inline-flex";
  el("checkOrder").classList.add("checkAttention");

  el("options").classList.add("mode-order");

  state.round.orderWords.forEach((w, idx)=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "orderWord";
    b.textContent = w;
    b.dataset.idx = String(idx);
    b.onclick = ()=> pickWord(idx, w, b);
    el("options").appendChild(b);
  });

  el("downloadReport").style.display = state.running ? "inline-flex" : "none";
  renderSelectedChips();
}

/* ==========================================================
   Submit / Check
========================================================== */
function submitMultiple(choiceKey){
  if(!state.running) return;
  const ok = (choiceKey === state.round.correctKey);

  const chosen = BANK_META.find(x=>x.key===choiceKey);
  const correct = BANK_META.find(x=>x.key===state.round.correctKey);

  gradeRound(ok, {
    chosen: chosen ? chosen.label : choiceKey,
    correct: correct ? correct.label : state.round.correctKey
  });
}

function checkOrder(){
  if(!state.running) return;
  const built = normalizeSentence(state.orderSelected.map(x=>x.word).join(" "));
  const correct = normalizeSentence(state.round.targetWords.join(" "));
  gradeRound(built === correct, { built, correct });
}

/* ==========================================================
   Feedback + auto-next (no Next button)
========================================================== */
function showFeedback(ok, detail, isWin){
  const overlay = el("feedbackOverlay");
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");

  el("fbIcon").textContent = ok ? "‚úÖ" : "‚ùå";
  el("fbTitle").textContent = ok ? (isWin ? "Streak complete!" : "Correct!") : "Not yet";
  el("fbSub").textContent = ok
    ? (isWin ? `You reached ${TARGET_STREAK} correct answers in a row!` : `Streak: ${state.streak} / ${TARGET_STREAK}`)
    : `Streak reset to 0. We‚Äôll practice this category again.`;

  let d = "";
  if(state.round.mode === "multiple"){
    d = ok
      ? `Correct form: ${detail.correct}`
      : `You chose: ${detail.chosen}\nCorrect: ${detail.correct}`;
  } else {
    d = ok
      ? `Nice ordering!`
      : `Your order: ‚Äú${detail.built || "(empty)"}‚Äù\nCorrect: ‚Äú${detail.correct}‚Äù`;
  }
  el("fbDetail").textContent = d;
}

function hideFeedback(){
  const overlay = el("feedbackOverlay");
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden","true");
}

function afterFeedbackAutoNext(isWin){
  if(isWin) return;
  setTimeout(()=>{
    hideFeedback();
    nextRound();
  }, 650);
}

/* ==========================================================
   Grading
========================================================== */
function logAttempt(ok, detail){
  const meta = BANK_META.find(x=>x.key===state.round.bankKey);
  state.log.push({
    time_s: state.seconds,
    ok: ok ? 1 : 0,
    streak_after: state.streak,
    bank: state.round.bankKey,
    bank_label: meta ? meta.label : state.round.bankKey,
    mode: state.round.mode,
    prompt: state.round.mode === "multiple" ? state.round.sentence : "(ordering round)",
    detail: JSON.stringify(detail || {})
  });
}

function gradeRound(ok, detail){
  const st = state.stats[state.round.bankKey];
  st.attempts++;

  if(ok){
    st.correct++;
    st.recentWrong = Math.max(0, st.recentWrong - 1);
    state.score++;
    state.streak++;
    blip(true);

    logAttempt(true, detail);
    updateHeader(); updateProgress();

    if(state.streak >= TARGET_STREAK){
      showFeedback(true, detail, true);
      winGame();
      return;
    }

    showFeedback(true, detail, false);
    afterFeedbackAutoNext(false);
    return;
  }

  st.wrong++;
  st.recentWrong++;

  state.remediation.bankKey = state.round.bankKey;
  state.remediation.remaining = 2;

  state.streak = 0;
  blip(false);

  logAttempt(false, detail);
  updateHeader(); updateProgress();

  showFeedback(false, detail, false);
  afterFeedbackAutoNext(false);
}

/* ==========================================================
   Flow
========================================================== */
function lockRoundControls(lock){
  el("options").querySelectorAll("button").forEach(b=> b.disabled = !!lock);
  el("resetOrder").disabled = !!lock;
  el("checkOrder").disabled = !!lock;
}

function nextRound(){
  if(!state.running) return;
  hideFeedback();
  state.round = makeRound();
  renderRound();
  lockRoundControls(false);
}

function startGame(){
  state.running = true;
  state.streak = 0;
  state.score = 0;
  state.seconds = 0;
  state.log = [];
  state.remediation = { bankKey:null, remaining:0 };
  state.lastBankKey = null;

  for(const k of Object.keys(state.stats)){
    state.stats[k] = {attempts:0, correct:0, wrong:0, recentWrong:0};
  }
  state.recentByBank = Object.fromEntries(BANK_META.map(b => [b.key, []]));

  el("playerName").textContent = (el("studentName").value || "‚Äî").trim() || "‚Äî";

  updateHeader();
  updateProgress();
  updateBankStats();

  if(state.timer) clearInterval(state.timer);
  state.timer = setInterval(()=>{
    if(!state.running) return;
    state.seconds++;
    updateHeader();
  }, 1000);

  try{
    if(el("musicToggle").checked){
      bgMusic.volume = 0.6;
      bgMusic.currentTime = 0;
      bgMusic.play().catch(()=>{});
    }
  }catch(e){}

  el("downloadReport").style.display = "inline-flex";
  nextRound();
}

function resetGame(){
  state.running = false;
  if(state.timer) clearInterval(state.timer);
  state.timer = null;

  try{ bgMusic.pause(); bgMusic.currentTime = 0; }catch(e){}

  hideFeedback();
  closeCelebration();

  state.streak = 0;
  state.score = 0;
  state.seconds = 0;
  state.round = null;
  state.orderSelected = [];

  updateHeader();
  updateProgress();

  setCard("Ready", "Press START to begin");
  el("orderBox").textContent = "Selected words will appear here (ordering rounds).";
  clearOptions();

  el("resetOrder").style.display = "none";
  el("checkOrder").style.display = "none";
  el("checkOrder").classList.remove("checkAttention");
  el("downloadReport").style.display = "none";
}

function winGame(){
  state.running = false;
  if(state.timer) clearInterval(state.timer);
  state.timer = null;

  try{ bgMusic.pause(); bgMusic.currentTime = 0; }catch(e){}

  lockRoundControls(true);

  const c = el("celebration");
  c.style.display = "flex";
  c.setAttribute("aria-hidden","false");
  el("celebrationSub").textContent = `Amazing! You got ${TARGET_STREAK} correct answers in a row.`;

  state.streak = TARGET_STREAK;
  updateHeader();
  updateProgress();
}

function closeCelebration(){
  const c = el("celebration");
  c.style.display = "none";
  c.setAttribute("aria-hidden","true");
}

/* ==========================================================
   CSV
========================================================== */
function downloadCSV(){
  const rows = [
    ["time_s","ok","streak_after","bank","bank_label","mode","prompt","detail"],
    ...state.log.map(r=>[
      r.time_s, r.ok, r.streak_after, r.bank, r.bank_label, r.mode,
      r.prompt.replaceAll('"','""'),
      r.detail.replaceAll('"','""')
    ])
  ];

  const csv = rows.map(r => r.map(x => `"${String(x)}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `future_forms_report_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

/* ==========================================================
   Wires
========================================================== */
el("startBtn").addEventListener("click", ()=>{
  if(state.running) return;
  startGame();
});
el("resetBtn").addEventListener("click", resetGame);

el("resetOrder").addEventListener("click", resetOrder);
el("checkOrder").addEventListener("click", checkOrder);

el("fbCloseBtn").addEventListener("click", hideFeedback);

el("downloadReport").addEventListener("click", downloadCSV);
el("celebrationDownload").addEventListener("click", downloadCSV);
el("celebrationRestart").addEventListener("click", ()=>{
  closeCelebration();
  resetGame();
  startGame();
});

el("studentName").addEventListener("input", ()=>{
  el("playerName").textContent = (el("studentName").value || "‚Äî").trim() || "‚Äî";
});

el("musicToggle").addEventListener("change", ()=>{
  if(!el("musicToggle").checked){
    try{ bgMusic.pause(); bgMusic.currentTime = 0; }catch(e){}
  }else{
    if(state.running){
      try{ bgMusic.volume = 0.6; bgMusic.play().catch(()=>{}); }catch(e){}
    }
  }
});

/* init */
updateHeader();
updateProgress();
updateBankStats();
</script>
</body>
</html>



