<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Future Grammar Mastery â€” Easy/Hard + Sheets</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* BLUE THEME */
      --bg:#0b3a6a;        /* page background */
      --bg2:#0a2f57;
      --card:#0e3f73;      /* main card */
      --panel:#0a2b4a;     /* panels */
      --ink:#ffffff;

      --cyan:#36d1ff;
      --blue:#2f80ff;
      --blue2:#1b63ff;
      --aqua:#00f0ff;
      --mint:#6fffd2;
      --yellow:#ffd166;
      --red:#ff4d6d;

      --bar:#071f36;
      --stroke:rgba(255,255,255,.18);
      --shadow:0 0 16px rgba(0,0,0,.30);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:radial-gradient(circle at 20% 0%, #0f4e8d 0%, var(--bg) 35%, var(--bg2) 100%);
      color:var(--ink);
    }
    .app{ max-width:980px; margin:0 auto; padding:16px; }

    header{ text-align:center; margin-bottom:12px; }
    h1{
      margin:0;
      font-size:2rem;
      font-weight:900;
      text-shadow:0 0 10px rgba(0,0,0,.35);
    }
    header p{
      margin:6px 0 10px;
      font-weight:800;
      opacity:.95;
    }

    .top-row{
      display:flex;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }

    .name-box{
      background:rgba(0,0,0,.18);
      border:2px solid var(--stroke);
      padding:8px 10px;
      border-radius:14px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .name-box span{ font-weight:900; }
    .name-box input{
      border:none;
      outline:none;
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      font-weight:900;
      min-width:170px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
    }
    .btn{
      border:none;
      border-radius:16px;
      padding:12px 18px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      box-shadow:0 0 14px rgba(0,0,0,.25);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.06); }

    .btn.blue{ background:linear-gradient(135deg,var(--blue),var(--blue2)); color:#fff; }
    .btn.cyan{ background:linear-gradient(135deg,var(--cyan),var(--aqua)); color:#001018; }
    .btn.red{ background:linear-gradient(135deg,var(--red),#ff7aa2); color:#24000e; }
    .btn.yellow{ background:linear-gradient(135deg,var(--yellow),#ffe6a7); color:#2b1500; }
    .btn.mint{ background:linear-gradient(135deg,var(--mint),#b8ffe9); color:#062116; }

    .btn.toggle{
      background:rgba(0,0,0,.20);
      border:2px solid rgba(54,209,255,.55);
      color:#fff;
    }
    .btn.toggle.on{
      background:linear-gradient(135deg,rgba(54,209,255,.95),rgba(0,240,255,.75));
      color:#001018;
      border-color:transparent;
    }

    .warning{
      margin-top:8px;
      min-height:18px;
      font-weight:900;
      color:#ffe3e3;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
      justify-content:center;
      margin:12px 0 14px;
    }
    .stat{
      background:rgba(0,0,0,.18);
      border:2px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      min-width:140px;
      text-align:center;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .stat .label{ font-size:.8rem; font-weight:900; opacity:.9; }
    .stat .value{ font-size:1.05rem; font-weight:900; margin-top:2px; }

    .progressWrap{
      flex:1;
      min-width:240px;
      background:rgba(0,0,0,.18);
      border:2px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .progressWrap .label{
      text-align:left;
      font-size:.8rem;
      font-weight:900;
      opacity:.92;
    }
    .bar{
      margin-top:8px;
      height:22px;
      background:var(--bar);
      border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(54,209,255,.55);
    }
    .fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--mint), var(--cyan));
      transition:width .25s ease;
    }

    .card{
      background:rgba(0,0,0,.20);
      border:2px solid var(--stroke);
      border-radius:18px;
      padding:18px;
      box-shadow:0 0 16px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }

    .miniTypeWrap{ text-align:center; }
    .miniType{
      display:inline-block;
      margin:0 auto 10px;
      padding:6px 12px;
      border-radius:999px;
      font-weight:900;
      background:rgba(0,0,0,.25);
      border:2px solid rgba(255,255,255,.16);
      box-shadow:0 0 10px rgba(0,0,0,.18);
      text-align:center;
    }

    .sentenceBox{
      display:flex;
      justify-content:center;
      margin: 10px 0 14px;
    }
    .sentenceBig{
      width:100%;
      background:#061a2d;
      border:3px solid rgba(54,209,255,.55);
      border-radius:18px;
      padding:18px 16px;
      font-weight:900;
      font-size:1.55rem;
      line-height:1.25;
      text-align:center;
      box-shadow:0 0 16px rgba(0,0,0,.35);
      user-select:none;
    }
    @media (max-width:680px){
      .sentenceBig{ font-size:1.22rem; }
      h1{ font-size:1.7rem; }
    }

    .interaction{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      min-height:52px;
      padding-bottom:10px;
      border-bottom:2px solid rgba(54,209,255,.32);
      margin-bottom:12px;
    }

    .word-bank{
      background:#05233f;
      border:2px solid rgba(255,255,255,.12);
      padding:14px;
      border-radius:16px;
      min-height:58px;
      box-shadow:0 3px 10px rgba(0,0,0,.25);
    }
    .wordItem{
      display:inline-block;
      background:#ffffff;
      color:#000;
      border:2px solid #3b3b3b;
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      margin:0 10px 10px 0;
      box-shadow:0 2px 6px rgba(0,0,0,.22);
      user-select:none;
    }
    .builtWord{
      background:#081f36;
      color:#fff;
      border:2px solid rgba(255,255,255,.14);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      user-select:none;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }

    .cards{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:8px;
    }
    @media (max-width:680px){
      .cards{ grid-template-columns:1fr; }
    }

    .cardBtn{
      border:none;
      border-radius:18px;
      padding:16px 16px;
      cursor:pointer;
      font-weight:900;
      font-size:1.08rem;
      color:#04101f;
      box-shadow:0 0 16px rgba(0,0,0,.28);
      border:3px solid rgba(255,255,255,.18);
      text-align:left;
      transition:transform .12s ease, filter .12s ease;
      min-height:86px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      user-select:none;
    }
    .cardBtn:hover{ transform:translateY(-1px); filter:brightness(1.05); }
    .cardTitle{ font-size:1.14rem; font-weight:900; }
    .cardDesc{ font-size:.92rem; font-weight:800; opacity:.92; }

    .pal0{ background:linear-gradient(135deg,#b8ecff,#36d1ff); }
    .pal1{ background:linear-gradient(135deg,#c7dcff,#2f80ff); color:#061a2d; }
    .pal2{ background:linear-gradient(135deg,#d9fff4,#6fffd2); }
    .pal3{ background:linear-gradient(135deg,#ffe6a7,#ffd166); }
    .pal4{ background:linear-gradient(135deg,#ffd0dc,#ff4d6d); }
    .pal5{ background:linear-gradient(135deg,#c7f0ff,#00f0ff); }

    .feedback{
      margin-top:12px;
      min-height:26px;
      text-align:center;
      font-weight:900;
      font-size:1.05rem;
    }
    .ok{ color:#b8ffe9; }
    .no{ color:#ffd1d1; }

    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .hidden{ display:none !important; }

    .pillRow{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .pill{
      background:rgba(0,0,0,.20);
      border:2px solid rgba(255,255,255,.14);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .pill b{ color:var(--aqua); }

  </style>
</head>

<body>
  <!-- AUDIO -->
  <audio id="bgm" loop preload="auto">
    <source src="audio/koala2.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound" preload="auto">
    <source src="audio/tadaa.mp3" type="audio/mpeg">
  </audio>

  <div class="app">
    <header>
      <h1>Future Grammar Mastery</h1>
      <p>Mix: ORDER â€¢ TENSE â€¢ MEANING â€” reach 25 correct in a row.</p>

      <div class="top-row">
        <div class="name-box">
          <span>Name:</span>
          <input id="playerName" type="text" placeholder="Enter your name">
        </div>

        <div class="controls">
          <button class="btn blue" onclick="startGame()">Start</button>
          <button class="btn toggle" id="musicBtn" onclick="toggleMusic()">Music: OFF</button>
          <button class="btn mint" id="levelBtn" onclick="toggleLevel()">Level: EASY</button>
          <button class="btn red" onclick="resetGame()">Reset</button>
        </div>
      </div>

      <div class="warning" id="nameWarning"></div>

      <div class="pillRow">
        <div class="pill">Attempts: <b id="attemptsPill">0</b></div>
        <div class="pill">Most failed: <b id="mostFailedPill">â€”</b></div>
        <div class="pill">Current type: <b id="typePill">â€”</b></div>
      </div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="label">Player</div>
        <div class="value" id="displayName">---</div>
      </div>

      <div class="stat">
        <div class="label">Streak</div>
        <div class="value"><span id="streak">0</span> / 25</div>
      </div>

      <div class="progressWrap">
        <div class="label">Progress</div>
        <div class="bar"><div class="fill" id="progressFill"></div></div>
      </div>

      <div class="stat">
        <div class="label">Time</div>
        <div class="value" id="timerDisplay">00:00</div>
      </div>
    </div>

    <div class="card">
      <div class="miniTypeWrap"><span class="miniType" id="miniType">Ready</span></div>

      <!-- Big sentence (for tense / meaning) -->
      <div class="sentenceBox hidden" id="sentenceBox">
        <div class="sentenceBig" id="sentenceBig"></div>
      </div>

      <!-- ORDER built words -->
      <div class="interaction hidden" id="interaction"></div>

      <!-- Cards area -->
      <div id="cardsArea" class="cards hidden"></div>

      <!-- Word bank -->
      <div class="word-bank hidden" id="wordBank"></div>

      <div class="feedback" id="feedback"></div>

      <div class="actions hidden" id="orderActions">
        <button class="btn red" onclick="clearWords()">Clear</button>
        <button class="btn yellow" onclick="checkOrder()">Check</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   GOOGLE SHEETS
============================ */
const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";
const SECRET_KEY = "CHANGE_ME_TO_SOMETHING_PRIVATE";

/* Send SAFE primitive fields only (no {object Object}) */
async function sendToSheet(payload){
  const body = {
    secret: SECRET_KEY,
    name: String(payload.name || ""),
    time_s: Number(payload.time_s || 0),
    attempts: Number(payload.attempts || 0),
    most_failed_category: String(payload.most_failed_category || ""),
    activity_type: String(payload.activity_type || ""),
    sentence: String(payload.sentence || ""),
    level: String(payload.level || "")
  };
  try{
    await fetch(SHEET_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
  }catch(err){
    console.error("Sheets send error:", err);
  }
}

/* ===========================================================
   BANK: sentence + form + meaning (intent) + difficulty tag
   NOTE: You asked "add 20 more in each" â€” I expanded heavily.
=========================================================== */
const BANK = [
  /* ===== PRESENT SIMPLE (schedule) ===== */
  { text:"The train leaves at 8:10 tomorrow.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"School starts at 9 oâ€™clock on Monday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The concert begins at 7 p.m. on Friday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The museum closes at 6 p.m.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"Does the match start at noon?", form:"present_simple", intent:"schedule", diff:"easy" },

  /* +20 more (schedule) */
  { text:"The bus arrives at 7:35 tomorrow morning.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The flight lands at 5:20 p.m. on Tuesday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The library opens at 8:30 a.m. every weekday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The exam starts at 10:00 a.m. on Thursday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The show ends at 9:45 tonight.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The ferry departs at 2 p.m. tomorrow.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The shop opens at 9 a.m. on Saturdays.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The meeting begins at 3:00 p.m. sharp.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The lesson finishes at 1:30 today.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The train to London leaves at 6:05.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The gates open at 6 p.m. for the concert.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The results come out next Friday at noon.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The ceremony starts at 11:15 a.m. tomorrow.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The class begins after the break at 11:00.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The last bus leaves at 11:50 tonight.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The restaurant opens at 12, not at 11.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The conference starts on Monday at 9 a.m.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The train does not stop here at night.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"Does your flight depart at 6:40?", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"What time does the movie start tonight?", form:"present_simple", intent:"schedule", diff:"hard" },

  /* ===== PRESENT CONTINUOUS (arrangement) ===== */
  { text:"Iâ€™m meeting my friends at 6 p.m.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Weâ€™re having dinner together tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Sheâ€™s seeing the dentist on Friday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Theyâ€™re coming over for lunch tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you visiting your grandma this weekend?", form:"present_continuous", intent:"arrangement", diff:"easy" },

  /* +20 more (arrangement) */
  { text:"Iâ€™m flying to Madrid on Saturday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Weâ€™re studying together after school.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Heâ€™s playing basketball this evening.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Iâ€™m not working tomorrow; Iâ€™m taking the day off.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"Weâ€™re not meeting on Mondayâ€”weâ€™re meeting on Tuesday.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"Sheâ€™s staying at her cousinâ€™s house this weekend.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Theyâ€™re having a party next Saturday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you coming to the library at 4?", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Iâ€™m having a driving lesson tomorrow morning.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Weâ€™re going to the cinema tonight.", form:"present_continuous", intent:"arrangement", diff:"easy" }, /* tricky: looks going_to, but it's PC phrase */
  { text:"Heâ€™s seeing his coach after practice.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"Iâ€™m meeting the principal at 9 a.m. tomorrow.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"Weâ€™re doing a class presentation next week.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Sheâ€™s not coming with us this time.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Theyâ€™re having lunch with their grandparents tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Iâ€™m seeing the doctor at 3:30.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Weâ€™re leaving early tomorrow morning.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you joining the club next term?", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"Heâ€™s not playing today; heâ€™s resting.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"Iâ€™m meeting her after the meeting ends.", form:"present_continuous", intent:"arrangement", diff:"hard" },

  /* ===== WILL (prediction / decision / offer / announcement) ===== */
  { text:"I think it will rain later.", form:"will", intent:"prediction", diff:"easy" },
  { text:"They will probably win the match.", form:"will", intent:"prediction", diff:"easy" },
  { text:"Maybe we will have a test tomorrow.", form:"will", intent:"prediction", diff:"easy" },

  { text:"Donâ€™t worry, Iâ€™ll help you.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"I wonâ€™t tell anyone. I promise.", form:"will", intent:"offer_promise", diff:"easy" },

  { text:"Okay, Iâ€™ll do it now.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"Waitâ€”Iâ€™ll message her right now.", form:"will", intent:"decision_now", diff:"easy" },

  { text:"The results will be published tomorrow.", form:"will", intent:"announcement", diff:"hard" },
  { text:"The show will start in five minutes.", form:"will", intent:"announcement", diff:"easy" },

  /* +20 more (will) */
  { text:"Iâ€™m sure youâ€™ll enjoy the film.", form:"will", intent:"prediction", diff:"easy" },
  { text:"I donâ€™t think heâ€™ll be late.", form:"will", intent:"prediction", diff:"easy" },
  { text:"Sheâ€™ll pass the examâ€”she studied a lot.", form:"will", intent:"prediction", diff:"hard" }, /* trap: sounds evidence */
  { text:"Iâ€™ll carry that for you.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"Iâ€™ll call you tonight, I promise.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"Weâ€™ll see what happens.", form:"will", intent:"prediction", diff:"hard" },
  { text:"Iâ€™ll have the chicken salad, please.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"Iâ€™ll open the window.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"The teacher will explain the rules again.", form:"will", intent:"announcement", diff:"hard" },
  { text:"The new timetable will be posted on Monday.", form:"will", intent:"announcement", diff:"hard" },
  { text:"Iâ€™ll help you with your homework after dinner.", form:"will", intent:"offer_promise", diff:"hard" },
  { text:"I think theyâ€™ll move to another city.", form:"will", intent:"prediction", diff:"easy" },
  { text:"Weâ€™ll start the lesson in two minutes.", form:"will", intent:"announcement", diff:"easy" },
  { text:"Iâ€™ll get it! (The phone is ringing.)", form:"will", intent:"decision_now", diff:"easy" },
  { text:"I wonâ€™t forget your birthday.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"Theyâ€™ll probably arrive after 9.", form:"will", intent:"prediction", diff:"easy" },
  { text:"The principal will make an announcement at noon.", form:"will", intent:"announcement", diff:"hard" },
  { text:"Iâ€™ll send you the file right now.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"Iâ€™ll be there at 5, I promise.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"I donâ€™t think itâ€™ll snow in April.", form:"will", intent:"prediction", diff:"hard" },

  /* ===== GOING TO (plan / evidence prediction) ===== */
  { text:"Iâ€™m going to study tonight.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Weâ€™re going to meet after school.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Are you going to watch the new episode?", form:"going_to", intent:"plan", diff:"easy" },

  { text:"Look at those clouds! Itâ€™s going to rain.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"That glass is going to fall!", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"Youâ€™re going to miss the busâ€”run!", form:"going_to", intent:"evidence_prediction", diff:"hard" },

  /* +20 more (going_to) */
  { text:"Iâ€™m going to buy a new backpack this weekend.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Sheâ€™s going to visit her aunt tomorrow.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Weâ€™re going to practice for the test after class.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Theyâ€™re going to paint the classroom next month.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Are you going to join the football team?", form:"going_to", intent:"plan", diff:"easy" },
  { text:"He isnâ€™t going to eat junk food anymore.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Watch out! Youâ€™re going to drop your phone.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"Itâ€™s going to be a long dayâ€”look at the schedule.", form:"going_to", intent:"evidence_prediction", diff:"hard" },
  { text:"That bike is going to crash if you donâ€™t slow down!", form:"going_to", intent:"evidence_prediction", diff:"hard" },
  { text:"Look! The cat is going to jump on the table.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"Iâ€™m going to start a new project next week.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Weâ€™re going to take a trip in June.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Sheâ€™s going to study medicine at university.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Theyâ€™re going to organize a fundraiser soon.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Itâ€™s going to snowâ€”look at the dark sky.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"That chair is going to break! Donâ€™t sit on it.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"Iâ€™m not going to be late tomorrow.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Are we going to finish this today?", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Heâ€™s going to forget his keys againâ€”he always does.", form:"going_to", intent:"evidence_prediction", diff:"hard" },
  { text:"Look at the scoreâ€”weâ€™re going to win!", form:"going_to", intent:"evidence_prediction", diff:"easy" },

  /* ===== FIRST CONDITIONAL ===== */
  { text:"If you donâ€™t study, youâ€™ll fail the test.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you feel tired, take a break.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If it rains, weâ€™ll stay at home.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If she studies, sheâ€™ll do well.", form:"first_conditional", intent:"prediction_result", diff:"easy" },

  /* +20 more (first conditional) */
  { text:"If you hurry, youâ€™ll catch the bus.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you donâ€™t sleep, youâ€™ll feel awful tomorrow.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you need help, Iâ€™ll explain it again.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If the teacher is free, weâ€™ll ask a question.", form:"first_conditional", intent:"plan_condition", diff:"hard" },
  { text:"If you practise every day, youâ€™ll improve fast.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you keep talking, youâ€™ll get in trouble.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you donâ€™t understand, ask me.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If itâ€™s sunny, weâ€™ll play outside.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If you forget your homework, youâ€™ll lose points.", form:"first_conditional", intent:"warning_consequence", diff:"hard" },
  { text:"If she arrives early, weâ€™ll start right away.", form:"first_conditional", intent:"plan_condition", diff:"hard" },
  { text:"If they study tonight, theyâ€™ll pass tomorrow.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you donâ€™t charge your phone, itâ€™ll die.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you want, weâ€™ll work together after school.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If the bus is late, weâ€™ll take a taxi.", form:"first_conditional", intent:"plan_condition", diff:"hard" },
  { text:"If you eat better, youâ€™ll feel stronger.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you donâ€™t listen, youâ€™ll miss the instructions.", form:"first_conditional", intent:"warning_consequence", diff:"hard" },
  { text:"If you feel stressed, breathe slowly.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If it gets cold, weâ€™ll go inside.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If youâ€™re late again, youâ€™ll have detention.", form:"first_conditional", intent:"warning_consequence", diff:"hard" },
  { text:"If he studies harder, heâ€™ll get better marks.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
];

/* Count sentences per form (for your â€œhow many?â€ question) */
function countByForm(){
  const out = {};
  for(const q of BANK){
    out[q.form] = (out[q.form]||0)+1;
  }
  return out;
}

/* ===== Tense cards ===== */
const TENSE_OPTIONS = [
  { key:"present_simple", label:"Present Simple", desc:"Schedules / timetables" },
  { key:"present_continuous", label:"Present Continuous", desc:"Arrangements / plans" },
  { key:"will", label:"Future (will)", desc:"Prediction / decision / promise" },
  { key:"going_to", label:"Be going to", desc:"Plan / evidence prediction" },
  { key:"first_conditional", label:"First Conditional", desc:"If + present, will..." }
];

/* Meaning/intent cards by form */
const MEANING_OPTIONS = {
  will: [
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"offer_promise", label:"Offer / Promise", desc:"Help / promise" },
    { key:"decision_now", label:"Decision now", desc:"Made right now" },
    { key:"announcement", label:"Announcement", desc:"Official info" },
    { key:"plan", label:"Plan", desc:"Already decided" },                 // distractor
    { key:"evidence_prediction", label:"Evidence prediction", desc:"Look! evidence" } // distractor
  ],
  going_to: [
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"evidence_prediction", label:"Prediction (evidence)", desc:"Look! / evidence" },
    { key:"announcement", label:"Announcement", desc:"Official info" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"decision_now", label:"Decision now", desc:"Made right now" },   // distractor
    { key:"schedule", label:"Schedule", desc:"Timetable time" }           // distractor
  ],
  present_simple: [
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" },
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"announcement", label:"Announcement", desc:"Official info" },    // distractor
    { key:"warning_consequence", label:"Warning", desc:"Bad result" }      // distractor
  ],
  present_continuous: [
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" },
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"announcement", label:"Announcement", desc:"Official info" },    // distractor
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion" }         // distractor
  ],
  first_conditional: [
    { key:"warning_consequence", label:"Warning", desc:"Bad result" },
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion" },
    { key:"plan_condition", label:"Plan", desc:"If X, we do Y" },
    { key:"prediction_result", label:"Prediction", desc:"If X, Y happens" },
    { key:"schedule", label:"Schedule", desc:"Timetable time" },           // distractor
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" }          // distractor
  ]
};

/* ===========================================================
   State
=========================================================== */
let currentType = "";
let currentQ = null;
let tokens = [];     // strings
let built = [];      // strings only => no {object Object}

let streak = 0;
const masteryGoal = 25;

let timerInterval = null;
let startTime = null;

let musicOn = false;
let level = "easy"; // easy | hard

let attempts = 0;
const wrongCounts = { ORDER:0, TENSE:0, MEANING:0 };

/* 3 activities */
const TYPES = ["ORDER","TENSE","MEANING"];

/* ===========================================================
   Utils
=========================================================== */
function shuffle(arr){
  const a = arr.slice();
  for(let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function formatTime(ms){
  const s = Math.floor(ms / 1000);
  const m = String(Math.floor(s / 60)).padStart(2,"0");
  const r = String(s % 60).padStart(2,"0");
  return `${m}:${r}`;
}
function secondsElapsed(){
  if(!startTime) return 0;
  return Math.floor((Date.now() - startTime)/1000);
}
function updateTimerDisplay(){
  document.getElementById("timerDisplay").textContent = startTime ? formatTime(Date.now() - startTime) : "00:00";
}
function startTimer(){
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 500);
}
function stopTimer(){
  clearInterval(timerInterval);
  timerInterval = null;
}
function updateStats(){
  document.getElementById("streak").textContent = streak;
  const pct = Math.max(0, Math.min(100, (streak / masteryGoal) * 100));
  document.getElementById("progressFill").style.width = pct + "%";
  document.getElementById("attemptsPill").textContent = String(attempts);
  document.getElementById("typePill").textContent = currentType || "â€”";
  document.getElementById("mostFailedPill").textContent = mostFailedCategory() || "â€”";
}
function setFeedback(text, ok=null){
  const fb = document.getElementById("feedback");
  fb.textContent = text || "";
  fb.className = "feedback";
  if(ok === true) fb.classList.add("ok");
  if(ok === false) fb.classList.add("no");
}
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function setMiniType(txt){ document.getElementById("miniType").textContent = txt; }

function resetView(){
  setFeedback("");
  hide(document.getElementById("sentenceBox"));
  hide(document.getElementById("interaction"));
  hide(document.getElementById("cardsArea"));
  hide(document.getElementById("wordBank"));
  hide(document.getElementById("orderActions"));

  document.getElementById("cardsArea").innerHTML = "";
  document.getElementById("wordBank").innerHTML = "";
  document.getElementById("interaction").innerHTML = "";
}

function pickPaletteClass(i){
  const pals = ["pal0","pal1","pal2","pal3","pal4","pal5"];
  return pals[i % pals.length];
}

/* ===========================================================
   Difficulty behavior
=========================================================== */
function toggleLevel(){
  level = (level === "easy") ? "hard" : "easy";
  const b = document.getElementById("levelBtn");
  b.textContent = "Level: " + level.toUpperCase();
  setFeedback("Level set to " + level.toUpperCase() + ".", true);
}

function bankForLevel(){
  if(level === "easy"){
    // prefer easy and shorter
    return BANK.filter(q => q.diff !== "hard" && q.text.split(" ").length <= 10);
  }
  // hard: everything, prefer longer & tricky
  return BANK.slice();
}

/* ===========================================================
   Music
=========================================================== */
function toggleMusic(){
  const bgm = document.getElementById("bgm");
  const btn = document.getElementById("musicBtn");
  bgm.volume = 0.35;

  if(!musicOn){
    const p = bgm.play();
    if(p && p.then){
      p.then(()=>{ musicOn = true; btn.textContent = "Music: ON"; btn.classList.add("on"); })
       .catch(()=>{ musicOn = false; btn.textContent = "Music: OFF"; btn.classList.remove("on"); });
    } else {
      musicOn = true; btn.textContent = "Music: ON"; btn.classList.add("on");
    }
  } else {
    bgm.pause();
    musicOn = false;
    btn.textContent = "Music: OFF";
    btn.classList.remove("on");
  }
}

/* ===========================================================
   Start / Reset
=========================================================== */
function startGame(){
  const name = document.getElementById("playerName").value.trim();
  if(!name){
    document.getElementById("nameWarning").textContent = "Please enter your name before starting.";
    return;
  }
  document.getElementById("nameWarning").textContent = "";
  document.getElementById("displayName").textContent = name;

  streak = 0;
  attempts = 0;
  wrongCounts.ORDER = 0; wrongCounts.TENSE = 0; wrongCounts.MEANING = 0;

  updateStats();
  setFeedback("");
  document.getElementById("bgm").load();

  startTimer();
  nextQuestion();
}

function resetGame(){
  stopTimer();
  startTime = null;
  updateTimerDisplay();

  streak = 0;
  attempts = 0;
  wrongCounts.ORDER = 0; wrongCounts.TENSE = 0; wrongCounts.MEANING = 0;

  currentQ = null;
  tokens = [];
  built = [];
  currentType = "";

  setMiniType("Ready");
  resetView();
  updateStats();

  const bgm = document.getElementById("bgm");
  bgm.pause();
  musicOn = false;
  const mbtn = document.getElementById("musicBtn");
  mbtn.textContent = "Music: OFF";
  mbtn.classList.remove("on");

  setFeedback("Reset.", true);
}

/* ===========================================================
   Next question (shuffle)
=========================================================== */
function nextQuestion(){
  built = [];
  resetView();

  // Pick type: Easy = more ORDER/TENSE, Hard = more MEANING/TENSE (trickier)
  const weighted = (level === "easy")
    ? ["ORDER","ORDER","TENSE","TENSE","MEANING"]
    : ["ORDER","TENSE","TENSE","MEANING","MEANING"];

  currentType = weighted[Math.floor(Math.random()*weighted.length)];
  const pool = bankForLevel();
  currentQ = pool[Math.floor(Math.random()*pool.length)];
  tokens = currentQ.text.split(" "); // strings only

  updateStats();

  if(currentType === "ORDER"){
    setMiniType(level === "hard" ? "Order words (HARD)" : "Order words");
    renderOrder(currentQ.text);
    return;
  }
  if(currentType === "TENSE"){
    setMiniType(level === "hard" ? "Verb tense (HARD)" : "Verb tense");
    showBigSentence(currentQ.text);
    renderTenseCards(currentQ.form);
    return;
  }
  setMiniType(level === "hard" ? "Speaker meaning (HARD)" : "Speaker meaning");
  showBigSentence(currentQ.text);
  renderMeaningCards(currentQ.form, currentQ.intent);
}

function showBigSentence(text){
  document.getElementById("sentenceBig").textContent = text;
  show(document.getElementById("sentenceBox"));
}

/* ===========================================================
   ORDER
=========================================================== */
function renderOrder(){
  const interaction = document.getElementById("interaction");
  const bank = document.getElementById("wordBank");
  show(interaction); show(bank); show(document.getElementById("orderActions"));

  bank.innerHTML = "";
  const words = shuffle(tokens);

  words.forEach((w)=>{
    const b = document.createElement("span");
    b.className = "wordItem";
    b.textContent = w;
    b.onclick = ()=>{
      built.push(w);            // strings only
      b.style.display = "none";
      renderBuiltWords();
    };
    bank.appendChild(b);
  });

  renderBuiltWords();
}

function renderBuiltWords(){
  const area = document.getElementById("interaction");
  area.innerHTML = "";

  built.forEach((w,i)=>{
    const chip = document.createElement("span");
    chip.className = "builtWord";
    chip.textContent = w;
    chip.onclick = ()=>{
      const removed = built.splice(i,1)[0];  // string
      // re-show one hidden matching token (first match)
      const kids = Array.from(document.getElementById("wordBank").children);
      for(const el of kids){
        if(el.textContent === removed && el.style.display === "none"){
          el.style.display = "inline-block";
          break;
        }
      }
      renderBuiltWords();
    };
    area.appendChild(chip);
  });
}

function clearWords(){
  built = [];
  renderBuiltWords();
  Array.from(document.getElementById("wordBank").children).forEach(el=>{
    el.style.display = "inline-block";
  });
}

function normalizeLoose(s){
  // EASY: ignore case, extra spaces, and simple punctuation at ends
  return String(s)
    .trim()
    .replace(/\s+/g," ")
    .replace(/[â€œâ€]/g,'"')
    .replace(/[â€™]/g,"'")
    .replace(/[!?.,:;]+/g,"")
    .toLowerCase();
}
function normalizeStrict(s){
  // HARD: strict spaces but normalize multiple spaces only
  return String(s).trim().replace(/\s+/g," ");
}

function checkOrder(){
  if(!currentQ) return;
  const attempt = built.join(" ");
  const ok = (level === "hard")
    ? (normalizeStrict(attempt) === normalizeStrict(currentQ.text))
    : (normalizeLoose(attempt) === normalizeLoose(currentQ.text));

  grade(ok, { activity:"ORDER", sentence: currentQ.text });
}

/* ===========================================================
   TENSE cards
=========================================================== */
function renderTenseCards(correctForm){
  const cards = document.getElementById("cardsArea");
  show(cards);
  cards.innerHTML = "";

  // EASY: 4 options
  // HARD: 6 options (if possible) -> tougher
  const want = (level === "hard") ? 6 : 4;

  const pool = shuffle([...TENSE_OPTIONS]);
  const correct = pool.find(x => x.key === correctForm) || TENSE_OPTIONS[0];
  const others = pool.filter(x => x.key !== correctForm).slice(0, want-1);
  const options = shuffle([correct, ...others]);

  options.forEach((o, idx)=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn " + pickPaletteClass(idx);
    btn.innerHTML = `<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick = ()=> grade(o.key === correctForm, { activity:"TENSE", sentence: currentQ.text });
    cards.appendChild(btn);
  });
}

/* ===========================================================
   MEANING cards
=========================================================== */
function renderMeaningCards(form, correctIntent){
  const cards = document.getElementById("cardsArea");
  show(cards);
  cards.innerHTML = "";

  const all = (MEANING_OPTIONS[form] || []).slice();
  const want = (level === "hard") ? 6 : 4;

  // ensure correct included
  let options = all.filter(x => x.key === correctIntent);
  const distractors = shuffle(all.filter(x => x.key !== correctIntent)).slice(0, Math.max(0, want-1));
  options = shuffle(options.concat(distractors)).slice(0, want);

  options.forEach((o, idx)=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn " + pickPaletteClass(idx);
    btn.innerHTML = `<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick = ()=> grade(o.key === correctIntent, { activity:"MEANING", sentence: currentQ.text, correctIntent });
    cards.appendChild(btn);
  });
}

function prettyIntent(key){
  return (key||"").replaceAll("_"," ").toUpperCase();
}

/* ===========================================================
   Reporting helpers
=========================================================== */
function mostFailedCategory(){
  const entries = Object.entries(wrongCounts);
  entries.sort((a,b)=> b[1]-a[1]);
  if(entries[0][1] === 0) return "â€”";
  // tie-break: show one
  return entries[0][0];
}

function playerName(){
  const n = document.getElementById("playerName").value.trim();
  return n || "â€”";
}

/* ===========================================================
   Grade + Google Sheets send
=========================================================== */
function grade(correct, info){
  // attempts increment every answer submission (ORDER check / clicking a card)
  attempts++;

  const activity = (info && info.activity) ? info.activity : currentType;
  const sentence = (info && info.sentence) ? info.sentence : (currentQ ? currentQ.text : "");

  if(correct){
    setFeedback("âœ… Correct!", true);
    streak++;
    updateStats();

    // Send to Sheets on every attempt (ok or not)
    sendToSheet({
      name: playerName(),
      time_s: secondsElapsed(),
      attempts,
      most_failed_category: mostFailedCategory(),
      activity_type: activity,
      sentence,
      level
    });

    if(streak >= masteryGoal){
      try{ document.getElementById("winSound").play().catch(()=>{}); }catch(e){}
      setFeedback("ðŸ† Mastery! 25 in a row!", true);
      return;
    }
    setTimeout(nextQuestion, 550);
  } else {
    setFeedback("âŒ Try again!", false);
    streak = 0;

    if(activity === "ORDER") wrongCounts.ORDER++;
    if(activity === "TENSE") wrongCounts.TENSE++;
    if(activity === "MEANING") wrongCounts.MEANING++;

    updateStats();

    // If MEANING wrong, show correct intent in HARD for learning (and in EASY too)
    if(activity === "MEANING" && info && info.correctIntent){
      setFeedback("âŒ Try again! Correct: " + prettyIntent(info.correctIntent), false);
    }

    // Send to Sheets on wrong attempts too
    sendToSheet({
      name: playerName(),
      time_s: secondsElapsed(),
      attempts,
      most_failed_category: mostFailedCategory(),
      activity_type: activity,
      sentence,
      level
    });

    // For ORDER wrong: reset built words (avoid â€œstuckâ€)
    if(activity === "ORDER"){
      clearWords();
    }
  }
}

/* ===========================================================
   Init
=========================================================== */
window.addEventListener("load", ()=>{
  document.getElementById("bgm").volume = 0.35;
  setMiniType("Ready");
  updateStats();

  // Optional: log counts in console
  console.log("Sentence counts by form:", countByForm());
});
</script>
</body>
</html>
