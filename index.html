<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Future Forms + First Conditional ‚Äî Streak to 25 (Manga) + Google Sheets Stats</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#05040d; --bg2:#0b0830; --bg3:#140a2b;
  --ink:#f7fbff; --mut:rgba(247,251,255,.72);
  --panel: rgba(18, 13, 34, .88);
  --stroke: rgba(255,255,255,.14);
  --pink:#ff2fb3; --cyan:#11e8ff; --yellow:#ffe04a; --lime:#7dff6a; --violet:#9b5cff;
  --shadow: 0 26px 80px rgba(0,0,0,.60);
  --focus: 0 0 0 5px rgba(17,232,255,.25);
  --wMax: 1200px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:Montserrat,system-ui,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 520px at 15% 18%, rgba(255,47,179,.22), transparent 60%),
    radial-gradient(900px 520px at 85% 22%, rgba(17,232,255,.18), transparent 60%),
    radial-gradient(720px 420px at 55% 85%, rgba(255,224,74,.12), transparent 60%),
    linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}

.container{
  width:min(var(--wMax), 100%);
  min-height: calc(100vh - 24px);
  max-height: 980px;
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);
  display:grid;
  grid-template-columns: 1fr 330px;
  grid-template-rows: auto auto 1fr auto;
  gap:12px;
  overflow:hidden;
}

.header{grid-column:1/2; grid-row:1/2; display:flex; gap:12px; align-items:center}
.logo{
  width:56px;height:56px;border-radius:16px;
  background: linear-gradient(135deg, rgba(255,47,179,.25), rgba(17,232,255,.22), rgba(255,224,74,.18));
  border:2px solid rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 14px 28px rgba(0,0,0,.30);
  position:relative;
}
.logo:after{
  content:"";
  position:absolute; inset:6px;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.20);
  pointer-events:none;
}
.title{margin:0;font-size:20px;color:#fff;letter-spacing:.2px}
.lead{margin:2px 0 0;font-size:13px;color:var(--mut)}

.topbar{
  grid-column:1/2; grid-row:2/3;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
  gap:10px;
  flex-wrap:wrap;
}
.statRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stat{
  border:2px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:8px 12px;
  font-weight:900;
  font-size:13px;
  background:rgba(0,0,0,.18);
}
.playerTag{font-size:13px;color:var(--mut)}
.playerTag strong{color:var(--ink)}

.controlsPanel{
  grid-column:2/3; grid-row:1/4;
  display:flex; flex-direction:column; gap:10px;
  padding:12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
  overflow:hidden;
}
.inputRow{display:flex;flex-direction:column;gap:6px}
.inputRow label{font-weight:900;font-size:13px;color:var(--ink)}
.inputRow input{
  border:2px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  border-radius:14px;
  padding:12px;
  font-size:14px;
  outline:none;
}
.inputRow input:focus{border-color: rgba(17,232,255,.80); box-shadow:var(--focus);}

.controlsBtns{display:flex;gap:10px}
.btnPrimary,.btnSecondary{
  width:50%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease;
}
.btnPrimary{
  border:2px solid rgba(255,255,255,.16);
  color:#06101a;
  background:linear-gradient(180deg,var(--yellow),#ffbf00);
  box-shadow:0 14px 28px rgba(255,224,74,.18);
}
.btnSecondary{
  border:2px solid rgba(255,255,255,.16);
  color:var(--ink);
  background:rgba(0,0,0,.18);
}
.btnPrimary:hover,.btnSecondary:hover{transform:translateY(-2px);filter:brightness(1.05)}
.btnPrimary:disabled,.btnSecondary:disabled{opacity:.6;cursor:not-allowed;transform:none}

.toggles{
  display:flex; gap:10px; flex-wrap:wrap;
  font-size:13px;color:var(--mut);
}
.toggles label{display:flex;gap:8px;align-items:center;cursor:pointer;user-select:none}

.tipBox{
  margin-top:auto;
  padding:12px;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.18);
  background:rgba(0,0,0,.15);
  font-size:12.7px;
  color:rgba(247,251,255,.88);
  line-height:1.35;
}
.bankStats{
  margin-top:10px;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--stroke);
  background:rgba(0,0,0,.16);
  color:rgba(247,251,255,.90);
  font-size:12.5px;
  line-height:1.35;
}

.game{
  grid-column:1/2; grid-row:3/4;
  overflow:hidden;
  display:flex;
  align-items:stretch;
  justify-content:center;
  position:relative;
}
.gameInner{
  width:100%;
  max-width:860px;
  height:100%;
  display:grid;
  grid-template-rows:
    minmax(140px, .44fr)
    minmax(54px, auto)
    minmax(240px, 1fr)
    auto
    auto;
  gap:10px;
  overflow:hidden;
}

#card{
  border-radius:18px;
  padding:12px;
  background:
    radial-gradient(circle at 20% 20%, rgba(17,232,255,.22), transparent 50%),
    radial-gradient(circle at 80% 25%, rgba(255,47,179,.22), transparent 55%),
    radial-gradient(circle at 55% 90%, rgba(255,224,74,.16), transparent 55%),
    linear-gradient(135deg, rgba(17,232,255,.16), rgba(255,47,179,.14), rgba(255,224,74,.10));
  border:2px solid rgba(255,255,255,.18);
  box-shadow:0 18px 48px rgba(0,0,0,.34);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;
  position:relative;
  overflow:hidden;
}
#card::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    repeating-linear-gradient(45deg,
      rgba(255,255,255,.08) 0 10px,
      rgba(255,255,255,.02) 10px 20px);
  transform:rotate(-10deg);
  pointer-events:none;
  opacity:.35;
}
#cardLabel{
  position:relative;
  font-size:13px;
  font-weight:900;
  color:#07111b;
  padding:8px 14px;
  border-radius:999px;
  background:linear-gradient(180deg, var(--cyan), #00c8dd);
  border:2px solid rgba(0,0,0,.35);
  margin:0 0 8px;
}
#cardText{
  position:relative;
  width:min(92%, 780px);
  padding:10px 12px;
  border-radius:14px;
  background:rgba(0,0,0,.22);
  border:2px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight:900;
  font-size:clamp(18px, 2.0vw, 30px);
  line-height:1.14;
  text-shadow:0 2px 14px rgba(0,0,0,.35);
  overflow-wrap:anywhere;
  word-break:break-word;
}

#orderBox{
  border:2px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:rgba(0,0,0,.18);
  padding:10px;
  min-height:54px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:var(--ink);
  overflow:hidden;
}

#options{
  width:100%;
  border-radius:16px;
  border:2px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  padding:10px;
  overflow:hidden;
}

/* Multiple-choice */
#options.mode-multiple{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.choiceCard{
  border:2px solid rgba(0,0,0,.35);
  border-radius:18px;
  padding:14px 14px;
  color:#07101a;
  font-weight:900;
  cursor:pointer;
  text-align:left;
  display:flex;
  align-items:center;
  gap:12px;
  min-height:86px;
  box-shadow:0 16px 34px rgba(0,0,0,.24);
  transition:transform .12s ease, filter .12s ease;
  position:relative;
  overflow:hidden;
}
.choiceCard:hover{transform:translateY(-3px);filter:brightness(1.06)}
.choiceIcon{
  width:46px;height:46px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.45);
  border:2px solid rgba(0,0,0,.35);
  font-size:22px;
  z-index:1;
}
.choiceText{z-index:1; font-size:18px; line-height:1.12}
.choiceText small{display:block;font-size:13px;font-weight:800;opacity:.95;margin-top:3px}

.choiceWILL{background:linear-gradient(180deg, var(--yellow), #ffb703);}
.choiceGOING{background:linear-gradient(180deg, var(--pink), #ff5cc9);}
.choicePC{background:linear-gradient(180deg, var(--cyan), #00b6ca);}
.choicePS{background:linear-gradient(180deg, var(--lime), #56ff8b);}
.choiceCOND{background:linear-gradient(180deg, var(--violet), #b78bff);}

/* Ordering */
#options.mode-order{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(108px, 1fr));
  gap:12px;
  align-content:start;
  grid-auto-rows: minmax(44px, auto);
}
.orderWord{
  border:2px solid rgba(0,0,0,.35);
  border-radius:16px;
  padding: 11px 12px;
  font-weight:900;
  font-size: 16px;
  cursor:pointer;
  color:#07101a;
  background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
  box-shadow:0 12px 22px rgba(0,0,0,.18);
  transition:transform .12s ease, filter .12s ease;
  text-align:center;
  white-space:nowrap;
}
.orderWord:hover{transform:translateY(-3px); filter:brightness(1.05);}
.orderWord:disabled{opacity:.55;cursor:not-allowed;transform:none !important}
.orderWord.chosen{ color:#fff; background:linear-gradient(180deg,#ef4444,#b91c1c); }

.selChip{
  padding:8px 12px;
  border-radius:14px;
  background:rgba(17,232,255,.16);
  border:2px solid rgba(17,232,255,.26);
  font-weight:900;
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, filter .12s ease;
}
.selChip:hover{transform:translateY(-2px);filter:brightness(1.05)}

.progressWrap{
  width:100%;
  height:12px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, var(--lime), var(--cyan), var(--yellow), var(--pink), var(--lime));
  background-size:220% 100%;
  transition:width 350ms ease;
}
.progressBar.moving{ animation: prog 1.1s linear infinite; }
@keyframes prog{ 0%{background-position:0%} 100%{background-position:220%} }
.progressLabel{font-size:13px; color:rgba(247,251,255,.92); text-align:center; margin-top:-4px; font-weight:900;}

.controlsRow{
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
}
.smallBtn{
  border:2px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease, opacity .12s ease;
}
.smallBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.smallBtn:disabled{opacity:.55;cursor:not-allowed;transform:none !important}

/* BIG blinking CHECK */
#checkOrder.smallBtn{
  padding: 18px 32px !important;
  font-size: 19px !important;
  border-radius: 18px !important;
  min-width: 230px !important;
  border:2px solid rgba(0,0,0,.35) !important;
  color:#06101a !important;
  background: linear-gradient(180deg, var(--yellow), #ffb703) !important;
  box-shadow: 0 18px 38px rgba(255,224,74,.22) !important;
}
#checkOrder.smallBtn.checkAttention{ animation: checkPulse 1.0s ease-in-out infinite; }
@keyframes checkPulse{
  0%,100%{ transform: scale(1); filter: brightness(1); }
  50%{ transform: scale(1.07); filter: brightness(1.12); }
}

#sendStats.smallBtn{
  border:2px solid rgba(0,0,0,.35) !important;
  color:#06101a !important;
  background: linear-gradient(180deg, var(--cyan), #00b6ca) !important;
  box-shadow: 0 18px 38px rgba(17,232,255,.16) !important;
}

.footer{
  grid-column:1/2; grid-row:4/5;
  display:flex; justify-content:space-between; align-items:center;
  color:var(--mut); font-size:13px;
  gap:10px;
  flex-wrap:wrap;
}

/* Feedback overlay */
.fbOverlay{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(2,8,23,.62);
  opacity:0; pointer-events:none;
  transition:opacity .18s ease;
  z-index:20;
}
.fbOverlay.show{ opacity:1; pointer-events:auto; }
.fbCard{
  width:min(640px, 94%);
  border-radius:18px;
  padding:18px 18px 16px;
  background:linear-gradient(180deg, rgba(20,14,36,.97), rgba(20,14,36,.93));
  border:2px solid rgba(255,255,255,.16);
  box-shadow:0 24px 70px rgba(0,0,0,.60);
  text-align:center;
}
.fbTop{display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900;}
.fbIcon{
  width:48px;height:48px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.10);
  border:2px solid rgba(255,255,255,.14);
  font-size:22px;
}
.fbTitle{font-size:22px; margin:0;}
.fbSub{
  margin:12px auto 0;
  font-size:16px; color:#fff; font-weight:900;
  line-height:1.32; max-width:600px;
}
.fbDetail{
  margin:10px auto 0;
  font-size:14.2px;
  color:rgba(247,251,255,.92);
  font-weight:800;
  line-height:1.38;
  max-width:600px;
  border-top:1px solid rgba(255,255,255,.12);
  padding-top:10px;
  white-space:pre-line;
}
.fbBtnRow{margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;}
.fbBtn{
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  border:2px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  transition:transform .12s ease, filter .12s ease;
}
.fbBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}

/* Celebration */
.celebration-overlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(2,8,23,0.72);
  z-index:9999;
  padding:18px;
}
.celebration-card{
  width:min(780px, 96%);
  background:linear-gradient(180deg, rgba(20,14,36,.95), rgba(20,14,36,.90));
  border:2px solid rgba(255,255,255,.14);
  color:var(--ink);
  border-radius:18px;
  padding:26px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.60);
}
.celebration-title{font-size:34px;font-weight:900;color:#fff;margin-bottom:8px}
.celebration-sub{color:rgba(247,251,255,.88);font-weight:900; font-size:16px; margin-bottom:12px}
.celebration-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}

/* Responsive */
@media (max-width: 1020px){
  .container{grid-template-columns:1fr; grid-template-rows:auto auto 1fr auto auto}
  .controlsPanel{grid-column:1/2; grid-row:5/6; flex-direction:row; flex-wrap:wrap; gap:10px}
  .inputRow{width:calc(50% - 5px)}
  .controlsBtns{width:100%}
  .tipBox{width:100%; margin-top:0}
  .bankStats{width:100%}
}
@media (max-width: 640px){
  .inputRow{width:100%}
  #options.mode-multiple{grid-template-columns:1fr}
}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Future forms and first conditional game">

    <div class="header">
      <div class="logo" aria-hidden="true">‚ú¶</div>
      <div>
        <h1 class="title">Future Forms + First Conditional</h1>
        <p class="lead">No answers shown before choosing ‚Ä¢ ordering less frequent ‚Ä¢ stats-only ‚Üí Google Sheets</p>
      </div>
    </div>

    <div class="topbar">
      <div class="statRow">
        <div class="stat" id="scoreBox">Score: 0</div>
        <div class="stat" id="timerBox">Time: 0s</div>
        <div class="stat" id="streakBox">Streak: 0</div>
      </div>
      <div class="playerTag">Player: <strong id="playerName">‚Äî</strong></div>
    </div>

    <div class="controlsPanel">
      <div class="inputRow">
        <label for="studentName">Name</label>
        <input id="studentName" type="text" placeholder="E.g., Laura">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Target streak</label>
        <input id="targetStreak" type="number" value="25" disabled>
        <div style="font-size:12px;color:var(--mut);margin-top:-4px">Locked to 25 ‚úÖ</div>
      </div>

      <div class="controlsBtns">
        <button id="startBtn" class="btnPrimary">START</button>
        <button id="resetBtn" class="btnSecondary">RESET</button>
      </div>

      <div class="toggles">
        <label><input id="soundToggle" type="checkbox" checked> SFX</label>
        <label><input id="musicToggle" type="checkbox" checked> Music</label>
      </div>

      <div class="tipBox">
        <b>How it works</b><br>
        ‚Ä¢ Choose the correct <b>form</b> (WILL / GOING TO / PS / PC / First conditional).<br>
        ‚Ä¢ Ordering rounds: build the sentence then press the big <b>CHECK</b> button.<br>
        ‚Ä¢ Mistakes reset streak to 0.<br>
        ‚Ä¢ Win at <b>25 correct in a row</b> (stats send automatically).
      </div>

      <div class="bankStats" id="bankStats">
        <b>Adaptive engine:</b> topics you miss appear more often.
      </div>
    </div>

    <div class="game" role="main" aria-live="polite">
      <div id="feedbackOverlay" class="fbOverlay" aria-hidden="true">
        <div class="fbCard" role="dialog" aria-modal="true" aria-label="Feedback popup">
          <div class="fbTop">
            <div class="fbIcon" id="fbIcon">‚úÖ</div>
            <h3 class="fbTitle" id="fbTitle">Nice!</h3>
          </div>
          <div class="fbSub" id="fbSub">Keep it going.</div>
          <div class="fbDetail" id="fbDetail"></div>
          <div class="fbBtnRow">
            <button class="fbBtn" id="fbCloseBtn" type="button">Close</button>
          </div>
        </div>
      </div>

      <div class="gameInner">
        <div id="card" role="region" aria-label="Prompt card">
          <div id="cardLabel">Ready</div>
          <div id="cardText">Press START to begin</div>
        </div>

        <div id="orderBox" aria-live="polite">Selected words will appear here (ordering rounds).</div>

        <div id="options" role="group" aria-label="Answer options"></div>

        <div class="progressWrap">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Goal progress: 0 / 25 (0%)</div>

        <div class="controlsRow">
          <button id="resetOrder" class="smallBtn" style="display:none">Reset order</button>
          <button id="checkOrder" class="smallBtn" style="display:none">CHECK</button>
          <button id="sendStats" class="smallBtn" style="display:none">Send Stats</button>
          <button id="downloadReport" class="smallBtn" style="display:none">CSV (stats)</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Fair: affirmative ‚Ä¢ negative ‚Ä¢ questions (per topic)</div>
      <div>Goal: <span id="targetLabel">25</span> in a row</div>
    </div>

    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-title">Perfect streak! üèÜ</div>
        <div class="celebration-sub" id="celebrationSub">You reached 25 correct answers in a row.</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnPrimary" style="width:auto;padding:12px 18px">Download CSV</button>
          <button id="celebrationRestart" class="btnSecondary" style="width:auto;padding:12px 18px">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FIX 1: audio file name -->
  <audio id="bgMusic" src="audio/koala2.mp3" preload="auto" loop></audio>

<script>
/* ==========================================================
   GOOGLE SHEETS WEB APP URL (yours)
========================================================== */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";

/* ==========================================================
   GOAL
========================================================== */
const TARGET_STREAK = 25;

/* ==========================================================
   TOPICS
========================================================== */
const TOPICS = [
  { id:"WILL",  label:"Future form ‚Äî WILL",              hint:"predictions ‚Ä¢ offers ‚Ä¢ promises", css:"choiceWILL", icon:"üü®",
    subs:["WILL_aff","WILL_neg","WILL_q"] },
  { id:"GOING", label:"Future form ‚Äî BE GOING TO",       hint:"plans ‚Ä¢ intentions",              css:"choiceGOING", icon:"üíó",
    subs:["GOING_aff","GOING_neg","GOING_q"] },
  { id:"PC",    label:"Future meaning ‚Äî PRESENT CONT.",  hint:"definite arrangements",          css:"choicePC", icon:"üü¶",
    subs:["PC_aff","PC_neg","PC_q"] },
  { id:"PS",    label:"Future meaning ‚Äî PRESENT SIMPLE", hint:"timetables ‚Ä¢ schedules",         css:"choicePS", icon:"üü©",
    subs:["PS_aff","PS_neg","PS_q"] },
  { id:"FC",    label:"First conditional",               hint:"If + present, will + base",      css:"choiceCOND", icon:"üü™",
    subs:["FC_aff","FC_neg","FC_q"] },
];

/* ==========================================================
   BANKS (same as before)
========================================================== */
const BANKS = {
  WILL_aff: [
    "I think it will be difficult to find a hotel at the last minute.",
    "Don‚Äôt worry ‚Äî I‚Äôll help you choose a national park to visit.",
    "Your best option will probably be the aquarium if it rains.",
    "I‚Äôll call the phone repair shop and ask about the price.",
    "Personally, I think the theme park will be amazing.",
    "I‚Äôll send you the address of the botanical gardens.",
    "The parade will start soon, so let‚Äôs get a good place to watch.",
    "I think the tower will look fantastic at sunset.",
    "We‚Äôll meet you at the monument after lunch.",
    "I‚Äôll buy the tickets online tonight.",
    "I‚Äôll recommend a restaurant near the wildlife reserve.",
    "I think the ancient site will be crowded tomorrow.",
    "I‚Äôll bring snacks for the trip.",
    "I‚Äôm sure the tour will be interesting.",
    "I‚Äôll text you the timetable now."
  ],
  WILL_neg: [
    "I don‚Äôt think it will be easy to park near the theme park.",
    "She won‚Äôt forget the tickets this time.",
    "We won‚Äôt be late if we leave now.",
    "It won‚Äôt be warm enough for paddleboarding today.",
    "He won‚Äôt need a guide for the museum tour.",
    "I won‚Äôt recommend that hotel ‚Äî it‚Äôs too noisy.",
    "They won‚Äôt miss the parade if they arrive early.",
    "The shop won‚Äôt be open after six.",
    "I won‚Äôt buy trainers today ‚Äî I‚Äôll wait for a discount.",
    "It won‚Äôt take long to get to the monument.",
    "We won‚Äôt go scuba diving if the sea is rough.",
    "She won‚Äôt choose canyoning ‚Äî she prefers kayaking.",
    "I won‚Äôt call now ‚Äî I‚Äôll email them later.",
    "The bus won‚Äôt arrive on time in this traffic.",
    "He won‚Äôt enjoy the trip without water."
  ],
  WILL_q: [
    "Will you recommend a good hotel around here?",
    "Will the aquarium be open today?",
    "Will you help me choose the best option?",
    "Will they buy tickets online or at the gate?",
    "Will the parade start on time?",
    "Will you call the phone repair shop for me?",
    "Will it be too windy for parasailing?",
    "Will the train be late again?",
    "Will she visit the botanical gardens tomorrow?",
    "Will we have time to see the ancient site?",
    "Will you bring snacks for the trip?",
    "Will the tower look good at night?",
    "Will he need a helmet for canyoning?",
    "Will you text me the timetable?",
    "Will they meet us at the monument?"
  ],

  GOING_aff: [
    "We‚Äôre going to explore the national park on Saturday.",
    "I‚Äôm going to book a hotel near the botanical gardens.",
    "She‚Äôs going to try canyoning for the first time.",
    "They‚Äôre going to visit the aquarium after school.",
    "I‚Äôm going to ask for recommendations at the tourist office.",
    "We‚Äôre going to go sightseeing in the old town.",
    "He‚Äôs going to buy trainers before the trek.",
    "I‚Äôm going to take photos at the ancient site.",
    "They‚Äôre going to ride horses near the wildlife reserve.",
    "We‚Äôre going to eat at a small restaurant by the tower.",
    "She‚Äôs going to learn new vocabulary for the project.",
    "I‚Äôm going to plan a route to the monument.",
    "They‚Äôre going to watch the parade from the main square.",
    "We‚Äôre going to go scuba diving if the sea is calm.",
    "I‚Äôm going to recommend the theme park to my cousins."
  ],
  GOING_neg: [
    "I‚Äôm not going to buy tickets at the gate.",
    "We aren‚Äôt going to stay in that hotel ‚Äî it‚Äôs too expensive.",
    "She isn‚Äôt going to go canyoning without a guide.",
    "They‚Äôre not going to visit the aquarium today.",
    "I‚Äôm not going to forget the timetable this time.",
    "We aren‚Äôt going to go parasailing ‚Äî it‚Äôs too windy.",
    "He isn‚Äôt going to book the tour now.",
    "I‚Äôm not going to ask for recommendations yet.",
    "They‚Äôre not going to eat at the theme park.",
    "We aren‚Äôt going to miss the parade.",
    "She isn‚Äôt going to ride horses today.",
    "I‚Äôm not going to take the bus ‚Äî I‚Äôm going to walk.",
    "They aren‚Äôt going to explore the national park in the rain.",
    "We‚Äôre not going to buy new trainers this week.",
    "He isn‚Äôt going to call the repair shop ‚Äî he‚Äôll email them."
  ],
  GOING_q: [
    "Are you going to book a hotel near the tower?",
    "Is she going to try kayaking this weekend?",
    "Are they going to visit the aquarium after lunch?",
    "Are we going to explore the national park tomorrow?",
    "Are you going to ask for recommendations?",
    "Is he going to buy trainers before the trek?",
    "Are they going to watch the parade from the bridge?",
    "Are you going to take photos at the ancient site?",
    "Is she going to ride horses near the wildlife reserve?",
    "Are we going to go sightseeing today?",
    "Are you going to plan a route to the monument?",
    "Is he going to call the phone repair shop?",
    "Are they going to eat at a restaurant around here?",
    "Are you going to recommend the theme park?",
    "Are we going to go scuba diving if it‚Äôs calm?"
  ],

  PC_aff: [
    "We‚Äôre meeting at the station at 8:00.",
    "I‚Äôm having lunch with my friend after the museum visit.",
    "She‚Äôs flying to Madrid tomorrow morning.",
    "They‚Äôre visiting the theme park this afternoon.",
    "I‚Äôm talking to a guide about the ancient site later.",
    "We‚Äôre staying in a hotel near the tower tonight.",
    "He‚Äôs going kayaking with his class on Friday.",
    "I‚Äôm taking my brother to the aquarium on Saturday.",
    "They‚Äôre going mountain biking after school.",
    "We‚Äôre going to the botanical gardens at 5:30.",
    "I‚Äôm seeing the teacher after class to ask a question.",
    "She‚Äôs meeting us at the monument entrance.",
    "They‚Äôre having a picnic in the national park tomorrow.",
    "We‚Äôre watching the parade from the bridge this evening.",
    "I‚Äôm calling you later to confirm the plan."
  ],
  PC_neg: [
    "We aren‚Äôt meeting at the station ‚Äî we‚Äôre meeting at the monument.",
    "I‚Äôm not having lunch out today.",
    "She isn‚Äôt flying tomorrow morning.",
    "They aren‚Äôt visiting the aquarium this afternoon.",
    "I‚Äôm not talking to the guide right now.",
    "We aren‚Äôt staying in that hotel tonight.",
    "He isn‚Äôt going kayaking on Friday.",
    "I‚Äôm not taking my brother to the theme park.",
    "They aren‚Äôt going mountain biking after school.",
    "We aren‚Äôt going to the botanical gardens today.",
    "I‚Äôm not seeing the teacher after class.",
    "She isn‚Äôt meeting us at the tower.",
    "They aren‚Äôt having a picnic tomorrow.",
    "We aren‚Äôt watching the parade from the bridge.",
    "I‚Äôm not calling you later ‚Äî I‚Äôll text you."
  ],
  PC_q: [
    "Are we meeting at the station at 8:00?",
    "Are you having lunch after the museum visit?",
    "Is she flying tomorrow morning?",
    "Are they visiting the theme park this afternoon?",
    "Are you talking to a guide later?",
    "Are we staying in a hotel near the tower tonight?",
    "Is he going kayaking on Friday?",
    "Are you taking your brother to the aquarium on Saturday?",
    "Are they going mountain biking after school?",
    "Are we going to the botanical gardens at 5:30?",
    "Are you seeing the teacher after class?",
    "Is she meeting us at the monument entrance?",
    "Are they having a picnic in the national park tomorrow?",
    "Are we watching the parade this evening?",
    "Are you calling me later to confirm the plan?"
  ],

  PS_aff: [
    "The train leaves at 3 p.m.",
    "The tour starts at 10:15.",
    "The aquarium opens at nine.",
    "The national park closes at six.",
    "The museum bus arrives every thirty minutes.",
    "The parade begins at noon.",
    "The ticket office shuts at 5:45.",
    "The boat departs from the harbour at 8:30.",
    "The theme park opens at 10:00 on weekends.",
    "The guided walk finishes at 2:00.",
    "The flight lands at 7:20.",
    "The lesson starts at 8:05.",
    "The coach stops near the monument at 11:10.",
    "The ferry leaves every hour.",
    "The show ends at 9:00."
  ],
  PS_neg: [
    "The train doesn‚Äôt leave at 2 p.m. ‚Äî it leaves at 3 p.m.",
    "The tour doesn‚Äôt start at ten ‚Äî it starts at 10:15.",
    "The aquarium doesn‚Äôt open at eight.",
    "The national park doesn‚Äôt close at five.",
    "The museum bus doesn‚Äôt arrive every ten minutes.",
    "The parade doesn‚Äôt begin at one o‚Äôclock.",
    "The ticket office doesn‚Äôt shut at six.",
    "The boat doesn‚Äôt depart at 9:30.",
    "The theme park doesn‚Äôt open at 9:00 on weekends.",
    "The guided walk doesn‚Äôt finish at 1:00.",
    "The flight doesn‚Äôt land at 6:20.",
    "The lesson doesn‚Äôt start at 9:05.",
    "The coach doesn‚Äôt stop at the tower first.",
    "The ferry doesn‚Äôt leave every two hours.",
    "The show doesn‚Äôt end at 8:00."
  ],
  PS_q: [
    "Does the train leave at 3 p.m.?",
    "Does the tour start at 10:15?",
    "Does the aquarium open at nine?",
    "Does the national park close at six?",
    "Does the museum bus arrive every thirty minutes?",
    "Does the parade begin at noon?",
    "Does the ticket office shut at 5:45?",
    "Does the boat depart at 8:30?",
    "Does the theme park open at 10:00 on weekends?",
    "Does the guided walk finish at 2:00?",
    "Does the flight land at 7:20?",
    "Does the lesson start at 8:05?",
    "Does the coach stop near the monument at 11:10?",
    "Does the ferry leave every hour?",
    "Does the show end at 9:00?"
  ],

  FC_aff: [
    "If the traffic is bad, we‚Äôll miss our flight.",
    "If it rains, we‚Äôll go to the aquarium instead.",
    "If you ask politely, they‚Äôll recommend a good hotel.",
    "If we leave early, we‚Äôll reach the national park before lunch.",
    "If you don‚Äôt book now, the theme park tickets will sell out.",
    "If the sea is calm, we‚Äôll go scuba diving.",
    "If you try canyoning, you‚Äôll need a helmet.",
    "If you get lost, I‚Äôll send you the location.",
    "If the parade starts late, we‚Äôll wait near the tower.",
    "If you want advice, I‚Äôll recommend the botanical gardens.",
    "If she finishes her homework, she‚Äôll come sightseeing with us.",
    "If the bus arrives late, we‚Äôll take a taxi to the monument.",
    "If you practice the key phrases, you‚Äôll sound more confident.",
    "If you pack water, you‚Äôll feel better on the trek.",
    "If we have time, we‚Äôll visit the ancient site."
  ],
  FC_neg: [
    "If the traffic is bad, we won‚Äôt catch the train.",
    "If it rains, we won‚Äôt go paddleboarding.",
    "If you don‚Äôt ask, they won‚Äôt give you recommendations.",
    "If we leave late, we won‚Äôt reach the national park before lunch.",
    "If you don‚Äôt book now, you won‚Äôt get a room in that hotel.",
    "If the sea is rough, we won‚Äôt go scuba diving.",
    "If you don‚Äôt wear a helmet, you won‚Äôt go canyoning.",
    "If you get lost, don‚Äôt worry ‚Äî I won‚Äôt stop helping you.",
    "If the parade starts late, we won‚Äôt panic.",
    "If you don‚Äôt check the timetable, you won‚Äôt know the time.",
    "If she doesn‚Äôt finish her homework, she won‚Äôt come with us.",
    "If the bus doesn‚Äôt arrive, we won‚Äôt wait forever.",
    "If you don‚Äôt practice the phrases, you won‚Äôt sound confident.",
    "If you don‚Äôt drink water, you won‚Äôt feel well on the trek.",
    "If we don‚Äôt have time, we won‚Äôt visit the ancient site."
  ],
  FC_q: [
    "What will you do if the traffic is bad?",
    "Where will we go if it rains?",
    "Will you recommend a good hotel if I ask politely?",
    "What will happen if we leave late?",
    "Will the tickets sell out if we don‚Äôt book now?",
    "Will we go scuba diving if the sea is calm?",
    "What will you need if you try canyoning?",
    "Will you send me the location if I get lost?",
    "What will we do if the parade starts late?",
    "Will you recommend the botanical gardens if I want advice?",
    "Will she come sightseeing if she finishes her homework?",
    "What will we do if the bus doesn‚Äôt arrive?",
    "Will you sound more confident if you practice the key phrases?",
    "Will you feel better if you drink water?",
    "Will we visit the ancient site if we have time?"
  ],
};

/* ==========================================================
   STATE
========================================================== */
const el = (id)=>document.getElementById(id);

const state = {
  running:false,
  streak:0,
  bestStreak:0,
  score:0,
  seconds:0,
  timer:null,

  stats: Object.fromEntries(TOPICS.map(t => [t.id, {attempts:0, correct:0, wrong:0, recentWrong:0}])),
  remediation: { topicId:null, remaining:0 },
  lastTopicId:null,

  fairPtr: Object.fromEntries(TOPICS.map(t => [t.id, 0])),

  round:null,
  orderSelected:[],

  sentStats:false,
  gameId: (crypto?.randomUUID?.() || String(Date.now())),

  recentBySub: Object.fromEntries(TOPICS.flatMap(t => t.subs.map(s => [s, []]))),
};

const RECENT_LIMIT = 8;
const REROLL_TRIES = 12;

const bgMusic = el("bgMusic");

/* ==========================================================
   UTIL
========================================================== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function normalizeSentence(s){ return String(s).trim().replace(/\s+/g," "); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function blip(ok){
  if(!el("soundToggle").checked) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = "square";
    o.frequency.value = ok ? 740 : 220;
    g.gain.value = 0.05;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ok ? 95 : 150);
  }catch(e){}
}

/* ==========================================================
   UI
========================================================== */
function updateHeader(){
  el("scoreBox").textContent = `Score: ${state.score}`;
  el("timerBox").textContent = `Time: ${state.seconds}s`;
  el("streakBox").textContent = `Streak: ${state.streak}`;
  el("targetLabel").textContent = TARGET_STREAK;
}
function updateProgress(){
  const pct = Math.max(0, Math.min(100, Math.round((state.streak / TARGET_STREAK) * 100)));
  el("progressBar").style.width = `${pct}%`;
  el("progressLabel").textContent = `Goal progress: ${state.streak} / ${TARGET_STREAK} (${pct}%)`;
  if(state.running && state.streak > 0 && state.streak < TARGET_STREAK) el("progressBar").classList.add("moving");
  else el("progressBar").classList.remove("moving");
}
function updateBankStats(){
  const arr = TOPICS.map(t=>{
    const s = state.stats[t.id];
    const acc = s.attempts ? (s.correct / s.attempts) : 1;
    const weightHint = (s.recentWrong*2) + (s.wrong) + (1-acc)*3;
    return { id:t.id, label:t.label, wrong:s.wrong, recentWrong:s.recentWrong, acc, weightHint };
  }).sort((a,b)=> b.weightHint - a.weightHint);

  const top = arr.slice(0,2).map(x=>{
    const a = Math.round(x.acc*100);
    return `‚Ä¢ <b>${escapeHtml(x.label)}</b> ‚Äî acc ${a}% (wrong ${x.wrong}, recent ${x.recentWrong})`;
  }).join("<br>");

  el("bankStats").innerHTML =
    `<b>Adaptive engine:</b><br>${top}<br><span style="color:rgba(247,251,255,.72)">Mistakes make that topic appear more often.</span>`;
}
function setCard(label, text){
  el("cardLabel").textContent = label;
  el("cardText").textContent = text;
}

/* ==========================================================
   NO-REPEAT sentence picker (per subbank)
========================================================== */
function pickSentenceNoRepeat(subKey){
  const bank = BANKS[subKey];
  const recent = state.recentBySub[subKey] || [];

  let chosen = bank[Math.floor(Math.random()*bank.length)];
  for(let t=0; t<REROLL_TRIES; t++){
    const candidate = bank[Math.floor(Math.random()*bank.length)];
    if(!recent.includes(candidate)){
      chosen = candidate; break;
    }
    chosen = candidate;
  }

  recent.push(chosen);
  while(recent.length > RECENT_LIMIT) recent.shift();
  state.recentBySub[subKey] = recent;
  return chosen;
}

/* ==========================================================
   ADAPTIVE TOPIC picker
========================================================== */
function pickTopicId(){
  if(state.remediation.remaining > 0 && state.remediation.topicId){
    state.remediation.remaining--;
    return state.remediation.topicId;
  }

  const weights = TOPICS.map(t=>{
    const st = state.stats[t.id];
    const acc = st.attempts ? (st.correct / st.attempts) : 0.75;
    let w = 1.0;
    w += st.wrong * 0.35;
    w += st.recentWrong * 0.75;
    w += (1 - acc) * 2.2;
    if(st.attempts === 0) w += 1.2;
    if(state.lastTopicId === t.id) w *= 0.65;
    return { id:t.id, w };
  });

  const sum = weights.reduce((a,x)=>a+x.w,0);
  let r = Math.random() * sum;
  for(const x of weights){
    r -= x.w;
    if(r <= 0) return x.id;
  }
  return weights[weights.length-1].id;
}

/* FAIR subbank selection: rotates aff -> neg -> q */
function pickSubKeyFair(topicId){
  const topic = TOPICS.find(t=>t.id===topicId);
  const idx = state.fairPtr[topicId] || 0;
  const subKey = topic.subs[idx % topic.subs.length];
  state.fairPtr[topicId] = (idx + 1) % topic.subs.length;
  return subKey;
}

/* ==========================================================
   Round builder (ordering freq: <12=0.20, >=12=0.30)
========================================================== */
function makeRound(){
  const topicId = pickTopicId();
  const subKey = pickSubKeyFair(topicId);
  const sentence = pickSentenceNoRepeat(subKey);

  const orderChance = state.streak >= 12 ? 0.30 : 0.20;
  const mode = Math.random() < orderChance ? "order" : "multiple";

  state.lastTopicId = topicId;

  if(mode === "multiple"){
    return { mode, topicId, subKey, sentence, correctKey: topicId };
  }

  const targetWords = normalizeSentence(sentence).split(" ");
  const orderWords = shuffle(targetWords);
  return { mode:"order", topicId, subKey, sentence, targetWords, orderWords };
}

/* ==========================================================
   Render
========================================================== */
function clearOptions(){
  el("options").className = "";
  el("options").innerHTML = "";
}

function renderSelectedChips(){
  const box = el("orderBox");
  box.innerHTML = "";
  if(state.orderSelected.length === 0){
    box.textContent = "Tap words to build the sentence.";
    return;
  }
  state.orderSelected.forEach((it, i)=>{
    const chip = document.createElement("span");
    chip.className = "selChip";
    chip.textContent = it.word;
    chip.title = "Click to remove";
    chip.onclick = ()=> removeSelectedAt(i);
    box.appendChild(chip);
  });
}

function removeSelectedAt(i){
  if(!state.running) return;
  const removed = state.orderSelected.splice(i,1)[0];
  el("options").querySelectorAll(".orderWord").forEach(b=>{
    if(b.dataset.idx === String(removed.idx)){
      b.disabled = false;
      b.classList.remove("chosen");
    }
  });
  renderSelectedChips();
}

function pickWord(idx, word, btn){
  if(!state.running) return;
  btn.disabled = true;
  btn.classList.add("chosen");
  state.orderSelected.push({ idx, word });
  renderSelectedChips();
}

function resetOrder(){
  if(!state.running) return;
  state.orderSelected = [];
  el("options").querySelectorAll(".orderWord").forEach(b=>{
    b.disabled = false;
    b.classList.remove("chosen");
  });
  renderSelectedChips();
}

/* build 4-option MC (correct + 3 distractors) */
function buildChoices(correctTopicId){
  const others = TOPICS.map(t=>t.id).filter(id=>id !== correctTopicId);
  const distractors = shuffle(others).slice(0,3);
  return shuffle([correctTopicId, ...distractors]);
}

function renderRound(){
  clearOptions();
  state.orderSelected = [];
  updateBankStats();

  // FIX 2: DO NOT reveal the correct topic before the student answers.
  // Use a neutral label + prompt.
  setCard("Choose the correct form", state.round.sentence);

  if(state.round.mode === "multiple"){
    el("orderBox").textContent = "Ordering box is used only for ordering rounds.";
    el("resetOrder").style.display = "none";
    el("checkOrder").style.display = "none";
    el("checkOrder").classList.remove("checkAttention");

    el("options").classList.add("mode-multiple");

    const keys = buildChoices(state.round.correctKey);
    keys.forEach(id=>{
      const t = TOPICS.find(x=>x.id===id);
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = `choiceCard ${t.css}`;
      btn.innerHTML = `
        <div class="choiceIcon">${escapeHtml(t.icon)}</div>
        <div class="choiceText">${escapeHtml(t.label.replace("Future form ‚Äî ","").replace("Future meaning ‚Äî ",""))}
          <small>${escapeHtml(t.hint)}</small>
        </div>
      `;
      btn.onclick = ()=> submitMultiple(id);
      el("options").appendChild(btn);
    });

    return;
  }

  /* ORDERING mode (still neutral label; sentence not shown as "answer") */
  setCard("Ordering round", "Build the sentence from the scrambled words below.");
  el("orderBox").textContent = "Tap words to build the sentence. Tap a chip to remove it.";

  el("resetOrder").style.display = "inline-flex";
  el("checkOrder").style.display = "inline-flex";
  el("checkOrder").classList.add("checkAttention");

  el("options").classList.add("mode-order");

  state.round.orderWords.forEach((w, idx)=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "orderWord";
    b.textContent = w;
    b.dataset.idx = String(idx);
    b.onclick = ()=> pickWord(idx, w, b);
    el("options").appendChild(b);
  });

  renderSelectedChips();
}

/* ==========================================================
   Submit / Check
========================================================== */
function submitMultiple(choiceTopicId){
  if(!state.running) return;
  const ok = (choiceTopicId === state.round.correctKey);

  const chosen = TOPICS.find(x=>x.id===choiceTopicId);
  const correct = TOPICS.find(x=>x.id===state.round.correctKey);

  gradeRound(ok, {
    chosen: chosen ? chosen.label : choiceTopicId,
    correct: correct ? correct.label : state.round.correctKey
  });
}

function checkOrder(){
  if(!state.running) return;
  const built = normalizeSentence(state.orderSelected.map(x=>x.word).join(" "));
  const correct = normalizeSentence(state.round.targetWords.join(" "));
  gradeRound(built === correct, { built, correct });
}

/* ==========================================================
   Feedback (auto-next always; no Next button)
========================================================== */
function showFeedback(ok, detail, isWin){
  const overlay = el("feedbackOverlay");
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");

  el("fbIcon").textContent = ok ? "‚úÖ" : "‚ùå";
  el("fbTitle").textContent = ok ? (isWin ? "Streak complete!" : "Correct!") : "Not yet";
  el("fbSub").textContent = ok
    ? (isWin ? `You reached ${TARGET_STREAK} correct answers in a row!` : `Streak: ${state.streak} / ${TARGET_STREAK}`)
    : `Streak reset to 0. We‚Äôll practice this topic again.`;

  // Reveal the correct topic ONLY here (after answering).
  let d = "";
  if(state.round.mode === "multiple"){
    d = ok
      ? `Correct form: ${detail.correct}`
      : `You chose: ${detail.chosen}\nCorrect: ${detail.correct}`;
  } else {
    d = ok
      ? `Nice ordering!`
      : `Your order: ‚Äú${detail.built || "(empty)"}‚Äù\nCorrect: ‚Äú${detail.correct}‚Äù`;
  }
  el("fbDetail").textContent = d;
}

function hideFeedback(){
  const overlay = el("feedbackOverlay");
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden","true");
}

function afterFeedbackAutoNext(isWin){
  if(isWin) return;
  setTimeout(()=>{
    hideFeedback();
    nextRound();
  }, 650);
}

/* ==========================================================
   Grade
========================================================== */
function gradeRound(ok, detail){
  const st = state.stats[state.round.topicId];
  st.attempts++;

  if(ok){
    st.correct++;
    st.recentWrong = Math.max(0, st.recentWrong - 1);

    state.score++;
    state.streak++;
    state.bestStreak = Math.max(state.bestStreak, state.streak);

    blip(true);

    updateHeader(); updateProgress();

    if(state.streak >= TARGET_STREAK){
      showFeedback(true, detail, true);
      winGame();
      return;
    }

    showFeedback(true, detail, false);
    afterFeedbackAutoNext(false);
    return;
  }

  st.wrong++;
  st.recentWrong++;

  state.remediation.topicId = state.round.topicId;
  state.remediation.remaining = 2;

  state.streak = 0;
  blip(false);

  updateHeader(); updateProgress();

  showFeedback(false, detail, false);
  afterFeedbackAutoNext(false);
}

/* ==========================================================
   Flow
========================================================== */
function lockRoundControls(lock){
  el("options").querySelectorAll("button").forEach(b=> b.disabled = !!lock);
  el("resetOrder").disabled = !!lock;
  el("checkOrder").disabled = !!lock;
}

function nextRound(){
  if(!state.running) return;
  hideFeedback();
  state.round = makeRound();
  renderRound();
  lockRoundControls(false);
}

function startGame(){
  state.running = true;
  state.streak = 0;
  state.bestStreak = 0;
  state.score = 0;
  state.seconds = 0;
  state.remediation = { topicId:null, remaining:0 };
  state.lastTopicId = null;

  state.sentStats = false;
  state.gameId = (crypto?.randomUUID?.() || String(Date.now()));

  state.stats = Object.fromEntries(TOPICS.map(t => [t.id, {attempts:0, correct:0, wrong:0, recentWrong:0}]));
  state.fairPtr = Object.fromEntries(TOPICS.map(t => [t.id, 0]));
  state.recentBySub = Object.fromEntries(TOPICS.flatMap(t => t.subs.map(s => [s, []])));

  el("playerName").textContent = (el("studentName").value || "‚Äî").trim() || "‚Äî";

  updateHeader();
  updateProgress();
  updateBankStats();

  if(state.timer) clearInterval(state.timer);
  state.timer = setInterval(()=>{
    if(!state.running) return;
    state.seconds++;
    updateHeader();
  }, 1000);

  try{
    if(el("musicToggle").checked){
      bgMusic.volume = 0.6;
      bgMusic.currentTime = 0;
      bgMusic.play().catch(()=>{});
    }
  }catch(e){}

  el("sendStats").style.display = "inline-flex";
  el("downloadReport").style.display = "inline-flex";

  nextRound();
}

function resetGame(){
  state.running = false;
  if(state.timer) clearInterval(state.timer);
  state.timer = null;

  try{ bgMusic.pause(); bgMusic.currentTime = 0; }catch(e){}

  hideFeedback();
  closeCelebration();

  state.streak = 0;
  state.bestStreak = 0;
  state.score = 0;
  state.seconds = 0;
  state.round = null;
  state.orderSelected = [];

  updateHeader();
  updateProgress();

  setCard("Ready", "Press START to begin");
  el("orderBox").textContent = "Selected words will appear here (ordering rounds).";
  clearOptions();

  el("resetOrder").style.display = "none";
  el("checkOrder").style.display = "none";
  el("checkOrder").classList.remove("checkAttention");

  el("sendStats").style.display = "none";
  el("downloadReport").style.display = "none";
}

function winGame(){
  state.running = false;
  if(state.timer) clearInterval(state.timer);
  state.timer = null;

  try{ bgMusic.pause(); bgMusic.currentTime = 0; }catch(e){}

  lockRoundControls(true);

  const c = el("celebration");
  c.style.display = "flex";
  c.setAttribute("aria-hidden","false");
  el("celebrationSub").textContent = `Amazing! You got ${TARGET_STREAK} correct answers in a row.`;

  state.streak = TARGET_STREAK;
  updateHeader();
  updateProgress();

  if(!state.sentStats){
    state.sentStats = true;
    sendStatsToGoogleSheets();
  }
}

function closeCelebration(){
  const c = el("celebration");
  c.style.display = "none";
  c.setAttribute("aria-hidden","true");
}

/* ==========================================================
   Stats-only to Google Sheets
========================================================== */
function topicPracticeText(topicId){
  const map = {
    WILL: "Practice WILL: predictions/offers. Patterns: I‚Äôll‚Ä¶, It will‚Ä¶, Will you‚Ä¶?",
    GOING: "Practice GOING TO: plans/intentions. Patterns: I‚Äôm going to‚Ä¶, Are you going to‚Ä¶?",
    PC: "Practice PRESENT CONTINUOUS (future arrangements). Patterns: We‚Äôre meeting‚Ä¶, Are you meeting‚Ä¶?",
    PS: "Practice PRESENT SIMPLE (timetables). Patterns: The train leaves‚Ä¶, Does it leave‚Ä¶?",
    FC: "Practice FIRST CONDITIONAL. Patterns: If + present, will + base. Questions: What will you do if‚Ä¶?"
  };
  return map[topicId] || "Practice this topic with more examples (aff/neg/questions).";
}

function computePriorityScore(s){
  const attempts = s.attempts || 0;
  const acc = attempts ? (s.correct / attempts) : 0;
  return (s.wrong * 2) + (s.recentWrong * 3) + ((1 - acc) * 10);
}

function buildStatsPayload(){
  const student = (el("studentName").value || "‚Äî").trim() || "‚Äî";

  const topicRows = TOPICS.map(t=>{
    const s = state.stats[t.id];
    const attempts = s.attempts || 0;
    const correct = s.correct || 0;
    const wrong = s.wrong || 0;
    const acc = attempts ? (correct / attempts) : 0;
    const pr = computePriorityScore(s);

    return {
      topic: t.id,
      attempts,
      correct,
      wrong,
      accuracy: acc,
      recentWrong: s.recentWrong || 0,
      priorityScore: Math.round(pr * 100) / 100,
      suggestedPractice: topicPracticeText(t.id)
    };
  }).sort((a,b)=> b.priorityScore - a.priorityScore);

  const totalAttempts = topicRows.reduce((a,x)=>a + x.attempts, 0);
  const totalCorrect  = topicRows.reduce((a,x)=>a + x.correct, 0);
  const totalWrong    = topicRows.reduce((a,x)=>a + x.wrong, 0);
  const accuracy = totalAttempts ? (totalCorrect / totalAttempts) : 0;

  const top1 = topicRows[0]?.topic || "";
  const top2 = topicRows[1]?.topic || "";

  return {
    student,
    gameId: state.gameId,
    summary: {
      seconds: state.seconds,
      attempts: totalAttempts,
      correct: totalCorrect,
      wrong: totalWrong,
      accuracy,
      bestStreak: state.bestStreak || 0,
      topWeak1: top1,
      topWeak2: top2,
      rec1: topicPracticeText(top1),
      rec2: topicPracticeText(top2)
    },
    topics: topicRows
  };
}

async function sendStatsToGoogleSheets(){
  if(!SHEETS_WEBAPP_URL){
    alert("Missing Google Sheets Web App URL.");
    return false;
  }

  const payload = buildStatsPayload();

  try{
    const res = await fetch(SHEETS_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const txt = await res.text();
    let data = null;
    try{ data = JSON.parse(txt); }catch(e){}

    if(!res.ok || !data || data.ok !== true){
      console.error("Sheets error:", txt);
      alert("Could not send stats to Google Sheets. Check Apps Script deployment access.");
      return false;
    }
    return true;
  }catch(err){
    console.error(err);
    alert("Network error sending to Google Sheets.");
    return false;
  }
}

/* ==========================================================
   CSV (stats only)
========================================================== */
function safeCsv(v){
  const s = String(v ?? "").replaceAll('"','""');
  return `"${s}"`;
}

function downloadStatsCSV(){
  const payload = buildStatsPayload();
  const lines = [];

  lines.push(["SECTION","student","seconds","attempts","correct","wrong","accuracy","bestStreak","topWeak1","topWeak2"].join(","));
  lines.push([
    "SUMMARY",
    safeCsv(payload.student),
    payload.summary.seconds,
    payload.summary.attempts,
    payload.summary.correct,
    payload.summary.wrong,
    payload.summary.accuracy,
    payload.summary.bestStreak,
    safeCsv(payload.summary.topWeak1),
    safeCsv(payload.summary.topWeak2),
  ].join(","));
  lines.push("");

  lines.push(["SECTION","topic","attempts","correct","wrong","accuracy","recentWrong","priorityScore","suggestedPractice"].join(","));
  payload.topics.forEach(t=>{
    lines.push([
      "TOPIC",
      safeCsv(t.topic),
      t.attempts,
      t.correct,
      t.wrong,
      t.accuracy,
      t.recentWrong,
      t.priorityScore,
      safeCsv(t.suggestedPractice)
    ].join(","));
  });

  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  const name = (payload.student || "student").replace(/[^\w\-]+/g,"_");
  a.download = `future_forms_stats_${name}_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ==========================================================
   Wiring
========================================================== */
el("startBtn").addEventListener("click", ()=>{
  if(state.running) return;
  startGame();
});
el("resetBtn").addEventListener("click", resetGame);

el("resetOrder").addEventListener("click", resetOrder);
el("checkOrder").addEventListener("click", checkOrder);

el("fbCloseBtn").addEventListener("click", hideFeedback);

el("sendStats").addEventListener("click", async ()=>{
  if(state.sentStats) return;
  const ok = await sendStatsToGoogleSheets();
  if(ok) state.sentStats = true;
});

el("downloadReport").addEventListener("click", downloadStatsCSV);
el("celebrationDownload").addEventListener("click", downloadStatsCSV);
el("celebrationRestart").addEventListener("click", ()=>{
  closeCelebration();
  resetGame();
  startGame();
});

el("studentName").addEventListener("input", ()=>{
  el("playerName").textContent = (el("studentName").value || "‚Äî").trim() || "‚Äî";
});

el("musicToggle").addEventListener("change", ()=>{
  if(!el("musicToggle").checked){
    try{ bgMusic.pause(); bgMusic.currentTime = 0; }catch(e){}
  }else{
    if(state.running){
      try{ bgMusic.volume = 0.6; bgMusic.play().catch(()=>{}); }catch(e){}
    }
  }
});

/* init */
updateHeader();
updateProgress();
updateBankStats();
</script>
</body>
</html>





