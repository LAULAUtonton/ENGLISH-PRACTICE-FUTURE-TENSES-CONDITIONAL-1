<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Future Grammar Mastery</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0099cc;
      --card:#515151;
      --panel:#004b63;
      --ink:#ffffff;

      --cyan:#00ffff;
      --yellow:#ffb703;
      --red:#d00000;
      --purple:#c77dff;
      --green:#00ff99;

      --bar:#002b36;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    .app{ max-width:980px; margin:0 auto; padding:16px; }

    header{ text-align:center; margin-bottom:12px; }
    h1{
      margin:0;
      font-size:2rem;
      font-weight:900;
      text-shadow:0 0 10px rgba(0,0,0,.35);
    }
    header p{
      margin:6px 0 10px;
      font-weight:800;
      opacity:.95;
    }

    .top-row{
      display:flex;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }

    .name-box{
      background:var(--panel);
      padding:8px 10px;
      border-radius:14px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow:0 0 10px rgba(0,0,0,.22);
    }
    .name-box span{ font-weight:900; }
    .name-box input{
      border:none;
      outline:none;
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      font-weight:900;
      min-width:170px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
    }

    .btn{
      border:none;
      border-radius:16px;
      padding:12px 18px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      box-shadow:0 0 14px rgba(0,0,0,.25);
      transition:transform .12s ease, filter .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.06); }

    .btn.cyan{ background:var(--cyan); color:#001018; }
    .btn.purple{ background:var(--purple); color:#120018; }
    .btn.red{ background:var(--red); color:#fff; }
    .btn.yellow{ background:var(--yellow); color:#2b1500; }

    .warning{
      margin-top:8px;
      min-height:18px;
      font-weight:900;
      color:#ffe3e3;
    }
    .audioStatus{
      margin-top:4px;
      min-height:18px;
      font-weight:900;
      color:#e8ffff;
      opacity:.95;
    }

    /* Minimal stats */
    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
      justify-content:center;
      margin:12px 0 14px;
    }
    .stat{
      background:var(--panel);
      border-radius:14px;
      padding:10px 12px;
      min-width:140px;
      text-align:center;
      box-shadow:0 0 10px rgba(0,0,0,.22);
    }
    .stat .label{ font-size:.8rem; font-weight:900; opacity:.9; }
    .stat .value{ font-size:1.05rem; font-weight:900; margin-top:2px; }

    .progressWrap{
      flex:1;
      min-width:240px;
      background:var(--panel);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 0 10px rgba(0,0,0,.22);
    }
    .progressWrap .label{
      text-align:left;
      font-size:.8rem;
      font-weight:900;
      opacity:.92;
    }
    .bar{
      margin-top:8px;
      height:22px;
      background:var(--bar);
      border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(0,255,255,.65);
    }
    .fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--green), var(--cyan));
      transition:width .25s ease;
    }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:18px;
      box-shadow:0 0 14px rgba(0,0,0,.35);
    }

    .prompt{
      text-align:center;
      font-weight:900;
      font-size:1.12rem;
      margin:0 0 10px;
    }

    .activityTag{
      display:inline-block;
      margin:0 auto 12px;
      padding:6px 12px;
      border-radius:999px;
      font-weight:900;
      background:rgba(0,0,0,.22);
      border:2px solid rgba(255,255,255,.16);
      box-shadow:0 0 10px rgba(0,0,0,.18);
    }
    .tagWrap{ text-align:center; }

    .interaction{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      min-height:52px;
      padding-bottom:10px;
      border-bottom:2px solid rgba(0,255,255,.32);
      margin-bottom:12px;
    }

    /* ORDER word bank */
    .word-bank{
      background:#1f1f1f;
      padding:14px;
      border-radius:16px;
      min-height:58px;
      box-shadow:0 3px 10px rgba(0,0,0,.25);
    }
    .wordItem{
      display:inline-block;
      background:#ffffff;
      color:#000;
      border:2px solid #3b3b3b;
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      margin:0 10px 10px 0;
      box-shadow:0 2px 6px rgba(0,0,0,.22);
      user-select:none;
    }
    .builtWord{
      background:#111;
      color:#fff;
      border:2px solid rgba(255,255,255,.14);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      user-select:none;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }

    /* Cards area (NEXT WORD + INTENT) */
    .cards{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:680px){
      .cards{ grid-template-columns:1fr; }
      h1{ font-size:1.7rem; }
    }

    .cardBtn{
      border:none;
      border-radius:18px;
      padding:16px 16px;
      cursor:pointer;
      font-weight:900;
      font-size:1.08rem;
      color:#0b0b0b;
      box-shadow:0 0 16px rgba(0,0,0,.28);
      border:3px solid rgba(255,255,255,.22);
      text-align:left;
      transition:transform .12s ease, filter .12s ease;
      min-height:76px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .cardBtn:hover{ transform:translateY(-1px); filter:brightness(1.05); }

    .cardTitle{ font-size:1.08rem; font-weight:900; }
    .cardDesc{ font-size:.9rem; font-weight:800; opacity:.92; }

    /* Vibrant classes */
    .c-prediction{ background:linear-gradient(135deg,#00ffff,#00ff99); }
    .c-offer{ background:linear-gradient(135deg,#ffb703,#ffd166); }
    .c-decision{ background:linear-gradient(135deg,#c77dff,#ff4dff); color:#140018; }
    .c-announce{ background:linear-gradient(135deg,#ffffff,#b9f6ff); }

    .c-plan{ background:linear-gradient(135deg,#00ff99,#00ffff); }
    .c-evidence{ background:linear-gradient(135deg,#ff4d6d,#ffb703); color:#180007; }

    .c-arrange{ background:linear-gradient(135deg,#8aff00,#00ffff); }

    .c-schedule{ background:linear-gradient(135deg,#ffffff,#00ffff); }

    .c-warning{ background:linear-gradient(135deg,#ff0033,#ffb703); color:#1a0006; }
    .c-advice{ background:linear-gradient(135deg,#00ffff,#c77dff); }
    .c-plancond{ background:linear-gradient(135deg,#00ff99,#8aff00); }
    .c-predres{ background:linear-gradient(135deg,#ffd166,#ff4dff); }

    .feedback{
      margin-top:12px;
      min-height:26px;
      text-align:center;
      font-weight:900;
      font-size:1.05rem;
    }
    .ok{ color:#a8ffd0; }
    .no{ color:#ffd1d1; }

    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <!-- Background music -->
  <audio id="bgm" loop preload="auto">
    <source src="audio/koala2.mp3" type="audio/mpeg">
  </audio>

  <!-- Optional win sound -->
  <audio id="winSound" preload="auto">
    <source src="tadaa.mp3" type="audio/mpeg">
  </audio>

  <div class="app">
    <header>
      <h1>Future Grammar Mastery</h1>
      <p>ORDER â€¢ NEXT WORD â€¢ INTENT (mixed)</p>

      <div class="top-row">
        <div class="name-box">
          <span>Name:</span>
          <input id="playerName" type="text" placeholder="Enter your name">
        </div>

        <div class="controls">
          <button class="btn cyan" onclick="startGame()">Start</button>
          <button class="btn purple" id="musicBtn" onclick="toggleMusic()">Music: OFF</button>
          <button class="btn red" onclick="resetGame()">Reset</button>
        </div>
      </div>

      <div class="warning" id="nameWarning"></div>
      <div class="audioStatus" id="audioStatus"></div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="label">Player</div>
        <div class="value" id="displayName">---</div>
      </div>

      <div class="stat">
        <div class="label">Streak</div>
        <div class="value"><span id="streak">0</span> / 25</div>
      </div>

      <div class="progressWrap">
        <div class="label">Progress</div>
        <div class="bar"><div class="fill" id="progressFill"></div></div>
      </div>

      <div class="stat">
        <div class="label">Time</div>
        <div class="value" id="timerDisplay">00:00</div>
      </div>
    </div>

    <div class="card">
      <p class="prompt" id="prompt">Enter your name and click Start</p>
      <div class="tagWrap"><span class="activityTag" id="activityTag">Activity: ---</span></div>

      <div class="interaction" id="interaction"></div>

      <!-- Cards area (NEXT WORD / INTENT) -->
      <div id="cardsArea" class="cards hidden"></div>

      <!-- Word bank (ORDER) -->
      <div class="word-bank hidden" id="wordBank"></div>

      <div class="feedback" id="feedback"></div>

      <!-- Actions only for ORDER -->
      <div class="actions hidden" id="orderActions">
        <button class="btn red" onclick="clearWords()">Clear</button>
        <button class="btn yellow" onclick="checkOrder()">Check</button>
      </div>
    </div>
  </div>

<script>
/* -----------------------------------------------------------
   DATA â€” Sentences (ORDER + NEXT WORD) keep working pool
----------------------------------------------------------- */
const sentences = [
  "The train leaves at 8 a.m. tomorrow.","School starts at 9 o'clock on Monday.","The plane lands at 3:15 p.m.","The football match kicks off at noon.","The shop opens at 9 a.m. on Saturday.","The concert begins at 7 p.m. next Friday.","The ferry departs at 2 p.m.","My flight departs at 6 in the morning.","The museum closes at 6 p.m.","Our exam starts at 10 a.m. sharp.","The show begins at 7:30 tonight.","The train to Madrid leaves at 4:20.","The bus arrives at the station at 5:30.","The library opens at 8:30 a.m.","The movie starts at 6:45 tonight.",
  "I am meeting my friends at the cinema tonight.","We are having dinner with our cousins tomorrow.","I am seeing the dentist on Friday.","She is visiting her grandma this weekend.","They are coming over for lunch tomorrow.","He is playing football on Saturday.","They are moving house next month.",
  "She will call you later.","He will arrive at noon.","I will help you with your homework.","We will watch a movie tonight.","I will bring the snacks.",
  "I am going to visit London next week.","He is going to learn Spanish.","We are going to bake a cake tomorrow.","She is going to study for the exam.",
  "If it rains, we will stay at home.","If we leave now, we will catch the bus.","If she studies, she will do well."
];

/* -----------------------------------------------------------
   DATA â€” INTENT BANK (>=50) â€” simplified but clear
----------------------------------------------------------- */
const INTENT_BANK = [
  // WILL â€” prediction
  { text:"I think it will rain later.", form:"will", intent:"prediction" },
  { text:"They will probably win the match.", form:"will", intent:"prediction" },
  { text:"Iâ€™m sure he will be late.", form:"will", intent:"prediction" },
  { text:"Maybe we will have a test tomorrow.", form:"will", intent:"prediction" },
  { text:"Do you think it will be hard?", form:"will", intent:"prediction" },
  { text:"It wonâ€™t be easy to finish today.", form:"will", intent:"prediction" },

  // WILL â€” offer/promise
  { text:"Donâ€™t worry, Iâ€™ll help you.", form:"will", intent:"offer_promise" },
  { text:"Iâ€™ll carry that for you.", form:"will", intent:"offer_promise" },
  { text:"Iâ€™ll explain it again.", form:"will", intent:"offer_promise" },
  { text:"I wonâ€™t tell anyone. I promise.", form:"will", intent:"offer_promise" },
  { text:"Weâ€™ll bring snacks for everyone.", form:"will", intent:"offer_promise" },
  { text:"Will you open the door, please?", form:"will", intent:"offer_promise" },

  // WILL â€” decision now
  { text:"Okay, Iâ€™ll do it now.", form:"will", intent:"decision_now" },
  { text:"Waitâ€”Iâ€™ll message her right now.", form:"will", intent:"decision_now" },
  { text:"Iâ€™ll take the blue one.", form:"will", intent:"decision_now" },
  { text:"Alright, weâ€™ll sit here.", form:"will", intent:"decision_now" },
  { text:"I wonâ€™t go out tonight then.", form:"will", intent:"decision_now" },
  { text:"Oh! Iâ€™ll answer it.", form:"will", intent:"decision_now" },

  // WILL â€” announcement
  { text:"The show will start in five minutes.", form:"will", intent:"announcement" },
  { text:"The results will be published tomorrow.", form:"will", intent:"announcement" },
  { text:"The gate will open soon.", form:"will", intent:"announcement" },
  { text:"Your order will arrive on Friday.", form:"will", intent:"announcement" },
  { text:"The exam will end at 11:00.", form:"will", intent:"announcement" },
  { text:"The class will begin in two minutes.", form:"will", intent:"announcement" },

  // GOING TO â€” plan
  { text:"Iâ€™m going to study tonight.", form:"going_to", intent:"plan" },
  { text:"Weâ€™re going to meet after school.", form:"going_to", intent:"plan" },
  { text:"Sheâ€™s going to apply for that course.", form:"going_to", intent:"plan" },
  { text:"They arenâ€™t going to travel this weekend.", form:"going_to", intent:"plan" },
  { text:"Are you going to watch the new episode?", form:"going_to", intent:"plan" },
  { text:"Iâ€™m not going to buy a new phone.", form:"going_to", intent:"plan" },

  // GOING TO â€” evidence prediction
  { text:"Look at those clouds! Itâ€™s going to rain.", form:"going_to", intent:"evidence_prediction" },
  { text:"Listen to that thunderâ€”thereâ€™s going to be a storm.", form:"going_to", intent:"evidence_prediction" },
  { text:"Be careful! Youâ€™re going to drop your phone.", form:"going_to", intent:"evidence_prediction" },
  { text:"That glass is going to fall!", form:"going_to", intent:"evidence_prediction" },
  { text:"Heâ€™s going to be sickâ€”he looks terrible.", form:"going_to", intent:"evidence_prediction" },
  { text:"Youâ€™re going to miss the busâ€”run!", form:"going_to", intent:"evidence_prediction" },

  // PRESENT CONTINUOUS â€” arrangement
  { text:"Iâ€™m meeting my friends at 6 p.m.", form:"present_continuous", intent:"arrangement" },
  { text:"Weâ€™re having dinner together tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"Sheâ€™s seeing the dentist on Friday.", form:"present_continuous", intent:"arrangement" },
  { text:"Theyâ€™re coming over for lunch tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"He isnâ€™t playing football on Saturday.", form:"present_continuous", intent:"arrangement" },
  { text:"Are you visiting your grandma this weekend?", form:"present_continuous", intent:"arrangement" },

  // PRESENT SIMPLE â€” schedule
  { text:"The train leaves at 8:10 tomorrow.", form:"present_simple", intent:"schedule" },
  { text:"School starts at 9 oâ€™clock on Monday.", form:"present_simple", intent:"schedule" },
  { text:"The plane lands at 3:15 p.m.", form:"present_simple", intent:"schedule" },
  { text:"The concert begins at 7 p.m. on Friday.", form:"present_simple", intent:"schedule" },
  { text:"The museum closes at 6 p.m.", form:"present_simple", intent:"schedule" },
  { text:"Does the match start at noon?", form:"present_simple", intent:"schedule" },

  // FIRST CONDITIONAL â€” warning/consequence
  { text:"If you donâ€™t study, youâ€™ll fail the test.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If you touch that, it will break.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If we are late, the teacher will be angry.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If you keep shouting, youâ€™ll get in trouble.", form:"first_conditional", intent:"warning_consequence" },

  // FIRST CONDITIONAL â€” advice/suggestion
  { text:"If you feel tired, take a break.", form:"first_conditional", intent:"advice_suggestion" },
  { text:"If you donâ€™t understand, ask the teacher.", form:"first_conditional", intent:"advice_suggestion" },
  { text:"If you want, Iâ€™ll explain it again.", form:"first_conditional", intent:"advice_suggestion" },

  // FIRST CONDITIONAL â€” plan_condition
  { text:"If it rains, weâ€™ll stay at home.", form:"first_conditional", intent:"plan_condition" },
  { text:"If the bus is full, weâ€™ll take the next one.", form:"first_conditional", intent:"plan_condition" },
  { text:"If you finish early, weâ€™ll start the game.", form:"first_conditional", intent:"plan_condition" },

  // FIRST CONDITIONAL â€” prediction_result
  { text:"If she studies, sheâ€™ll do well.", form:"first_conditional", intent:"prediction_result" },
  { text:"If they train hard, theyâ€™ll win.", form:"first_conditional", intent:"prediction_result" },
  { text:"If we leave now, weâ€™ll catch the bus.", form:"first_conditional", intent:"prediction_result" }
];

/* -----------------------------------------------------------
   INTENT OPTIONS (title + short description)
----------------------------------------------------------- */
const INTENT_OPTIONS = {
  will: [
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" , cls:"c-prediction"},
    { key:"offer_promise", label:"Offer / Promise", desc:"Help / promise" , cls:"c-offer"},
    { key:"decision_now", label:"Decision now", desc:"Made right now" , cls:"c-decision"},
    { key:"announcement", label:"Announcement", desc:"Official info" , cls:"c-announce"}
  ],
  going_to: [
    { key:"plan", label:"Plan / Intention", desc:"Already decided" , cls:"c-plan"},
    { key:"evidence_prediction", label:"Prediction (evidence)", desc:"Look! / evidence" , cls:"c-evidence"}
  ],
  present_continuous: [
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" , cls:"c-arrange"}
  ],
  present_simple: [
    { key:"schedule", label:"Schedule", desc:"Timetable time" , cls:"c-schedule"}
  ],
  first_conditional: [
    { key:"warning_consequence", label:"Warning", desc:"Bad result" , cls:"c-warning"},
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion" , cls:"c-advice"},
    { key:"plan_condition", label:"Plan", desc:"If X, we do Y" , cls:"c-plancond"},
    { key:"prediction_result", label:"Prediction", desc:"If X, Y happens" , cls:"c-predres"}
  ]
};

/* -----------------------------------------------------------
   STATE
----------------------------------------------------------- */
let currentType = "";
let current = "";
let tokens = [];
let built = [];

let currentIntentQ = null;

let streak = 0;
let strikes = 0;
const masteryGoal = 25;

let timerInterval = null;
let startTime = null;

let musicOn = false;

/* 3 activities only */
const TYPES = ["ORDER","NEXT_WORD","INTENT"];

/* -----------------------------------------------------------
   UTILS
----------------------------------------------------------- */
function shuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function formatTime(ms){
  const s = Math.floor(ms / 1000);
  const m = String(Math.floor(s / 60)).padStart(2,"0");
  const r = String(s % 60).padStart(2,"0");
  return `${m}:${r}`;
}

function updateTimerDisplay(){
  if(!startTime) return;
  document.getElementById("timerDisplay").textContent = formatTime(Date.now() - startTime);
}

function startTimer(){
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 500);
}

function stopTimer(){
  clearInterval(timerInterval);
  timerInterval = null;
}

function updateStats(){
  document.getElementById("streak").textContent = streak;
  const pct = Math.max(0, Math.min(100, (streak / masteryGoal) * 100));
  document.getElementById("progressFill").style.width = pct + "%";
}

function setAudioStatus(msg){
  document.getElementById("audioStatus").textContent = msg || "";
}

function setTag(text){
  document.getElementById("activityTag").textContent = text;
}

/* -----------------------------------------------------------
   MUSIC
----------------------------------------------------------- */
function toggleMusic(){
  const bgm = document.getElementById("bgm");
  const btn = document.getElementById("musicBtn");
  bgm.volume = 0.35;

  if(!musicOn){
    const p = bgm.play();
    if(p && p.then){
      p.then(()=>{
        musicOn = true;
        btn.textContent = "Music: ON";
        setAudioStatus("Audio: playing âœ…");
      }).catch(()=>{
        musicOn = false;
        btn.textContent = "Music: OFF";
        setAudioStatus("Audio error âŒ Check audio/koala2.mp3");
      });
    } else {
      musicOn = true;
      btn.textContent = "Music: ON";
      setAudioStatus("Audio: playing âœ…");
    }
  } else {
    bgm.pause();
    musicOn = false;
    btn.textContent = "Music: OFF";
    setAudioStatus("Audio: paused â¸ï¸");
  }
}

/* -----------------------------------------------------------
   START / RESET
----------------------------------------------------------- */
function startGame(){
  const name = document.getElementById("playerName").value.trim();
  if(!name){
    document.getElementById("nameWarning").textContent = "Please enter your name before starting.";
    return;
  }
  document.getElementById("nameWarning").textContent = "";
  document.getElementById("displayName").textContent = name;

  streak = 0;
  updateStats();
  document.getElementById("feedback").textContent = "";
  document.getElementById("feedback").className = "feedback";
  document.getElementById("bgm").load();
  setAudioStatus("Audio ready (press Music).");

  startTimer();
  nextQuestion();
}

function resetGame(){
  stopTimer();
  startTime = null;
  document.getElementById("timerDisplay").textContent = "00:00";

  streak = 0;
  updateStats();
  current = "";
  built = [];
  tokens = [];
  currentIntentQ = null;

  document.getElementById("prompt").textContent = "Enter your name and click Start";
  setTag("Activity: ---");
  hideAllAreas();
  document.getElementById("interaction").innerHTML = "";
  setFeedback("");

  const bgm = document.getElementById("bgm");
  bgm.pause();
  musicOn = false;
  document.getElementById("musicBtn").textContent = "Music: OFF";
  setAudioStatus("");
}

function setFeedback(text, ok=null){
  const fb = document.getElementById("feedback");
  fb.textContent = text || "";
  fb.className = "feedback";
  if(ok === true) fb.classList.add("ok");
  if(ok === false) fb.classList.add("no");
}

function hideAllAreas(){
  document.getElementById("cardsArea").classList.add("hidden");
  document.getElementById("wordBank").classList.add("hidden");
  document.getElementById("orderActions").classList.add("hidden");
  document.getElementById("cardsArea").innerHTML = "";
  document.getElementById("wordBank").innerHTML = "";
  document.getElementById("interaction").innerHTML = "";
}

/* -----------------------------------------------------------
   NEXT QUESTION â€” mix 3 activity types
----------------------------------------------------------- */
function nextQuestion(){
  built = [];
  hideAllAreas();
  setFeedback("");

  currentType = TYPES[Math.floor(Math.random()*TYPES.length)];

  if(currentType === "INTENT"){
    currentIntentQ = INTENT_BANK[Math.floor(Math.random()*INTENT_BANK.length)];
    current = currentIntentQ.text;
    tokens = current.split(" ");
    document.getElementById("prompt").textContent = "Choose the speaker's intention:";
    setTag("Activity: INTENT");
    renderSentenceChip(current);
    renderIntentCards(currentIntentQ);
    return;
  }

  // ORDER or NEXT_WORD use the working pool
  currentIntentQ = null;
  current = sentences[Math.floor(Math.random()*sentences.length)];
  tokens = current.split(" ");

  if(currentType === "ORDER"){
    document.getElementById("prompt").textContent = "Build the sentence (tap words):";
    setTag("Activity: ORDER");
    renderOrder();
    return;
  }

  // NEXT_WORD
  document.getElementById("prompt").textContent = "Choose the next word:";
  setTag("Activity: NEXT WORD");
  renderNextWordStep();
}

/* -----------------------------------------------------------
   COMMON: show sentence chip in interaction
----------------------------------------------------------- */
function renderSentenceChip(text){
  const area = document.getElementById("interaction");
  area.innerHTML = "";
  const span = document.createElement("span");
  span.textContent = text;
  span.className = "builtWord";
  span.style.cursor = "default";
  area.appendChild(span);
}

/* -----------------------------------------------------------
   ACTIVITY: ORDER
----------------------------------------------------------- */
function renderOrder(){
  document.getElementById("wordBank").classList.remove("hidden");
  document.getElementById("orderActions").classList.remove("hidden");

  const bank = document.getElementById("wordBank");
  bank.innerHTML = "";
  const words = shuffle([...tokens]);

  words.forEach(w=>{
    const b = document.createElement("span");
    b.className = "wordItem";
    b.textContent = w;
    b.onclick = ()=>{
      built.push(w);
      b.style.display = "none";
      renderBuiltWords();
    };
    bank.appendChild(b);
  });

  renderBuiltWords();
}

function renderBuiltWords(){
  const area = document.getElementById("interaction");
  area.innerHTML = "";
  built.forEach((w,i)=>{
    const chip = document.createElement("span");
    chip.className = "builtWord";
    chip.textContent = w;
    chip.onclick = ()=>{
      const removed = built.splice(i,1)[0];
      // show back one hidden matching word
      Array.from(document.getElementById("wordBank").children).forEach(el=>{
        if(el.textContent === removed && el.style.display === "none"){
          el.style.display = "inline-block";
        }
      });
      renderBuiltWords();
    };
    area.appendChild(chip);
  });
}

function clearWords(){
  built = [];
  renderBuiltWords();
  Array.from(document.getElementById("wordBank").children).forEach(el=>{
    el.style.display = "inline-block";
  });
}

function checkOrder(){
  if(!current) return;
  const attempt = built.join(" ");
  gradeAttempt(attempt === current);
}

/* -----------------------------------------------------------
   ACTIVITY: NEXT WORD (MCQ build)
----------------------------------------------------------- */
function renderNextWordStep(){
  document.getElementById("cardsArea").classList.remove("hidden");
  const cards = document.getElementById("cardsArea");
  cards.innerHTML = "";

  // display built so far
  const area = document.getElementById("interaction");
  area.innerHTML = "";
  built.forEach(w=>{
    const chip = document.createElement("span");
    chip.className = "builtWord";
    chip.textContent = w;
    chip.style.cursor = "default";
    area.appendChild(chip);
  });

  if(built.length >= tokens.length){
    gradeAttempt(built.join(" ") === current);
    return;
  }

  const correct = tokens[built.length];
  const pool = shuffle([...tokens]).filter(t=>t !== correct);
  const distract = [];
  for(const t of pool){
    if(distract.length >= 3) break;
    if(!distract.includes(t)) distract.push(t);
  }
  while(distract.length < 3){
    distract.push(tokens[Math.floor(Math.random()*tokens.length)]);
  }

  const opts = shuffle([correct, ...distract]);

  opts.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn";
    btn.innerHTML = `<div class="cardTitle">${opt}</div><div class="cardDesc">Tap to choose</div>`;
    btn.style.textAlign = "center";
    btn.onclick = ()=>{
      built.push(opt);
      renderNextWordStep();
    };
    cards.appendChild(btn);
  });
}

/* -----------------------------------------------------------
   ACTIVITY: INTENT (cards with short description)
----------------------------------------------------------- */
function renderIntentCards(q){
  document.getElementById("cardsArea").classList.remove("hidden");
  const cards = document.getElementById("cardsArea");
  cards.innerHTML = "";

  const options = (INTENT_OPTIONS[q.form] || []).slice();
  shuffle(options);

  // If only 1 option exists, add 2 generic distractors (visual only)
  if(options.length === 1){
    const extra = [
      { key:"prediction", label:"Prediction", desc:"Guess / opinion", cls:"c-prediction"},
      { key:"plan", label:"Plan / Intention", desc:"Already decided", cls:"c-plan"}
    ].filter(x=>x.key !== options[0].key);
    options.push(extra[0], extra[1]);
    shuffle(options);
  }

  options.forEach(o=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn " + (o.cls || "");
    btn.innerHTML = `<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick = ()=> gradeAttempt(o.key === q.intent, q.intent);
    cards.appendChild(btn);
  });
}

/* -----------------------------------------------------------
   GRADING
----------------------------------------------------------- */
function gradeAttempt(correct, correctIntent=null){
  if(correct){
    setFeedback("âœ… Correct!", true);
    streak++;
    updateStats();

    if(streak >= masteryGoal){
      try{ document.getElementById("winSound").play().catch(()=>{}); }catch(e){}
      setFeedback("ðŸ† Mastery! 25 in a row!", true);
      return;
    }
    setTimeout(nextQuestion, 650);
  } else {
    streak = 0;
    updateStats();

    if(currentType === "INTENT" && correctIntent){
      setFeedback("âŒ Try again! (Correct: " + prettyIntent(correctIntent) + ")", false);
    } else {
      setFeedback("âŒ Try again!", false);
    }

    if(currentType === "ORDER"){
      clearWords();
    } else if(currentType === "NEXT_WORD"){
      built = [];
      renderNextWordStep();
    }
  }
}

function prettyIntent(key){
  return key.replaceAll("_"," ").toUpperCase();
}

/* init */
window.addEventListener("load", ()=>{
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.35;
});
</script>
</body>
</html>

