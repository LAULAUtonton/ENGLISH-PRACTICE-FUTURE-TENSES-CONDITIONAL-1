<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Future Forms Game â€” 3-Step Engine</title>

  <style>
    body{
      margin:0; padding:0;
      background:#0a0a0f;
      font-family: Arial, sans-serif;
      color:#fff;
      text-align:center;
    }
    .hidden{ display:none; }
    .screen{ padding-top:60px; }

    .title{
      font-size:2.5rem;
      margin-bottom:20px;
      color:#66e0ff;
      text-shadow:0 0 10px #00aaff;
    }

    input[type="text"], input[type="password"]{
      padding:12px;
      width:260px;
      border-radius:6px;
      border:none;
      margin-bottom:20px;
      font-size:1rem;
    }

    .mainBtn{
      background:#00aaff;
      border:none;
      padding:12px 24px;
      border-radius:6px;
      color:#fff;
      font-size:1.1rem;
      cursor:pointer;
      margin-top:10px;
      transition:.2s;
    }
    .mainBtn:hover{ background:#33cfff; }

    .secondaryBtn{
      background:#444;
      border:none;
      padding:10px 20px;
      border-radius:6px;
      color:#fff;
      cursor:pointer;
      margin-top:10px;
    }
    .secondaryBtn:hover{ background:#666; }

    #teacherBtn{
      position:fixed;
      top:10px; right:10px;
      font-size:2rem;
      cursor:pointer;
      color:#ffdd55;
      text-shadow:0 0 8px #ffaa00;
      transition:.2s;
      user-select:none;
      z-index:60;
    }
    #teacherBtn:hover{ transform:scale(1.1); }

    #topBar{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 20px;
      font-size:1.2rem;
      flex-wrap:wrap;
    }
    #scoreBox, #streakBox, #bestBox{
      background:#111;
      padding:10px 16px;
      border-radius:6px;
      border:1px solid #00aaff;
      box-shadow:0 0 10px #005577;
      min-width:140px;
    }

    #sentenceCard{
      background:#111;
      width:80%;
      margin:20px auto;
      padding:20px;
      border-radius:10px;
      border:1px solid #00aaff;
      box-shadow:0 0 15px #005577;
    }
    #sentenceText{ font-size:1.4rem; }

    #questionPrompt{
      font-size:1.3rem;
      margin-top:20px;
      color:#66e0ff;
    }
    #stepLabel{
      margin-top:8px;
      font-size:1rem;
      color:#cfefff;
      opacity:.95;
    }

    #optionsContainer{
      margin-top:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      width:80%;
      margin-left:auto;
      margin-right:auto;
    }

    .optionBtn{
      background:#222;
      border:1px solid #00aaff;
      padding:12px;
      border-radius:6px;
      cursor:pointer;
      transition:.2s;
      font-size:1.1rem;
      color:#fff;
      text-align:left;
    }
    .optionBtn:hover{ background:#003344; }
    .optionBtn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Ordering UI */
    .pickedBox{
      margin-top:10px;
      background:#0f0f14;
      border:1px dashed #00aaff;
      border-radius:8px;
      padding:10px;
      text-align:left;
      box-shadow: inset 0 0 0 1px rgba(0,170,255,.15);
    }
    .pill{
      display:inline-block;
      margin:6px 6px 0 0;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #00aaff;
      background: rgba(0,170,255,.08);
      font-weight:700;
      font-size:.95rem;
    }

    /* Matching UI */
    .matchWrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      width:100%;
    }
    .matchCol{
      background:#0f0f14;
      border:1px solid #00aaff;
      border-radius:8px;
      padding:10px;
      text-align:left;
    }
    .matchHead{
      font-weight:700;
      color:#66e0ff;
      margin-bottom:8px;
    }
    .matchBtn{
      width:100%;
      margin:6px 0;
      text-align:left;
      background:#222;
      border:1px solid #00aaff;
      padding:10px;
      border-radius:6px;
      cursor:pointer;
      color:#fff;
    }
    .matchBtn:hover{ background:#003344; }
    .matchBtn.selected{
      outline:3px solid rgba(102,224,255,.25);
      border-color:#66e0ff;
    }
    .matchBtn.paired{ opacity:.6; cursor:not-allowed; }

    /* Overlays */
    .overlay{
      position:fixed;
      top:0; left:0;
      width:100%;
      height:100%;
      background: rgba(0,0,0,.85);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:18px;
      z-index:50;
    }
    .overlayContent{
      background:#111;
      padding:30px;
      border-radius:10px;
      width:70%;
      max-width:520px;
      border:1px solid #00aaff;
      box-shadow:0 0 20px #005577;
    }
    .overlayContent.small{ max-width:350px; }

    .toggleRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin:12px 0;
      font-size:1.1rem;
      justify-content:center;
    }
    .toggleRow input{ transform:scale(1.2); }

    .shake{
      animation: shake .25s linear 0s 2;
      border:2px solid #ef4444 !important;
    }
    @keyframes shake{
      0%{ transform:translateX(0); }
      25%{ transform:translateX(-6px); }
      50%{ transform:translateX(6px); }
      75%{ transform:translateX(-6px); }
      100%{ transform:translateX(0); }
    }

    @media (max-width:600px){
      #sentenceCard{ width:95%; }
      #optionsContainer{ width:95%; }
      .matchWrap{ grid-template-columns: 1fr; }
      #topBar{ justify-content:center; }
    }
  </style>
</head>

<body>
  <!-- NAME SCREEN -->
  <div id="nameScreen" class="screen">
    <h1 class="title">Future Forms Game</h1>
    <input id="studentNameInput" type="text" placeholder="Enter your name" autocomplete="name" />
    <br />
    <button id="startNameBtn" class="mainBtn">Start</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="gameScreen" class="screen hidden">
    <div id="teacherBtn" title="Teacher Access">ðŸŽ“</div>

    <div id="topBar">
      <div id="scoreBox">Score: 0</div>
      <div id="streakBox">Streak: 0</div>
      <div id="bestBox">Best: 0</div>
    </div>

    <div id="sentenceCard">
      <p id="sentenceText">Sentence will appear here</p>
    </div>

    <div id="questionPrompt">What is the speaker's intended meaning?</div>
    <div id="stepLabel">Step 1/3</div>

    <div id="optionsContainer"></div>

    <button id="nextBtn" class="hidden mainBtn">Next Round</button>
  </div>

  <!-- FEEDBACK -->
  <div id="feedbackOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent">
      <h2 id="feedbackTitle">Feedback</h2>
      <p id="feedbackText"></p>
      <button id="closeFeedbackBtn" class="mainBtn">Continue</button>
    </div>
  </div>

  <!-- CELEBRATION -->
  <div id="celebrationOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent">
      <h2>ðŸŽ‰ Amazing! ðŸŽ‰</h2>
      <p>You reached a streak of 25!</p>
      <button id="closeCelebrationBtn" class="mainBtn">Keep Going</button>
    </div>
  </div>

  <!-- TEACHER LOGIN -->
  <div id="teacherLogin" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent small">
      <h2>Teacher Access</h2>
      <input id="teacherCodeInput" type="password" placeholder="Enter code" inputmode="numeric" />
      <button id="teacherCodeBtn" class="mainBtn">Enter</button>
      <button id="closeTeacherLogin" class="secondaryBtn">Cancel</button>
    </div>
  </div>

  <!-- TEACHER PANEL -->
  <div id="teacherPanel" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent">
      <h2>Teacher Panel</h2>

      <button id="teacherStartBtn" class="mainBtn">Start Round</button>
      <button id="teacherResetBtn" class="secondaryBtn">Reset Game</button>

      <label class="toggleRow">
        <input type="checkbox" id="autoNextToggle" />
        Auto-next
      </label>

      <label class="toggleRow">
        <input type="checkbox" id="musicToggle" checked />
        Music
      </label>

      <label class="toggleRow">
        <input type="checkbox" id="sfxToggle" checked />
        Sound Effects
      </label>

      <button id="sendStatsBtn" class="mainBtn">Send Stats Now</button>
      <button id="closeTeacherPanel" class="secondaryBtn">Close</button>
    </div>
  </div>

  <!-- AUDIO -->
  <audio id="bgMusic" src="music.mp3" preload="auto"></audio>
  <audio id="correctSound" src="correct.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
  <audio id="celebrationSound" src="celebration.mp3" preload="auto"></audio>

  <script>
  (() => {
    "use strict";

    /* =========================================================
       CONFIG
    ========================================================= */
    const GOOGLE_SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE"; // optional
    const STREAK_TARGET = 25;

    /* =========================================================
       SENTENCES (your banks)
    ========================================================= */
    const BANKS = {
      PS_aff: [
        "She usually walks to school.",
        "He plays the guitar every afternoon.",
        "They enjoy quiet mornings together.",
        "My cat sleeps on my backpack.",
        "I like how this coffee smells.",
        "We read the newspaper every morning.",
        "The bus arrives at eight o'clock.",
        "Tom studies French at university.",
        "Anna works in a small bakery.",
        "Birds fly south in winter.",
        "The shop opens at nine every day.",
        "He drinks green tea after lunch.",
        "Students practice vocabulary every evening.",
        "She always helps her neighbors.",
        "The sun rises in the east.",
        "He writes emails every morning.",
        "We celebrate birthdays with cake.",
        "The teacher explains the lesson clearly.",
        "She takes the dog for a walk daily.",
        "They visit the museum on weekends.",
        "My brother cooks dinner on Fridays."
      ],
      PS_neg: [
        "She doesn't like cold pizza.",
        "They don't study on Sundays.",
        "He does not enjoy long movies.",
        "I don't drink soda anymore.",
        "The cat doesn't sleep in its bed.",
        "We don't watch TV at night.",
        "He doesn't own a car.",
        "She does not eat meat.",
        "They don't arrive early.",
        "I don't understand this word.",
        "She doesn't answer her phone often.",
        "We don't use that old computer anymore.",
        "He doesn't believe the rumor.",
        "They don't accept late homework.",
        "I don't remember his name.",
        "She doesn't drive to work.",
        "He doesn't like loud music.",
        "We don't go out when it rains.",
        "The store doesn't open on Sundays.",
        "He doesn't speak Spanish.",
        "They don't play video games on school nights."
      ],
      PS_int: [
        "Do you like spicy food?",
        "Does she play the violin?",
        "Do they live near here?",
        "Does he enjoy swimming?",
        "Do we have class today?",
        "Do you speak English?",
        "Does it rain a lot here?",
        "Do they know the answer?",
        "Does she work on Saturdays?",
        "Do I need to bring a book?",
        "Do you usually study in the morning?",
        "Does he visit his grandparents every week?",
        "Do they play chess after school?",
        "Does she cook for the family?",
        "Do we meet at the library?",
        "Do you understand the instructions?",
        "Does he take the train to work?",
        "Do they practice every day?",
        "Does she prefer tea or coffee?",
        "Do I have to finish this today?",
        "Do you remember the homework?"
      ],
      PC_aff: [
        "She's studying English right now.",
        "They are cooking dinner together.",
        "He's drawing a robot at the moment.",
        "I'm listening to music.",
        "We're walking to the bus stop.",
        "She is reading a new novel.",
        "They are playing football in the park.",
        "He is fixing his bicycle.",
        "I'm watching a documentary.",
        "We are preparing for the exam.",
        "She is practicing the piano this afternoon.",
        "They are building a model in the workshop.",
        "He is cleaning his room right now.",
        "I'm checking my email at the moment.",
        "We are learning a new song today.",
        "She is talking on the phone now.",
        "They are planting flowers in the garden.",
        "He is making a sandwich right now.",
        "I'm writing my notes at the moment.",
        "We are working on our project today.",
        "She is waiting for the bus right now."
      ],
      PC_neg: [
        "She isn't sleeping at the moment.",
        "They aren't watching TV right now.",
        "He is not studying today.",
        "I'm not feeling well right now.",
        "We aren't going out tonight.",
        "She isn't using her laptop now.",
        "They are not listening to the teacher.",
        "He isn't playing football today.",
        "I'm not working on that task right now.",
        "We are not talking about that now.",
        "She isn't wearing her jacket today.",
        "They aren't doing their homework at the moment.",
        "He is not driving right now.",
        "I'm not texting anyone right now.",
        "We aren't waiting anymore.",
        "She isn't smiling today.",
        "They are not cleaning the classroom now.",
        "He isn't helping right now.",
        "I'm not eating at the moment.",
        "We aren't practicing today.",
        "She isn't studying right now."
      ],
      PC_int: [
        "Are you studying right now?",
        "Is she working today?",
        "Are they playing outside?",
        "Is he watching TV at the moment?",
        "Are we meeting after school?",
        "Are you listening to me?",
        "Is it raining right now?",
        "Are they using their phones?",
        "Is she taking notes now?",
        "Am I doing this correctly?",
        "Are you working on the project?",
        "Is he wearing his uniform today?",
        "Are they preparing for the test?",
        "Is she talking too loudly?",
        "Are we waiting for the bus?",
        "Are you learning new vocabulary today?",
        "Is he fixing his bike right now?",
        "Are they studying in the library?",
        "Is she writing an email now?",
        "Are we doing the activity right now?",
        "Are you feeling tired today?"
      ]
    };

    const BANK_META = [
      { key:"PS_aff", meaningType:"ps_aff", meaningLabel:"habit/routine or general fact", grammarLabel:"Present Simple â€” affirmative" },
      { key:"PS_neg", meaningType:"ps_neg", meaningLabel:"a negative habit/fact (it doesn't happen)", grammarLabel:"Present Simple â€” negative" },
      { key:"PS_int", meaningType:"ps_int", meaningLabel:"a question about a habit/fact", grammarLabel:"Present Simple â€” question" },
      { key:"PC_aff", meaningType:"pc_aff", meaningLabel:"happening now / around now", grammarLabel:"Present Continuous â€” affirmative" },
      { key:"PC_neg", meaningType:"pc_neg", meaningLabel:"NOT happening now", grammarLabel:"Present Continuous â€” negative" },
      { key:"PC_int", meaningType:"pc_int", meaningLabel:"a question about what is happening now", grammarLabel:"Present Continuous â€” question" }
    ];

    function pick4GrammarOptions(correctLabel, all) {
      const pool = all.filter(x => x !== correctLabel);
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      return [correctLabel, pool[0], pool[1], pool[2]];
    }

    function buildQuestionBank() {
      const grammarOptionsAll = [
        "Present Simple â€” affirmative",
        "Present Simple â€” negative",
        "Present Simple â€” question",
        "Present Continuous â€” affirmative",
        "Present Continuous â€” negative",
        "Present Continuous â€” question"
      ];

      const certaintyOrdering = {
        prompt: "Order these from MOST certain â†’ LEAST certain (click in order):",
        items: ["definitely", "probably", "maybe", "unlikely"],
        correctOrder: ["definitely", "probably", "maybe", "unlikely"]
      };

      const matchingTemplate = {
        prompt: "Match meaning â†” grammar (click a meaning, then a grammar):",
        pairs: [
          { left: "Habit / routine", right: "Present Simple" },
          { left: "Happening now", right: "Present Continuous" },
          { left: "Negative statement", right: "Negative form (donâ€™t / isnâ€™t)" },
          { left: "Question", right: "Question form (Do/Does/Are/Is)" }
        ]
      };

      const qbank = [];
      for (const meta of BANK_META) {
        const sentences = BANKS[meta.key] || [];
        for (const sentence of sentences) {
          const meaningCorrect = `The speaker means: ${meta.meaningLabel}.`;

          const meaningOptions =
            meta.key.startsWith("PS_")
              ? [
                  meaningCorrect,
                  "The speaker means: it is happening right now.",
                  "The speaker means: it happened yesterday.",
                  "The speaker means: it will happen tomorrow."
                ]
              : [
                  meaningCorrect,
                  "The speaker means: it is a habit/routine.",
                  "The speaker means: it happened yesterday.",
                  "The speaker means: it will happen tomorrow."
                ];

          qbank.push({
            sentence,
            meaning: {
              type: meta.meaningType,
              prompt: "What is the speaker's intended meaning?",
              correct: meaningCorrect,
              options: meaningOptions
            },
            grammar: {
              prompt: "Which grammar label fits best?",
              correct: meta.grammarLabel,
              options: pick4GrammarOptions(meta.grammarLabel, grammarOptionsAll)
            },
            ordering: certaintyOrdering,
            matching: matchingTemplate
          });
        }
      }
      return qbank;
    }

    const QUESTION_BANK = buildQuestionBank();

    /* =========================================================
       DOM
    ========================================================= */
    const $ = (s) => document.querySelector(s);

    const el = {
      nameScreen: $("#nameScreen"),
      gameScreen: $("#gameScreen"),

      studentNameInput: $("#studentNameInput"),
      startNameBtn: $("#startNameBtn"),

      teacherBtn: $("#teacherBtn"),

      scoreBox: $("#scoreBox"),
      streakBox: $("#streakBox"),
      bestBox: $("#bestBox"),

      sentenceText: $("#sentenceText"),
      questionPrompt: $("#questionPrompt"),
      stepLabel: $("#stepLabel"),

      optionsContainer: $("#optionsContainer"),
      nextBtn: $("#nextBtn"),

      feedbackOverlay: $("#feedbackOverlay"),
      feedbackTitle: $("#feedbackTitle"),
      feedbackText: $("#feedbackText"),
      closeFeedbackBtn: $("#closeFeedbackBtn"),

      celebrationOverlay: $("#celebrationOverlay"),
      closeCelebrationBtn: $("#closeCelebrationBtn"),

      teacherLogin: $("#teacherLogin"),
      teacherCodeInput: $("#teacherCodeInput"),
      teacherCodeBtn: $("#teacherCodeBtn"),
      closeTeacherLogin: $("#closeTeacherLogin"),

      teacherPanel: $("#teacherPanel"),
      teacherStartBtn: $("#teacherStartBtn"),
      teacherResetBtn: $("#teacherResetBtn"),
      autoNextToggle: $("#autoNextToggle"),
      musicToggle: $("#musicToggle"),
      sfxToggle: $("#sfxToggle"),
      sendStatsBtn: $("#sendStatsBtn"),
      closeTeacherPanel: $("#closeTeacherPanel"),

      bgMusic: $("#bgMusic"),
      correctSound: $("#correctSound"),
      wrongSound: $("#wrongSound"),
      celebrationSound: $("#celebrationSound")
    };

    /* =========================================================
       STATE
    ========================================================= */
    const state = {
      studentName: "",
      score: 0,
      streak: 0,
      bestStreak: 0,

      currentBundle: null,
      currentStep: 1,
      stepPlan: [],

      autoNext: false,
      musicOn: true,
      sfxOn: true,

      weakAreas: {},
      log: [],

      questionStartMs: 0
    };

    /* =========================================================
       HELPERS
    ========================================================= */
    const nowISO = () => new Date().toISOString();

    const shuffle = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };

    const show = (node) => node && node.classList.remove("hidden");
    const hide = (node) => node && node.classList.add("hidden");

    function arraysEqual(a, b) {
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
      return true;
    }

    function escapeHTML(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setHUD() {
      if (el.scoreBox) el.scoreBox.textContent = `Score: ${state.score}`;
      if (el.streakBox) el.streakBox.textContent = `Streak: ${state.streak}`;
      if (el.bestBox) el.bestBox.textContent = `Best: ${state.bestStreak}`;
    }

    function setSentence(text) {
      if (el.sentenceText) el.sentenceText.textContent = text || "";
    }

    function setPrompt(text) {
      if (el.questionPrompt) el.questionPrompt.textContent = text || "";
    }

    function setStepLabel() {
      if (el.stepLabel) el.stepLabel.textContent = `Step ${state.currentStep}/3`;
    }

    function clearOptions() {
      if (el.optionsContainer) el.optionsContainer.innerHTML = "";
    }

    function playSfx(kind) {
      if (!state.sfxOn) return;
      const a =
        kind === "correct" ? el.correctSound :
        kind === "wrong" ? el.wrongSound :
        kind === "celebration" ? el.celebrationSound :
        null;
      if (!a) return;
      try { a.currentTime = 0; a.play(); } catch (_) {}
    }

    function syncMusic() {
      if (!el.bgMusic) return;
      try {
        el.bgMusic.loop = true;
        if (state.musicOn) el.bgMusic.play().catch(() => {});
        else el.bgMusic.pause();
      } catch (_) {}
    }

    function savePrefs() {
      try {
        localStorage.setItem("future_game_prefs_v1", JSON.stringify({
          autoNext: state.autoNext,
          musicOn: state.musicOn,
          sfxOn: state.sfxOn,
          bestStreak: state.bestStreak
        }));
      } catch (_) {}
    }

    function loadPrefs() {
      try {
        const raw = localStorage.getItem("future_game_prefs_v1");
        if (!raw) return;
        const p = JSON.parse(raw);
        if (typeof p.autoNext === "boolean") state.autoNext = p.autoNext;
        if (typeof p.musicOn === "boolean") state.musicOn = p.musicOn;
        if (typeof p.sfxOn === "boolean") state.sfxOn = p.sfxOn;
        if (typeof p.bestStreak === "number") state.bestStreak = p.bestStreak;
      } catch (_) {}
    }

    function bumpWeakAreas(type, correct) {
      const key = type || "unknown";
      if (!state.weakAreas[key]) state.weakAreas[key] = { correct: 0, total: 0 };
      state.weakAreas[key].total += 1;
      if (correct) state.weakAreas[key].correct += 1;
    }

    function logAnswer({ kind, meaningType, chosen, correctAnswer, correct }) {
      const elapsedMs = Date.now() - (state.questionStartMs || Date.now());

      if (correct) {
        state.score += 1;
        state.streak += 1;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
      } else {
        state.streak = 0;
      }

      bumpWeakAreas(meaningType, correct);

      state.log.push({
        studentName: state.studentName,
        sentence: state.currentBundle?.sentence || "",
        meaningType: meaningType || "unknown",
        kind,
        studentAnswer: chosen,
        correctAnswer,
        isCorrect: !!correct,
        timeISO: nowISO(),
        elapsedMs,
        streakAfter: state.streak,
        scoreAfter: state.score
      });

      setHUD();
      savePrefs();
    }

    /* =========================================================
       OVERLAYS
    ========================================================= */
    function showFeedback(title, text, isCorrect, afterClose) {
      if (el.feedbackTitle) el.feedbackTitle.textContent = title || "Feedback";
      if (el.feedbackText) el.feedbackText.textContent = text || "";
      show(el.feedbackOverlay);
      playSfx(isCorrect ? "correct" : "wrong");

      const close = () => {
        hide(el.feedbackOverlay);
        el.closeFeedbackBtn?.removeEventListener("click", close);
        if (state.autoNext) setTimeout(() => afterClose && afterClose(), 120);
        else afterClose && afterClose();
      };

      el.closeFeedbackBtn?.addEventListener("click", close);
    }

    function showCelebration(afterClose) {
      show(el.celebrationOverlay);
      playSfx("celebration");

      const close = () => {
        hide(el.celebrationOverlay);
        el.closeCelebrationBtn?.removeEventListener("click", close);
        // Spec: reset streak to continue
        state.streak = 0;
        setHUD();
        savePrefs();
        afterClose && afterClose();
      };

      el.closeCelebrationBtn?.addEventListener("click", close);
    }

    function maybeCelebrateThen(next) {
      if (state.streak >= STREAK_TARGET) showCelebration(next);
      else next();
    }

    /* =========================================================
       STEP PLAN
    ========================================================= */
    function pickStepPlan() {
      const combos = [
        ["meaning", "grammar", "ordering"],
        ["meaning", "ordering", "grammar"],
        ["meaning", "grammar", "matching"],
        ["meaning", "matching", "grammar"]
      ];
      return combos[Math.floor(Math.random() * combos.length)];
    }

    /* =========================================================
       RENDER HELPERS
    ========================================================= */
    function renderOptionButtons(options, onPick) {
      clearOptions();
      const opts = shuffle(options || []).slice(0, 4);
      const frag = document.createDocumentFragment();
      opts.forEach((opt) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "optionBtn";
        btn.textContent = opt;
        btn.addEventListener("click", () => onPick(opt));
        frag.appendChild(btn);
      });
      el.optionsContainer?.appendChild(frag);
    }

    /* =========================================================
       ENGINES
    ========================================================= */
    function renderMeaning() {
      const q = state.currentBundle.meaning;
      setPrompt(q.prompt || "What is the speaker's intended meaning?");
      setStepLabel();

      renderOptionButtons(q.options, (chosen) => {
        const correct = chosen === q.correct;

        logAnswer({
          kind: "meaning",
          meaningType: q.type || "unknown",
          chosen,
          correctAnswer: q.correct,
          correct
        });

        const msg = correct ? "Correct!" : `Not quite. Correct answer: "${q.correct}"`;

        showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
          maybeCelebrateThen(advanceStepOrFinish);
        });
      });
    }

    function renderGrammar() {
      const q = state.currentBundle.grammar;
      setPrompt(q.prompt || "Which grammar label fits best?");
      setStepLabel();

      renderOptionButtons(q.options, (chosen) => {
        const correct = chosen === q.correct;

        logAnswer({
          kind: "grammar",
          meaningType: state.currentBundle.meaning?.type || "unknown",
          chosen,
          correctAnswer: q.correct,
          correct
        });

        const msg = correct ? "Correct!" : `Not quite. Correct answer: "${q.correct}"`;

        showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
          maybeCelebrateThen(advanceStepOrFinish);
        });
      });
    }

    function renderOrdering() {
      const q = state.currentBundle.ordering;
      setPrompt(q.prompt || "Order these (click in order):");
      setStepLabel();

      clearOptions();
      const picked = [];
      const correctOrder = q.correctOrder || [];

      const pickedBox = document.createElement("div");
      pickedBox.className = "pickedBox";
      pickedBox.innerHTML = `<div><strong>Your order:</strong></div><div id="pickedList"></div>`;
      el.optionsContainer?.appendChild(pickedBox);
      const pickedList = pickedBox.querySelector("#pickedList");

      const refreshPicked = () => {
        if (!pickedList) return;
        pickedList.innerHTML = picked
          .map((x, i) => `<span class="pill">${i + 1}. ${escapeHTML(x)}</span>`)
          .join(" ");
      };

      const items = shuffle(q.items || []);
      items.forEach((text) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "optionBtn";
        btn.textContent = text;

        btn.addEventListener("click", () => {
          if (picked.includes(text)) return;
          picked.push(text);
          btn.disabled = true;
          refreshPicked();

          if (picked.length === 4) {
            const correct = arraysEqual(picked, correctOrder);

            logAnswer({
              kind: "ordering",
              meaningType: state.currentBundle.meaning?.type || "unknown",
              chosen: picked.slice(),
              correctAnswer: correctOrder.slice(),
              correct
            });

            const msg = correct
              ? "Correct!"
              : `Not quite. Correct order: ${correctOrder.join(" â†’ ")}`;

            showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
              maybeCelebrateThen(advanceStepOrFinish);
            });
          }
        });

        el.optionsContainer?.appendChild(btn);
      });
    }

    function renderMatching() {
      const q = state.currentBundle.matching;
      setPrompt(q.prompt || "Match meaning â†” grammar:");
      setStepLabel();

      clearOptions();

      const pairs = q.pairs || [];
      const lefts = shuffle(pairs.map(p => p.left));
      const rights = shuffle(pairs.map(p => p.right));

      const correctMap = new Map(pairs.map(p => [p.left, p.right]));
      const chosenMap = new Map();
      let selectedLeft = null;

      const wrap = document.createElement("div");
      wrap.className = "matchWrap";

      const leftCol = document.createElement("div");
      leftCol.className = "matchCol";
      const rightCol = document.createElement("div");
      rightCol.className = "matchCol";

      wrap.appendChild(leftCol);
      wrap.appendChild(rightCol);
      el.optionsContainer?.appendChild(wrap);

      function rerender() {
        leftCol.innerHTML = `<div class="matchHead">Meaning</div>`;
        rightCol.innerHTML = `<div class="matchHead">Grammar</div>`;

        lefts.forEach((l) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "matchBtn";
          btn.textContent = l;

          if (chosenMap.has(l)) { btn.classList.add("paired"); btn.disabled = true; }
          if (selectedLeft === l) btn.classList.add("selected");

          btn.addEventListener("click", () => {
            if (chosenMap.has(l)) return;
            selectedLeft = l;
            rerender();
          });

          leftCol.appendChild(btn);
        });

        rights.forEach((r) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "matchBtn";
          btn.textContent = r;

          if ([...chosenMap.values()].includes(r)) { btn.classList.add("paired"); btn.disabled = true; }

          btn.addEventListener("click", () => {
            if (!selectedLeft) return;
            if ([...chosenMap.values()].includes(r)) return;
            chosenMap.set(selectedLeft, r);
            selectedLeft = null;
            rerender();
            if (chosenMap.size === 4) finish();
          });

          rightCol.appendChild(btn);
        });
      }

      function finish() {
        let correctCount = 0;
        for (const [l, r] of chosenMap.entries()) {
          if (correctMap.get(l) === r) correctCount++;
        }
        const correct = correctCount === 4;

        logAnswer({
          kind: "matching",
          meaningType: state.currentBundle.meaning?.type || "unknown",
          chosen: [...chosenMap.entries()],
          correctAnswer: pairs.map(p => [p.left, p.right]),
          correct
        });

        const msg = correct ? "Correct!" : `Not quite. You got ${correctCount}/4 correct.`;

        showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
          maybeCelebrateThen(advanceStepOrFinish);
        });
      }

      rerender();
    }

    /* =========================================================
       FLOW CONTROL
    ========================================================= */
    function renderCurrentStep() {
      state.questionStartMs = Date.now();
      setSentence(state.currentBundle?.sentence || "");
      hide(el.nextBtn);

      const stepType = state.stepPlan[state.currentStep - 1] || "meaning";
      if (stepType === "meaning") renderMeaning();
      else if (stepType === "grammar") renderGrammar();
      else if (stepType === "ordering") renderOrdering();
      else if (stepType === "matching") renderMatching();
      else renderMeaning();
    }

    function advanceStepOrFinish() {
      if (state.currentStep < 3) {
        state.currentStep += 1;
        renderCurrentStep();
        return;
      }
      showFeedback("Round complete!", "Nice work. Click Next Round to continue.", true, () => {
        show(el.nextBtn);
      });
    }

    function startNewRound() {
      if (!QUESTION_BANK.length) {
        alert("QUESTION_BANK is empty.");
        return;
      }
      state.currentBundle = QUESTION_BANK[Math.floor(Math.random() * QUESTION_BANK.length)];
      state.stepPlan = pickStepPlan();
      state.currentStep = 1;
      renderCurrentStep();
    }

    /* =========================================================
       TEACHER + STATS
    ========================================================= */
    function openTeacherLogin() {
      show(el.teacherLogin);
      if (el.teacherCodeInput) el.teacherCodeInput.value = "";
      el.teacherCodeInput?.focus();
    }
    function closeTeacherLogin() { hide(el.teacherLogin); }

    function openTeacherPanel() {
      hide(el.teacherLogin);
      show(el.teacherPanel);
      if (el.autoNextToggle) el.autoNextToggle.checked = state.autoNext;
      if (el.musicToggle) el.musicToggle.checked = state.musicOn;
      if (el.sfxToggle) el.sfxToggle.checked = state.sfxOn;
    }
    function closeTeacherPanel() { hide(el.teacherPanel); }

    function teacherSubmit() {
      const code = (el.teacherCodeInput?.value || "").trim();
      if (code === "1362") {
        openTeacherPanel();
      } else {
        el.teacherCodeInput?.classList.remove("shake");
        void el.teacherCodeInput?.offsetWidth;
        el.teacherCodeInput?.classList.add("shake");
      }
    }

    async function sendStatsNow() {
      const payload = {
        studentName: state.studentName,
        summary: {
          studentName: state.studentName,
          score: state.score,
          streak: state.streak,
          bestStreak: state.bestStreak,
          weakAreas: state.weakAreas,
          sentAt: nowISO()
        },
        log: state.log
      };

      if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("PASTE_")) {
        alert("Add your GOOGLE_SCRIPT_URL in the script before sending stats.");
        return;
      }

      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        alert("Stats sent successfully âœ…");
      } catch (err) {
        console.error(err);
        alert("Failed to send stats. Check Apps Script URL + permissions.");
      }
    }

    function resetGame() {
      state.score = 0;
      state.streak = 0;
      state.weakAreas = {};
      state.log = [];
      state.currentBundle = null;
      state.currentStep = 1;
      state.stepPlan = [];

      setHUD();
      setSentence("Sentence will appear here");
      setPrompt("What is the speaker's intended meaning?");
      if (el.stepLabel) el.stepLabel.textContent = "Step 1/3";
      clearOptions();
      hide(el.nextBtn);
    }

    /* =========================================================
       EVENTS
    ========================================================= */
    function wireEvents() {
      el.startNameBtn?.addEventListener("click", () => {
        const name = (el.studentNameInput?.value || "").trim();
        if (!name) { alert("Please enter your name."); return; }
        state.studentName = name;

        hide(el.nameScreen);
        show(el.gameScreen);

        setHUD();
        syncMusic();
        startNewRound();
      });

      el.studentNameInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") el.startNameBtn?.click();
      });

      el.nextBtn?.addEventListener("click", startNewRound);

      // Teacher
      el.teacherBtn?.addEventListener("click", openTeacherLogin);
      el.closeTeacherLogin?.addEventListener("click", closeTeacherLogin);
      el.teacherCodeBtn?.addEventListener("click", teacherSubmit);
      el.teacherCodeInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") teacherSubmit();
        if (e.key === "Escape") closeTeacherLogin();
      });

      el.teacherLogin?.addEventListener("click", (e) => {
        if (e.target === el.teacherLogin) closeTeacherLogin();
      });

      el.teacherStartBtn?.addEventListener("click", startNewRound);
      el.teacherResetBtn?.addEventListener("click", resetGame);

      el.autoNextToggle?.addEventListener("change", (e) => {
        state.autoNext = !!e.target.checked;
        savePrefs();
      });

      el.musicToggle?.addEventListener("change", (e) => {
        state.musicOn = !!e.target.checked;
        savePrefs();
        syncMusic();
      });

      el.sfxToggle?.addEventListener("change", (e) => {
        state.sfxOn = !!e.target.checked;
        savePrefs();
      });

      el.sendStatsBtn?.addEventListener("click", sendStatsNow);
      el.closeTeacherPanel?.addEventListener("click", closeTeacherPanel);

      el.teacherPanel?.addEventListener("click", (e) => {
        if (e.target === el.teacherPanel) closeTeacherPanel();
      });
    }

    /* =========================================================
       18) INIT
       Loads preferences, syncs music, sets HUD, wires events.
    ========================================================= */
    function init() {
      loadPrefs();
      if (el.autoNextToggle) el.autoNextToggle.checked = state.autoNext;
      if (el.musicToggle) el.musicToggle.checked = state.musicOn;
      if (el.sfxToggle) el.sfxToggle.checked = state.sfxOn;

      syncMusic();
      setHUD();
      wireEvents();
    }

    // Start the engine
    init();

  })();
  </script>
</body>
</html>



