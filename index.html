<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Future Grammar Mastery ‚Äî Lively Blue (No Gradients) + Easy/Hard + Pause + Sheets</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      /* ====== BASE (no gradients) ====== */
      --bg:#073B6F;         /* page background */
      --panel:#0B4C8C;      /* panels */
      --card:#082F57;       /* main card */
      --surface:#062846;    /* inner surfaces */
      --ink:#ffffff;
      --muted:rgba(255,255,255,.78);
      --stroke:rgba(255,255,255,.18);
      --shadow:0 10px 22px rgba(0,0,0,.28);

      /* ====== FUN ACCENTS (flat colors) ====== */
      --cyan:#2FE6FF;
      --mint:#6BFFCF;
      --yellow:#FFD166;
      --orange:#FF9F1C;
      --pink:#FF4DAB;
      --purple:#9B5CFF;
      --lime:#B6FF4D;
      --red:#FF4D6D;

      --btnTextDark:#06131f;
      --bar:#031C33;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .app{
      max-width:980px;
      margin:0 auto;
      padding:14px 14px 26px;
    }

    header{
      text-align:center;
      margin-bottom:10px;
    }
    h1{
      margin:0;
      font-size:2rem;
      font-weight:900;
      letter-spacing:.2px;
    }
    header p{
      margin:6px 0 10px;
      font-weight:800;
      opacity:.95;
    }

    /* ===== top controls layout ===== */
    .topControls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      align-items:stretch;
      margin-top:8px;
    }

    .nameBox{
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:var(--shadow);
      min-width:290px;
      justify-content:center;
    }
    .nameBox span{ font-weight:900; }
    .nameBox input{
      border:none;
      outline:none;
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      font-weight:900;
      min-width:180px;
    }

    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      align-items:center;
    }

    .btn{
      border:none;
      border-radius:16px;
      padding:12px 18px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.05); }
    .btn:active{ transform:translateY(0px) scale(.99); }

    /* flat button colors (no gradients) */
    .bStart{ background:var(--mint); color:var(--btnTextDark); }
    .bMusic{ background:var(--cyan); color:var(--btnTextDark); }
    .bLevel{ background:var(--yellow); color:#2b1500; }
    .bPause{ background:var(--purple); color:#13002b; }
    .bExit{ background:var(--red); color:#fff; }
    .bReset{ background:var(--orange); color:#2b1500; }

    .btn.small{ padding:10px 14px; font-size:.95rem; border-radius:14px; }

    .warning{
      margin-top:8px;
      min-height:18px;
      font-weight:900;
      color:#ffe3e3;
    }

    /* ===== stats row ===== */
    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
      justify-content:center;
      margin:12px 0 12px;
    }
    .stat{
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      min-width:150px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .stat .label{
      font-size:.82rem;
      font-weight:900;
      opacity:.95;
    }
    .stat .value{
      font-size:1.07rem;
      font-weight:900;
      margin-top:2px;
    }

    .progressWrap{
      flex:1;
      min-width:260px;
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .progressWrap .label{
      text-align:left;
      font-size:.82rem;
      font-weight:900;
      opacity:.95;
    }
    .bar{
      margin-top:8px;
      height:22px;
      background:var(--bar);
      border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(47,230,255,.55);
    }
    .fill{
      height:100%;
      width:0%;
      background:var(--lime);
      transition:width .25s ease;
    }

    /* ===== main game card ===== */
    .card{
      background:var(--card);
      border:2px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      box-shadow:0 14px 26px rgba(0,0,0,.32);
    }

    .miniTypeWrap{ text-align:center; }
    .miniType{
      display:inline-block;
      margin:0 auto 10px;
      padding:7px 14px;
      border-radius:999px;
      font-weight:900;
      background:var(--surface);
      border:2px solid rgba(255,255,255,.12);
    }

    .sentenceBox{
      display:flex;
      justify-content:center;
      margin: 10px 0 14px;
    }
    .sentenceBig{
      width:100%;
      background:var(--surface);
      border:3px solid rgba(47,230,255,.55);
      border-radius:18px;
      padding:18px 16px;
      font-weight:900;
      font-size:1.55rem;
      line-height:1.25;
      text-align:center;
      user-select:none;
    }

    @media (max-width:680px){
      h1{ font-size:1.65rem; }
      .sentenceBig{ font-size:1.22rem; padding:16px 14px; }
      .nameBox{ min-width:0; width:100%; }
    }

    /* ORDER (built words) */
    .interaction{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      min-height:52px;
      padding-bottom:10px;
      border-bottom:2px solid rgba(47,230,255,.22);
      margin-bottom:12px;
    }
    .word-bank{
      background:var(--surface);
      border:2px solid rgba(255,255,255,.12);
      padding:14px;
      border-radius:16px;
      min-height:58px;
    }
    .wordItem{
      display:inline-block;
      background:#ffffff;
      color:#000;
      border:2px solid rgba(0,0,0,.18);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      margin:0 10px 10px 0;
      user-select:none;
    }
    .builtWord{
      background:#0A3A66;
      color:#fff;
      border:2px solid rgba(255,255,255,.14);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      user-select:none;
    }

    /* Cards area */
    .cards{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:8px;
    }
    @media (max-width:680px){
      .cards{ grid-template-columns:1fr; }
    }

    .cardBtn{
      border:none;
      border-radius:18px;
      padding:16px 16px;
      cursor:pointer;
      font-weight:900;
      font-size:1.08rem;
      box-shadow:0 10px 18px rgba(0,0,0,.25);
      border:3px solid rgba(255,255,255,.14);
      text-align:left;
      transition:transform .12s ease, filter .12s ease;
      min-height:86px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      user-select:none;
      color:#06131f;
    }
    .cardBtn:hover{ transform:translateY(-1px); filter:brightness(1.04); }

    .cardTitle{ font-size:1.14rem; font-weight:900; }
    .cardDesc{ font-size:.92rem; font-weight:800; opacity:.92; }

    /* flat palettes for option cards (no gradients) */
    .pal0{ background:var(--cyan); }
    .pal1{ background:var(--yellow); }
    .pal2{ background:var(--mint); }
    .pal3{ background:var(--pink); color:#210013; }
    .pal4{ background:var(--purple); color:#120018; }
    .pal5{ background:var(--lime); }

    .feedback{
      margin-top:12px;
      min-height:28px;
      text-align:center;
      font-weight:900;
      font-size:1.05rem;
    }
    .ok{ color:var(--mint); }
    .no{ color:#ffd1d1; }

    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      margin:10px 0 0;
      opacity:.95;
    }
    .pill{
      background:var(--panel);
      border:2px solid var(--stroke);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 8px 18px rgba(0,0,0,.20);
    }
    .pill b{ color:var(--cyan); }

    .hidden{ display:none !important; }

    /* ===== overlays (pause / exit confirm) ===== */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      padding:16px;
      z-index:50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      background:var(--panel);
      border:2px solid rgba(255,255,255,.16);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 34px rgba(0,0,0,.45);
      text-align:center;
    }
    .modal h2{ margin:0 0 6px; font-size:1.35rem; }
    .modal p{ margin:0 0 14px; font-weight:800; color:var(--muted); }
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <!-- AUDIO -->
  <audio id="bgm" loop preload="auto">
    <source src="audio/koala2.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound" preload="auto">
    <source src="audio/tadaa.mp3" type="audio/mpeg">
  </audio>

  <div class="app">
    <header>
      <h1>Future Grammar Mastery</h1>
      <p>Mix: ORDER ‚Ä¢ TENSE ‚Ä¢ MEANING ‚Äî reach 25 correct in a row.</p>

      <div class="topControls">
        <div class="nameBox">
          <span>Name:</span>
          <input id="playerName" type="text" placeholder="Enter your name">
        </div>

        <div class="btnRow">
          <button class="btn bStart" id="startBtn" type="button">Start</button>
          <button class="btn bMusic" id="musicBtn" type="button">Music: OFF</button>
          <button class="btn bLevel" id="levelBtn" type="button">Level: EASY</button>
          <button class="btn bPause" id="pauseBtn" type="button" disabled>Pause</button>
          <button class="btn bReset" id="resetBtn" type="button">Reset</button>
          <button class="btn bExit" id="exitBtn" type="button">Exit</button>
        </div>
      </div>

      <div class="warning" id="nameWarning"></div>

      <div class="metaRow">
        <div class="pill">Attempts: <b id="attemptsPill">0</b></div>
        <div class="pill">Most failed: <b id="mostFailedPill">‚Äî</b></div>
        <div class="pill">Current type: <b id="typePill">‚Äî</b></div>
      </div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="label">Player</div>
        <div class="value" id="displayName">---</div>
      </div>

      <div class="stat">
        <div class="label">Streak</div>
        <div class="value"><span id="streak">0</span> / 25</div>
      </div>

      <div class="progressWrap">
        <div class="label">Progress</div>
        <div class="bar"><div class="fill" id="progressFill"></div></div>
      </div>

      <div class="stat">
        <div class="label">Time</div>
        <div class="value" id="timerDisplay">00:00</div>
      </div>
    </div>

    <div class="card">
      <div class="miniTypeWrap"><span class="miniType" id="miniType">Ready</span></div>

      <div class="sentenceBox hidden" id="sentenceBox">
        <div class="sentenceBig" id="sentenceBig"></div>
      </div>

      <div class="interaction hidden" id="interaction"></div>
      <div id="cardsArea" class="cards hidden"></div>
      <div class="word-bank hidden" id="wordBank"></div>

      <div class="feedback" id="feedback"></div>

      <div class="actions hidden" id="orderActions">
        <button class="btn bReset small" id="clearBtn" type="button">Clear</button>
        <button class="btn bLevel small" id="checkBtn" type="button">Check</button>
      </div>
    </div>
  </div>

  <!-- PAUSE OVERLAY -->
  <div class="overlay" id="pauseOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Paused">
      <h2>‚è∏ Paused</h2>
      <p>Press Resume to continue.</p>
      <div class="modalActions">
        <button class="btn bStart" id="resumeBtn" type="button">Resume</button>
        <button class="btn bReset" id="pauseResetBtn" type="button">Reset</button>
        <button class="btn bExit" id="pauseExitBtn" type="button">Exit</button>
      </div>
    </div>
  </div>

  <!-- EXIT CONFIRM OVERLAY -->
  <div class="overlay" id="exitOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Exit confirm">
      <h2>Exit game?</h2>
      <p>Your current streak will be lost.</p>
      <div class="modalActions">
        <button class="btn bStart" id="stayBtn" type="button">Stay</button>
        <button class="btn bExit" id="confirmExitBtn" type="button">Exit</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   GOOGLE SHEETS (INTEGRATED)
============================ */
const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";

/* Put SAME secret in Apps Script SECRET_KEY */
const SECRET_KEY = "CHANGE_ME_TO_SOMETHING_PRIVATE";

async function sendToSheet(payload){
  const body = {
    secret: SECRET_KEY,
    name: String(payload.name || ""),
    time_s: Number(payload.time_s || 0),
    attempts: Number(payload.attempts || 0),
    most_failed_category: String(payload.most_failed_category || ""),
    activity_type: String(payload.activity_type || ""),
    sentence: String(payload.sentence || ""),
    level: String(payload.level || "")
  };
  try{
    await fetch(SHEET_ENDPOINT, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
  }catch(err){
    console.error("Sheets send error:", err);
  }
}

/* ===========================================================
   BANK (same as previous version you had)
=========================================================== */
const BANK = [
  /* PRESENT SIMPLE (schedule) */
  { text:"The train leaves at 8:10 tomorrow.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"School starts at 9 o‚Äôclock on Monday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The concert begins at 7 p.m. on Friday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The museum closes at 6 p.m.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"Does the match start at noon?", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The bus arrives at 7:35 tomorrow morning.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The flight lands at 5:20 p.m. on Tuesday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The library opens at 8:30 a.m. every weekday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The exam starts at 10:00 a.m. on Thursday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The show ends at 9:45 tonight.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The ferry departs at 2 p.m. tomorrow.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The shop opens at 9 a.m. on Saturdays.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The meeting begins at 3:00 p.m. sharp.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The lesson finishes at 1:30 today.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The train to London leaves at 6:05.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The gates open at 6 p.m. for the concert.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The results come out next Friday at noon.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The ceremony starts at 11:15 a.m. tomorrow.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The class begins after the break at 11:00.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The last bus leaves at 11:50 tonight.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The restaurant opens at 12, not at 11.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The conference starts on Monday at 9 a.m.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"The train does not stop here at night.", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"Does your flight depart at 6:40?", form:"present_simple", intent:"schedule", diff:"hard" },
  { text:"What time does the movie start tonight?", form:"present_simple", intent:"schedule", diff:"hard" },

  /* PRESENT CONTINUOUS (arrangement) */
  { text:"I‚Äôm meeting my friends at 6 p.m.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"We‚Äôre having dinner together tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"She‚Äôs seeing the dentist on Friday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"They‚Äôre coming over for lunch tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you visiting your grandma this weekend?", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"I‚Äôm flying to Madrid on Saturday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"We‚Äôre studying together after school.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"He‚Äôs playing basketball this evening.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"I‚Äôm not working tomorrow; I‚Äôm taking the day off.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"We‚Äôre not meeting on Monday‚Äîwe‚Äôre meeting on Tuesday.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"She‚Äôs staying at her cousin‚Äôs house this weekend.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"They‚Äôre having a party next Saturday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you coming to the library at 4?", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"I‚Äôm having a driving lesson tomorrow morning.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"We‚Äôre going to the cinema tonight.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"He‚Äôs seeing his coach after practice.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"I‚Äôm meeting the principal at 9 a.m. tomorrow.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"We‚Äôre doing a class presentation next week.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"She‚Äôs not coming with us this time.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"They‚Äôre having lunch with their grandparents tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"I‚Äôm seeing the doctor at 3:30.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"We‚Äôre leaving early tomorrow morning.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you joining the club next term?", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"He‚Äôs not playing today; he‚Äôs resting.", form:"present_continuous", intent:"arrangement", diff:"hard" },
  { text:"I‚Äôm meeting her after the meeting ends.", form:"present_continuous", intent:"arrangement", diff:"hard" },

  /* WILL */
  { text:"I think it will rain later.", form:"will", intent:"prediction", diff:"easy" },
  { text:"They will probably win the match.", form:"will", intent:"prediction", diff:"easy" },
  { text:"Maybe we will have a test tomorrow.", form:"will", intent:"prediction", diff:"easy" },
  { text:"Don‚Äôt worry, I‚Äôll help you.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"I won‚Äôt tell anyone. I promise.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"Okay, I‚Äôll do it now.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"Wait‚ÄîI‚Äôll message her right now.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"The results will be published tomorrow.", form:"will", intent:"announcement", diff:"hard" },
  { text:"The show will start in five minutes.", form:"will", intent:"announcement", diff:"easy" },
  { text:"I‚Äôm sure you‚Äôll enjoy the film.", form:"will", intent:"prediction", diff:"easy" },
  { text:"I don‚Äôt think he‚Äôll be late.", form:"will", intent:"prediction", diff:"easy" },
  { text:"She‚Äôll pass the exam‚Äîshe studied a lot.", form:"will", intent:"prediction", diff:"hard" },
  { text:"I‚Äôll carry that for you.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"I‚Äôll call you tonight, I promise.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"We‚Äôll see what happens.", form:"will", intent:"prediction", diff:"hard" },
  { text:"I‚Äôll have the chicken salad, please.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"I‚Äôll open the window.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"The teacher will explain the rules again.", form:"will", intent:"announcement", diff:"hard" },
  { text:"The new timetable will be posted on Monday.", form:"will", intent:"announcement", diff:"hard" },
  { text:"I‚Äôll help you with your homework after dinner.", form:"will", intent:"offer_promise", diff:"hard" },
  { text:"I think they‚Äôll move to another city.", form:"will", intent:"prediction", diff:"easy" },
  { text:"We‚Äôll start the lesson in two minutes.", form:"will", intent:"announcement", diff:"easy" },
  { text:"I‚Äôll get it! (The phone is ringing.)", form:"will", intent:"decision_now", diff:"easy" },
  { text:"I won‚Äôt forget your birthday.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"They‚Äôll probably arrive after 9.", form:"will", intent:"prediction", diff:"easy" },
  { text:"The principal will make an announcement at noon.", form:"will", intent:"announcement", diff:"hard" },
  { text:"I‚Äôll send you the file right now.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"I‚Äôll be there at 5, I promise.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"I don‚Äôt think it‚Äôll snow in April.", form:"will", intent:"prediction", diff:"hard" },

  /* GOING TO */
  { text:"I‚Äôm going to study tonight.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"We‚Äôre going to meet after school.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Are you going to watch the new episode?", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Look at those clouds! It‚Äôs going to rain.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"That glass is going to fall!", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"You‚Äôre going to miss the bus‚Äîrun!", form:"going_to", intent:"evidence_prediction", diff:"hard" },
  { text:"I‚Äôm going to buy a new backpack this weekend.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"She‚Äôs going to visit her aunt tomorrow.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"We‚Äôre going to practice for the test after class.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"They‚Äôre going to paint the classroom next month.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Are you going to join the football team?", form:"going_to", intent:"plan", diff:"easy" },
  { text:"He isn‚Äôt going to eat junk food anymore.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Watch out! You‚Äôre going to drop your phone.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"That bike is going to crash if you don‚Äôt slow down!", form:"going_to", intent:"evidence_prediction", diff:"hard" },
  { text:"Look! The cat is going to jump on the table.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"I‚Äôm going to start a new project next week.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"We‚Äôre going to take a trip in June.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"She‚Äôs going to study medicine at university.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"They‚Äôre going to organize a fundraiser soon.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"That chair is going to break! Don‚Äôt sit on it.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"I‚Äôm not going to be late tomorrow.", form:"going_to", intent:"plan", diff:"hard" },
  { text:"Are we going to finish this today?", form:"going_to", intent:"plan", diff:"hard" },
  { text:"He‚Äôs going to forget his keys again‚Äîhe always does.", form:"going_to", intent:"evidence_prediction", diff:"hard" },
  { text:"Look at the score‚Äîwe‚Äôre going to win!", form:"going_to", intent:"evidence_prediction", diff:"easy" },

  /* FIRST CONDITIONAL */
  { text:"If you don‚Äôt study, you‚Äôll fail the test.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you feel tired, take a break.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If it rains, we‚Äôll stay at home.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If she studies, she‚Äôll do well.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you hurry, you‚Äôll catch the bus.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you don‚Äôt sleep, you‚Äôll feel awful tomorrow.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you need help, I‚Äôll explain it again.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If the teacher is free, we‚Äôll ask a question.", form:"first_conditional", intent:"plan_condition", diff:"hard" },
  { text:"If you practise every day, you‚Äôll improve fast.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you keep talking, you‚Äôll get in trouble.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you don‚Äôt understand, ask me.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If it‚Äôs sunny, we‚Äôll play outside.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If you forget your homework, you‚Äôll lose points.", form:"first_conditional", intent:"warning_consequence", diff:"hard" },
  { text:"If she arrives early, we‚Äôll start right away.", form:"first_conditional", intent:"plan_condition", diff:"hard" },
  { text:"If they study tonight, they‚Äôll pass tomorrow.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you don‚Äôt charge your phone, it‚Äôll die.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you want, we‚Äôll work together after school.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If the bus is late, we‚Äôll take a taxi.", form:"first_conditional", intent:"plan_condition", diff:"hard" },
  { text:"If you eat better, you‚Äôll feel stronger.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you don‚Äôt listen, you‚Äôll miss the instructions.", form:"first_conditional", intent:"warning_consequence", diff:"hard" },
  { text:"If you feel stressed, breathe slowly.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If it gets cold, we‚Äôll go inside.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If you‚Äôre late again, you‚Äôll have detention.", form:"first_conditional", intent:"warning_consequence", diff:"hard" },
  { text:"If he studies harder, he‚Äôll get better marks.", form:"first_conditional", intent:"prediction_result", diff:"easy" }
];

const TENSE_OPTIONS = [
  { key:"present_simple", label:"Present Simple", desc:"Schedules / timetables" },
  { key:"present_continuous", label:"Present Continuous", desc:"Arrangements / plans" },
  { key:"will", label:"Future (will)", desc:"Prediction / decision / promise" },
  { key:"going_to", label:"Be going to", desc:"Plan / evidence prediction" },
  { key:"first_conditional", label:"First Conditional", desc:"If + present, will..." }
];

const MEANING_OPTIONS = {
  will: [
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"offer_promise", label:"Offer / Promise", desc:"Help / promise" },
    { key:"decision_now", label:"Decision now", desc:"Made right now" },
    { key:"announcement", label:"Announcement", desc:"Official info" },
    { key:"plan", label:"Plan", desc:"Already decided" },
    { key:"evidence_prediction", label:"Evidence prediction", desc:"Look! evidence" }
  ],
  going_to: [
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"evidence_prediction", label:"Prediction (evidence)", desc:"Look! / evidence" },
    { key:"announcement", label:"Announcement", desc:"Official info" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"decision_now", label:"Decision now", desc:"Made right now" },
    { key:"schedule", label:"Schedule", desc:"Timetable time" }
  ],
  present_simple: [
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" },
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"announcement", label:"Announcement", desc:"Official info" },
    { key:"warning_consequence", label:"Warning", desc:"Bad result" }
  ],
  present_continuous: [
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" },
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"announcement", label:"Announcement", desc:"Official info" },
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion" }
  ],
  first_conditional: [
    { key:"warning_consequence", label:"Warning", desc:"Bad result" },
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion" },
    { key:"plan_condition", label:"Plan", desc:"If X, we do Y" },
    { key:"prediction_result", label:"Prediction", desc:"If X, Y happens" },
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" }
  ]
};

/* ===========================================================
   Game state
=========================================================== */
let running = false;
let paused = false;
let musicOn = false;
let level = "easy";              // easy | hard

let currentType = "";
let currentQ = null;
let tokens = [];                 // strings
let built = [];                  // strings only => fixes {object Object}

let streak = 0;
const masteryGoal = 25;
let attempts = 0;
const wrongCounts = { ORDER:0, TENSE:0, MEANING:0 };

let startTime = null;
let timerInterval = null;

/* ===========================================================
   Helpers
=========================================================== */
const $ = (id)=>document.getElementById(id);

function playerName(){
  const n = $("playerName").value.trim();
  return n || "‚Äî";
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function formatTime(ms){
  const s = Math.floor(ms/1000);
  const m = String(Math.floor(s/60)).padStart(2,"0");
  const r = String(s%60).padStart(2,"0");
  return `${m}:${r}`;
}
function secondsElapsed(){
  if(!startTime) return 0;
  return Math.floor((Date.now()-startTime)/1000);
}

function updateTimer(){
  $("timerDisplay").textContent = startTime ? formatTime(Date.now()-startTime) : "00:00";
}
function startTimer(){
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{ if(running && !paused) updateTimer(); }, 500);
}
function stopTimer(){
  clearInterval(timerInterval);
  timerInterval = null;
}

function mostFailedCategory(){
  const entries = Object.entries(wrongCounts).sort((a,b)=>b[1]-a[1]);
  if(entries[0][1]===0) return "‚Äî";
  return entries[0][0];
}

function updateStats(){
  $("displayName").textContent = playerName();
  $("streak").textContent = String(streak);

  const pct = Math.max(0, Math.min(100, (streak / masteryGoal) * 100));
  $("progressFill").style.width = pct + "%";

  $("attemptsPill").textContent = String(attempts);
  $("typePill").textContent = currentType || "‚Äî";
  $("mostFailedPill").textContent = mostFailedCategory() || "‚Äî";
}

function setMiniType(txt){ $("miniType").textContent = txt; }

function setFeedback(text, ok=null){
  const fb = $("feedback");
  fb.textContent = text || "";
  fb.className = "feedback";
  if(ok===true) fb.classList.add("ok");
  if(ok===false) fb.classList.add("no");
}

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function resetView(){
  setFeedback("");
  hide($("sentenceBox"));
  hide($("interaction"));
  hide($("cardsArea"));
  hide($("wordBank"));
  hide($("orderActions"));

  $("cardsArea").innerHTML = "";
  $("wordBank").innerHTML = "";
  $("interaction").innerHTML = "";
}

function pickPaletteClass(i){
  const pals = ["pal0","pal1","pal2","pal3","pal4","pal5"];
  return pals[i % pals.length];
}

/* ============================
   Google Sheets (same endpoint)
============================ */
const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";
const SECRET_KEY = "CHANGE_ME_TO_SOMETHING_PRIVATE";

async function sendToSheet(payload){
  const body = {
    secret: SECRET_KEY,
    name: String(payload.name || ""),
    time_s: Number(payload.time_s || 0),
    attempts: Number(payload.attempts || 0),
    most_failed_category: String(payload.most_failed_category || ""),
    activity_type: String(payload.activity_type || ""),
    sentence: String(payload.sentence || ""),
    level: String(payload.level || "")
  };
  try{
    await fetch(SHEET_ENDPOINT, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
  }catch(err){
    console.error("Sheets send error:", err);
  }
}

/* ============================
   Difficulty rules
============================ */
function bankForLevel(){
  if(level==="easy"){
    return BANK.filter(q => q.diff!=="hard" && q.text.split(" ").length <= 10);
  }
  return BANK.slice();
}
function typeMixForLevel(){
  // easy: more ORDER + TENSE
  // hard: more TENSE + MEANING
  return (level==="easy")
    ? ["ORDER","ORDER","TENSE","TENSE","MEANING"]
    : ["ORDER","TENSE","TENSE","MEANING","MEANING"];
}

/* ============================
   Music
============================ */
function toggleMusic(){
  const bgm = $("bgm");
  bgm.volume = 0.35;

  if(!musicOn){
    const p = bgm.play();
    if(p && p.then){
      p.then(()=>{ musicOn = true; $("musicBtn").textContent="Music: ON"; })
       .catch(()=>{ musicOn = false; $("musicBtn").textContent="Music: OFF"; });
    } else {
      musicOn = true; $("musicBtn").textContent="Music: ON";
    }
  } else {
    bgm.pause();
    musicOn = false;
    $("musicBtn").textContent="Music: OFF";
  }
}

/* ============================
   Start / Reset / Exit
============================ */
function startGame(){
  const name = $("playerName").value.trim();
  if(!name){
    $("nameWarning").textContent = "Please enter your name before starting.";
    return;
  }
  $("nameWarning").textContent = "";

  running = true;
  paused = false;

  streak = 0;
  attempts = 0;
  wrongCounts.ORDER=0; wrongCounts.TENSE=0; wrongCounts.MEANING=0;

  $("pauseBtn").disabled = false;
  $("pauseBtn").textContent = "Pause";

  resetView();
  updateStats();
  updateTimer();
  startTimer();

  nextQuestion();
}

function resetGame(){
  running = false;
  paused = false;

  stopTimer();
  startTime = null;
  updateTimer();

  streak = 0;
  attempts = 0;
  wrongCounts.ORDER=0; wrongCounts.TENSE=0; wrongCounts.MEANING=0;

  currentType = "";
  currentQ = null;
  tokens = [];
  built = [];

  $("pauseBtn").disabled = true;
  $("pauseBtn").textContent = "Pause";

  resetView();
  setMiniType("Ready");
  updateStats();

  // stop audio
  try{
    $("bgm").pause();
    $("bgm").currentTime = 0;
  }catch(e){}
  musicOn = false;
  $("musicBtn").textContent = "Music: OFF";

  closePause();
  closeExitConfirm();
  setFeedback("Reset.", true);
}

function openExitConfirm(){
  $("exitOverlay").classList.add("show");
  $("exitOverlay").setAttribute("aria-hidden","false");
}
function closeExitConfirm(){
  $("exitOverlay").classList.remove("show");
  $("exitOverlay").setAttribute("aria-hidden","true");
}
function confirmExit(){
  // "Exit" returns to ready state (doesn't close the tab)
  resetGame();
}

function toggleLevel(){
  level = (level==="easy") ? "hard" : "easy";
  $("levelBtn").textContent = "Level: " + level.toUpperCase();
  setFeedback("Level set to " + level.toUpperCase() + ".", true);

  // if game running, immediately go to next question with new difficulty
  if(running && !paused) nextQuestion();
}

/* ============================
   Pause / Resume
============================ */
function openPause(){
  paused = true;
  $("pauseOverlay").classList.add("show");
  $("pauseOverlay").setAttribute("aria-hidden","false");
  $("pauseBtn").textContent = "Resume";
  if(musicOn) $("bgm").pause();
}
function closePause(){
  $("pauseOverlay").classList.remove("show");
  $("pauseOverlay").setAttribute("aria-hidden","true");
}
function resumeGame(){
  if(!running) return;
  paused = false;
  closePause();
  $("pauseBtn").textContent = "Pause";
  if(musicOn) $("bgm").play().catch(()=>{});
}
function pauseToggle(){
  if(!running) return;
  if(paused) resumeGame();
  else openPause();
}

/* ============================
   Next question
============================ */
function nextQuestion(){
  if(!running || paused) return;

  built = [];
  resetView();

  const mix = typeMixForLevel();
  currentType = mix[Math.floor(Math.random()*mix.length)];

  const pool = bankForLevel();
  currentQ = pool[Math.floor(Math.random()*pool.length)];
  tokens = currentQ.text.split(" "); // strings only

  updateStats();

  if(currentType==="ORDER"){
    setMiniType(level==="hard" ? "Order words (HARD)" : "Order words");
    renderOrder();
    return;
  }
  if(currentType==="TENSE"){
    setMiniType(level==="hard" ? "Verb tense (HARD)" : "Verb tense");
    showSentence(currentQ.text);
    renderTenseCards(currentQ.form);
    return;
  }

  setMiniType(level==="hard" ? "Speaker meaning (HARD)" : "Speaker meaning");
  showSentence(currentQ.text);
  renderMeaningCards(currentQ.form, currentQ.intent);
}

function showSentence(text){
  $("sentenceBig").textContent = text;
  show($("sentenceBox"));
}

/* ============================
   ORDER (fixes {object Object} by storing strings)
============================ */
function renderOrder(){
  const interaction = $("interaction");
  const bank = $("wordBank");

  show(interaction);
  show(bank);
  show($("orderActions"));

  bank.innerHTML = "";
  const words = shuffle(tokens);

  words.forEach((w)=>{
    const b = document.createElement("span");
    b.className = "wordItem";
    b.textContent = w;
    b.onclick = ()=>{
      if(!running || paused) return;
      built.push(w);
      b.style.display = "none";
      renderBuiltWords();
    };
    bank.appendChild(b);
  });

  renderBuiltWords();
}

function renderBuiltWords(){
  const area = $("interaction");
  area.innerHTML = "";

  built.forEach((w,i)=>{
    const chip = document.createElement("span");
    chip.className = "builtWord";
    chip.textContent = w;
    chip.onclick = ()=>{
      if(!running || paused) return;
      const removed = built.splice(i,1)[0];
      const kids = Array.from($("wordBank").children);
      for(const el of kids){
        if(el.textContent===removed && el.style.display==="none"){
          el.style.display = "inline-block";
          break;
        }
      }
      renderBuiltWords();
    };
    area.appendChild(chip);
  });
}

function clearWords(){
  if(!running || paused) return;
  built = [];
  renderBuiltWords();
  Array.from($("wordBank").children).forEach(el=> el.style.display="inline-block");
}

function normalizeLoose(s){
  return String(s)
    .trim()
    .replace(/\s+/g," ")
    .replace(/[‚Äú‚Äù]/g,'"')
    .replace(/[‚Äô]/g,"'")
    .replace(/[!?.,:;]+/g,"")
    .toLowerCase();
}
function normalizeStrict(s){
  return String(s).trim().replace(/\s+/g," ");
}
function checkOrder(){
  if(!currentQ || !running || paused) return;
  const attempt = built.join(" ");
  const ok = (level==="hard")
    ? (normalizeStrict(attempt) === normalizeStrict(currentQ.text))
    : (normalizeLoose(attempt) === normalizeLoose(currentQ.text));
  grade(ok, { activity:"ORDER", sentence: currentQ.text });
}

/* ============================
   TENSE
============================ */
function renderTenseCards(correctForm){
  const cards = $("cardsArea");
  show(cards);
  cards.innerHTML = "";

  const want = (level==="hard") ? 6 : 4;

  const pool = shuffle([...TENSE_OPTIONS]);
  const correct = pool.find(x=>x.key===correctForm) || TENSE_OPTIONS[0];
  const others = pool.filter(x=>x.key!==correctForm).slice(0, want-1);
  const options = shuffle([correct, ...others]);

  options.forEach((o, idx)=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn " + pickPaletteClass(idx);
    btn.innerHTML = `<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick = ()=>{ if(running && !paused) grade(o.key===correctForm, { activity:"TENSE", sentence: currentQ.text }); };
    cards.appendChild(btn);
  });
}

/* ============================
   MEANING
============================ */
function renderMeaningCards(form, correctIntent){
  const cards = $("cardsArea");
  show(cards);
  cards.innerHTML = "";

  const all = (MEANING_OPTIONS[form] || []).slice();
  const want = (level==="hard") ? 6 : 4;

  let options = all.filter(x=>x.key===correctIntent);
  const distractors = shuffle(all.filter(x=>x.key!==correctIntent)).slice(0, Math.max(0, want-1));
  options = shuffle(options.concat(distractors)).slice(0, want);

  options.forEach((o, idx)=>{
    const btn = document.createElement("button");
    btn.className = "cardBtn " + pickPaletteClass(idx);
    btn.innerHTML = `<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick = ()=>{ if(running && !paused) grade(o.key===correctIntent, { activity:"MEANING", sentence: currentQ.text, correctIntent }); };
    cards.appendChild(btn);
  });
}

function prettyIntent(key){
  return (key||"").replaceAll("_"," ").toUpperCase();
}

/* ============================
   Grade + Google Sheets
============================ */
function grade(correct, info){
  if(!running || paused) return;

  attempts++;
  const activity = (info && info.activity) ? info.activity : currentType;
  const sentence = (info && info.sentence) ? info.sentence : (currentQ ? currentQ.text : "");

  if(correct){
    setFeedback("‚úÖ Correct!", true);
    streak++;
    updateStats();

    sendToSheet({
      name: playerName(),
      time_s: secondsElapsed(),
      attempts,
      most_failed_category: mostFailedCategory(),
      activity_type: activity,
      sentence,
      level
    });

    if(streak >= masteryGoal){
      try{ $("winSound").play().catch(()=>{}); }catch(e){}
      setFeedback("üèÜ Mastery! 25 in a row!", true);
      running = false;
      $("pauseBtn").disabled = true;
      return;
    }
    setTimeout(nextQuestion, 550);
  } else {
    streak = 0;
    if(activity==="ORDER") wrongCounts.ORDER++;
    if(activity==="TENSE") wrongCounts.TENSE++;
    if(activity==="MEANING") wrongCounts.MEANING++;

    updateStats();

    if(activity==="MEANING" && info && info.correctIntent){
      setFeedback("‚ùå Try again! Correct: " + prettyIntent(info.correctIntent), false);
    } else {
      setFeedback("‚ùå Try again!", false);
    }

    sendToSheet({
      name: playerName(),
      time_s: secondsElapsed(),
      attempts,
      most_failed_category: mostFailedCategory(),
      activity_type: activity,
      sentence,
      level
    });

    if(activity==="ORDER"){
      clearWords();
    }
  }
}

/* ============================
   Wire up buttons
============================ */
$("startBtn").addEventListener("click", startGame);
$("musicBtn").addEventListener("click", toggleMusic);
$("levelBtn").addEventListener("click", toggleLevel);
$("pauseBtn").addEventListener("click", pauseToggle);
$("resetBtn").addEventListener("click", resetGame);
$("exitBtn").addEventListener("click", ()=>{ openExitConfirm(); });

$("clearBtn").addEventListener("click", clearWords);
$("checkBtn").addEventListener("click", checkOrder);

$("resumeBtn").addEventListener("click", resumeGame);
$("pauseResetBtn").addEventListener("click", resetGame);
$("pauseExitBtn").addEventListener("click", ()=>{ closePause(); openExitConfirm(); });

$("stayBtn").addEventListener("click", closeExitConfirm);
$("confirmExitBtn").addEventListener("click", confirmExit);

/* Init */
window.addEventListener("load", ()=>{
  $("bgm").volume = 0.35;
  $("pauseBtn").disabled = true;
  setMiniType("Ready");
  updateStats();
  updateTimer();
});
</script>
</body>
</html>
