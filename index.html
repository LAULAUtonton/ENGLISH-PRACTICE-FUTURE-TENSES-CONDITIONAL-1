<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Future Forms + First Conditional ‚Äî Meaning Game (Streak 25)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800;900&display=swap" rel="stylesheet">

<style>
:root{
  /* Manga-ish bright palette */
  --bg1:#0b1026;
  --bg2:#111a44;
  --bg3:#091a2b;

  --panel: rgba(10, 14, 30, .90);
  --ink:#f4f7ff;
  --mut: rgba(244,247,255,.72);

  --accent:#ff4fd8;     /* neon pink */
  --accent2:#48f0ff;    /* neon cyan */
  --accent3:#ffe14a;    /* neon yellow */
  --good:#22c55e;
  --bad:#ef4444;

  --stroke: rgba(255,255,255,.12);
  --shadow: 0 24px 70px rgba(0,0,0,.55);
  --wMax: 1200px;

  --cardA:#ff4fd8;
  --cardB:#7c3aed;
  --cardC:#48f0ff;

  --focus: 0 0 0 5px rgba(255,79,216,.22);
}

*{box-sizing:border-box}
html,body{height:100%; margin:0;}
body{
  font-family:Montserrat,system-ui,sans-serif;
  background:
    radial-gradient(900px 520px at 15% 15%, rgba(255,79,216,.22), transparent 60%),
    radial-gradient(900px 520px at 85% 20%, rgba(72,240,255,.18), transparent 60%),
    radial-gradient(900px 520px at 55% 90%, rgba(255,225,74,.12), transparent 60%),
    linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));
  color:var(--ink);
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:12px;
}

/* ========= LAYOUT ========= */
.container{
  width:min(var(--wMax), 100%);
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);

  display:grid;
  grid-template-columns: 1fr 320px;
  grid-template-rows: auto auto 1fr auto;
  gap:12px;
  overflow:visible;
}

/* Header */
.header{grid-column:1/2; grid-row:1/2; display:flex; gap:12px; align-items:center}
.logo{
  width:56px;height:56px;border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.16);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 14px 28px rgba(0,0,0,.25);
}
.title{margin:0;font-size:20px;color:#fff;letter-spacing:.2px}
.lead{margin:2px 0 0;font-size:13px;color:var(--mut)}

/* Topbar */
.topbar{
  grid-column:1/2; grid-row:2/3;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  gap:10px;
  flex-wrap:wrap;
}
.statRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stat{
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:8px 12px;
  font-weight:900;
  font-size:13px;
  background:rgba(0,0,0,.12);
}
.playerTag{font-size:13px;color:var(--mut)}
.playerTag strong{color:var(--ink)}

/* Teacher toggle (small) */
.teacherToggle{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  border-radius:14px;
  padding:9px 12px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease;
}
.teacherToggle:hover{transform:translateY(-2px);filter:brightness(1.05)}

/* Right placeholder panel (for layout only, optional text) */
.placeholderPanel{
  grid-column:2/3; grid-row:1/4;
  padding:12px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.03));
  font-size:13px;
  color:var(--mut);
}

/* ========= TEACHER OVERLAY ========= */
.teacherOverlay{
  position:fixed;
  inset:0;
  background:rgba(2,8,23,.70);
  backdrop-filter:blur(8px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9998;
  padding:18px;
}
.teacherOverlay.show{
  display:flex;
}

/* Teacher panel (now modal, not in grid) */
.controlsPanel{
  width:min(380px, 100%);
  max-height:90vh;
  overflow-y:auto;
  padding:14px;
  border-radius:16px;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  box-shadow:0 24px 70px rgba(0,0,0,.70);
}
.inputRow{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.inputRow label{font-weight:900;font-size:13px;color:var(--ink)}
.inputRow input{
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  border-radius:14px;
  padding:12px;
  font-size:14px;
  outline:none;
}
.inputRow input::placeholder{color:rgba(244,247,255,.55)}
.inputRow input:focus{border-color: rgba(255,79,216,.70); box-shadow:var(--focus);}

.controlsBtns{display:flex;gap:10px;margin:6px 0 10px}
.btnPrimary,.btnSecondary{
  width:50%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.btnPrimary{
  border:none;
  color:#0b1026;
  background:linear-gradient(180deg,var(--accent3),#ffd000);
  box-shadow:0 14px 28px rgba(255,225,74,.20);
}
.btnSecondary{
  border:1px solid rgba(255,255,255,.16);
  color:var(--ink);
  background:rgba(0,0,0,.14);
}
.btnPrimary:hover,.btnSecondary:hover{transform:translateY(-2px);filter:brightness(1.05)}

.toggles{
  display:flex; gap:10px; flex-wrap:wrap;
  font-size:13px;color:var(--mut);
  margin-bottom:10px;
}
.toggles label{display:flex;gap:8px;align-items:center;cursor:pointer;user-select:none}

/* Simple teacher stats (visual) */
.teacherBox{
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.05);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.teacherBox h3{margin:0 0 8px; font-size:14px}
.bar{
  height:10px; border-radius:999px; overflow:hidden;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.10);
}
.bar > i{
  display:block; height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--accent2),var(--accent),var(--accent3));
}
.small{font-size:12.5px;color:rgba(244,247,255,.80);line-height:1.35}

/* ========= GAME ========= */
.game{
  grid-column:1/2; grid-row:3/4;
  overflow:auto;
  min-height:0;
}
.gameInner{
  width:100%;
  max-width:880px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Prompt card */
#card{
  border-radius:18px;
  padding:14px;
  background:linear-gradient(135deg,var(--cardA),var(--cardB),var(--cardC));
  box-shadow:0 18px 48px rgba(0,0,0,.30);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;
  position:relative;
  overflow:hidden;
}
#card::before{
  content:"";
  position:absolute; inset:-25%;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.22), transparent 45%),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,.18), transparent 48%),
    radial-gradient(circle at 70% 75%, rgba(255,255,255,.14), transparent 52%);
  transform:rotate(-10deg);
  pointer-events:none;
  animation: floatGlow 4.2s ease-in-out infinite;
}
@keyframes floatGlow{0%,100%{transform:rotate(-10deg) translateY(0)}50%{transform:rotate(-10deg) translateY(10px)}}

#cardLabel{
  position:relative;
  font-size:13px;
  font-weight:900;
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.22);
  backdrop-filter: blur(8px);
  margin:0 0 10px;
}
#cardText{
  position:relative;
  width:min(94%, 820px);
  padding:12px 14px;
  border-radius:14px;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;
  font-weight:900;
  font-size:clamp(18px, 2.0vw, 30px);
  line-height:1.18;
  text-shadow:0 2px 14px rgba(0,0,0,.35);
  overflow-wrap:anywhere;
}

/* Meaning question box */
.meaningPrompt{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:rgba(0,0,0,.14);
  padding:12px;
  text-align:center;
  font-weight:900;
  color:rgba(244,247,255,.92);
}

/* Options grid */
#options{
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.14);
  padding:10px;
}

#options.mode-meaning{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.choiceCard{
  border:none;
  border-radius:18px;
  padding:14px 14px;
  color:#fff;
  font-weight:900;
  cursor:pointer;
  text-align:left;
  display:flex;
  align-items:flex-start;
  gap:12px;
  min-height:86px;
  box-shadow:0 16px 34px rgba(0,0,0,.22);
  transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
  position:relative;
  overflow:hidden;
}
.choiceCard:focus-visible{outline:none; box-shadow: var(--focus), 0 18px 40px rgba(0,0,0,.30);}
.choiceCard::after{
  content:"";
  position:absolute; inset:-40%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%);
  transform:rotate(10deg);
  opacity:.7;
}
.choiceCard:hover{transform:translateY(-3px);filter:brightness(1.06);box-shadow:0 18px 40px rgba(0,0,0,.30)}
.choiceIcon{
  width:46px;height:46px;border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.18);
  font-size:22px;
  z-index:1;
  flex:0 0 auto;
}
.choiceText{z-index:1}
.choiceText small{display:block;font-size:12px;font-weight:800;opacity:.92;margin-top:2px; line-height:1.25}

/* manga color blocks */
.c1{background:linear-gradient(135deg,#ff4fd8,#c026d3);}
.c2{background:linear-gradient(135deg,#48f0ff,#2563eb);}
.c3{background:linear-gradient(135deg,#ffe14a,#f59e0b);}
.c4{background:linear-gradient(135deg,#22c55e,#10b981);}
.c5{background:linear-gradient(135deg,#f97316,#ef4444);}
.c6{background:linear-gradient(135deg,#a855f7,#7c3aed);}

/* Progress */
.progressWrap{
  width:100%;
  height:12px;
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
}
.progressBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#16a34a,#22c55e);
  background-size:200% 100%;
  transition:width 300ms ease;
}
.progressBar.moving{ animation: prog 1.1s linear infinite; }
@keyframes prog{ 0%{background-position:0%} 100%{background-position:200%} }
.progressLabel{
  font-size:13px;
  color:rgba(244,247,255,.90);
  text-align:center;
  margin-top:-4px;
  font-weight:900;
}

/* Feedback overlay */
.fbOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(2,8,23,.62);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
  z-index:9999;
  padding:18px;
}
.fbOverlay.show{ opacity:1; pointer-events:auto; }
.fbCard{
  width:min(720px, 96%);
  border-radius:18px;
  padding:18px 18px 16px;
  background:linear-gradient(180deg, rgba(10,14,30,.97), rgba(10,14,30,.93));
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 24px 70px rgba(0,0,0,.60);
  text-align:center;
  transform:scale(.965) translateY(6px);
  animation: fbIn .22s ease both;
}
@keyframes fbIn{ to{transform:scale(1) translateY(0)} }
.fbTop{display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900;}
.fbIcon{
  width:48px;height:48px;
  border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  font-size:22px;
}
.fbTitle{font-size:22px; margin:0;}
.fbSub{
  margin:10px auto 0;
  font-size:16px;
  color:#ffffff;
  font-weight:900;
  line-height:1.32;
  max-width:650px;
}
.fbDetail{
  margin:10px auto 0;
  font-size:14px;
  color:rgba(244,247,255,.92);
  font-weight:800;
  line-height:1.38;
  max-width:650px;
  border-top:1px solid rgba(255,255,255,.12);
  padding-top:10px;
  white-space:pre-wrap;
}
.fbBtnRow{margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;}
.fbBtn{
  border-radius:14px;
  padding:12px 16px;
  font-weight:900;
  cursor:pointer;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.14);
  color:var(--ink);
  transition:transform .12s ease, filter .12s ease;
}
.fbBtn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.fbBtn.primary{
  border:none;
  background:linear-gradient(180deg,var(--accent),#c026d3);
  color:#fff;
  box-shadow:0 14px 28px rgba(255,79,216,.18);
}

/* Celebration */
.celebration-overlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(2,8,23,0.72);
  z-index:10000;
  padding:18px;
}
.celebration-card{
  width:min(780px, 96%);
  background:linear-gradient(180deg, rgba(10,14,30,.94), rgba(10,14,30,.90));
  border:1px solid rgba(255,255,255,.14);
  color:var(--ink);
  border-radius:18px;
  padding:26px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.60);
}
.celebration-title{font-size:34px;font-weight:900;color:#fff;margin-bottom:8px}
.celebration-sub{color:rgba(244,247,255,.86);font-weight:900; font-size:16px; margin-bottom:12px}
.celebration-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}

/* Footer */
.footer{
  grid-column:1/2; grid-row:4/5;
  display:flex; justify-content:space-between; align-items:center;
  color:var(--mut); font-size:13px;
  gap:10px;
  flex-wrap:wrap;
}

/* ========= RESPONSIVE ========= */
@media (max-width: 1020px){
  .container{
    grid-template-columns:1fr;
    grid-template-rows:auto auto 1fr auto;
  }
  .placeholderPanel{
    display:none;
  }
}
@media (max-width: 640px){
  #options.mode-meaning{grid-template-columns:1fr}
}
@media (max-height: 760px){
  .container{
    grid-template-columns:1fr;
    grid-template-rows:auto auto 1fr auto;
  }
}

/* reduced motion */
@media (prefers-reduced-motion: reduce){
  #card::before,.progressBar.moving{animation:none !important}
  *{transition:none !important}
}
</style>
</head>

<body>
  <div class="container" role="application" aria-label="Future meaning game">
    <!-- Header -->
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="36" height="36" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#ff4fd8"/>
              <stop offset="1" stop-color="#48f0ff"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="30" fill="url(#g1)"/>
        </svg>
      </div>
      <div>
        <h1 class="title">Future Forms + First Conditional</h1>
        <p class="lead">Choose the <b>intended meaning</b> (Synchrony Unit 2) ‚Ä¢ win at <b>25 in a row</b></p>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="statRow">
        <div class="stat" id="scoreBox">Score: 0</div>
        <div class="stat" id="timerBox">Time: 0s</div>
        <div class="stat" id="streakBox">Streak: 0</div>
      </div>
      <div class="statRow">
        <div class="playerTag">Player: <strong id="playerName">‚Äî</strong></div>
        <button id="teacherToggle" class="teacherToggle" type="button">Teacher</button>
      </div>
    </div>

    <!-- Placeholder right panel (keeps layout stable, optional info) -->
    <div class="placeholderPanel">
      <strong>Teacher panel</strong><br>
      Open the <b>Teacher</b> button to start / reset the game, toggle music/SFX, and send stats.
    </div>

    <!-- Game -->
    <div class="game" role="main" aria-live="polite">
      <div class="gameInner">
        <div id="card" role="region" aria-label="Prompt card">
          <div id="cardLabel">Ready</div>
          <div id="cardText">Press <b>Teacher</b> ‚Üí START to begin the game.</div>
        </div>

        <div class="meaningPrompt" id="meaningPrompt">
          Question: What is the speaker‚Äôs intended meaning?
        </div>

        <div id="options" class="mode-meaning" role="group" aria-label="Answer options"></div>

        <div class="progressWrap" aria-hidden="false">
          <div id="progressBar" class="progressBar" style="width:0%"></div>
        </div>
        <div class="progressLabel" id="progressLabel">Goal progress: 0 / 25 (0%)</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div>Unit 2 focus: will / going to / present continuous / present simple / first conditional</div>
      <div>Goal: <span id="targetLabel">25</span> in a row</div>
    </div>
  </div>

  <!-- Teacher overlay (modal) -->
  <div class="teacherOverlay" id="teacherOverlay" aria-hidden="true">
    <div class="controlsPanel" aria-label="Teacher controls">
      <div class="inputRow">
        <label for="studentName">Name</label>
        <input id="studentName" type="text" placeholder="E.g., Laura">
      </div>

      <div class="inputRow">
        <label for="targetStreak">Target streak</label>
        <input id="targetStreak" type="number" value="25" disabled>
      </div>

      <div class="controlsBtns">
        <button id="startBtn" class="btnPrimary" type="button">START</button>
        <button id="resetBtn" class="btnSecondary" type="button">RESET</button>
      </div>

      <div class="toggles">
        <label><input id="soundToggle" type="checkbox" checked> SFX</label>
        <label><input id="musicToggle" type="checkbox" checked> Music</label>
        <label title="Auto moves to the next question after feedback">
          <input id="autoNextToggle" type="checkbox" checked> Auto-next
        </label>
      </div>

      <div class="teacherBox">
        <h3>Teacher snapshot</h3>
        <div class="small" id="weakText">Start the game to see weak areas.</div>
        <div style="height:10px"></div>
        <div class="small"><b>Progress</b></div>
        <div class="bar"><i id="tBar"></i></div>
        <div class="small" id="tBarLabel" style="margin-top:6px">0 / 25</div>
      </div>

      <div class="teacherBox">
        <h3>Google Sheets</h3>
        <div class="small">
          Stats-only send on WIN (or when you press the button).
        </div>
        <button id="sendStatsBtn" class="btnSecondary" type="button" style="width:100%; margin-top:10px">Send stats now</button>
        <div class="small" id="sendMsg" style="margin-top:8px;color:rgba(244,247,255,.8)"></div>
      </div>

      <button id="closeTeacher" class="btnSecondary" type="button" style="width:100%;margin-top:4px">Close</button>
    </div>
  </div>

  <!-- Feedback overlay -->
  <div id="feedbackOverlay" class="fbOverlay" aria-hidden="true">
    <div class="fbCard" role="dialog" aria-modal="true" aria-label="Feedback popup">
      <div class="fbTop">
        <div class="fbIcon" id="fbIcon">‚úÖ</div>
        <h3 class="fbTitle" id="fbTitle">Nice!</h3>
      </div>
      <div class="fbSub" id="fbSub">Keep it going.</div>
      <div class="fbDetail" id="fbDetail"></div>
      <div class="fbBtnRow">
        <button class="fbBtn" id="fbCloseBtn" type="button">Close</button>
        <button class="fbBtn primary" id="fbNextBtn" type="button">Next</button>
      </div>
    </div>
  </div>

  <!-- Celebration -->
  <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="celebration-card" role="document">
      <div class="celebration-title">Perfect streak! üèÜ</div>
      <div class="celebration-sub" id="celebrationSub">You reached 25 correct answers in a row.</div>
      <div class="celebration-actions">
        <button id="celebrationSend" class="btnPrimary" style="width:auto;padding:12px 18px">Send stats</button>
        <button id="celebrationRestart" class="btnSecondary" style="width:auto;padding:12px 18px">Restart</button>
      </div>
    </div>
  </div>

  <!-- Background music -->
  <audio id="bgMusic" src="audio/koala2.mp3" preload="auto" loop></audio>

<script>
/* ==========================================================
   CONFIG
========================================================== */
const TARGET_STREAK = 25;

/* IMPORTANT: your Apps Script Web App URL (stats-only) */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";

/* ==========================================================
   MEANING CATEGORIES (Synchrony Unit 2 logic)
========================================================== */
const MEANINGS = [
  { key:"prediction",      icon:"üîÆ", cls:"c1", title:"Prediction / opinion",  hint:"guess, opinion, ‚ÄòI think‚Ä¶‚Äô ‚Üí usually WILL" },
  { key:"instant",         icon:"ü§ù", cls:"c2", title:"Offer / promise / decision now", hint:"offer/promise/decision ‚Üí WILL" },
  { key:"plan",            icon:"üß≠", cls:"c3", title:"Plan / intention",      hint:"intention, plan ‚Üí GOING TO" },
  { key:"arrangement",     icon:"üìÖ", cls:"c4", title:"Arrangement",          hint:"fixed plan, meeting time ‚Üí PRESENT CONTINUOUS" },
  { key:"timetable",       icon:"üöâ", cls:"c5", title:"Timetable / schedule", hint:"official schedule ‚Üí PRESENT SIMPLE" },
  { key:"first_cond",      icon:"‚ö°", cls:"c6", title:"First conditional",     hint:"possible future + result (if + present, will‚Ä¶)" },
];

/* Mapping meaning ‚Üí expected form (used for teacher explanation) */
const FORM_BY_MEANING = {
  prediction:  "will",
  instant:     "will",
  plan:        "be going to",
  arrangement: "present continuous",
  timetable:   "present simple",
  first_cond:  "first conditional"
};

/* ==========================================================
   BANKS
========================================================== */
const BANKS = {
  prediction: [
    "I think it will rain later.",
    "I‚Äôm sure you‚Äôll love the festival.",
    "The trip will be amazing.",
    "I don‚Äôt think the museum will be boring.",
    "People will probably buy tickets online.",
    "I don‚Äôt think we‚Äôll miss the plane.",
    "It won‚Äôt be easy to find a hotel tonight.",
    "She won‚Äôt enjoy that scary ride.",
    "They won‚Äôt be late, I‚Äôm sure.",
    "It won‚Äôt cost much.",
    "Do you think it will be crowded?",
    "Will you enjoy mountain biking?",
    "Do you think they‚Äôll come with us?",
    "Will it be cheaper if we pay today?",
    "Do you think she‚Äôll recommend that place?"
  ],
  instant: [
    "I‚Äôll help you with your brochure.",
    "I‚Äôll carry your bag.",
    "Don‚Äôt worry ‚Äî I‚Äôll send you the photo.",
    "Okay, I‚Äôll buy the tickets now.",
    "I‚Äôll call you tonight.",
    "I won‚Äôt forget to message you.",
    "I won‚Äôt be late ‚Äî I promise.",
    "I won‚Äôt tell anyone.",
    "I won‚Äôt do that again.",
    "I won‚Äôt leave without you.",
    "Shall I book the tour for you?",
    "Will you help me with this sentence?",
    "Will you send me the link?",
    "Shall we meet at the station?",
    "Will you hold my place in the queue?"
  ],
  plan: [
    "I‚Äôm going to visit the aquarium tomorrow.",
    "We‚Äôre going to explore the peninsula next weekend.",
    "She‚Äôs going to buy a new backpack.",
    "They‚Äôre going to try canyoning this summer.",
    "I‚Äôm going to write an announcement.",
    "I‚Äôm not going to stay at home this weekend.",
    "He isn‚Äôt going to do bungee-jumping.",
    "They aren‚Äôt going to travel abroad this year.",
    "We‚Äôre not going to miss the parade.",
    "She isn‚Äôt going to buy that expensive ticket.",
    "Are you going to visit London?",
    "Is he going to go sightseeing tomorrow?",
    "Are they going to book a package tour?",
    "Are we going to meet at the caf√©?",
    "Is she going to write to you later?"
  ],
  arrangement: [
    "We‚Äôre meeting at the station at 10.",
    "I‚Äôm having lunch with Sam tomorrow.",
    "She‚Äôs travelling to Greece on Friday.",
    "They‚Äôre staying in a hostel tonight.",
    "We‚Äôre going kayaking this afternoon.",
    "I‚Äôm not seeing him this evening.",
    "They aren‚Äôt coming to the museum with us.",
    "She isn‚Äôt meeting the group today.",
    "We‚Äôre not leaving at six ‚Äî we‚Äôre leaving at seven.",
    "He isn‚Äôt joining the tour tomorrow.",
    "Are you meeting your friends later?",
    "Is she coming to the parade today?",
    "Are they flying to Rome on Monday?",
    "Are we having dinner at your house tonight?",
    "Is he staying with his grandparents this weekend?"
  ],
  timetable: [
    "The train leaves from platform 2.",
    "The museum opens at nine.",
    "The bus arrives at 8:15.",
    "The tour starts at 11:00.",
    "The festival takes place in August.",
    "The shop doesn‚Äôt open on Sundays.",
    "The tour doesn‚Äôt include lunch.",
    "The train doesn‚Äôt stop here.",
    "The museum doesn‚Äôt close at five today.",
    "The bus doesn‚Äôt leave from this stop.",
    "Does the train leave at 3 p.m.?",
    "What time does the castle open?",
    "Does the tour start at ten?",
    "When does the plane land?",
    "Does the museum close early on Mondays?"
  ],
  first_cond: [
    "If it rains, we‚Äôll stay at home.",
    "If we miss the plane, we‚Äôll get a taxi.",
    "If you buy tickets online, you won‚Äôt have to wait outside.",
    "If we have time, we‚Äôll visit the temple.",
    "If she studies, she‚Äôll pass the test.",
    "If you don‚Äôt go now, you‚Äôll miss the parade.",
    "If we don‚Äôt leave early, we won‚Äôt get good seats.",
    "If he doesn‚Äôt bring his map, he‚Äôll get lost.",
    "If they don‚Äôt book soon, they won‚Äôt find a hotel.",
    "If I don‚Äôt have money, I won‚Äôt buy it.",
    "If it rains, will you still go out?",
    "What will you do if you miss the bus?",
    "Will we get a discount if we pay before July?",
    "If she loses her passport, what will she do?",
    "If you don‚Äôt like it, will you tell me?"
  ]
};

/* ==========================================================
   STATE
========================================================== */
const el = (id)=>document.getElementById(id);

const state = {
  running:false,
  streak:0,
  score:0,
  seconds:0,
  timer:null,
  locked:false,

  stats: Object.fromEntries(MEANINGS.map(m => [m.key, {attempts:0, correct:0, wrong:0}])),
  recent: Object.fromEntries(MEANINGS.map(m => [m.key, []])),

  round:null, // { meaningKey, sentence }

  bestStreak:0,
  log:[]
};

/* ==========================================================
   AUDIO
========================================================== */
const bgMusic = el("bgMusic");

function blip(ok){
  if(!el("soundToggle").checked) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = "sine";
    o.frequency.value = ok ? 720 : 220;
    g.gain.value = 0.06;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ok ? 110 : 150);
  }catch(e){}
}

/* ==========================================================
   UI
========================================================== */
function updateHeader(){
  el("scoreBox").textContent = `Score: ${state.score}`;
  el("timerBox").textContent = `Time: ${state.seconds}s`;
  el("streakBox").textContent = `Streak: ${state.streak}`;
  el("targetLabel").textContent = TARGET_STREAK;

  const pct = Math.max(0, Math.min(100, Math.round((state.streak / TARGET_STREAK) * 100)));
  el("tBar").style.width = `${pct}%`;
  el("tBarLabel").textContent = `${state.streak} / ${TARGET_STREAK}`;
}

function updateProgress(){
  const pct = Math.max(0, Math.min(100, Math.round((state.streak / TARGET_STREAK) * 100)));
  el("progressBar").style.width = `${pct}%`;
  el("progressLabel").textContent = `Goal progress: ${state.streak} / ${TARGET_STREAK} (${pct}%)`;

  if(state.running && state.streak > 0 && state.streak < TARGET_STREAK) el("progressBar").classList.add("moving");
  else el("progressBar").classList.remove("moving");
}

function setCard(label, text){
  el("cardLabel").textContent = label;
  el("cardText").textContent = text;
}

/* ==========================================================
   HELPERS
========================================================== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function pickSentenceNoRepeat(meaningKey){
  const bank = BANKS[meaningKey];
  const memory = state.recent[meaningKey] || [];
  for(let tries=0; tries<12; tries++){
    const s = bank[Math.floor(Math.random()*bank.length)];
    if(!memory.includes(s)) return s;
  }
  return bank[Math.floor(Math.random()*bank.length)];
}

function rememberSentence(meaningKey, sentence){
  const q = state.recent[meaningKey] || [];
  q.unshift(sentence);
  while(q.length > 8) q.pop();
  state.recent[meaningKey] = q;
}

/* ==========================================================
   ADAPTIVE MEANING PICK
========================================================== */
function weightForMeaning(key){
  const st = state.stats[key];
  const attempts = st.attempts || 0;
  const acc = attempts ? (st.correct / attempts) : 0.65;
  let w = 1.0;
  if(attempts === 0) w += 1.2;
  w += (1 - acc) * 2.0;
  w += (st.wrong) * 0.10;
  return w;
}

function pickMeaningAdaptive(){
  const weights = MEANINGS.map(m => ({ key:m.key, w:weightForMeaning(m.key) }));
  const total = weights.reduce((s,x)=>s+x.w,0);
  let r = Math.random()*total;
  for(const item of weights){
    if(r < item.w) return item.key;
    r -= item.w;
  }
  return MEANINGS[0].key;
}

/* ==========================================================
   ROUND FLOW
========================================================== */
function startRound(){
  if(!state.running) return;
  state.locked = false;

  const meaningKey = pickMeaningAdaptive();
  const sentence = pickSentenceNoRepeat(meaningKey);
  rememberSentence(meaningKey, sentence);

  state.round = { meaningKey, sentence };

  setCard("Read", sentence);
  renderOptions();
}

function renderOptions(){
  const optionsEl = el("options");
  optionsEl.innerHTML = "";
  optionsEl.classList.add("mode-meaning");

  const shuffled = shuffle(MEANINGS);
  shuffled.forEach((m, idx)=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = `choiceCard ${m.cls}`;
    btn.setAttribute("data-key", m.key);

    const icon = document.createElement("div");
    icon.className = "choiceIcon";
    icon.textContent = m.icon;

    const text = document.createElement("div");
    text.className = "choiceText";
    text.innerHTML = `${m.title}<small>${m.hint}</small>`;

    btn.appendChild(icon);
    btn.appendChild(text);

    btn.addEventListener("click", ()=>handleAnswer(m.key));

    optionsEl.appendChild(btn);
  });
}

/* ==========================================================
   FEEDBACK + SNAPSHOT
========================================================== */
function updateWeakArea(){
  const entries = Object.entries(state.stats);
  if(!entries.length) return;

  let weakest = null;
  for(const [key, st] of entries){
    if(st.attempts === 0) continue;
    const acc = st.correct / st.attempts;
    if(!weakest || acc < weakest.acc){
      weakest = { key, acc, st };
    }
  }
  if(!weakest){
    el("weakText").textContent = "Not enough data yet. Keep playing.";
    return;
  }
  const meaning = MEANINGS.find(m => m.key === weakest.key);
  const pct = Math.round(weakest.acc*100);
  el("weakText").textContent = `Weakest area: ${meaning.title} (${pct}% correct, ${weakest.st.wrong} wrong)`;
}

function showFeedback(correct, chosenKey){
  const overlay = el("feedbackOverlay");
  const icon = el("fbIcon");
  const title = el("fbTitle");
  const sub = el("fbSub");
  const detail = el("fbDetail");

  const round = state.round;
  const correctMeaning = MEANINGS.find(m => m.key === round.meaningKey);
  const chosenMeaning = MEANINGS.find(m => m.key === chosenKey);
  const form = FORM_BY_MEANING[round.meaningKey];

  if(correct){
    icon.textContent = "‚úÖ";
    title.textContent = "Nice!";
    sub.textContent = "You chose the correct meaning.";
  }else{
    icon.textContent = "‚ùå";
    title.textContent = "Not this time.";
    sub.textContent = "Look at the meaning and form.";
  }

  let detailText = `Sentence:\n${round.sentence}\n\nIntended meaning: ${correctMeaning.title}\nTypical form: ${form}`;
  if(!correct){
    detailText += `\n\nYou chose: ${chosenMeaning.title}`;
  }

  detail.textContent = detailText;

  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");

  const autoNext = el("autoNextToggle").checked;
  if(autoNext){
    setTimeout(()=>{
      hideFeedback();
      if(state.running) startRound();
    }, correct ? 900 : 1300);
  }
}

function hideFeedback(){
  const overlay = el("feedbackOverlay");
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden","true");
}

/* ==========================================================
   ANSWER HANDLING
========================================================== */
function handleAnswer(chosenKey){
  if(!state.running || state.locked || !state.round) return;
  state.locked = true;

  const correctKey = state.round.meaningKey;
  const correct = (chosenKey === correctKey);

  const st = state.stats[correctKey];
  st.attempts++;
  if(correct) st.correct++; else st.wrong++;

  state.score++;
  if(correct){
    state.streak++;
    state.bestStreak = Math.max(state.bestStreak, state.streak);
    blip(true);
  }else{
    state.streak = 0;
    blip(false);
  }

  state.log.push({
    time: Date.now(),
    sentence: state.round.sentence,
    meaning: correctKey,
    chosen: chosenKey,
    correct
  });

  updateHeader();
  updateProgress();
  updateWeakArea();
  showFeedback(correct, chosenKey);

  if(state.streak >= TARGET_STREAK){
    endGame(true);
  }
}

/* ==========================================================
   TIMER
========================================================== */
function startTimer(){
  if(state.timer) clearInterval(state.timer);
  state.timer = setInterval(()=>{
    state.seconds++;
    el("timerBox").textContent = `Time: ${state.seconds}s`;
  },1000);
}

function stopTimer(){
  if(state.timer){
    clearInterval(state.timer);
    state.timer = null;
  }
}

/* ==========================================================
   GAME CONTROL
========================================================== */
function resetState(keepBest=false){
  state.running = false;
  state.streak = 0;
  state.score = 0;
  state.seconds = 0;
  state.round = null;
  state.locked = false;
  if(!keepBest) state.bestStreak = 0;
  state.stats = Object.fromEntries(MEANINGS.map(m => [m.key, {attempts:0, correct:0, wrong:0}]));
  state.recent = Object.fromEntries(MEANINGS.map(m => [m.key, []]));
  state.log = [];
}

function startGame(){
  const name = el("studentName").value.trim();
  el("playerName").textContent = name || "‚Äî";

  resetState(true);
  state.running = true;
  state.seconds = 0;

  updateHeader();
  updateProgress();
  updateWeakArea();
  setCard("Ready", "Read the sentence and choose the intended meaning.");
  startTimer();

  if(el("musicToggle").checked){
    bgMusic.volume = 0.4;
    bgMusic.play().catch(()=>{});
  }

  startRound();
}

function endGame(perfect=false){
  state.running = false;
  stopTimer();
  el("progressBar").classList.remove("moving");

  if(perfect){
    const c = el("celebration");
    el("celebrationSub").textContent = `You reached ${TARGET_STREAK} correct answers in a row.`;
    c.style.display = "flex";
    c.setAttribute("aria-hidden","false");
  }
}

function hardReset(){
  stopTimer();
  resetState(false);
  updateHeader();
  updateProgress();
  updateWeakArea();
  setCard("Reset", "Press START in the Teacher panel to begin a new game.");
}

/* ==========================================================
   STATS SEND
========================================================== */
async function sendStats(){
  const name = el("studentName").value.trim() || "Unknown";
  const payload = {
    name,
    streak: state.streak,
    bestStreak: state.bestStreak,
    score: state.score,
    seconds: state.seconds,
    stats: state.stats,
    timestamp: new Date().toISOString()
  };

  el("sendMsg").textContent = "Sending‚Ä¶";

  try{
    const res = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("Network error");
    el("sendMsg").textContent = "Stats sent ‚úî";
  }catch(e){
    el("sendMsg").textContent = "Could not send stats.";
  }
}

/* ==========================================================
   EVENT BINDINGS
========================================================== */
window.addEventListener("DOMContentLoaded", ()=>{
  const teacherOverlay = el("teacherOverlay");

  el("teacherToggle").addEventListener("click", ()=>{
    teacherOverlay.classList.add("show");
    teacherOverlay.setAttribute("aria-hidden","false");
  });

  el("closeTeacher").addEventListener("click", ()=>{
    teacherOverlay.classList.remove("show");
    teacherOverlay.setAttribute("aria-hidden","true");
  });

  teacherOverlay.addEventListener("click", (e)=>{
    if(e.target === teacherOverlay){
      teacherOverlay.classList.remove("show");
      teacherOverlay.setAttribute("aria-hidden","true");
    }
  });

  el("startBtn").addEventListener("click", ()=>{
    teacherOverlay.classList.remove("show");
    teacherOverlay.setAttribute("aria-hidden","true");
    startGame();
  });

  el("resetBtn").addEventListener("click", ()=>{
    hardReset();
  });

  el("musicToggle").addEventListener("change", ()=>{
    if(el("musicToggle").checked){
      bgMusic.volume = 0.4;
      bgMusic.play().catch(()=>{});
    }else{
      bgMusic.pause();
    }
  });

  el("sendStatsBtn").addEventListener("click", ()=>sendStats());
  el("celebrationSend").addEventListener("click", ()=>sendStats());

  el("celebrationRestart").addEventListener("click", ()=>{
    el("celebration").style.display = "none";
    el("celebration").setAttribute("aria-hidden","true");
    startGame();
  });

  el("fbCloseBtn").addEventListener("click", ()=>{
    hideFeedback();
  });
  el("fbNextBtn").addEventListener("click", ()=>{
    hideFeedback();
    if(state.running) startRound();
  });

  // Initial UI
  updateHeader();
  updateProgress();
  updateWeakArea();
});
</script>
</body>
</html>


