<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Future Grammar Mastery ‚Äî Blue Remix (Responsive + Bottom Bar + Sheets)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      /* ===== BACKGROUND vs GAME CONTRAST (flat colors, no gradients) ===== */
      --page:#031B33;        /* very dark navy (page) */
      --page2:#05284A;       /* slightly lighter strip */
      --card:#0C3A66;        /* game card blue (clearly different from page) */
      --surface:#072B4D;     /* inner surfaces */
      --panel:#0A4A86;       /* header / pills */
      --ink:#ffffff;
      --mut:rgba(255,255,255,.80);
      --stroke:rgba(255,255,255,.16);
      --shadow:0 14px 28px rgba(0,0,0,.35);

      /* ===== lively flat accents ===== */
      --cyan:#2FE6FF;
      --mint:#6BFFCF;
      --yellow:#FFD166;
      --orange:#FF9F1C;
      --pink:#FF4DAB;
      --purple:#9B5CFF;
      --lime:#B6FF4D;
      --red:#FF4D6D;

      --btnDark:#06131f;
      --bar:#021427;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--page);
    }

    /* Subtle top strip (still flat color) */
    .topStrip{
      background:var(--page2);
      border-bottom:2px solid rgba(255,255,255,.06);
    }

    .app{
      max-width:980px;
      margin:0 auto;
      padding:14px;
    }

    header{
      text-align:center;
      padding:14px 10px 12px;
    }
    h1{
      margin:0;
      font-size:2rem;
      font-weight:900;
      letter-spacing:.2px;
    }
    header p{
      margin:6px 0 10px;
      font-weight:800;
      color:var(--mut);
    }

    /* ===== TOP: keep it minimal ===== */
    .topRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-top:8px;
    }
    .nameBox{
      display:flex;
      gap:10px;
      align-items:center;
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      width:min(520px, 100%);
      justify-content:center;
    }
    .nameBox span{ font-weight:900; white-space:nowrap; }
    .nameBox input{
      border:none;
      outline:none;
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      font-weight:900;
      min-width:180px;
      width:100%;
      max-width:280px;
    }

    .startOnly{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }

    .warning{
      margin-top:8px;
      min-height:18px;
      font-weight:900;
      color:#ffe3e3;
    }

    /* ===== stats row ===== */
    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin:12px 0 12px;
    }
    .stat{
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      min-width:150px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .stat .label{
      font-size:.82rem;
      font-weight:900;
      opacity:.95;
    }
    .stat .value{
      font-size:1.07rem;
      font-weight:900;
      margin-top:2px;
    }

    .progressWrap{
      flex:1;
      min-width:260px;
      background:var(--panel);
      border:2px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .progressWrap .label{
      text-align:left;
      font-size:.82rem;
      font-weight:900;
      opacity:.95;
    }
    .bar{
      margin-top:8px;
      height:22px;
      background:var(--bar);
      border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(47,230,255,.55);
    }
    .fill{
      height:100%;
      width:0%;
      background:var(--lime);
      transition:width .25s ease;
    }

    /* ===== game card ===== */
    .card{
      background:var(--card);
      border:2px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
      box-shadow:0 18px 32px rgba(0,0,0,.42);
      position:relative;
      overflow:hidden;
    }

    .miniTypeWrap{ text-align:center; }
    .miniType{
      display:inline-block;
      margin:0 auto 10px;
      padding:7px 14px;
      border-radius:999px;
      font-weight:900;
      background:var(--surface);
      border:2px solid rgba(255,255,255,.12);
    }

    .sentenceBox{
      display:flex;
      justify-content:center;
      margin: 10px 0 14px;
    }
    .sentenceBig{
      width:100%;
      background:var(--surface);
      border:3px solid rgba(47,230,255,.55);
      border-radius:18px;
      padding:18px 16px;
      font-weight:900;
      font-size:1.55rem;
      line-height:1.25;
      text-align:center;
      user-select:none;
    }

    /* ORDER */
    .interaction{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      min-height:52px;
      padding-bottom:10px;
      border-bottom:2px solid rgba(47,230,255,.20);
      margin-bottom:12px;
    }
    .word-bank{
      background:var(--surface);
      border:2px solid rgba(255,255,255,.12);
      padding:14px;
      border-radius:16px;
      min-height:58px;
    }
    .wordItem{
      display:inline-block;
      background:#ffffff;
      color:#000;
      border:2px solid rgba(0,0,0,.18);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      margin:0 10px 10px 0;
      user-select:none;
    }
    .builtWord{
      background:#0B2E4F; /* darker than surface for contrast */
      color:#fff;
      border:2px solid rgba(255,255,255,.16);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      cursor:pointer;
      user-select:none;
    }

    /* Cards */
    .cards{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:8px;
    }
    .cardBtn{
      border:none;
      border-radius:18px;
      padding:16px 16px;
      cursor:pointer;
      font-weight:900;
      font-size:1.08rem;
      box-shadow:0 10px 18px rgba(0,0,0,.25);
      border:3px solid rgba(255,255,255,.14);
      text-align:left;
      transition:transform .12s ease, filter .12s ease;
      min-height:86px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      user-select:none;
      color:#06131f;
    }
    .cardBtn:hover{ transform:translateY(-1px); filter:brightness(1.04); }
    .cardTitle{ font-size:1.14rem; font-weight:900; }
    .cardDesc{ font-size:.92rem; font-weight:800; opacity:.92; }

    /* flat palettes */
    .pal0{ background:var(--cyan); }
    .pal1{ background:var(--yellow); }
    .pal2{ background:var(--mint); }
    .pal3{ background:var(--pink); color:#210013; }
    .pal4{ background:var(--purple); color:#120018; }
    .pal5{ background:var(--lime); }

    .feedback{
      margin:12px 0 58px; /* leave space for bottom bar inside card */
      min-height:28px;
      text-align:center;
      font-weight:900;
      font-size:1.05rem;
    }
    .ok{ color:var(--mint); }
    .no{ color:#ffd1d1; }

    /* ===== bottom bar (moved controls here) ===== */
    .bottomBar{
      position:sticky;
      bottom:0;
      margin-top:10px;
      background:rgba(0,0,0,.18);   /* still flat-ish; overlay */
      border:2px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      box-shadow:0 18px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }

    .btn{
      border:none;
      border-radius:16px;
      padding:12px 18px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      transition:transform .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.05); }
    .btn:active{ transform:translateY(0px) scale(.99); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; filter:none; }

    .bMusic{ background:var(--cyan); color:var(--btnDark); }
    .bLevel{ background:var(--yellow); color:#2b1500; }
    .bPause{ background:var(--purple); color:#13002b; }
    .bExit{ background:var(--red); color:#fff; }
    .bReset{ background:var(--orange); color:#2b1500; }
    .bClear{ background:var(--pink); color:#210013; }
    .bCheck{ background:var(--mint); color:var(--btnDark); }

    /* overlays */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.55);
      padding:16px;
      z-index:50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      background:var(--panel);
      border:2px solid rgba(255,255,255,.16);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 34px rgba(0,0,0,.45);
      text-align:center;
    }
    .modal h2{ margin:0 0 6px; font-size:1.35rem; }
    .modal p{ margin:0 0 14px; font-weight:800; color:var(--mut); }
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .hidden{ display:none !important; }

    /* ===== responsive tweaks ===== */
    @media (max-width:680px){
      h1{ font-size:1.65rem; }
      .sentenceBig{ font-size:1.22rem; padding:16px 14px; }
      .stats{ gap:8px; }
      .stat{ min-width:140px; }
      .cards{ grid-template-columns:1fr; }
      .btn{ width:calc(50% - 8px); }          /* bottom bar buttons become 2 per row */
      .bottomBar{ justify-content:space-between; }
    }
    @media (max-width:420px){
      .btn{ width:100%; }
      .wordItem,.builtWord{ font-size:1rem; padding:10px 12px; }
    }
  </style>
</head>

<body>
  <div class="topStrip">
    <div class="app">
      <header>
        <h1>Future Grammar Mastery</h1>
        <p>ORDER ‚Ä¢ TENSE ‚Ä¢ MEANING ‚Äî reach 25 correct in a row.</p>

        <div class="topRow">
          <div class="nameBox">
            <span>Name:</span>
            <input id="playerName" type="text" placeholder="Enter your name">
          </div>

          <div class="startOnly">
            <button class="btn bCheck" id="startBtn" type="button">Start</button>
            <button class="btn bReset" id="resetBtnTop" type="button">Reset</button>
          </div>
        </div>

        <div class="warning" id="nameWarning"></div>
      </header>
    </div>
  </div>

  <div class="app">
    <div class="stats">
      <div class="stat">
        <div class="label">Player</div>
        <div class="value" id="displayName">---</div>
      </div>

      <div class="stat">
        <div class="label">Streak</div>
        <div class="value"><span id="streak">0</span> / 25</div>
      </div>

      <div class="progressWrap">
        <div class="label">Progress</div>
        <div class="bar"><div class="fill" id="progressFill"></div></div>
      </div>

      <div class="stat">
        <div class="label">Time</div>
        <div class="value" id="timerDisplay">00:00</div>
      </div>
    </div>

    <div class="card">
      <div class="miniTypeWrap"><span class="miniType" id="miniType">Ready</span></div>

      <div class="sentenceBox hidden" id="sentenceBox">
        <div class="sentenceBig" id="sentenceBig"></div>
      </div>

      <div class="interaction hidden" id="interaction"></div>
      <div id="cardsArea" class="cards hidden"></div>
      <div class="word-bank hidden" id="wordBank"></div>

      <div class="feedback" id="feedback"></div>

      <!-- bottom controls moved here -->
      <div class="bottomBar" id="bottomBar">
        <button class="btn bMusic" id="musicBtn" type="button">Music: OFF</button>
        <button class="btn bLevel" id="levelBtn" type="button">Level: EASY</button>
        <button class="btn bPause" id="pauseBtn" type="button" disabled>Pause</button>
        <button class="btn bExit" id="exitBtn" type="button">Exit</button>
        <button class="btn bClear" id="clearBtn" type="button" disabled>Clear</button>
        <button class="btn bCheck" id="checkBtn" type="button" disabled>Check</button>
      </div>
    </div>
  </div>

  <!-- AUDIO -->
  <audio id="bgm" loop preload="auto">
    <source src="audio/koala2.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound" preload="auto">
    <source src="audio/tadaa.mp3" type="audio/mpeg">
  </audio>

  <!-- PAUSE OVERLAY -->
  <div class="overlay" id="pauseOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Paused">
      <h2>‚è∏ Paused</h2>
      <p>Press Resume to continue.</p>
      <div class="modalActions">
        <button class="btn bCheck" id="resumeBtn" type="button">Resume</button>
        <button class="btn bReset" id="pauseResetBtn" type="button">Reset</button>
        <button class="btn bExit" id="pauseExitBtn" type="button">Exit</button>
      </div>
    </div>
  </div>

  <!-- EXIT CONFIRM -->
  <div class="overlay" id="exitOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Exit confirm">
      <h2>Exit game?</h2>
      <p>Your current streak will be lost.</p>
      <div class="modalActions">
        <button class="btn bCheck" id="stayBtn" type="button">Stay</button>
        <button class="btn bExit" id="confirmExitBtn" type="button">Exit</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   GOOGLE SHEETS (YOUR URL)
============================ */
const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";
const SECRET_KEY = "CHANGE_ME_TO_SOMETHING_PRIVATE";

async function sendToSheet(payload){
  const body = {
    secret: SECRET_KEY,
    name: String(payload.name || ""),
    time_s: Number(payload.time_s || 0),
    attempts: Number(payload.attempts || 0),
    most_failed_category: String(payload.most_failed_category || ""),
    activity_type: String(payload.activity_type || ""),
    sentence: String(payload.sentence || ""),
    level: String(payload.level || "")
  };
  try{
    await fetch(SHEET_ENDPOINT, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
  }catch(err){
    console.error("Sheets send error:", err);
  }
}

/* ===========================================================
   BANK (same categories as before; your list can be extended)
=========================================================== */
const BANK = [
  /* PRESENT SIMPLE (schedule) */
  { text:"The train leaves at 8:10 tomorrow.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"School starts at 9 o‚Äôclock on Monday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The concert begins at 7 p.m. on Friday.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"The museum closes at 6 p.m.", form:"present_simple", intent:"schedule", diff:"easy" },
  { text:"Does the match start at noon?", form:"present_simple", intent:"schedule", diff:"easy" },

  /* PRESENT CONTINUOUS (arrangement) */
  { text:"I‚Äôm meeting my friends at 6 p.m.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"We‚Äôre having dinner together tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"She‚Äôs seeing the dentist on Friday.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"They‚Äôre coming over for lunch tomorrow.", form:"present_continuous", intent:"arrangement", diff:"easy" },
  { text:"Are you visiting your grandma this weekend?", form:"present_continuous", intent:"arrangement", diff:"easy" },

  /* WILL */
  { text:"I think it will rain later.", form:"will", intent:"prediction", diff:"easy" },
  { text:"They will probably win the match.", form:"will", intent:"prediction", diff:"easy" },
  { text:"Don‚Äôt worry, I‚Äôll help you.", form:"will", intent:"offer_promise", diff:"easy" },
  { text:"Okay, I‚Äôll do it now.", form:"will", intent:"decision_now", diff:"easy" },
  { text:"The results will be published tomorrow.", form:"will", intent:"announcement", diff:"hard" },

  /* GOING TO */
  { text:"I‚Äôm going to study tonight.", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Are you going to watch the new episode?", form:"going_to", intent:"plan", diff:"easy" },
  { text:"Look at those clouds! It‚Äôs going to rain.", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"That glass is going to fall!", form:"going_to", intent:"evidence_prediction", diff:"easy" },
  { text:"You‚Äôre going to miss the bus‚Äîrun!", form:"going_to", intent:"evidence_prediction", diff:"hard" },

  /* FIRST CONDITIONAL */
  { text:"If you don‚Äôt study, you‚Äôll fail the test.", form:"first_conditional", intent:"warning_consequence", diff:"easy" },
  { text:"If you feel tired, take a break.", form:"first_conditional", intent:"advice_suggestion", diff:"easy" },
  { text:"If it rains, we‚Äôll stay at home.", form:"first_conditional", intent:"plan_condition", diff:"easy" },
  { text:"If she studies, she‚Äôll do well.", form:"first_conditional", intent:"prediction_result", diff:"easy" },
  { text:"If you forget your homework, you‚Äôll lose points.", form:"first_conditional", intent:"warning_consequence", diff:"hard" }
];

const TENSE_OPTIONS = [
  { key:"present_simple", label:"Present Simple", desc:"Schedules / timetables" },
  { key:"present_continuous", label:"Present Continuous", desc:"Arrangements / plans" },
  { key:"will", label:"Future (will)", desc:"Prediction / decision / promise" },
  { key:"going_to", label:"Be going to", desc:"Plan / evidence prediction" },
  { key:"first_conditional", label:"First Conditional", desc:"If + present, will..." }
];

const MEANING_OPTIONS = {
  will: [
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"offer_promise", label:"Offer / Promise", desc:"Help / promise" },
    { key:"decision_now", label:"Decision now", desc:"Made right now" },
    { key:"announcement", label:"Announcement", desc:"Official info" }
  ],
  going_to: [
    { key:"plan", label:"Plan / Intention", desc:"Already decided" },
    { key:"evidence_prediction", label:"Prediction (evidence)", desc:"Look! / evidence" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" },
    { key:"announcement", label:"Announcement", desc:"Official info" }
  ],
  present_simple: [
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" },
    { key:"plan", label:"Plan", desc:"Already decided" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" }
  ],
  present_continuous: [
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan" },
    { key:"schedule", label:"Schedule", desc:"Timetable time" },
    { key:"plan", label:"Plan", desc:"Already decided" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion" }
  ],
  first_conditional: [
    { key:"warning_consequence", label:"Warning", desc:"Bad result" },
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion" },
    { key:"plan_condition", label:"Plan", desc:"If X, we do Y" },
    { key:"prediction_result", label:"Prediction", desc:"If X, Y happens" }
  ]
};

/* ===========================================================
   State
=========================================================== */
const $ = (id)=>document.getElementById(id);

let running=false, paused=false, musicOn=false;
let level="easy"; // easy|hard

let currentType="";
let currentQ=null;
let tokens=[];
let built=[];              // STRINGS ONLY (fixes {object Object})

let streak=0;
const goal=25;
let attempts=0;
const wrongCounts={ ORDER:0, TENSE:0, MEANING:0 };

let startTime=null, timerInterval=null;

/* ===========================================================
   Utils
=========================================================== */
function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function playerName(){
  const n=$("playerName").value.trim();
  return n || "‚Äî";
}
function formatTime(ms){
  const s=Math.floor(ms/1000);
  const m=String(Math.floor(s/60)).padStart(2,"0");
  const r=String(s%60).padStart(2,"0");
  return `${m}:${r}`;
}
function secondsElapsed(){
  if(!startTime) return 0;
  return Math.floor((Date.now()-startTime)/1000);
}
function updateTimer(){
  $("timerDisplay").textContent = startTime ? formatTime(Date.now()-startTime) : "00:00";
}
function startTimer(){
  startTime=Date.now();
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{ if(running && !paused) updateTimer(); }, 500);
}
function stopTimer(){
  clearInterval(timerInterval);
  timerInterval=null;
}
function mostFailedCategory(){
  const entries=Object.entries(wrongCounts).sort((a,b)=>b[1]-a[1]);
  if(entries[0][1]===0) return "‚Äî";
  return entries[0][0];
}
function updateStats(){
  $("displayName").textContent=playerName();
  $("streak").textContent=String(streak);
  const pct=Math.max(0,Math.min(100,(streak/goal)*100));
  $("progressFill").style.width=pct+"%";
}
function setMiniType(txt){ $("miniType").textContent=txt; }
function setFeedback(text, ok=null){
  const fb=$("feedback");
  fb.textContent=text||"";
  fb.className="feedback";
  if(ok===true) fb.classList.add("ok");
  if(ok===false) fb.classList.add("no");
}
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function resetView(){
  setFeedback("");
  hide($("sentenceBox"));
  hide($("interaction"));
  hide($("cardsArea"));
  hide($("wordBank"));
  $("cardsArea").innerHTML="";
  $("wordBank").innerHTML="";
  $("interaction").innerHTML="";
  // disable order buttons by default
  $("clearBtn").disabled=true;
  $("checkBtn").disabled=true;
}
function pickPaletteClass(i){
  const pals=["pal0","pal1","pal2","pal3","pal4","pal5"];
  return pals[i % pals.length];
}

/* ===========================================================
   Difficulty
=========================================================== */
function bankForLevel(){
  if(level==="easy"){
    return BANK.filter(q => q.diff!=="hard" && q.text.split(" ").length <= 10);
  }
  return BANK.slice();
}
function typeMixForLevel(){
  return (level==="easy")
    ? ["ORDER","ORDER","TENSE","TENSE","MEANING"]
    : ["ORDER","TENSE","TENSE","MEANING","MEANING"];
}

/* ===========================================================
   Music
=========================================================== */
function toggleMusic(){
  const bgm=$("bgm");
  bgm.volume=0.35;
  if(!musicOn){
    const p=bgm.play();
    if(p && p.then){
      p.then(()=>{ musicOn=true; $("musicBtn").textContent="Music: ON"; })
       .catch(()=>{ musicOn=false; $("musicBtn").textContent="Music: OFF"; });
    }else{
      musicOn=true; $("musicBtn").textContent="Music: ON";
    }
  }else{
    bgm.pause();
    musicOn=false;
    $("musicBtn").textContent="Music: OFF";
  }
}

/* ===========================================================
   Start / Reset / Exit / Pause
=========================================================== */
function startGame(){
  const name=$("playerName").value.trim();
  if(!name){
    $("nameWarning").textContent="Please enter your name before starting.";
    return;
  }
  $("nameWarning").textContent="";

  running=true; paused=false;
  streak=0; attempts=0;
  wrongCounts.ORDER=0; wrongCounts.TENSE=0; wrongCounts.MEANING=0;

  $("pauseBtn").disabled=false;
  $("pauseBtn").textContent="Pause";

  resetView();
  updateStats();
  updateTimer();
  startTimer();
  nextQuestion();
}

function resetGame(){
  running=false; paused=false;

  stopTimer(); startTime=null; updateTimer();

  streak=0; attempts=0;
  wrongCounts.ORDER=0; wrongCounts.TENSE=0; wrongCounts.MEANING=0;
  currentType=""; currentQ=null; tokens=[]; built=[];

  resetView();
  setMiniType("Ready");
  updateStats();

  $("pauseBtn").disabled=true;
  $("pauseBtn").textContent="Pause";

  try{ $("bgm").pause(); $("bgm").currentTime=0; }catch(e){}
  musicOn=false; $("musicBtn").textContent="Music: OFF";

  closePause();
  closeExitConfirm();
  setFeedback("Reset.", true);
}

function toggleLevel(){
  level = (level==="easy") ? "hard" : "easy";
  $("levelBtn").textContent = "Level: " + level.toUpperCase();
  setFeedback("Level set to " + level.toUpperCase() + ".", true);
  if(running && !paused) nextQuestion();
}

function openPause(){
  paused=true;
  $("pauseOverlay").classList.add("show");
  $("pauseOverlay").setAttribute("aria-hidden","false");
  $("pauseBtn").textContent="Resume";
  if(musicOn) $("bgm").pause();
}
function closePause(){
  $("pauseOverlay").classList.remove("show");
  $("pauseOverlay").setAttribute("aria-hidden","true");
}
function resumeGame(){
  if(!running) return;
  paused=false;
  closePause();
  $("pauseBtn").textContent="Pause";
  if(musicOn) $("bgm").play().catch(()=>{});
}
function pauseToggle(){
  if(!running) return;
  if(paused) resumeGame();
  else openPause();
}

function openExitConfirm(){
  $("exitOverlay").classList.add("show");
  $("exitOverlay").setAttribute("aria-hidden","false");
}
function closeExitConfirm(){
  $("exitOverlay").classList.remove("show");
  $("exitOverlay").setAttribute("aria-hidden","true");
}
function confirmExit(){
  resetGame();
}

/* ===========================================================
   Next question
=========================================================== */
function nextQuestion(){
  if(!running || paused) return;

  built=[];
  resetView();

  const mix=typeMixForLevel();
  currentType=mix[Math.floor(Math.random()*mix.length)];

  const pool=bankForLevel();
  currentQ=pool[Math.floor(Math.random()*pool.length)];
  tokens=currentQ.text.split(" ");

  if(currentType==="ORDER"){
    setMiniType(level==="hard" ? "Order words (HARD)" : "Order words");
    renderOrder();
    return;
  }
  if(currentType==="TENSE"){
    setMiniType(level==="hard" ? "Verb tense (HARD)" : "Verb tense");
    showSentence(currentQ.text);
    renderTenseCards(currentQ.form);
    return;
  }
  setMiniType(level==="hard" ? "Speaker meaning (HARD)" : "Speaker meaning");
  showSentence(currentQ.text);
  renderMeaningCards(currentQ.form, currentQ.intent);
}

function showSentence(text){
  $("sentenceBig").textContent=text;
  show($("sentenceBox"));
}

/* ===========================================================
   ORDER (no {object Object})
=========================================================== */
function renderOrder(){
  const interaction=$("interaction");
  const bank=$("wordBank");
  show(interaction); show(bank);

  $("clearBtn").disabled=false;
  $("checkBtn").disabled=false;

  bank.innerHTML="";
  const words=shuffle(tokens);

  words.forEach((w)=>{
    const b=document.createElement("span");
    b.className="wordItem";
    b.textContent=w;
    b.onclick=()=>{
      if(!running || paused) return;
      built.push(w);              // push string
      b.style.display="none";
      renderBuiltWords();
    };
    bank.appendChild(b);
  });

  renderBuiltWords();
}

function renderBuiltWords(){
  const area=$("interaction");
  area.innerHTML="";
  built.forEach((w,i)=>{
    const chip=document.createElement("span");
    chip.className="builtWord";
    chip.textContent=w;
    chip.onclick=()=>{
      if(!running || paused) return;
      const removed=built.splice(i,1)[0];
      const kids=Array.from($("wordBank").children);
      for(const el of kids){
        if(el.textContent===removed && el.style.display==="none"){
          el.style.display="inline-block";
          break;
        }
      }
      renderBuiltWords();
    };
    area.appendChild(chip);
  });
}

function clearWords(){
  if(!running || paused) return;
  built=[];
  renderBuiltWords();
  Array.from($("wordBank").children).forEach(el=> el.style.display="inline-block");
}

function normalizeLoose(s){
  return String(s).trim().replace(/\s+/g," ").replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äô]/g,"'")
    .replace(/[!?.,:;]+/g,"").toLowerCase();
}
function normalizeStrict(s){
  return String(s).trim().replace(/\s+/g," ");
}
function checkOrder(){
  if(!currentQ || !running || paused) return;
  const attempt=built.join(" ");
  const ok=(level==="hard")
    ? (normalizeStrict(attempt)===normalizeStrict(currentQ.text))
    : (normalizeLoose(attempt)===normalizeLoose(currentQ.text));
  grade(ok, { activity:"ORDER", sentence: currentQ.text });
}

/* ===========================================================
   TENSE
=========================================================== */
function renderTenseCards(correctForm){
  const cards=$("cardsArea");
  show(cards);
  cards.innerHTML="";

  const want=(level==="hard") ? 6 : 4;
  const pool=shuffle([...TENSE_OPTIONS]);
  const correct=pool.find(x=>x.key===correctForm) || TENSE_OPTIONS[0];
  const others=pool.filter(x=>x.key!==correctForm).slice(0, want-1);
  const options=shuffle([correct, ...others]);

  options.forEach((o,idx)=>{
    const btn=document.createElement("button");
    btn.className="cardBtn "+pickPaletteClass(idx);
    btn.innerHTML=`<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick=()=>{ if(running && !paused) grade(o.key===correctForm, { activity:"TENSE", sentence: currentQ.text }); };
    cards.appendChild(btn);
  });
}

/* ===========================================================
   MEANING
=========================================================== */
function renderMeaningCards(form, correctIntent){
  const cards=$("cardsArea");
  show(cards);
  cards.innerHTML="";

  const want=(level==="hard") ? 6 : 4;
  const all=(MEANING_OPTIONS[form] || []).slice();
  const correct = all.find(x=>x.key===correctIntent);

  const distractors = shuffle(all.filter(x=>x.key!==correctIntent)).slice(0, want-1);
  const options = shuffle([correct, ...distractors].filter(Boolean)).slice(0, want);

  options.forEach((o,idx)=>{
    const btn=document.createElement("button");
    btn.className="cardBtn "+pickPaletteClass(idx);
    btn.innerHTML=`<div class="cardTitle">${o.label}</div><div class="cardDesc">${o.desc}</div>`;
    btn.onclick=()=>{ if(running && !paused) grade(o.key===correctIntent, { activity:"MEANING", sentence: currentQ.text, correctIntent }); };
    cards.appendChild(btn);
  });
}

function prettyIntent(key){
  return (key||"").replaceAll("_"," ").toUpperCase();
}

/* ===========================================================
   Grade + send to Sheets
=========================================================== */
function grade(correct, info){
  if(!running || paused) return;

  attempts++;
  const activity=(info && info.activity) ? info.activity : currentType;
  const sentence=(info && info.sentence) ? info.sentence : (currentQ ? currentQ.text : "");

  if(correct){
    setFeedback("‚úÖ Correct!", true);
    streak++;
    updateStats();

    sendToSheet({
      name: playerName(),
      time_s: secondsElapsed(),
      attempts,
      most_failed_category: mostFailedCategory(),
      activity_type: activity,
      sentence,
      level
    });

    if(streak>=goal){
      try{ $("winSound").play().catch(()=>{}); }catch(e){}
      setFeedback("üèÜ Mastery! 25 in a row!", true);
      running=false;
      $("pauseBtn").disabled=true;
      $("clearBtn").disabled=true;
      $("checkBtn").disabled=true;
      return;
    }
    setTimeout(nextQuestion, 550);
  }else{
    streak=0;
    if(activity==="ORDER") wrongCounts.ORDER++;
    if(activity==="TENSE") wrongCounts.TENSE++;
    if(activity==="MEANING") wrongCounts.MEANING++;
    updateStats();

    if(activity==="MEANING" && info && info.correctIntent){
      setFeedback("‚ùå Try again! Correct: "+prettyIntent(info.correctIntent), false);
    }else{
      setFeedback("‚ùå Try again!", false);
    }

    sendToSheet({
      name: playerName(),
      time_s: secondsElapsed(),
      attempts,
      most_failed_category: mostFailedCategory(),
      activity_type: activity,
      sentence,
      level
    });

    if(activity==="ORDER") clearWords();
  }
}

/* ===========================================================
   Events
=========================================================== */
$("startBtn").addEventListener("click", startGame);
$("resetBtnTop").addEventListener("click", resetGame);

$("musicBtn").addEventListener("click", toggleMusic);
$("levelBtn").addEventListener("click", toggleLevel);
$("pauseBtn").addEventListener("click", pauseToggle);
$("exitBtn").addEventListener("click", openExitConfirm);

$("clearBtn").addEventListener("click", clearWords);
$("checkBtn").addEventListener("click", checkOrder);

$("resumeBtn").addEventListener("click", resumeGame);
$("pauseResetBtn").addEventListener("click", resetGame);
$("pauseExitBtn").addEventListener("click", ()=>{ closePause(); openExitConfirm(); });

$("stayBtn").addEventListener("click", closeExitConfirm);
$("confirmExitBtn").addEventListener("click", confirmExit);

window.addEventListener("load", ()=>{
  $("bgm").volume=0.35;
  setMiniType("Ready");
  updateStats();
  updateTimer();
  resetView();
});
</script>
</body>
</html>
