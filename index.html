<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Future Grammar Mastery</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
:root {
  --bg: #0099cc;
  --card-bg: #555555;
  --text: #ffffff;
  --btn-cyan: #00ffff;
  --btn-yellow: #ffb703;
  --btn-red: #d00000;
  --btn-purple: #c77dff;
  --bar-bg: #002b36;
  --bar-fill: #00ff99;
  --accent: #00e5ff;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--bg);
  color: var(--text);
}

.app {
  max-width: 960px;
  margin: auto;
  padding: 20px;
}

header {
  text-align: center;
  margin-bottom: 14px;
}

header h1 {
  font-size: 2.2rem;
  margin: 0;
  text-shadow: 0 0 10px #000;
  font-weight: 900;
}

header p {
  margin: 6px 0 12px;
  font-weight: 800;
}

.top-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.name-box {
  display: flex;
  gap: 6px;
  align-items: center;
  background: #004b63;
  padding: 8px 10px;
  border-radius: 12px;
  box-shadow: 0 0 6px #00000055;
}

.name-box input {
  border: none;
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 1rem;
  font-weight: 800;
  outline: none;
  min-width: 170px;
}

.warning {
  color: #ffdddd;
  font-size: 0.9rem;
  min-height: 18px;
  text-align: center;
  margin-top: 6px;
  font-weight: 800;
}

.audioStatus {
  color: #d9ffff;
  font-size: 0.85rem;
  min-height: 18px;
  text-align: center;
  margin-top: 4px;
  font-weight: 800;
  opacity: .95;
}

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn {
  padding: 12px 18px;
  border: none;
  border-radius: 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 0 10px #00000055;
  font-size: 1rem;
  transition: transform .12s ease, filter .12s ease;
}
.btn:hover{ transform: translateY(-1px); filter: brightness(1.06); }

.btn.cyan { background: var(--btn-cyan); color: #000; }
.btn.yellow { background: var(--btn-yellow); color: #000; }
.btn.red { background: var(--btn-red); color: #fff; }
.btn.purple { background: var(--btn-purple); color: #000; }

.stats {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.stat-box {
  background: #004b63;
  padding: 10px 12px;
  border-radius: 12px;
  min-width: 120px;
  text-align: center;
  box-shadow: 0 0 6px #00000055;
}

.stat-label {
  font-size: 0.8rem;
  opacity: 0.95;
  font-weight: 800;
}

.stat-value {
  font-size: 1.02rem;
  font-weight: 900;
}

.progress-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 200px;
  background:#004b63;
  padding: 10px 12px;
  border-radius: 12px;
  box-shadow: 0 0 6px #00000055;
}

.progress-label {
  font-size: 0.85rem;
  font-weight: 900;
  text-align:left;
}

.progress-bar {
  position: relative;
  width: 100%;
  height: 22px;
  background: var(--bar-bg);
  border-radius: 999px;
  overflow: hidden;
  border: 2px solid #00ffffaa;
}

.progress-fill {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--bar-fill), #00ffff);
  transition: width 0.25s ease-out;
}

.card {
  background: var(--card-bg);
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 0 12px #00000088;
}

.prompt {
  font-size: 1.15rem;
  margin-bottom: 8px;
  text-align: center;
  font-weight: 900;
}

.typeLine {
  text-align:center;
  font-weight: 900;
  margin-bottom: 10px;
  color: #fff6cf;
  text-shadow: 0 0 10px rgba(0,0,0,.28);
}

.interaction {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  min-height: 50px;
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 2px solid #00ffff55;
  justify-content:center;
}

.word-bank-container {
  background-color: #1f1f1f;
  padding: 14px;
  border-radius: 12px;
  margin-top: 10px;
  margin-bottom: 12px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
  min-height: 52px;
}

.word-bank-item {
  background-color: #ffffff;
  color: #000000;
  border: 2px solid #444444;
  padding: 10px 16px;
  border-radius: 12px;
  font-weight: 900;
  font-size: 1.05rem;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
  margin-right: 10px;
  margin-bottom: 10px;
  display: inline-block;
  user-select: none;
}

.word.selected {
  background: #333333;
  color: #ffffff;
  border: 2px solid #000000;
  border-radius: 12px;
  padding: 10px 16px;
  font-weight: 900;
  font-size: 1.05rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.35);
  cursor: pointer;
  user-select: none;
}

.feedback {
  margin-top: 6px;
  font-weight: 900;
  min-height: 26px;
  text-align: center;
  font-size: 1.05rem;
}
.feedback.ok { color: #9cffb5; }
.feedback.no { color: #ffb3b3; }

.actions {
  margin-top: 10px;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* intent / mcq area */
.typeArea {
  margin-top: 10px;
}
.mcqRow{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
}
.mcqBtn{
  padding: 12px 14px;
  border-radius: 14px;
  border: 2px solid rgba(255,255,255,.22);
  font-weight: 900;
  cursor:pointer;
  background: rgba(0,0,0,.18);
  color:#fff;
  box-shadow: 0 0 10px rgba(0,0,0,.25);
  min-width: 210px;
  text-align:left;
}
.mcqBtn:hover{ filter:brightness(1.06); transform: translateY(-1px); }
.mcqSmall{ display:block; font-size:.88rem; opacity:.92; font-weight:800; margin-top:4px; }

.fillRow{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin-top: 10px;
}
.fillInput{
  padding: 12px 12px;
  border-radius: 14px;
  border: 2px solid rgba(255,255,255,.25);
  font-size:1.05rem;
  font-weight:900;
  outline:none;
  min-width: 260px;
}

.hidden{ display:none !important; }

@media (max-width: 600px) {
  header h1 { font-size: 1.75rem; }
  .mcqBtn{ min-width: 170px; }
}
  </style>
</head>

<body>
<!-- Background music -->
<audio id="bgm" loop preload="auto">
  <source src="audio/koala2.mp3" type="audio/mpeg">
</audio>

<!-- Victory sound (optional, keep if you have file) -->
<audio id="winSound" preload="auto">
  <source src="tadaa.mp3" type="audio/mpeg">
</audio>

<div class="app">
  <header>
    <h1>Future Grammar Mastery</h1>
    <p>4 mixed activities ‚Ä¢ includes speaker intention</p>

    <div class="top-row">
      <div class="name-box">
        <span style="font-size:0.9rem;font-weight:900;">Name:</span>
        <input id="playerName" type="text" placeholder="Enter your name">
      </div>

      <div class="controls">
        <button class="btn cyan" onclick="startGame()">Start</button>
        <button class="btn purple" id="musicBtn" onclick="toggleMusic()">Music: OFF</button>
        <button class="btn red" onclick="resetGame()">Reset</button>
      </div>
    </div>

    <div class="warning" id="nameWarning"></div>
    <div class="audioStatus" id="audioStatus"></div>
  </header>

  <div class="stats">
    <div class="stat-box">
      <div class="stat-label">Player</div>
      <div class="stat-value" id="displayName">---</div>
    </div>

    <div class="stat-box">
      <div class="stat-label">Activity</div>
      <div class="stat-value" id="typeStat">---</div>
    </div>

    <div class="stat-box">
      <div class="stat-label">Streak</div>
      <div class="stat-value"><span id="streak">0</span> / 25</div>
    </div>

    <div class="progress-wrapper">
      <div class="progress-label">Progress to mastery (25 in a row)</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="stat-box">
      <div class="stat-label">Strikes</div>
      <div class="stat-value" id="strikes">0</div>
    </div>

    <div class="stat-box">
      <div class="stat-label">Time</div>
      <div class="stat-value" id="timerDisplay">00:00</div>
    </div>
  </div>

  <div class="card">
    <div class="prompt" id="prompt">Enter your name and click Start</div>
    <div class="typeLine" id="typeDisplay">Activity: ---</div>

    <div class="interaction" id="interaction"></div>

    <!-- Activity-specific area (intent cards / next-word mcq / fill input) -->
    <div class="typeArea" id="typeArea"></div>

    <!-- Word bank (ORDER only) -->
    <div class="word-bank-container" id="choices"></div>

    <div class="feedback" id="feedback"></div>

    <div class="actions" id="actionRow">
      <button class="btn red" onclick="clearWords()">Clear</button>
      <button class="btn yellow" onclick="checkAnswer()">Check</button>
    </div>
  </div>
</div>

<script>
/* -----------------------------------------------------------
   KEEP YOUR WORKING SENTENCE POOL (for ORDER/FILL/NEXT_WORD)
   (This is your original idea: plain sentences)
----------------------------------------------------------- */
const sentences = [
  "The train leaves at 8 a.m. tomorrow.","School starts at 9 o'clock on Monday.","The plane lands at 3:15 p.m.","The football match kicks off at noon.","The shop opens at 9 a.m. on Saturday.","The concert begins at 7 p.m. next Friday.","The ferry departs at 2 p.m.","My flight departs at 6 in the morning.","The museum closes at 6 p.m.","Our exam starts at 10 a.m. sharp.","The show begins at 7:30 tonight.","The train to Madrid leaves at 4:20.","The bus arrives at the station at 5:30.","The library opens at 8:30 a.m.","The movie starts at 6:45 tonight.",
  "School doesn't start at 8 o'clock tomorrow.","The concert doesn't begin at 6 p.m.","The bus doesn't arrive at 6:30.","My flight doesn't depart at 7 in the morning.","The shop doesn't open at 10 a.m.","The museum doesn't close at 5 p.m.","The football match doesn't kick off at 1 p.m.","The plane doesn't land at 4 p.m.","The ferry doesn't depart at 3 p.m.","Our exam doesn't start at 11 a.m.","The train doesn't leave at 9 a.m.","The library doesn't open at 9 a.m.","The movie doesn't start at 7:30 tonight.","The train to Paris doesn't leave at 5:15.","The show doesn't begin at 8:30 tonight.",
  "Does the train leave at 8 a.m. tomorrow?","Does school start at 9 o'clock on Monday?","Does the plane land at 3:15 p.m.?","Does the football match kick off at noon?","Does the shop open at 9 a.m. on Saturday?","Does the concert begin at 7 p.m. next Friday?","Does the ferry depart at 2 p.m.?","Does your flight depart at 6 in the morning?","Does the museum close at 6 p.m.?","Does our exam start at 10 a.m. sharp?","Does the show begin at 7:30 tonight?","Does the train to Madrid leave at 4:20?","Does the bus arrive at the station at 5:30?","Does the library open at 8:30 a.m.?","Does the movie start at 6:45 tonight?",
  "I am meeting my friends at the cinema tonight.","We are watching a movie tonight.","We are having dinner with our cousins tomorrow.","I am seeing the dentist on Friday.","She is visiting her grandma this weekend.","We are celebrating my birthday on Saturday.","They are going shopping after school.","She is flying to Paris next week.","She is starting her new job next week.","They are coming over for lunch tomorrow.","He is playing football on Saturday.","He is taking his driving test on Monday.","I am joining the art club next term.","They are moving house next month.","We are going to the zoo next Sunday.",
  "I am not meeting my friends tonight.","We aren't watching a movie tonight.","We aren't having dinner tomorrow.","I am not seeing the dentist on Friday.","She isn't visiting her grandma this weekend.","We aren't celebrating my birthday on Saturday.","They aren't going shopping after school.","She isn't flying to Paris next week.","She isn't starting her new job next week.","They aren't coming over for lunch tomorrow.","He isn't playing football on Saturday.","He isn't taking his driving test on Monday.","I am not joining the art club next term.","They aren't moving house next month.","We aren't going to the zoo next Sunday.",
  "Are you meeting your friends tonight?","Are we watching a movie tonight?","Are we having dinner tomorrow?","Am I seeing the dentist on Friday?","Is she visiting her grandma this weekend?","Are we celebrating your birthday on Saturday?","Are they going shopping after school?","Is she flying to Paris next week?","Is she starting her new job next week?","Are they coming over for lunch tomorrow?","Is he playing football on Saturday?","Is he taking his driving test on Monday?","Am I joining the art club next term?","Are they moving house next month?","Are we going to the zoo next Sunday?",
  "She will call you later.","He will arrive at noon.","They will go to the concert.","I will help you with your homework.","We will watch a movie tonight.","She will bake a cake.","He will fix his bike.","They will travel to Spain next summer.","We will visit grandma this weekend.","We will have a party on Friday.","I will bring the snacks.","They will win the match.","He will study for the test.","I will clean my room tomorrow.","She will join the team.",
  "I won't help you with your homework.","We won't watch a movie tonight.","She won't call you later.","He won't fix his bike.","They won't travel to Spain next summer.","We won't visit grandma this weekend.","We won't have a party on Friday.","They won't go to the concert.","He won't arrive at noon.","I won't clean my room tomorrow.","They won't win the match.","He won't study for the test.","She won't bake a cake.","I won't bring the snacks.","She won't join the team.",
  "Will she call you later?","Will he arrive at noon?","Will they go to the concert?","Will you help me with my homework?","Will we watch a movie tonight?","Will they travel to Spain next summer?","Will he fix his bike?","Will we have a party on Friday?","Will you clean your room tomorrow?","Will they win the match?","Will he study for the test?","Will she bake a cake?","Will you bring the snacks?","Will we visit grandma this weekend?","Will she join the team?",
  "I am going to visit London next week.","He is going to learn Spanish.","They are going to play video games.","We are going to bake a cake tomorrow.","We are going to travel to Italy.","She is going to study for the exam.","He is going to cook dinner tonight.","They are going to have a barbecue.","They are going to watch a movie tonight.","I am going to read a new book.","I am going to help my dad clean the garage.","We are going to visit the museum.","She is going to start a new job.","She is going to paint her room.","They are going to play football in the park.",
  "I am not going to visit London next week.","He isn't going to learn Spanish.","They aren't going to play video games.","We aren't going to bake a cake tomorrow.","We aren't going to travel to Italy.","She isn't going to study for the exam.","He isn't going to cook dinner tonight.","They aren't going to have a barbecue.","They aren't going to watch a movie tonight.","I am not going to read a new new book.","I am not going to help my dad clean the garage.","We aren't going to visit the museum.","She isn't going to start a new job.","She isn't going to paint her room.","He isn't going to play football on Saturday.",
  "Are you going to visit London next week?","Is he going to learn Spanish?","Are they going to play video games?","Are we going to bake a cake tomorrow?","Are we going to travel to Italy?","Is she going to study for the exam?","Is he going to cook dinner tonight?","Are they going to have a barbecue?","Are they going to watch a movie tonight?","Are you going to read a new book?","Are you going to help your dad clean the garage?","Are we going to visit the museum?","Is she going to start a new job?","Is she going to paint her room?","Is he going to play football on Saturday?",
  "If it rains, we will stay at home.","If it‚Äôs sunny, we will go to the beach.","If we leave now, we will catch the bus.","If you help me, I will finish faster.","If she studies, she will do well.","If they win, we will celebrate.","If he trains hard, he will win.","If we save money, we will go on holiday.","If I study hard, I will pass the exam.","If I see her, I will say hello.","If she calls me, I will answer.","If they arrive late, we will wait.","If he finishes early, he will join us.","If we go to the park, we will play football.","If I get the job, I will be happy.",
  "If it rains, we won't go outside.","If we don't leave now, we won't catch the bus.","If I don't get the job, I won't be happy.","If I don't see her, I won't say hello.","If she doesn't study, she won't do well.","If it‚Äôs not sunny, we won't go to the beach.","If we don't go to the park, we won't play football.","If I don't study, I won't pass the exam.","If you don't help me, I won't finish in time.","If they don't win, we won't celebrate.","If we don't save money, we won't go on holiday.","If he doesn't train, he won't win.","If they don't arrive, we won't wait.","If she doesn't call me, I won't know.","If he doesn't finish, he won't join us.",
  "If it rains, will we stay at home?","If you study hard, will you pass the exam?","If he trains hard, will he win?","If we save money, will we go on holiday?","If I study hard, will I pass the exam?","If she studies, will she do well?","If they win, will we celebrate?","If we go to the park, will we play football?","If I get the job, will I be happy?","If you help me, will I finish faster?","If she calls you, will you answer?","If they arrive late, will we wait?","If he finishes early, will he join us?","If we leave now, will we catch the bus?","If it‚Äôs sunny, will we go to the beach?"
];

/* -----------------------------------------------------------
   NEW: INTENT BANK (60 tagged) for INTENT activity only
----------------------------------------------------------- */
const INTENT_BANK = [
  // WILL ‚Äî prediction
  { text:"I think it will rain later.", form:"will", intent:"prediction" },
  { text:"They will probably win the match.", form:"will", intent:"prediction" },
  { text:"I‚Äôm sure you will enjoy the trip.", form:"will", intent:"prediction" },
  { text:"Maybe the teacher will give us homework.", form:"will", intent:"prediction" },
  { text:"Do you think it will be difficult?", form:"will", intent:"prediction" },
  { text:"It won‚Äôt be easy to finish today.", form:"will", intent:"prediction" },

  // WILL ‚Äî offer/promise
  { text:"I‚Äôll help you with that exercise.", form:"will", intent:"offer_promise" },
  { text:"Don‚Äôt worry, I‚Äôll call you after class.", form:"will", intent:"offer_promise" },
  { text:"I won‚Äôt tell anyone, I promise.", form:"will", intent:"offer_promise" },
  { text:"We‚Äôll bring the snacks for the trip.", form:"will", intent:"offer_promise" },
  { text:"Will you carry my bag for a minute?", form:"will", intent:"offer_promise" },
  { text:"I‚Äôll explain it again if you want.", form:"will", intent:"offer_promise" },

  // WILL ‚Äî decision now
  { text:"Okay, I‚Äôll do it now.", form:"will", intent:"decision_now" },
  { text:"Wait‚ÄîI‚Äôll message her right now.", form:"will", intent:"decision_now" },
  { text:"I‚Äôll take the blue one.", form:"will", intent:"decision_now" },
  { text:"Alright, we‚Äôll sit here.", form:"will", intent:"decision_now" },
  { text:"I won‚Äôt go out tonight then.", form:"will", intent:"decision_now" },
  { text:"Oh! I‚Äôll answer it.", form:"will", intent:"decision_now" },

  // WILL ‚Äî announcement/future fact
  { text:"The show will start in five minutes.", form:"will", intent:"announcement" },
  { text:"The gate will open soon.", form:"will", intent:"announcement" },
  { text:"The results will be published tomorrow.", form:"will", intent:"announcement" },
  { text:"Your order will arrive on Friday.", form:"will", intent:"announcement" },
  { text:"The exam will not take longer than one hour.", form:"will", intent:"announcement" },
  { text:"Will the museum be open tomorrow?", form:"will", intent:"announcement" },

  // GOING TO ‚Äî plan
  { text:"I‚Äôm going to study for the test tonight.", form:"going_to", intent:"plan" },
  { text:"We‚Äôre going to meet at the library after school.", form:"going_to", intent:"plan" },
  { text:"She‚Äôs going to apply for that summer course.", form:"going_to", intent:"plan" },
  { text:"They aren‚Äôt going to travel this weekend.", form:"going_to", intent:"plan" },
  { text:"Are you going to watch the new episode tonight?", form:"going_to", intent:"plan" },
  { text:"I‚Äôm not going to buy a new phone this month.", form:"going_to", intent:"plan" },

  // GOING TO ‚Äî evidence prediction
  { text:"Look at those clouds! It‚Äôs going to rain.", form:"going_to", intent:"evidence_prediction" },
  { text:"Listen to that thunder‚Äîthere‚Äôs going to be a storm.", form:"going_to", intent:"evidence_prediction" },
  { text:"Be careful! You‚Äôre going to drop your laptop.", form:"going_to", intent:"evidence_prediction" },
  { text:"That glass is going to fall!", form:"going_to", intent:"evidence_prediction" },
  { text:"You‚Äôre going to faint‚Äîsit down.", form:"going_to", intent:"evidence_prediction" },
  { text:"He isn‚Äôt going to pass if he keeps skipping homework.", form:"going_to", intent:"evidence_prediction" },

  // PRESENT CONTINUOUS ‚Äî arrangement
  { text:"I‚Äôm meeting my friends at 6 p.m. today.", form:"present_continuous", intent:"arrangement" },
  { text:"We‚Äôre having dinner with my cousins tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"She‚Äôs seeing the dentist on Friday.", form:"present_continuous", intent:"arrangement" },
  { text:"They‚Äôre coming over for lunch tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"He isn‚Äôt playing football on Saturday.", form:"present_continuous", intent:"arrangement" },
  { text:"Are you visiting your grandma this weekend?", form:"present_continuous", intent:"arrangement" },

  // PRESENT SIMPLE ‚Äî schedule/timetable
  { text:"The train leaves at 8:10 tomorrow morning.", form:"present_simple", intent:"schedule" },
  { text:"School starts at 9 o‚Äôclock on Monday.", form:"present_simple", intent:"schedule" },
  { text:"The plane lands at 3:15 p.m.", form:"present_simple", intent:"schedule" },
  { text:"The concert begins at 7 p.m. on Friday.", form:"present_simple", intent:"schedule" },
  { text:"The museum closes at 6 p.m.", form:"present_simple", intent:"schedule" },
  { text:"Does the match start at noon?", form:"present_simple", intent:"schedule" },

  // FIRST CONDITIONAL ‚Äî intent types
  { text:"If you don‚Äôt study, you‚Äôll fail the test.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If you touch that, it will break.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If it rains, we‚Äôll stay at home.", form:"first_conditional", intent:"plan_condition" },
  { text:"If the bus is full, we‚Äôll take the next one.", form:"first_conditional", intent:"plan_condition" },
  { text:"If she studies, she‚Äôll do well.", form:"first_conditional", intent:"prediction_result" },
  { text:"If they train hard, they‚Äôll win.", form:"first_conditional", intent:"prediction_result" }
];

/* Intent options shown (cards) by form */
const INTENT_OPTIONS = {
  will: [
    { key:"prediction", label:"Prediction", desc:"Guess/opinion/hope (I think, probably‚Ä¶)" },
    { key:"offer_promise", label:"Offer / Promise", desc:"I‚Äôll help / I won‚Äôt‚Ä¶ (promise)" },
    { key:"decision_now", label:"Decision now", desc:"Spontaneous decision: Okay, I‚Äôll‚Ä¶" },
    { key:"announcement", label:"Announcement", desc:"Official/factual future info" }
  ],
  going_to: [
    { key:"plan", label:"Plan / Intention", desc:"Already decided plan" },
    { key:"evidence_prediction", label:"Prediction (evidence)", desc:"Look!/Listen! evidence now" }
  ],
  present_continuous: [
    { key:"arrangement", label:"Arrangement", desc:"Definite arrangement with time/people" }
  ],
  present_simple: [
    { key:"schedule", label:"Schedule / Timetable", desc:"Public timetable times" }
  ],
  first_conditional: [
    { key:"warning_consequence", label:"Warning / Consequence", desc:"If you do this, bad result‚Ä¶" },
    { key:"advice_suggestion", label:"Advice / Suggestion", desc:"If you‚Ä¶, you should/can‚Ä¶" },
    { key:"plan_condition", label:"Plan (depends on condition)", desc:"If X happens, we‚Äôll do Y" },
    { key:"prediction_result", label:"Prediction (result)", desc:"If X happens, Y will happen" }
  ]
};

/* -----------------------------------------------------------
   GAME STATE
----------------------------------------------------------- */
let current = "";
let tokens = [];
let built = [];

let currentType = "";
let currentQ = null; // only used by INTENT activity

let streak = 0;
let strikes = 0;
const masteryGoal = 25;

let timerInterval = null;
let startTime = null;

let musicOn = false;

/* 4 activity types (no deleting what works) */
const TYPES = ["ORDER","FILL_GAP","NEXT_WORD","INTENT"];

/* -----------------------------------------------------------
   FIXED SHUFFLE (your old one was broken)
----------------------------------------------------------- */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function formatTime(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
  const seconds = String(totalSeconds % 60).padStart(2, "0");
  return `${minutes}:${seconds}`;
}

function updateTimerDisplay() {
  if (!startTime) return;
  document.getElementById("timerDisplay").textContent = formatTime(Date.now() - startTime);
}

function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 500);
}

function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

/* -----------------------------------------------------------
   MUSIC TOGGLE (audio/koala2.mp3)
----------------------------------------------------------- */
function setAudioStatus(msg){ document.getElementById("audioStatus").textContent = msg || ""; }

function toggleMusic() {
  const bgm = document.getElementById("bgm");
  const btn = document.getElementById("musicBtn");
  bgm.volume = 0.35;

  if (!musicOn) {
    const p = bgm.play();
    if (p && typeof p.then === "function") {
      p.then(() => {
        musicOn = true;
        btn.textContent = "Music: ON";
        setAudioStatus("Audio: playing ‚úÖ");
      }).catch(err => {
        musicOn = false;
        btn.textContent = "Music: OFF";
        setAudioStatus("Audio error ‚ùå Check: audio/koala2.mp3");
        console.error(err);
      });
    } else {
      musicOn = true;
      btn.textContent = "Music: ON";
      setAudioStatus("Audio: playing ‚úÖ");
    }
  } else {
    bgm.pause();
    musicOn = false;
    btn.textContent = "Music: OFF";
    setAudioStatus("Audio: paused ‚è∏Ô∏è");
  }
}

/* -----------------------------------------------------------
   START / RESET
----------------------------------------------------------- */
function startGame() {
  const nameInput = document.getElementById("playerName");
  const warning = document.getElementById("nameWarning");
  const displayName = document.getElementById("displayName");

  const name = nameInput.value.trim();
  if (name === "") {
    warning.textContent = "Please enter your name before starting.";
    return;
  }
  warning.textContent = "";
  displayName.textContent = name;

  streak = 0;
  strikes = 0;
  built = [];
  updateStats();

  document.getElementById("feedback").textContent = "";
  document.getElementById("prompt").textContent = "Answer the challenge:";
  document.getElementById("interaction").innerHTML = "";
  document.getElementById("choices").innerHTML = "";
  document.getElementById("typeArea").innerHTML = "";

  document.getElementById("bgm").load();
  setAudioStatus("Audio ready (press Music).");

  startTimer();
  nextQuestion();
}

function resetGame() {
  stopTimer();
  startTime = null;
  document.getElementById("timerDisplay").textContent = "00:00";

  streak = 0;
  strikes = 0;
  built = [];
  current = "";
  currentQ = null;

  updateStats();

  document.getElementById("prompt").textContent = "Enter your name and click Start";
  document.getElementById("typeDisplay").textContent = "Activity: ---";
  document.getElementById("typeStat").textContent = "---";
  document.getElementById("interaction").innerHTML = "";
  document.getElementById("choices").innerHTML = "";
  document.getElementById("typeArea").innerHTML = "";
  document.getElementById("feedback").textContent = "";

  const bgm = document.getElementById("bgm");
  bgm.pause();
  musicOn = false;
  document.getElementById("musicBtn").textContent = "Music: OFF";
  setAudioStatus("");
}

/* -----------------------------------------------------------
   STATS
----------------------------------------------------------- */
function updateStats() {
  document.getElementById("streak").textContent = streak;
  document.getElementById("strikes").textContent = strikes;
  const fill = document.getElementById("progressFill");
  const pct = Math.max(0, Math.min(100, (streak / masteryGoal) * 100));
  fill.style.width = pct + "%";
}

/* -----------------------------------------------------------
   NEXT QUESTION (keeps working stuff, adds INTENT)
----------------------------------------------------------- */
function setTypeUI(type){
  const nice = (type==="ORDER") ? "ORDER (Word Bank)"
            : (type==="FILL_GAP") ? "FILL (Missing word)"
            : (type==="NEXT_WORD") ? "NEXT WORD (MCQ build)"
            : "INTENT CARDS (Speaker purpose)";
  document.getElementById("typeDisplay").textContent = "Activity: " + nice;
  document.getElementById("typeStat").textContent = nice;
}

function clearUI(){
  document.getElementById("interaction").innerHTML = "";
  document.getElementById("choices").innerHTML = "";
  document.getElementById("typeArea").innerHTML = "";
  document.getElementById("feedback").textContent = "";
  document.getElementById("feedback").className = "feedback";
  document.getElementById("choices").classList.remove("hidden");
  document.getElementById("actionRow").classList.remove("hidden");
}

function nextQuestion() {
  built = [];
  currentQ = null;
  clearUI();

  // pick an activity randomly
  currentType = TYPES[Math.floor(Math.random() * TYPES.length)];
  setTypeUI(currentType);

  if (currentType === "INTENT") {
    // Use INTENT_BANK only
    currentQ = INTENT_BANK[Math.floor(Math.random() * INTENT_BANK.length)];
    current = currentQ.text;
    tokens = current.split(" ");
    renderIntentCards();
    return;
  }

  // Otherwise: use your original sentences list (no changes)
  current = sentences[Math.floor(Math.random() * sentences.length)];
  tokens = current.split(" ");

  if (currentType === "ORDER") renderOrder();
  else if (currentType === "FILL_GAP") renderFillGap();
  else renderNextWordMCQ();
}

/* -----------------------------------------------------------
   ACTIVITY 1: ORDER (your working logic)
----------------------------------------------------------- */
function renderOrder() {
  document.getElementById("prompt").textContent = "Build the sentence (tap words):";
  const words = shuffle([...tokens]);

  const choices = document.getElementById("choices");
  words.forEach(word => {
    const span = document.createElement("span");
    span.textContent = word;
    span.className = "word-bank-item";
    span.onclick = () => {
      built.push(word);
      span.style.display = "none";
      renderBuilt();
    };
    choices.appendChild(span);
  });
}

function renderBuilt() {
  const area = document.getElementById("interaction");
  area.innerHTML = "";
  built.forEach((word, i) => {
    const span = document.createElement("span");
    span.textContent = word;
    span.className = "word selected";
    span.onclick = () => {
      const removed = built.splice(i, 1)[0];
      renderBuilt();
      Array.from(document.getElementById("choices").children).forEach(btn => {
        if (btn.textContent === removed && btn.style.display === "none") {
          btn.style.display = "inline-block";
        }
      });
    };
    area.appendChild(span);
  });
}

function clearWords() {
  built = [];
  renderBuilt();
  Array.from(document.getElementById("choices").children).forEach(btn => {
    btn.style.display = "inline-block";
  });
}

/* -----------------------------------------------------------
   ACTIVITY 2: FILL GAP (minimal)
----------------------------------------------------------- */
let missingIndex = -1;
let missingAnswer = "";

function cleanToken(t){ return t.replace(/[.,!?]$/g, ""); }

function renderFillGap(){
  document.getElementById("prompt").textContent = "Type the missing word:";
  document.getElementById("choices").classList.add("hidden");

  const candidates = tokens
    .map((t,i)=>({t,i}))
    .filter(x => cleanToken(x.t).length >= 3);

  const pick = candidates[Math.floor(Math.random()*candidates.length)] || { i:1, t: tokens[1] };
  missingIndex = pick.i;
  missingAnswer = pick.t;

  const masked = tokens.map((t,i)=> i===missingIndex ? "_____" : t).join(" ");

  const area = document.getElementById("interaction");
  const chip = document.createElement("span");
  chip.textContent = masked;
  chip.className = "word selected";
  chip.style.cursor = "default";
  area.appendChild(chip);

  const typeArea = document.getElementById("typeArea");
  const row = document.createElement("div");
  row.className = "fillRow";

  const input = document.createElement("input");
  input.className = "fillInput";
  input.id = "fillInput";
  input.placeholder = "Type the missing word‚Ä¶";
  input.autocomplete = "off";
  input.spellcheck = false;

  row.appendChild(input);
  typeArea.appendChild(row);

  setTimeout(()=> input.focus(), 60);
}

/* -----------------------------------------------------------
   ACTIVITY 3: NEXT WORD (MCQ build)
----------------------------------------------------------- */
function renderNextWordMCQ(){
  document.getElementById("prompt").textContent = "Choose the next word:";
  document.getElementById("choices").classList.add("hidden");
  renderNextWordStep();
}

function renderNextWordStep(){
  const area = document.getElementById("interaction");
  area.innerHTML = "";
  built.forEach(w => {
    const span = document.createElement("span");
    span.textContent = w;
    span.className = "word selected";
    span.style.cursor = "default";
    area.appendChild(span);
  });

  const typeArea = document.getElementById("typeArea");
  typeArea.innerHTML = "";

  if (built.length >= tokens.length){
    // auto-grade full sentence
    const attempt = built.join(" ");
    gradeAttempt(attempt === current);
    return;
  }

  const correct = tokens[built.length];
  const distractPool = shuffle([...tokens]).filter(t => t !== correct);
  const distractors = [];
  for (const t of distractPool){
    if (distractors.length >= 3) break;
    if (!distractors.includes(t)) distractors.push(t);
  }
  while (distractors.length < 3){
    distractors.push(tokens[Math.floor(Math.random()*tokens.length)]);
  }

  const options = shuffle([correct, ...distractors]);

  const row = document.createElement("div");
  row.className = "mcqRow";
  options.forEach(opt => {
    const b = document.createElement("button");
    b.className = "mcqBtn";
    b.textContent = opt;
    b.onclick = () => {
      built.push(opt);
      renderNextWordStep();
    };
    row.appendChild(b);
  });

  typeArea.appendChild(row);
}

/* -----------------------------------------------------------
   ACTIVITY 4: INTENT CARDS (new, safe, separate bank)
----------------------------------------------------------- */
function prettyForm(form){
  if(form==="will") return "WILL";
  if(form==="going_to") return "BE GOING TO";
  if(form==="present_continuous") return "PRESENT CONTINUOUS";
  if(form==="present_simple") return "PRESENT SIMPLE";
  return "FIRST CONDITIONAL";
}

function renderIntentCards(){
  document.getElementById("prompt").textContent = "Read the sentence. Choose the speaker‚Äôs intention:";
  document.getElementById("choices").classList.add("hidden");
  document.getElementById("actionRow").classList.add("hidden");

  const area = document.getElementById("interaction");
  const chip = document.createElement("span");
  chip.textContent = current;
  chip.className = "word selected";
  chip.style.cursor = "default";
  area.appendChild(chip);

  const typeArea = document.getElementById("typeArea");
  const row = document.createElement("div");
  row.className = "mcqRow";

  const opts = (INTENT_OPTIONS[currentQ.form] || []).slice();

  // If only 1 option exists (e.g., present simple schedule), add two safe distractors
  if (opts.length === 1){
    const extra = [
      { key:"prediction", label:"Prediction", desc:"Guess/opinion about the future" },
      { key:"plan", label:"Plan / Intention", desc:"Already decided plan" }
    ].filter(x => x.key !== opts[0].key);
    opts.push(...extra.slice(0,2));
  }

  shuffle(opts);

  opts.forEach(o => {
    const b = document.createElement("button");
    b.className = "mcqBtn";
    b.innerHTML = `${o.label}<span class="mcqSmall">${o.desc || ""}</span>`;
    b.onclick = () => gradeIntent(o.key);
    row.appendChild(b);
  });

  typeArea.appendChild(row);

  // small hint in feedback line (non-intrusive)
  const fb = document.getElementById("feedback");
  fb.textContent = `Form inside the sentence: ${prettyForm(currentQ.form)}`;
  fb.className = "feedback";
}

function gradeIntent(chosenKey){
  const correct = (chosenKey === currentQ.intent);
  gradeAttempt(correct, true);
}

/* -----------------------------------------------------------
   CHECK BUTTON (works for ORDER + FILL only)
----------------------------------------------------------- */
function checkAnswer() {
  if (!current) return;

  if (currentType === "ORDER"){
    const attempt = built.join(" ");
    gradeAttempt(attempt === current);
    return;
  }

  if (currentType === "FILL_GAP"){
    const input = document.getElementById("fillInput");
    const user = (input?.value || "").trim();
    const ok = cleanToken(user).toLowerCase() === cleanToken(missingAnswer).toLowerCase();
    gradeAttempt(ok);
    return;
  }

  // NEXT_WORD + INTENT are graded by clicking buttons
}

/* -----------------------------------------------------------
   GRADING
----------------------------------------------------------- */
function gradeAttempt(correct, isIntent=false){
  const feedback = document.getElementById("feedback");
  if (correct) {
    feedback.textContent = "‚úÖ Correct!";
    feedback.className = "feedback ok";
    streak++;
    updateStats();

    if (streak >= masteryGoal) {
      // simple mastery message (no overlay to keep changes minimal)
      feedback.textContent = "üèÜ Mastery! 25 in a row!";
      feedback.className = "feedback ok";
      try { document.getElementById("winSound").play().catch(()=>{}); } catch(e){}
      return;
    }

    setTimeout(() => nextQuestion(), 650);
  } else {
    if (isIntent && currentQ){
      feedback.textContent = `‚ùå Not this one. Correct intent: ${currentQ.intent.replaceAll("_"," ")}`;
    } else if (currentType === "FILL_GAP"){
      feedback.textContent = `‚ùå Try again! (Answer: ${missingAnswer})`;
    } else {
      feedback.textContent = "‚ùå Try again!";
    }

    feedback.className = "feedback no";
    strikes++;
    streak = 0;
    updateStats();

    // reset attempt for some activities
    if (currentType === "ORDER") clearWords();
    if (currentType === "FILL_GAP"){
      const input = document.getElementById("fillInput");
      if (input) { input.value=""; input.focus(); }
    }
  }
}

/* -----------------------------------------------------------
   INIT
----------------------------------------------------------- */
window.addEventListener("load", () => {
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.35;
  bgm.addEventListener("error", () => setAudioStatus("Audio load error ‚ùå Check audio/koala2.mp3"));
});
</script>
</body>
</html>

