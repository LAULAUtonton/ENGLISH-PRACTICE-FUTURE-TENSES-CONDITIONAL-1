https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Future Grammar Mastery ‚Äî Streak to 25</title>

  <!-- ====== GOOGLE SHEETS LOGGING (optional) ====== -->
  <script>
    // IMPORTANT:
    // 1) Put your deployed Apps Script Web App URL here:
    const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbxfuvpOoU7N--HTkzCUpWWP3uo-mwcKA71nne-yyhRFfXMj_XR0Wq0WXV6O-CbSMM6x/exec";
    // 2) Must match SECRET_KEY in Apps Script:
    const SECRET_KEY = "CHANGE_ME_TO_SOMETHING_PRIVATE";

    async function sendAttemptToSheet(row){
      // If you keep placeholder values, do nothing:
      if (!SHEET_ENDPOINT || SHEET_ENDPOINT.includes("PASTE_YOUR_WEB_APP_URL_HERE")) return;

      const payload = {
        secret: SECRET_KEY,
        player: row.player,
        time_s: row.time_s,
        ok: row.ok,
        streak_after: row.streak_after,

        level: row.level,
        mode: row.mode,              // order | tense | meaning
        form: row.form || "",        // present_simple | will | etc.
        intent: row.intent || "",    // prediction | plan | etc.
        prompt: row.prompt || "",
        choice: row.choice || "",
        correct: row.correct || "",
        detail: row.detail || {}     // always an object
      };

      try{
        await fetch(SHEET_ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
      }catch(err){
        console.error("Error sending to sheet:", err);
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#141824;

      --surface:#1c2333;
      --surface2:#222b3f;
      --panel:#1a2336;

      --text:#ffffff;
      --muted:#b7c0d4;

      --primary:#ff6b35;
      --accent:#00d4ff;

      --success:#22c55e;
      --error:#ef4444;

      --border:#36425c;

      --shadow:0 10px 30px rgba(0,0,0,.45);
      --shadow2:0 4px 15px rgba(0,0,0,.35);

      --r-sm:10px;
      --r-md:16px;
      --r-lg:24px;
      --r-xl:30px;
      --pill:9999px;

      --p1:#ff4fa0;
      --p2:#a855f7;
      --p3:#00d4ff;
      --p4:#22c55e;
      --p5:#f59e0b;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    body{
      font-family:'Poppins',system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.5;
      height:100dvh;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:10px;
    }

    h1,h2,h3,.title,.stat,.btnPrimary,.btnSecondary,.smallBtn{
      font-family:'Nunito',sans-serif;
    }

    .skip-link{
      position:absolute; top:-60px; left:0;
      background:var(--primary);
      color:#fff;
      padding:12px 20px;
      border-radius:0 0 var(--r-md) var(--r-md);
      z-index:200;
      font-weight:900;
      text-decoration:none;
    }
    .skip-link:focus{top:0}

    .container{
      width:100%;
      max-width:1320px;
      height:calc(100dvh - 20px);
      overflow:hidden;

      background:var(--surface);
      border-radius:var(--r-xl);
      padding:clamp(10px,2vw,18px);
      box-shadow:var(--shadow);
      border:1px solid var(--border);

      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:clamp(8px,1.2vw,12px);
    }

    .header{
      display:flex;
      gap:clamp(10px,1.5vw,14px);
      align-items:center;
      flex-wrap:wrap;
      padding-bottom:clamp(6px,1vw,10px);
      border-bottom:2px solid var(--border);
    }
    .logo{
      width:clamp(44px,6vw,62px);
      height:clamp(44px,6vw,62px);
      border-radius:var(--r-lg);
      background:var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:clamp(22px,4vw,34px);
      flex-shrink:0;
      box-shadow:var(--shadow2);
    }
    .header-text{flex:1;min-width:220px}
    .title{
      font-size:clamp(1.2rem,3.2vw,2rem);
      font-weight:900;
      line-height:1.15;
      color:#fff;
    }
    .lead{
      font-size:clamp(.82rem,1.6vw,1.05rem);
      color:var(--muted);
      margin-top:4px;
    }
    .lead b{color:var(--accent);font-weight:900}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .statRow{display:flex;gap:10px;flex-wrap:wrap}
    .stat{
      border:2px solid var(--border);
      border-radius:var(--r-md);
      padding:12px 14px;
      font-weight:900;
      font-size:clamp(.82rem,1.35vw,.98rem);
      display:flex;
      align-items:center;
      gap:10px;
      min-width:180px;
      min-height:56px;
      background:#26304a;
    }
    .stat-icon{
      width:40px;height:40px;border-radius:var(--r-sm);
      display:flex;align-items:center;justify-content:center;
      font-size:20px;
      background:#101827;
      border:2px solid rgba(255,255,255,.12);
    }
    .playerTag{
      font-size:clamp(.82rem,1.35vw,.98rem);
      color:var(--muted);
      background:var(--surface2);
      padding:12px 14px;
      border-radius:var(--r-md);
      border:2px solid var(--border);
      min-height:56px;
      display:flex;align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .playerTag strong{color:var(--accent)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:2px solid var(--border);
      border-radius:999px;
      padding:8px 12px;
      background:#101827;
      color:#fff;
      font-weight:900;
    }
    .pill small{color:var(--muted);font-weight:900}

    .mainArea{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      min-height:0;
    }
    @media (min-width:900px){
      .mainArea{
        grid-template-columns:minmax(0,1fr) minmax(300px,360px);
        align-items:stretch;
      }
    }

    .game{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    #card{
      border-radius:var(--r-xl);
      padding:14px;
      background:#2a3552;
      box-shadow:var(--shadow2);
      border:2px solid var(--border);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height:clamp(95px,12vh,140px);
    }
    #cardLabel{
      font-size:.82rem;
      font-weight:900;
      color:#fff;
      padding:6px 12px;
      border-radius:var(--pill);
      background:#101827;
      border:2px solid rgba(255,255,255,.14);
      margin-bottom:10px;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    #cardText{
      width:100%;
      max-width:760px;
      padding:12px 14px;
      border-radius:var(--r-lg);
      background:#ffffff;
      color:#111827;
      font-weight:900;
      font-size:clamp(1.02rem,2.0vw,1.55rem);
      line-height:1.35;
      box-shadow:var(--shadow);
      user-select:none;
    }

    /* Built sentence area (ORDER mode only) */
    #orderBox{
      border:2px solid var(--border);
      border-radius:var(--r-xl);
      background:var(--surface2);
      padding:14px 16px;
      min-height:74px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#fff;
      overflow:hidden;
    }
    #orderBox.empty{
      border-style:dashed;
      color:var(--muted);
    }

    #options{
      width:100%;
      border-radius:var(--r-lg);
      border:2px solid var(--border);
      background:var(--surface2);
      padding:12px;
      min-height:0;
      max-height:34vh;
      overflow:auto;
    }

    /* multiple-choice grid */
    #options.mode-multiple{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      align-content:center;
    }
    @media (min-width:520px){
      #options.mode-multiple{grid-template-columns:1fr 1fr}
    }

    .choiceCard{
      border:none;
      border-radius:var(--r-lg);
      padding:18px 18px;
      color:#111827;
      font-weight:900;
      cursor:pointer;
      text-align:left;
      display:flex;
      align-items:center;
      gap:12px;
      min-height:98px;
      box-shadow:var(--shadow);
      transition:transform .16s ease, filter .16s ease;
      border:3px solid rgba(255,255,255,.16);
    }
    .choiceCard:hover{transform:translateY(-2px);filter:brightness(1.03)}
    .choiceCard:active{transform:translateY(-1px) scale(.99)}
    .choiceCard:disabled{opacity:.55;cursor:not-allowed;transform:none!important}

    .choiceIcon{
      width:56px;height:56px;
      border-radius:var(--r-md);
      display:flex;align-items:center;justify-content:center;
      background:#101827;
      border:2px solid rgba(255,255,255,.18);
      font-size:28px;
      flex-shrink:0;
      color:#fff;
    }
    .choiceText{font-size:1.05rem;line-height:1.15}
    .choiceText small{
      display:block;
      font-size:.88rem;
      font-weight:800;
      opacity:.9;
      margin-top:4px;
    }

    /* vibrant card palettes */
    .pal0{ background:linear-gradient(135deg,#00d4ff,#22c55e); }
    .pal1{ background:linear-gradient(135deg,#ff6b35,#f59e0b); }
    .pal2{ background:linear-gradient(135deg,#a855f7,#ff4fa0); color:#120018; }
    .pal3{ background:linear-gradient(135deg,#ffffff,#b9f6ff); }
    .pal4{ background:linear-gradient(135deg,#8aff00,#00d4ff); }
    .pal5{ background:linear-gradient(135deg,#ff4d6d,#ffd166); color:#180007; }

    /* ORDER word buttons */
    #options.mode-order{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-content:flex-start;
      justify-content:center;
    }
    .orderWord{
      border-radius:var(--r-md);
      padding:10px 14px;
      font-weight:900;
      font-size:1.02rem;
      cursor:pointer;
      color:var(--text);
      background:#28324a;
      border:2px solid var(--border);
      box-shadow:var(--shadow2);
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .orderWord:hover{transform:translateY(-2px);border-color:var(--accent)}
    .orderWord:disabled{opacity:.45;cursor:not-allowed;transform:none!important}
    .orderWord.chosen{color:#111827;background:var(--accent);border-color:var(--accent)}

    .selChip{
      padding:8px 12px;
      border-radius:var(--r-md);
      background:var(--primary);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      box-shadow:var(--shadow2);
      animation: popIn .22s ease;
    }
    @keyframes popIn{
      0%{ transform:scale(.7); opacity:0; }
      100%{ transform:scale(1); opacity:1; }
    }

    .progressWrap{
      width:100%;
      height:16px;
      border-radius:var(--pill);
      overflow:hidden;
      border:2px solid var(--border);
      background:#101827;
    }
    .progressBar{
      height:100%;
      width:0%;
      background:var(--p1);
      transition:width 400ms ease, background 250ms ease;
      border-radius:var(--pill);
    }
    .progressLabel{
      font-size:.96rem;
      font-weight:900;
      color:var(--muted);
      text-align:center;
      margin-top:6px;
    }

    .controlsRow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      padding-bottom:4px;
    }
    .smallBtn{
      border:2px solid var(--border);
      background:#28324a;
      color:var(--text);
      border-radius:var(--r-md);
      padding:10px 14px;
      font-weight:900;
      font-size:.98rem;
      cursor:pointer;
    }
    .smallBtn:hover{border-color:var(--accent)}
    #checkOrder.smallBtn{
      padding:12px 22px!important;
      font-size:1.08rem!important;
      background:var(--primary)!important;
      color:#fff!important;
      border:2px solid transparent!important;
    }
    #pauseBtn.smallBtn{
      padding:12px 18px!important;
      background:#f59e0b!important;
      color:#111827!important;
      border:2px solid transparent!important;
    }

    .controlsPanel{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      background:var(--surface2);
      border-radius:var(--r-xl);
      border:2px solid var(--border);
      min-height:0;
    }
    .inputRow{display:flex;flex-direction:column;gap:6px}
    .inputRow label{
      font-size:.78rem;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .inputRow input{
      padding:10px 12px;
      border-radius:var(--r-md);
      border:2px solid var(--border);
      background:var(--panel);
      font-size:1rem;
      font-weight:800;
      color:var(--text);
    }
    .inputRow input:focus{outline:none;border-color:var(--accent)}
    .inputRow input:disabled{opacity:.7}

    .controlsBtns{display:flex;gap:10px}
    .btnPrimary,.btnSecondary{
      flex:1;
      padding:12px 12px;
      border-radius:var(--r-md);
      font-weight:900;
      font-size:.98rem;
      cursor:pointer;
      border:none;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .btnPrimary{background:var(--primary);color:#fff}
    .btnSecondary{background:#28324a;color:#fff;border:2px solid var(--border)}

    .toggles{
      display:flex;
      gap:14px;
      font-size:.95rem;
      font-weight:800;
      flex-wrap:wrap;
      color:var(--muted);
    }
    .toggles label{display:flex;align-items:center;gap:8px;cursor:pointer}
    .toggles input[type="checkbox"]{width:18px;height:18px;accent-color:var(--primary)}

    .tipBox{
      padding:10px 12px;
      border-radius:var(--r-md);
      background:var(--panel);
      border:2px solid var(--border);
      font-size:.9rem;
      color:var(--muted);
      max-height:220px;
      overflow:auto;
    }
    .tipBox b{color:var(--accent);display:block;margin-bottom:6px}

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:var(--muted);
      font-size:.92rem;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
      border-top:2px solid var(--border);
    }

    /* Feedback overlay */
    .fbOverlay{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.70);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      z-index:100;
      padding:16px;
    }
    .fbOverlay.show{opacity:1;pointer-events:auto}
    .fbCard{
      width:min(540px,96%);
      border-radius:var(--r-xl);
      padding:22px;
      background:#111827;
      border:2px solid var(--border);
      box-shadow:var(--shadow);
      text-align:center;
    }
    .fbTop{display:flex;align-items:center;justify-content:center;gap:12px}
    .fbIcon{
      width:60px;height:60px;border-radius:var(--r-lg);
      display:flex;align-items:center;justify-content:center;
      font-size:30px;background:var(--panel);border:2px solid var(--border);
    }
    .fbIcon.success{border-color:#1f7a42}
    .fbIcon.error{border-color:#7a1f1f}
    .fbTitle{font-size:1.6rem;font-weight:900}
    .fbSub{margin-top:10px;font-size:1.05rem;font-weight:800}
    .fbDetail{margin-top:10px;font-size:.95rem;color:var(--muted);white-space:pre-line}
    .fbBtnRow{margin-top:16px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
    .fbBtn{
      border-radius:var(--r-md);
      padding:10px 18px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      border:2px solid var(--accent);
      background:var(--accent);
      color:#111827;
    }

    /* Celebration overlay */
    .celebration-overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.80);
      z-index:9999;
      padding:20px;
    }
    .celebration-card{
      width:min(640px,96%);
      background:#111827;
      border:3px solid var(--primary);
      border-radius:var(--r-xl);
      padding:28px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .celebration-icon{font-size:72px;margin-bottom:10px}
    .celebration-title{font-size:2.1rem;font-weight:900;margin-bottom:8px}
    .celebration-sub{color:var(--muted);font-weight:800;font-size:1.1rem;margin-bottom:18px}
    .celebration-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

    /* Paused overlay */
    .paused-overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.75);
      z-index:8000;
      padding:20px;
    }
    .paused-card{
      width:min(520px,96%);
      background:#111827;
      border:3px solid #f59e0b;
      border-radius:var(--r-xl);
      padding:22px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .paused-title{font-size:1.8rem;font-weight:900;margin-bottom:10px}
    .paused-sub{color:var(--muted);font-weight:800;margin-bottom:16px}
    .paused-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

    @media (max-width:900px){
      .mainArea{grid-template-columns:1fr}
      #options{max-height:30vh}
    }
    @media (prefers-reduced-motion: reduce){
      *,*::before,*::after{
        animation-duration:.01ms!important;
        animation-iteration-count:1!important;
        transition-duration:.01ms!important;
      }
    }
  </style>
</head>

<body>
  <a href="#game" class="skip-link">Skip to Game</a>

  <div class="container" role="application" aria-label="Future grammar mastery game">

    <div>
      <div class="header">
        <div class="logo" aria-hidden="true">üöÄ</div>
        <div class="header-text">
          <h1 class="title">Future Grammar Mastery</h1>
          <p class="lead">Mixed practice ‚Ä¢ Build your streak to <b>25 in a row</b> to win!</p>
        </div>
      </div>

      <div class="topbar">
        <div class="statRow">
          <div class="stat"><div class="stat-icon">‚≠ê</div><span id="scoreBox">Score: 0</span></div>
          <div class="stat"><div class="stat-icon">‚è±Ô∏è</div><span id="timerBox">Time: 0s</span></div>
          <div class="stat"><div class="stat-icon">üî•</div><span id="streakBox">Streak: 0</span></div>
        </div>
        <div class="playerTag">
          Player: <strong id="playerName">‚Äî</strong>
          <span class="pill" id="levelPill" title="Difficulty level"><small>Level</small> <span id="levelLabel">Easy</span></span>
          <span class="pill" id="attemptPill" title="Total attempts"><small>Attempts</small> <span id="attemptsLabel">0</span></span>
        </div>
      </div>
    </div>

    <div class="mainArea">

      <div id="game" class="game" role="main" aria-live="polite">

        <div id="feedbackOverlay" class="fbOverlay" aria-hidden="true">
          <div class="fbCard" role="dialog" aria-modal="true" aria-label="Feedback popup">
            <div class="fbTop">
              <div class="fbIcon success" id="fbIcon">‚úÖ</div>
              <h3 class="fbTitle" id="fbTitle">Nice!</h3>
            </div>
            <div class="fbSub" id="fbSub">Keep it going.</div>
            <div class="fbDetail" id="fbDetail"></div>
            <div class="fbBtnRow">
              <button class="fbBtn" id="fbCloseBtn" type="button">Continue</button>
            </div>
          </div>
        </div>

        <div id="card" role="region" aria-label="Prompt card">
          <div id="cardLabel">Ready</div>
          <div id="cardText">Press START to begin your practice!</div>
        </div>

        <div id="orderBox" class="empty" aria-live="polite">Your answer will appear here...</div>
        <div id="options" role="group" aria-label="Answer options"></div>

        <div>
          <div class="progressWrap">
            <div id="progressBar" class="progressBar" style="width:0%"
                 role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="progressLabel" id="progressLabel">Progress: 0 / 25 (0%)</div>
        </div>

        <div class="controlsRow">
          <button id="resetOrder" class="smallBtn" style="display:none" type="button">Reset Order</button>
          <button id="checkOrder" class="smallBtn" style="display:none" type="button">CHECK</button>
          <button id="pauseBtn" class="smallBtn" style="display:none" type="button">‚è∏ Pause</button>
          <button id="downloadReport" class="smallBtn" style="display:none" type="button">üìä Download CSV</button>
        </div>
      </div>

      <div class="controlsPanel">
        <div class="inputRow">
          <label for="studentName">Your Name</label>
          <input id="studentName" type="text" placeholder="Enter your name...">
        </div>

        <div class="controlsBtns">
          <button id="startBtn" class="btnPrimary" type="button">Start</button>
          <button id="resetBtn" class="btnSecondary" type="button">Reset</button>
        </div>

        <div class="controlsBtns">
          <button id="levelBtn" class="btnSecondary" type="button">Level: Easy</button>
          <button id="summaryBtn" class="btnSecondary" type="button">üìå Summary</button>
        </div>

        <div class="toggles">
          <label><input id="soundToggle" type="checkbox" checked> Sound FX</label>
          <label><input id="musicToggle" type="checkbox" checked> Music</label>
        </div>

        <div class="tipBox" id="tipBox">
          <b>üìñ How to Play</b>
          ‚Ä¢ Activities mix randomly: <strong>Order</strong>, <strong>Tense</strong>, <strong>Meaning</strong><br>
          ‚Ä¢ Click <strong style="color: var(--primary)">CHECK</strong> in ordering rounds<br>
          ‚Ä¢ Mistakes reset your streak to 0<br>
          ‚Ä¢ Win by reaching <strong style="color: var(--accent)">25 correct in a row!</strong><br><br>
          <b>üéö Levels</b>
          ‚Ä¢ <strong>Easy</strong>: fewer, clearer sentences<br>
          ‚Ä¢ <strong>Hard</strong>: larger bank + trickier distractors
        </div>

        <div class="tipBox" id="summaryBox" style="display:none">
          <b>üìå Session Summary</b>
          <div id="summaryText">Press ‚ÄúSummary‚Äù during/after play.</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Modes: Order ‚Ä¢ Tense ‚Ä¢ Meaning</div>
      <div>Goal: <span id="targetLabel">25</span> correct in a row</div>
    </div>

    <div id="celebration" class="celebration-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="celebration-card" role="document">
        <div class="celebration-icon">üèÜ</div>
        <div class="celebration-title">Perfect Streak!</div>
        <div class="celebration-sub" id="celebrationSub">You reached 25 correct answers in a row!</div>
        <div class="celebration-actions">
          <button id="celebrationDownload" class="btnSecondary" style="width:auto;padding:14px 24px" type="button">üìä Download Report</button>
          <button id="celebrationRestart" class="btnPrimary" style="width:auto;padding:14px 24px" type="button">üîÑ Play Again</button>
        </div>
      </div>
    </div>

    <div id="pausedOverlay" class="paused-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="paused-card" role="document">
        <div class="paused-title">Paused</div>
        <div class="paused-sub">Press Resume to continue.</div>
        <div class="paused-actions">
          <button id="resumeBtn" class="btnPrimary" style="width:auto;padding:14px 24px" type="button">‚ñ∂ Resume</button>
          <button id="pausedResetBtn" class="btnSecondary" style="width:auto;padding:14px 24px" type="button">Reset</button>
        </div>
      </div>
    </div>

  </div>

  <!-- AUDIO -->
  <audio id="bgMusic" loop preload="auto">
    <source src="audio/koala.mp3" type="audio/mpeg">
  </audio>
  <audio id="celebrationSound" preload="auto">
    <source src="audio/tadaa.mp3" type="audio/mpeg">
  </audio>

<script>
/* =============================
   CONFIG
============================= */
const TARGET_STREAK = 25;

const FORM_LABELS = {
  present_simple: "Present Simple (schedule)",
  present_continuous: "Present Continuous (arrangement)",
  will: "Future (will)",
  going_to: "Be going to",
  first_conditional: "First Conditional"
};

const INTENT_LABELS = {
  schedule: "Schedule / Timetable",
  arrangement: "Arrangement",
  prediction: "Prediction (opinion)",
  offer_promise: "Offer / Promise",
  decision_now: "Decision now",
  announcement: "Announcement",
  plan: "Plan / Intention",
  evidence_prediction: "Prediction (evidence)",
  warning_consequence: "Warning / Consequence",
  advice_suggestion: "Advice / Suggestion",
  plan_condition: "Plan with condition",
  prediction_result: "Prediction result"
};

/* ====== BANKS (Easy / Hard) ====== */
const BANK_EASY = [
  { text:"The train leaves at 8:10 tomorrow.", form:"present_simple", intent:"schedule" },
  { text:"School starts at 9 o‚Äôclock on Monday.", form:"present_simple", intent:"schedule" },
  { text:"The concert begins at 7 p.m. on Friday.", form:"present_simple", intent:"schedule" },
  { text:"The museum closes at 6 p.m.", form:"present_simple", intent:"schedule" },
  { text:"Does the match start at noon?", form:"present_simple", intent:"schedule" },

  { text:"I‚Äôm meeting my friends at 6 p.m.", form:"present_continuous", intent:"arrangement" },
  { text:"We‚Äôre having dinner together tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"She‚Äôs seeing the dentist on Friday.", form:"present_continuous", intent:"arrangement" },
  { text:"They‚Äôre coming over for lunch tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"Are you visiting your grandma this weekend?", form:"present_continuous", intent:"arrangement" },

  { text:"I think it will rain later.", form:"will", intent:"prediction" },
  { text:"They will probably win the match.", form:"will", intent:"prediction" },
  { text:"Don‚Äôt worry, I‚Äôll help you.", form:"will", intent:"offer_promise" },
  { text:"Okay, I‚Äôll do it now.", form:"will", intent:"decision_now" },
  { text:"The results will be published tomorrow.", form:"will", intent:"announcement" },

  { text:"I‚Äôm going to study tonight.", form:"going_to", intent:"plan" },
  { text:"We‚Äôre going to meet after school.", form:"going_to", intent:"plan" },
  { text:"Look at those clouds! It‚Äôs going to rain.", form:"going_to", intent:"evidence_prediction" },
  { text:"That glass is going to fall!", form:"going_to", intent:"evidence_prediction" },
  { text:"Are you going to watch the new episode?", form:"going_to", intent:"plan" },

  { text:"If you don‚Äôt study, you‚Äôll fail the test.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If you feel tired, take a break.", form:"first_conditional", intent:"advice_suggestion" },
  { text:"If it rains, we‚Äôll stay at home.", form:"first_conditional", intent:"plan_condition" },
  { text:"If she studies, she‚Äôll do well.", form:"first_conditional", intent:"prediction_result" }
];

// Hard = Easy + extra items (bigger variety)
const BANK_HARD = BANK_EASY.concat([
  { text:"The flight departs at 6:45 tomorrow morning.", form:"present_simple", intent:"schedule" },
  { text:"The show starts at 7:30 tonight.", form:"present_simple", intent:"schedule" },
  { text:"Does the bus arrive at 5:20?", form:"present_simple", intent:"schedule" },

  { text:"I‚Äôm working late tomorrow.", form:"present_continuous", intent:"arrangement" },
  { text:"We‚Äôre flying to London next week.", form:"present_continuous", intent:"arrangement" },
  { text:"Is he meeting us after class?", form:"present_continuous", intent:"arrangement" },

  { text:"I‚Äôll call you back in a minute.", form:"will", intent:"decision_now" },
  { text:"I won‚Äôt tell anyone. I promise.", form:"will", intent:"offer_promise" },
  { text:"Maybe we will have a quiz tomorrow.", form:"will", intent:"prediction" },

  { text:"I‚Äôm not going to buy it; it‚Äôs too expensive.", form:"going_to", intent:"plan" },
  { text:"Be careful! You‚Äôre going to drop it!", form:"going_to", intent:"evidence_prediction" },

  { text:"If you miss the bus, you‚Äôll be late.", form:"first_conditional", intent:"warning_consequence" },
  { text:"If you want, I‚Äôll explain it again.", form:"first_conditional", intent:"advice_suggestion" }
]);

/* ===== Options ===== */
const TENSE_OPTIONS = [
  { key:"present_simple", label:"Present Simple", desc:"Schedules / timetables", icon:"üïò" },
  { key:"present_continuous", label:"Present Continuous", desc:"Arrangements", icon:"üìÖ" },
  { key:"will", label:"Future (will)", desc:"Prediction / promise / decision", icon:"üîÆ" },
  { key:"going_to", label:"Be going to", desc:"Plan / evidence", icon:"üéØ" },
  { key:"first_conditional", label:"First Conditional", desc:"If + present, will‚Ä¶", icon:"‚ö°" }
];

const MEANING_OPTIONS = {
  will: [
    { key:"prediction", label:"Prediction", desc:"Guess / opinion", icon:"üåßÔ∏è" },
    { key:"offer_promise", label:"Offer / Promise", desc:"Help / promise", icon:"ü§ù" },
    { key:"decision_now", label:"Decision now", desc:"Made right now", icon:"üí°" },
    { key:"announcement", label:"Announcement", desc:"Official info", icon:"üì£" }
  ],
  going_to: [
    { key:"plan", label:"Plan / Intention", desc:"Already decided", icon:"üóìÔ∏è" },
    { key:"evidence_prediction", label:"Prediction (evidence)", desc:"Look! evidence", icon:"üëÄ" },
    { key:"announcement", label:"Announcement", desc:"Official info", icon:"üì£" },
    { key:"prediction", label:"Prediction (opinion)", desc:"Guess / opinion", icon:"üîÆ" }
  ],
  present_simple: [
    { key:"schedule", label:"Schedule", desc:"Timetable time", icon:"üïò" },
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan", icon:"üìÖ" },
    { key:"plan", label:"Plan", desc:"Already decided", icon:"üéØ" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion", icon:"üîÆ" }
  ],
  present_continuous: [
    { key:"arrangement", label:"Arrangement", desc:"Fixed plan", icon:"üìÖ" },
    { key:"schedule", label:"Schedule", desc:"Timetable time", icon:"üïò" },
    { key:"plan", label:"Plan", desc:"Already decided", icon:"üéØ" },
    { key:"prediction", label:"Prediction", desc:"Guess / opinion", icon:"üîÆ" }
  ],
  first_conditional: [
    { key:"warning_consequence", label:"Warning", desc:"Bad result", icon:"‚ö†Ô∏è" },
    { key:"advice_suggestion", label:"Advice", desc:"Suggestion", icon:"üí¨" },
    { key:"plan_condition", label:"Plan", desc:"If X, we do Y", icon:"üß≠" },
    { key:"prediction_result", label:"Prediction", desc:"If X, Y happens", icon:"üìà" }
  ]
};

const el = (id) => document.getElementById(id);

/* AUDIO */
const bgMusic = el("bgMusic");
const celebrationSound = el("celebrationSound");
bgMusic.volume = 0.15;
celebrationSound.volume = 0.65;

el("musicToggle").addEventListener("change", () => {
  if (el("musicToggle").checked && state.running && !state.paused) bgMusic.play().catch(()=>{});
  else bgMusic.pause();
});

/* =============================
   STATE
============================= */
const state = {
  running:false,
  paused:false,

  level:"easy", // easy | hard

  streak:0,
  score:0,
  seconds:0,
  timer:null,

  attempts:0,

  // mistakes by mode:
  modeStats:{
    order:{ attempts:0, wrong:0 },
    tense:{ attempts:0, wrong:0 },
    meaning:{ attempts:0, wrong:0 }
  },

  // mistakes by form for tense/meaning
  formWrong:{
    present_simple:0,
    present_continuous:0,
    will:0,
    going_to:0,
    first_conditional:0
  },

  round:null,
  orderSelected:[],
  log:[],

  recent:[] // recent sentence indices (avoid repeats)
};

/* =============================
   HELPERS
============================= */
function blip(ok){
  if (!el("soundToggle").checked) return;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type="sine";
    o.frequency.value = ok ? 880 : 280;
    g.gain.value = 0.08;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, ok ? 120 : 180);
  }catch(e){}
}

function setCard(label,text){
  el("cardLabel").textContent = label;
  el("cardText").textContent = text;
}

function getCss(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}
function progressColorForStreak(streak){
  const pct = (streak / TARGET_STREAK) * 100;
  if (pct < 20) return getCss("--p1");
  if (pct < 40) return getCss("--p2");
  if (pct < 60) return getCss("--p3");
  if (pct < 80) return getCss("--p4");
  return getCss("--p5");
}

function updateHeader(){
  el("scoreBox").textContent = "Score: " + state.score;
  el("timerBox").textContent = "Time: " + state.seconds + "s";
  el("streakBox").textContent = "Streak: " + state.streak;
  el("targetLabel").textContent = TARGET_STREAK;
  el("levelLabel").textContent = state.level === "easy" ? "Easy" : "Hard";
  el("attemptsLabel").textContent = String(state.attempts);
  el("levelBtn").textContent = "Level: " + (state.level === "easy" ? "Easy" : "Hard");
}

function updateProgress(){
  const pct = Math.max(0, Math.min(100, Math.round((state.streak / TARGET_STREAK) * 100)));
  const bar = el("progressBar");
  bar.style.width = pct + "%";
  bar.style.background = progressColorForStreak(state.streak);
  bar.setAttribute("aria-valuenow", pct);
  el("progressLabel").textContent = "Progress: " + state.streak + " / " + TARGET_STREAK + " (" + pct + "%)";
}

function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function normalizeSentence(s){
  return String(s).trim().replace(/\s+/g," ");
}
function pickPaletteClass(i){
  const pals = ["pal0","pal1","pal2","pal3","pal4","pal5"];
  return pals[i % pals.length];
}
function safeLabelForm(form){ return FORM_LABELS[form] || String(form||"").replaceAll("_"," "); }
function safeLabelIntent(intent){ return INTENT_LABELS[intent] || String(intent||"").replaceAll("_"," "); }

function currentBank(){
  return state.level === "easy" ? BANK_EASY : BANK_HARD;
}

/* =============================
   ROUND GENERATION
============================= */
const RECENT_LIMIT = 8, REROLL_TRIES = 12;

function pickQuestionNoRepeat(){
  const bank = currentBank();
  if (bank.length <= 1) return bank[0];

  // store recent sentence texts (simple)
  let chosen = bank[Math.floor(Math.random()*bank.length)];
  for (let t=0;t<REROLL_TRIES;t++){
    const candidate = bank[Math.floor(Math.random()*bank.length)];
    const recentTexts = state.recent;
    if (!recentTexts.includes(candidate.text)){
      chosen = candidate;
      break;
    }
    chosen = candidate;
  }
  state.recent.push(chosen.text);
  while (state.recent.length > RECENT_LIMIT) state.recent.shift();
  return chosen;
}

function makeRound(){
  const q = pickQuestionNoRepeat();

  // Mode mix: more ORDER early, more TENSE/MEANING later
  const r = Math.random();
  let mode = "order";
  if (state.streak < 8){
    mode = r < 0.45 ? "order" : (r < 0.75 ? "tense" : "meaning");
  } else {
    mode = r < 0.30 ? "order" : (r < 0.65 ? "tense" : "meaning");
  }

  if (mode === "order"){
    const targetWords = normalizeSentence(q.text).split(" ");
    const orderWords = shuffle(targetWords);
    return { mode, q, targetWords, orderWords };
  }

  return { mode, q };
}

/* =============================
   RENDER
============================= */
function clearOptions(){
  el("options").className = "";
  el("options").innerHTML = "";
}

function setOrderBoxEmpty(){
  const box = el("orderBox");
  box.classList.add("empty");
  box.innerHTML = "";
  box.textContent = "Tap words below to build your sentence...";
}

function renderSelectedChips(){
  const box = el("orderBox");
  box.innerHTML = "";

  if (state.orderSelected.length === 0){
    setOrderBoxEmpty();
    return;
  }

  box.classList.remove("empty");

  state.orderSelected.forEach((item, idx) => {
    const chip = document.createElement("div");
    chip.className = "selChip";
    chip.textContent = item.word;
    chip.addEventListener("click", () => {
      // remove chip
      state.orderSelected.splice(idx, 1);
      // re-enable corresponding word button
      el("options").querySelectorAll(".orderWord").forEach(b=>{
        if (b.dataset.idx === String(item.idx)){
          b.disabled = false;
          b.classList.remove("chosen");
        }
      });
      renderSelectedChips();
    });
    box.appendChild(chip);
  });
}

function pickWord(idx, word, btn){
  if (!state.running || state.paused) return;
  btn.disabled = true;
  btn.classList.add("chosen");
  state.orderSelected.push({ idx, word });
  renderSelectedChips();
}

function resetOrder(){
  if (!state.running || state.paused) return;
  state.orderSelected = [];
  el("options").querySelectorAll(".orderWord").forEach(b=>{
    b.disabled=false;
    b.classList.remove("chosen");
  });
  renderSelectedChips();
}

function renderRound(){
  clearOptions();
  state.orderSelected = [];
  const r = state.round;

  // Common prompt card:
  if (r.mode === "order"){
    setCard("Order words", "Arrange the words to form the correct sentence:");

    el("resetOrder").style.display = "inline-flex";
    el("checkOrder").style.display = "inline-flex";

    setOrderBoxEmpty();

    el("options").classList.add("mode-order");
    r.orderWords.forEach((w,idx)=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "orderWord";
      b.textContent = w;
      b.dataset.idx = String(idx);
      b.onclick = () => pickWord(idx, w, b);
      el("options").appendChild(b);
    });

    el("downloadReport").style.display = state.running ? "inline-flex" : "none";
    el("pauseBtn").style.display = state.running ? "inline-flex" : "none";
    renderSelectedChips();
    return;
  }

  // TENSE or MEANING
  setCard(r.mode === "tense" ? "Verb tense" : "Speaker meaning", r.q.text);

  el("resetOrder").style.display = "none";
  el("checkOrder").style.display = "none";

  // show a clean instruction in orderBox:
  el("orderBox").classList.add("empty");
  el("orderBox").textContent = (r.mode === "tense")
    ? "Choose the correct verb form / structure."
    : "Choose the speaker‚Äôs purpose / meaning.";

  el("options").classList.add("mode-multiple");

  if (r.mode === "tense"){
    renderTenseCards(r.q.form);
  } else {
    renderMeaningCards(r.q.form, r.q.intent);
  }

  el("downloadReport").style.display = state.running ? "inline-flex" : "none";
  el("pauseBtn").style.display = state.running ? "inline-flex" : "none";
}

function renderTenseCards(correctForm){
  // show 4 cards: correct + 3 distractors (hard uses trickier)
  const pool = shuffle([...TENSE_OPTIONS]);
  const correct = pool.find(x => x.key === correctForm) || TENSE_OPTIONS[0];

  let distractors = pool.filter(x => x.key !== correctForm);
  distractors = distractors.slice(0,3);

  const options = shuffle([correct, ...distractors]);

  options.forEach((o, idx)=>{
    const btn = document.createElement("button");
    btn.className = "choiceCard " + pickPaletteClass(idx);
    btn.type = "button";
    btn.innerHTML =
      `<div class="choiceIcon">${o.icon}</div>
       <div class="choiceText">${o.label}<small>${o.desc}</small></div>`;
    btn.onclick = () => submitMultiple("tense", o.key, correctForm);
    el("options").appendChild(btn);
  });
}

function renderMeaningCards(form, correctIntent){
  let opts = (MEANING_OPTIONS[form] || []).slice();

  // ensure 4 options
  if (opts.length < 4){
    // fill from other pools
    const all = Object.values(MEANING_OPTIONS).flat();
    const need = 4 - opts.length;
    const extra = shuffle(all.filter(x => !opts.some(y=>y.key===x.key))).slice(0,need);
    opts = opts.concat(extra);
  }

  // In hard mode, shuffle; in easy keep the provided set (still shuffled)
  opts = shuffle(opts).slice(0,4);

  // Guarantee correct is inside
  if (!opts.some(x=>x.key===correctIntent)){
    opts.pop();
    const corr = (MEANING_OPTIONS[form] || []).find(x=>x.key===correctIntent) || { key:correctIntent, label:safeLabelIntent(correctIntent), desc:"", icon:"‚úÖ" };
    opts.push(corr);
    opts = shuffle(opts);
  }

  opts.forEach((o, idx)=>{
    const btn = document.createElement("button");
    btn.className = "choiceCard " + pickPaletteClass(idx);
    btn.type = "button";
    btn.innerHTML =
      `<div class="choiceIcon">${o.icon || "üí¨"}</div>
       <div class="choiceText">${o.label}<small>${o.desc || ""}</small></div>`;
    btn.onclick = () => submitMultiple("meaning", o.key, correctIntent);
    el("options").appendChild(btn);
  });
}

/* =============================
   SUBMIT / GRADING
============================= */
function checkOrder(){
  if (!state.running || state.paused) return;
  const built = normalizeSentence(state.orderSelected.map(x=>x.word).join(" "));
  const correct = normalizeSentence(state.round.targetWords.join(" "));
  gradeRound(built === correct, {
    built,
    correct
  }, {
    choice: built,
    correct
  });
}

function submitMultiple(mode, chosenKey, correctKey){
  if (!state.running || state.paused) return;
  const ok = (chosenKey === correctKey);

  const r = state.round;
  const q = r.q;

  gradeRound(ok, {
    chosen: chosenKey,
    correct: correctKey,
    prompt: q.text
  }, {
    choice: chosenKey,
    correct: correctKey
  });
}

function showFeedback(ok, detail, isWin){
  const overlay = el("feedbackOverlay");
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");

  const fbIconEl = el("fbIcon");
  fbIconEl.textContent = ok ? "‚úÖ" : "‚ùå";
  fbIconEl.className = ok ? "fbIcon success" : "fbIcon error";

  el("fbTitle").textContent = ok ? (isWin ? "Perfect!" : "Correct!") : "Not quite...";
  el("fbSub").textContent = ok
    ? (isWin ? "Amazing! You reached " + TARGET_STREAK + " correct in a row!" : "Great job! Streak: " + state.streak + " / " + TARGET_STREAK)
    : "Streak reset to 0. Keep practicing!";

  const r = state.round;

  let d = "";
  if (r.mode === "order"){
    d = ok ? "Perfect ordering!" :
      `Your answer:\n"${detail.built || "(empty)"}"\n\nCorrect:\n"${detail.correct}"`;
  } else if (r.mode === "tense"){
    d = ok ? `Correct tense: ${safeLabelForm(r.q.form)}` :
      `You chose: ${safeLabelForm(detail.chosen)}\nCorrect: ${safeLabelForm(detail.correct)}`;
  } else {
    d = ok ? `Correct meaning: ${safeLabelIntent(r.q.intent)}` :
      `You chose: ${safeLabelIntent(detail.chosen)}\nCorrect: ${safeLabelIntent(detail.correct)}`;
  }

  el("fbDetail").textContent = d;
}

function hideFeedback(){
  const overlay = el("feedbackOverlay");
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden","true");
}

function afterFeedbackAutoNext(isWin){
  if (isWin) return;
  setTimeout(()=>{ hideFeedback(); nextRound(); }, 650);
}

function logAttempt(ok, detail, choicePack){
  const player = (el("playerName").textContent || "‚Äî").trim() || "‚Äî";
  const r = state.round;
  const q = r.q || {};

  // track attempts + stats
  state.attempts++;
  el("attemptsLabel").textContent = String(state.attempts);

  state.modeStats[r.mode].attempts++;
  if (!ok) state.modeStats[r.mode].wrong++;

  // wrong by form (useful for "category most fails")
  if (!ok && q.form && state.formWrong[q.form] !== undefined){
    state.formWrong[q.form]++;
  }

  const row = {
    player,
    time_s: state.seconds,
    ok: ok ? 1 : 0,
    streak_after: state.streak,
    level: state.level,
    mode: r.mode,
    form: q.form || "",
    intent: q.intent || "",
    prompt: (q.text || ""),
    choice: String(choicePack?.choice ?? ""),
    correct: String(choicePack?.correct ?? ""),
    detail: detail || {}
  };

  state.log.push(row);

  // send to Sheets
  sendAttemptToSheet(row);
}

function gradeRound(ok, detail, choicePack){
  const r = state.round;
  const q = r.q || {};

  if (ok){
    state.score++;
    state.streak++;
    blip(true);

    logAttempt(true, detail, choicePack);
    updateHeader();
    updateProgress();

    if (state.streak >= TARGET_STREAK){
      showFeedback(true, detail, true);
      winGame();
      return;
    }
    showFeedback(true, detail, false);
    afterFeedbackAutoNext(false);
    return;
  }

  // wrong
  state.streak = 0;
  blip(false);

  logAttempt(false, detail, choicePack);
  updateHeader();
  updateProgress();

  showFeedback(false, detail, false);
  afterFeedbackAutoNext(false);

  // In ORDER mode, reset the built sentence so they can try again next time without leftovers
  if (r.mode === "order") resetOrder();
}

/* =============================
   FLOW
============================= */
function lockRoundControls(lock){
  el("options").querySelectorAll("button").forEach(b => b.disabled = !!lock);
  el("resetOrder").disabled = !!lock;
  el("checkOrder").disabled = !!lock;
}

function nextRound(){
  if (!state.running || state.paused) return;
  hideFeedback();
  state.round = makeRound();
  renderRound();
  lockRoundControls(false);
}

function startTimer(){
  if (state.timer) clearInterval(state.timer);
  state.timer = setInterval(()=>{
    if (!state.running || state.paused) return;
    state.seconds++;
    updateHeader();
  }, 1000);
}

function startGame(){
  const nm = (el("studentName").value || "").trim();
  el("playerName").textContent = nm || "‚Äî";

  state.running = true;
  state.paused = false;

  state.streak = 0;
  state.score = 0;
  state.seconds = 0;
  state.attempts = 0;

  state.modeStats = {
    order:{ attempts:0, wrong:0 },
    tense:{ attempts:0, wrong:0 },
    meaning:{ attempts:0, wrong:0 }
  };
  state.formWrong = {
    present_simple:0,
    present_continuous:0,
    will:0,
    going_to:0,
    first_conditional:0
  };

  state.log = [];
  state.round = null;
  state.orderSelected = [];
  state.recent = [];

  updateHeader();
  updateProgress();

  // start music (user gesture)
  if (el("musicToggle").checked){
    bgMusic.currentTime = 0;
    bgMusic.play().catch(()=>{});
  }

  startTimer();

  el("downloadReport").style.display = "inline-flex";
  el("pauseBtn").style.display = "inline-flex";
  el("pauseBtn").textContent = "‚è∏ Pause";

  nextRound();
}

function closeCelebration(){
  const c = el("celebration");
  c.style.display = "none";
  c.setAttribute("aria-hidden","true");
}

function openPauseOverlay(){
  const p = el("pausedOverlay");
  p.style.display = "flex";
  p.setAttribute("aria-hidden","false");
}
function closePauseOverlay(){
  const p = el("pausedOverlay");
  p.style.display = "none";
  p.setAttribute("aria-hidden","true");
}

function resetGame(){
  state.running = false;
  state.paused = false;

  if (state.timer) clearInterval(state.timer);
  state.timer = null;

  hideFeedback();
  closeCelebration();
  closePauseOverlay();

  bgMusic.pause();
  bgMusic.currentTime = 0;
  celebrationSound.pause();
  celebrationSound.currentTime = 0;

  state.streak = 0; state.score = 0; state.seconds = 0;
  state.attempts = 0;
  state.round = null;
  state.orderSelected = [];
  state.log = [];
  state.recent = [];

  updateHeader();
  updateProgress();
  setCard("Ready","Press START to begin your practice!");

  el("orderBox").classList.add("empty");
  el("orderBox").textContent = "Your answer will appear here...";
  clearOptions();
  el("resetOrder").style.display = "none";
  el("checkOrder").style.display = "none";
  el("pauseBtn").style.display = "none";
  el("downloadReport").style.display = "none";

  // summary panel reset
  el("summaryBox").style.display = "none";
  el("tipBox").style.display = "block";
}

function winGame(){
  state.running = false;
  state.paused = false;

  if (state.timer) clearInterval(state.timer);
  state.timer = null;

  lockRoundControls(true);
  bgMusic.pause();

  if (el("soundToggle").checked){
    celebrationSound.currentTime = 0;
    celebrationSound.play().catch(()=>{});
  }

  const c = el("celebration");
  c.style.display = "flex";
  c.setAttribute("aria-hidden","false");

  el("celebrationSub").textContent = "Incredible! You got " + TARGET_STREAK + " correct answers in a row!";
  state.streak = TARGET_STREAK;
  updateHeader();
  updateProgress();

  el("pauseBtn").style.display = "none";
}

/* =============================
   REPORTING
============================= */
function downloadCSV(){
  const rows = [
    ["player","time_s","ok","streak_after","level","mode","form","intent","prompt","choice","correct","detail_json"],
    ...state.log.map(r => ([
      r.player,
      r.time_s,
      r.ok,
      r.streak_after,
      r.level,
      r.mode,
      r.form,
      r.intent,
      String(r.prompt).replaceAll('"','""'),
      String(r.choice).replaceAll('"','""'),
      String(r.correct).replaceAll('"','""'),
      JSON.stringify(r.detail || {}).replaceAll('"','""')
    ]))
  ];
  const csv = rows.map(r => r.map(x => '"' + String(x) + '"').join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "future_grammar_report_" + Date.now() + ".csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function computeSummary(){
  const totalAttempts = state.attempts;

  // find worst mode
  const modeKeys = ["order","tense","meaning"];
  let worstMode = "order";
  let worstRate = -1;
  for (const m of modeKeys){
    const s = state.modeStats[m];
    const rate = s.attempts ? (s.wrong / s.attempts) : 0;
    if (rate > worstRate){
      worstRate = rate;
      worstMode = m;
    }
  }

  // worst form (by wrong count)
  let worstForm = "present_simple";
  let wf = -1;
  for (const k of Object.keys(state.formWrong)){
    if (state.formWrong[k] > wf){
      wf = state.formWrong[k];
      worstForm = k;
    }
  }

  return {
    name: (el("playerName").textContent || "‚Äî").trim() || "‚Äî",
    time_s: state.seconds,
    attempts: totalAttempts,
    worst_mode: worstMode,
    worst_form: worstForm,
    wrong_by_mode: JSON.parse(JSON.stringify(state.modeStats)),
    wrong_by_form: JSON.parse(JSON.stringify(state.formWrong))
  };
}

function showSummary(){
  const s = computeSummary();

  const niceMode = (m)=> (m==="order"?"ORDER":m==="tense"?"TENSE":"MEANING");
  const t = [];
  t.push(`Name: ${s.name}`);
  t.push(`Time: ${s.time_s}s`);
  t.push(`Attempts: ${s.attempts}`);
  t.push(`Most mistakes (mode): ${niceMode(s.worst_mode)}`);
  t.push(`Most mistakes (grammar area): ${safeLabelForm(s.worst_form)} (wrong: ${s.wrong_by_form[s.worst_form] || 0})`);
  t.push("");
  t.push("Wrong by mode:");
  t.push(`‚Ä¢ ORDER: ${s.wrong_by_mode.order.wrong}/${s.wrong_by_mode.order.attempts}`);
  t.push(`‚Ä¢ TENSE: ${s.wrong_by_mode.tense.wrong}/${s.wrong_by_mode.tense.attempts}`);
  t.push(`‚Ä¢ MEANING: ${s.wrong_by_mode.meaning.wrong}/${s.wrong_by_mode.meaning.attempts}`);

  el("summaryText").textContent = t.join("\n");
}

/* =============================
   PAUSE / RESUME
============================= */
function pauseGame(){
  if (!state.running || state.paused) return;
  state.paused = true;
  lockRoundControls(true);
  el("pauseBtn").textContent = "‚ñ∂ Resume";
  if (el("musicToggle").checked) bgMusic.pause();
  openPauseOverlay();
}
function resumeGame(){
  if (!state.running || !state.paused) return;
  state.paused = false;
  lockRoundControls(false);
  el("pauseBtn").textContent = "‚è∏ Pause";
  if (el("musicToggle").checked) bgMusic.play().catch(()=>{});
  closePauseOverlay();
}

/* =============================
   EVENTS
============================= */
el("startBtn").addEventListener("click", ()=>{ if (state.running) return; startGame(); });
el("resetBtn").addEventListener("click", resetGame);

el("resetOrder").addEventListener("click", resetOrder);
el("checkOrder").addEventListener("click", checkOrder);

el("pauseBtn").addEventListener("click", ()=>{
  if (!state.running) return;
  if (state.paused) resumeGame();
  else pauseGame();
});

el("resumeBtn").addEventListener("click", resumeGame);
el("pausedResetBtn").addEventListener("click", resetGame);

el("fbCloseBtn").addEventListener("click", ()=>{ hideFeedback(); if(state.running && !state.paused) nextRound(); });

el("downloadReport").addEventListener("click", downloadCSV);
el("celebrationDownload").addEventListener("click", downloadCSV);
el("celebrationRestart").addEventListener("click", ()=>{
  closeCelebration();
  resetGame();
  startGame();
});

el("studentName").addEventListener("input", ()=>{
  el("playerName").textContent = (el("studentName").value || "‚Äî").trim() || "‚Äî";
});

el("levelBtn").addEventListener("click", ()=>{
  // allow changing level only when not running (avoids weird mid-round changes)
  if (state.running){
    // quick feedback
    el("summaryBox").style.display = "block";
    el("tipBox").style.display = "none";
    el("summaryText").textContent = "Tip: Change level after pressing Reset (to keep gameplay consistent).";
    return;
  }
  state.level = (state.level === "easy") ? "hard" : "easy";
  updateHeader();
});

el("summaryBtn").addEventListener("click", ()=>{
  showSummary();
  const isOpen = el("summaryBox").style.display !== "none";
  if (isOpen){
    el("summaryBox").style.display = "none";
    el("tipBox").style.display = "block";
  } else {
    el("summaryBox").style.display = "block";
    el("tipBox").style.display = "none";
  }
});

// init
updateHeader();
updateProgress();
setCard("Ready","Press START to begin your practice!");
</script>
</body>
</html>
