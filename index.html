<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Future Forms Game â€” 3-Step Engine (Responsive)</title>

  <style>
    /* =========================================================
       BASE + THEME
    ========================================================= */
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:0;
      min-height:100vh;
      overflow-x:hidden;
      background:#0a0a0f;
      font-family: Arial, system-ui, sans-serif;
      color:#fff;
      text-align:center;
    }
    .hidden{ display:none !important; }

    /* General screens (Name Screen overrides this below) */
    .screen{
      padding-top: clamp(22px, 5vw, 60px);
      padding-left: 14px;
      padding-right: 14px;
    }

    .title{
      font-size: clamp(1.8rem, 4.2vw, 2.6rem);
      margin: 0 0 14px;
      color:#66e0ff;
      text-shadow:0 0 10px #00aaff;
    }

    input[type="text"], input[type="password"]{
      padding:12px;
      width: min(360px, 92vw);
      border-radius:12px;
      border:none;
      margin-bottom:14px;
      font-size:1rem;
      outline:none;
    }

    .mainBtn{
      background:#00aaff;
      border:none;
      padding:12px 22px;
      border-radius:14px;
      color:#fff;
      font-size:1.05rem;
      font-weight:900;
      cursor:pointer;
      margin-top:10px;
      transition:.18s;
      box-shadow: 0 10px 28px rgba(0,170,255,.18);
    }
    .mainBtn:hover{ background:#33cfff; transform: translateY(-1px); }

    .secondaryBtn{
      background:#3a3a3a;
      border:none;
      padding:10px 18px;
      border-radius:14px;
      color:#fff;
      font-weight:900;
      cursor:pointer;
      margin-top:10px;
      transition:.18s;
    }
    .secondaryBtn:hover{ background:#555; transform: translateY(-1px); }

    /* =========================================================
       GAME WRAPPER (RESPONSIVE)
    ========================================================= */
    .appWrap{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 14px 0 44px;
    }

    /* Teacher button */
    #teacherBtn{
      position:fixed;
      top:10px; right:10px;
      font-size: clamp(1.6rem, 5vw, 2rem);
      cursor:pointer;
      color:#ffdd55;
      text-shadow:0 0 8px #ffaa00;
      transition:.2s;
      user-select:none;
      z-index:60;
    }
    #teacherBtn:hover{ transform:scale(1.08); }

    /* Top bar */
    #topBar{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin: 6px 0 12px;
    }
    #scoreBox, #streakBox, #bestBox{
      background:#111;
      padding: 10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,170,255,.8);
      box-shadow:0 0 14px rgba(0,87,119,.65);
      font-size: clamp(0.95rem, 1.6vw, 1.15rem);
      min-width:0;
      width:100%;
      text-align:left;
    }

    /* Sentence card */
    #sentenceCard{
      background:#111;
      width: 100%;
      margin: 12px 0 10px;
      padding: clamp(14px, 3vw, 22px);
      border-radius:18px;
      border:1px solid rgba(0,170,255,.85);
      box-shadow: 0 0 18px rgba(0,87,119,.7);
      text-align:left;
    }
    #sentenceText{
      margin:0;
      font-size: clamp(1.05rem, 2.3vw, 1.5rem);
      line-height:1.35;
    }

    /* Prompts */
    #questionPrompt{
      font-size: clamp(1.05rem, 2.2vw, 1.35rem);
      margin-top: 14px;
      color:#66e0ff;
      text-shadow: 0 0 10px rgba(0,170,255,.18);
    }
    #stepLabel{
      margin-top: 6px;
      font-size: clamp(0.9rem, 1.8vw, 1rem);
      color:#cfefff;
      opacity:.95;
    }

    /* Options */
    #optionsContainer{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      width: 100%;
      text-align:left;
    }
    .optionBtn{
      width:100%;
      background:#1f1f26;
      border:1px solid rgba(0,170,255,.85);
      padding: clamp(12px, 2.6vw, 14px);
      border-radius:14px;
      cursor:pointer;
      transition:.15s;
      font-size: clamp(1rem, 2vw, 1.15rem);
      font-weight:900;
      color:#fff;
      text-align:left;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .optionBtn:hover{ background:#003344; transform: translateY(-1px); }
    .optionBtn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    /* Ordering UI */
    .pickedBox{
      margin-top:10px;
      background:#0f0f14;
      border:1px dashed rgba(0,170,255,.85);
      border-radius:16px;
      padding:12px;
      box-shadow: inset 0 0 0 1px rgba(0,170,255,.12);
    }
    .pill{
      display:inline-block;
      margin: 8px 8px 0 0;
      padding: 7px 11px;
      border-radius: 999px;
      border:1px solid rgba(0,170,255,.9);
      background: rgba(0,170,255,.10);
      font-weight:900;
      font-size: .95rem;
    }

    /* Matching UI */
    .matchWrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width:100%;
    }
    .matchCol{
      background:#0f0f14;
      border:1px solid rgba(0,170,255,.85);
      border-radius:16px;
      padding: 12px;
    }
    .matchHead{
      font-weight: 900;
      color:#66e0ff;
      margin-bottom: 10px;
    }
    .matchBtn{
      width:100%;
      margin: 7px 0;
      background:#1f1f26;
      border:1px solid rgba(0,170,255,.85);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      color:#fff;
      font-weight: 900;
      transition:.15s;
      text-align:left;
    }
    .matchBtn:hover{ background:#003344; transform: translateY(-1px); }
    .matchBtn.selected{
      outline: 3px solid rgba(102,224,255,.25);
      border-color:#66e0ff;
    }
    .matchBtn.paired{ opacity:.6; cursor:not-allowed; transform:none; }

    /* Next button */
    #nextBtn{
      width: min(360px, 100%);
      margin: 18px auto 0;
      display:block;
    }

    /* Overlays */
    .overlay{
      position:fixed;
      top:0; left:0;
      width:100%;
      height:100%;
      background: rgba(0,0,0,.85);
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 16px;
      z-index: 50;
    }
    .overlayContent{
      background:#111;
      padding: clamp(16px, 3vw, 28px);
      border-radius: 18px;
      width: min(560px, 100%);
      max-height: calc(100vh - 32px);
      overflow:auto;
      border:1px solid rgba(0,170,255,.85);
      box-shadow: 0 0 22px rgba(0,87,119,.8);
      text-align:center;
    }
    .overlayContent.small{ width: min(380px, 100%); }

    .toggleRow{
      display:flex;
      align-items:center;
      gap: 10px;
      margin: 12px 0;
      font-size: 1.05rem;
      font-weight: 900;
      justify-content:center;
    }
    .toggleRow input{ transform: scale(1.25); }

    .shake{
      animation: shake .25s linear 0s 2;
      border:2px solid #ef4444 !important;
    }
    @keyframes shake{
      0%{ transform:translateX(0); }
      25%{ transform:translateX(-6px); }
      50%{ transform:translateX(6px); }
      75%{ transform:translateX(-6px); }
      100%{ transform:translateX(0); }
    }

    /* Breakpoints */
    @media (max-width: 900px){
      #topBar{ grid-template-columns: 1fr 1fr; }
      #bestBox{ grid-column: 1 / -1; }
    }
    @media (max-width: 650px){
      .matchWrap{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      #topBar{ grid-template-columns: 1fr; }
      .mainBtn, .secondaryBtn{ width:min(360px, 100%); }
      #scoreBox, #streakBox, #bestBox{ text-align:center; }
      #sentenceCard{ text-align:left; }
    }

    /* =========================================================
       NAME SCREEN â€” RESPONSIVE (MUST BE LAST)
    ========================================================= */
    .srOnly{
      position:absolute;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }
    #nameScreen{
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 18px 14px;
    }
    #nameScreen .nameWrap{
      width: min(520px, 100%);
      background: rgba(17,17,17,.86);
      border: 1px solid rgba(0,170,255,.55);
      box-shadow: 0 0 18px rgba(0,87,119,.55);
      border-radius: 18px;
      padding: clamp(16px, 3.5vw, 28px);
    }
    #nameScreen #studentNameInput{
      width: 100%;
      max-width: 100%;
      padding: 14px;
      border-radius: 14px;
      font-size: clamp(1rem, 2.2vw, 1.1rem);
    }
    #nameScreen #startNameBtn{
      width: 100%;
      max-width: 100%;
      padding: 14px;
      border-radius: 14px;
      font-size: clamp(1rem, 2.2vw, 1.1rem);
    }
    #nameScreen .hintText{
      margin: 12px 0 0;
      opacity: .8;
      font-size: .95rem;
    }
  </style>
</head>

<body>
  <!-- NAME SCREEN -->
  <div id="nameScreen" class="screen">
    <div class="nameWrap">
      <h1 class="title">Future Forms Game</h1>

      <label class="srOnly" for="studentNameInput">Student name</label>
      <input id="studentNameInput" type="text" placeholder="Enter your name" autocomplete="name" />

      <button id="startNameBtn" class="mainBtn">Start</button>

      <p class="hintText">Tip: press Enter to start</p>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="gameScreen" class="screen hidden">
    <div id="teacherBtn" title="Teacher Access">ðŸŽ“</div>

    <div class="appWrap">
      <div id="topBar">
        <div id="scoreBox">Score: 0</div>
        <div id="streakBox">Streak: 0</div>
        <div id="bestBox">Best: 0</div>
      </div>

      <div id="sentenceCard">
        <p id="sentenceText">Sentence will appear here</p>
      </div>

      <div id="questionPrompt">What is the speaker's intended meaning?</div>
      <div id="stepLabel">Step 1/3</div>

      <div id="optionsContainer"></div>

      <button id="nextBtn" class="hidden mainBtn">Next Round</button>
    </div>
  </div>

  <!-- FEEDBACK -->
  <div id="feedbackOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent">
      <h2 id="feedbackTitle">Feedback</h2>
      <p id="feedbackText"></p>
      <button id="closeFeedbackBtn" class="mainBtn">Continue</button>
    </div>
  </div>

  <!-- CELEBRATION -->
  <div id="celebrationOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent">
      <h2>ðŸŽ‰ Amazing! ðŸŽ‰</h2>
      <p>You reached a streak of 25!</p>
      <button id="closeCelebrationBtn" class="mainBtn">Keep Going</button>
    </div>
  </div>

  <!-- TEACHER LOGIN -->
  <div id="teacherLogin" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent small">
      <h2>Teacher Access</h2>
      <input id="teacherCodeInput" type="password" placeholder="Enter code" inputmode="numeric" />
      <button id="teacherCodeBtn" class="mainBtn">Enter</button>
      <button id="closeTeacherLogin" class="secondaryBtn">Cancel</button>
    </div>
  </div>

  <!-- TEACHER PANEL -->
  <div id="teacherPanel" class="overlay hidden" aria-hidden="true">
    <div class="overlayContent">
      <h2>Teacher Panel</h2>

      <button id="teacherStartBtn" class="mainBtn">Start Round</button>
      <button id="teacherResetBtn" class="secondaryBtn">Reset Game</button>

      <label class="toggleRow">
        <input type="checkbox" id="autoNextToggle" />
        Auto-next
      </label>

      <label class="toggleRow">
        <input type="checkbox" id="musicToggle" checked />
        Music
      </label>

      <label class="toggleRow">
        <input type="checkbox" id="sfxToggle" checked />
        Sound Effects
      </label>

      <button id="sendStatsBtn" class="mainBtn">Send Stats Now</button>
      <button id="closeTeacherPanel" class="secondaryBtn">Close</button>
    </div>
  </div>

  <!-- AUDIO (rename src to match your repo files) -->
  <audio id="bgMusic" src="music.mp3" preload="auto"></audio>
  <audio id="correctSound" src="correct.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
  <audio id="celebrationSound" src="celebration.mp3" preload="auto"></audio>

  <script>
  (() => {
    "use strict";

    /* =========================================================
       CONFIG
    ========================================================= */
    const GOOGLE_SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE"; // optional
    const STREAK_TARGET = 25;

    /* =========================================================
       YOUR GROUPED SENTENCE BANKS (from test21.txt)
       Keys: PS_aff, PS_neg, PS_int, PC_aff, PC_neg, PC_int
    ========================================================= */
    const BANKS = {
      "PS_aff": [
        "She usually walks to school.",
        "He plays the guitar every afternoon.",
        "They enjoy quiet mornings together.",
        "My cat sleeps on my backpack.",
        "I like how this coffee smells.",
        "We read the newspaper every morning.",
        "The bus arrives at eight o'clock.",
        "Tom studies French at university.",
        "Anna works in a small bakery.",
        "Birds fly south in winter.",
        "The shop opens at nine every day.",
        "He drinks green tea after lunch.",
        "Students practice vocabulary every evening.",
        "She always helps her neighbors.",
        "The sun rises in the east.",
        "He writes emails every morning.",
        "We celebrate birthdays with cake.",
        "The teacher explains the lesson clearly.",
        "She takes the dog for a walk daily.",
        "They visit the museum on weekends.",
        "My brother cooks dinner on Fridays."
      ],
      "PS_neg": [
        "She doesn't like cold pizza.",
        "They don't study on Sundays.",
        "He does not enjoy long movies.",
        "I don't drink soda anymore.",
        "The cat doesn't sleep in its bed.",
        "We don't watch TV at night.",
        "He doesn't own a car.",
        "She does not eat meat.",
        "They don't arrive early.",
        "I don't understand this word.",
        "She doesn't answer her phone often.",
        "We don't use that old computer anymore.",
        "He doesn't believe the rumor.",
        "They don't accept late homework.",
        "I don't remember his name.",
        "She doesn't drive to work.",
        "He doesn't like loud music.",
        "We don't go out when it rains.",
        "The store doesn't open on Sundays.",
        "He doesn't speak Spanish.",
        "They don't play video games on school nights."
      ],
      "PS_int": [
        "Do you like spicy food?",
        "Does she play the violin?",
        "Do they live near here?",
        "Does he enjoy swimming?",
        "Do we have class today?",
        "Do you speak English?",
        "Does it rain a lot here?",
        "Do they know the answer?",
        "Does she work on Saturdays?",
        "Do I need to bring a book?",
        "Do you usually study in the morning?",
        "Does he visit his grandparents every week?",
        "Do they play chess after school?",
        "Does she cook for the family?",
        "Do we meet at the library?",
        "Do you understand the instructions?",
        "Does he take the train to work?",
        "Do they practice every day?",
        "Does she prefer tea or coffee?",
        "Do I have to finish this today?",
        "Do you remember the homework?"
      ],
      "PC_aff": [
        "I'm studying for my test right now.",
        "She's talking on the phone at the moment.",
        "They are playing football in the park.",
        "We are working on a new project today.",
        "He is cooking dinner right now.",
        "I'm reading an interesting book.",
        "She is watching a movie at the moment.",
        "They are learning English this semester.",
        "We are waiting for the bus right now.",
        "He is listening to music at the moment.",
        "I'm writing an email right now.",
        "She's cleaning her room at the moment.",
        "They are building a house this year.",
        "We are traveling to Madrid today.",
        "He is fixing his bike at the moment.",
        "I'm drinking coffee right now.",
        "She is studying English this month.",
        "They are planning a trip this week.",
        "We are having lunch right now.",
        "He is playing the guitar at the moment.",
        "I'm working on my homework right now."
      ],
      "PC_neg": [
        "I'm not studying right now.",
        "She's not talking on the phone at the moment.",
        "They aren't playing football in the park.",
        "We are not working on a new project today.",
        "He isn't cooking dinner right now.",
        "I'm not reading an interesting book.",
        "She is not watching a movie at the moment.",
        "They are not learning English this semester.",
        "We aren't waiting for the bus right now.",
        "He is not listening to music at the moment.",
        "I'm not writing an email right now.",
        "She's not cleaning her room at the moment.",
        "They are not building a house this year.",
        "We aren't traveling to Madrid today.",
        "He is not fixing his bike at the moment.",
        "I'm not drinking coffee right now.",
        "She isn't studying English this month.",
        "They are not planning a trip this week.",
        "We are not having lunch right now.",
        "He isn't playing the guitar at the moment.",
        "I'm not working on my homework right now."
      ],
      "PC_int": [
        "Am I studying for my test right now?",
        "Is she talking on the phone at the moment?",
        "Are they playing football in the park?",
        "Are we working on a new project today?",
        "Is he cooking dinner right now?",
        "Am I reading an interesting book?",
        "Is she watching a movie at the moment?",
        "Are they learning English this semester?",
        "Are we waiting for the bus right now?",
        "Is he listening to music at the moment?",
        "Am I writing an email right now?",
        "Is she cleaning her room at the moment?",
        "Are they building a house this year?",
        "Are we traveling to Madrid today?",
        "Is he fixing his bike at the moment?",
        "Am I drinking coffee right now?",
        "Is she studying English this month?",
        "Are they planning a trip this week?",
        "Are we having lunch right now?",
        "Is he playing the guitar at the moment?",
        "Am I working on my homework right now?"
      ]
    };

    /* =========================================================
       BANK META (meaning + grammar mapping)
    ========================================================= */
    const BANK_META = [
      { key:"PS_aff", meaningType:"ps_aff", meaningLabel:"a habit / routine or general fact", grammarLabel:"Present Simple â€” affirmative" },
      { key:"PS_neg", meaningType:"ps_neg", meaningLabel:"a negative habit / fact (it doesnâ€™t happen)", grammarLabel:"Present Simple â€” negative" },
      { key:"PS_int", meaningType:"ps_int", meaningLabel:"a question about a habit / fact", grammarLabel:"Present Simple â€” question" },
      { key:"PC_aff", meaningType:"pc_aff", meaningLabel:"happening now / around now", grammarLabel:"Present Continuous â€” affirmative" },
      { key:"PC_neg", meaningType:"pc_neg", meaningLabel:"NOT happening now", grammarLabel:"Present Continuous â€” negative" },
      { key:"PC_int", meaningType:"pc_int", meaningLabel:"a question about what is happening now", grammarLabel:"Present Continuous â€” question" }
    ];

    function pick4GrammarOptions(correctLabel, all) {
      const pool = all.filter(x => x !== correctLabel);
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      return [correctLabel, pool[0], pool[1], pool[2]];
    }

    function buildQuestionBank() {
      const grammarAll = [
        "Present Simple â€” affirmative",
        "Present Simple â€” negative",
        "Present Simple â€” question",
        "Present Continuous â€” affirmative",
        "Present Continuous â€” negative",
        "Present Continuous â€” question"
      ];

      const orderingTemplate = {
        prompt: "Order these from MOST certain â†’ LEAST certain (click in order):",
        items: ["definitely", "probably", "maybe", "unlikely"],
        correctOrder: ["definitely", "probably", "maybe", "unlikely"]
      };

      const matchingTemplate = {
        prompt: "Match meaning â†” grammar (click a meaning, then a grammar):",
        pairs: [
          { left: "Habit / routine", right: "Present Simple" },
          { left: "Happening now", right: "Present Continuous" },
          { left: "Negative statement", right: "Negative form (donâ€™t / isnâ€™t)" },
          { left: "Question", right: "Question form (Do/Does/Are/Is)" }
        ]
      };

      const qbank = [];
      for (const meta of BANK_META) {
        const sentences = BANKS[meta.key] || [];
        for (const sentence of sentences) {
          const meaningCorrect = `The speaker means: ${meta.meaningLabel}.`;

          const meaningOptions =
            meta.key.startsWith("PS_")
              ? [
                  meaningCorrect,
                  "The speaker means: it is happening right now.",
                  "The speaker means: it happened yesterday.",
                  "The speaker means: it will happen tomorrow."
                ]
              : [
                  meaningCorrect,
                  "The speaker means: it is a habit / routine.",
                  "The speaker means: it happened yesterday.",
                  "The speaker means: it will happen tomorrow."
                ];

          qbank.push({
            sentence,
            meaning: {
              type: meta.meaningType,
              prompt: "What is the speaker's intended meaning?",
              correct: meaningCorrect,
              options: meaningOptions
            },
            grammar: {
              prompt: "Which grammar label fits best?",
              correct: meta.grammarLabel,
              options: pick4GrammarOptions(meta.grammarLabel, grammarAll)
            },
            ordering: orderingTemplate,
            matching: matchingTemplate
          });
        }
      }
      return qbank;
    }

    const QUESTION_BANK = buildQuestionBank();

    /* =========================================================
       DOM
    ========================================================= */
    const $ = (s) => document.querySelector(s);
    const el = {
      nameScreen: $("#nameScreen"),
      gameScreen: $("#gameScreen"),
      studentNameInput: $("#studentNameInput"),
      startNameBtn: $("#startNameBtn"),

      teacherBtn: $("#teacherBtn"),

      scoreBox: $("#scoreBox"),
      streakBox: $("#streakBox"),
      bestBox: $("#bestBox"),

      sentenceText: $("#sentenceText"),
      questionPrompt: $("#questionPrompt"),
      stepLabel: $("#stepLabel"),

      optionsContainer: $("#optionsContainer"),
      nextBtn: $("#nextBtn"),

      feedbackOverlay: $("#feedbackOverlay"),
      feedbackTitle: $("#feedbackTitle"),
      feedbackText: $("#feedbackText"),
      closeFeedbackBtn: $("#closeFeedbackBtn"),

      celebrationOverlay: $("#celebrationOverlay"),
      closeCelebrationBtn: $("#closeCelebrationBtn"),

      teacherLogin: $("#teacherLogin"),
      teacherCodeInput: $("#teacherCodeInput"),
      teacherCodeBtn: $("#teacherCodeBtn"),
      closeTeacherLogin: $("#closeTeacherLogin"),

      teacherPanel: $("#teacherPanel"),
      teacherStartBtn: $("#teacherStartBtn"),
      teacherResetBtn: $("#teacherResetBtn"),
      autoNextToggle: $("#autoNextToggle"),
      musicToggle: $("#musicToggle"),
      sfxToggle: $("#sfxToggle"),
      sendStatsBtn: $("#sendStatsBtn"),
      closeTeacherPanel: $("#closeTeacherPanel"),

      bgMusic: $("#bgMusic"),
      correctSound: $("#correctSound"),
      wrongSound: $("#wrongSound"),
      celebrationSound: $("#celebrationSound")
    };

    /* =========================================================
       STATE
    ========================================================= */
    const state = {
      studentName: "",
      score: 0,
      streak: 0,
      bestStreak: 0,

      currentBundle: null,
      currentStep: 1,
      stepPlan: [],

      autoNext: false,
      musicOn: true,
      sfxOn: true,

      weakAreas: {},
      log: [],

      questionStartMs: 0
    };

    /* =========================================================
       HELPERS
    ========================================================= */
    const nowISO = () => new Date().toISOString();

    const shuffle = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };

    const show = (node) => node && node.classList.remove("hidden");
    const hide = (node) => node && node.classList.add("hidden");

    function arraysEqual(a, b) {
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
      return true;
    }

    /* requested escapeHTML with > replacement */
    function escapeHTML(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setHUD() {
      if (el.scoreBox) el.scoreBox.textContent = `Score: ${state.score}`;
      if (el.streakBox) el.streakBox.textContent = `Streak: ${state.streak}`;
      if (el.bestBox) el.bestBox.textContent = `Best: ${state.bestStreak}`;
      savePrefs();
    }

    function setSentence(text) {
      if (el.sentenceText) el.sentenceText.textContent = text || "";
    }

    function setPrompt(text) {
      if (el.questionPrompt) el.questionPrompt.textContent = text || "";
    }

    function setStepLabel() {
      if (el.stepLabel) el.stepLabel.textContent = `Step ${state.currentStep}/3`;
    }

    function clearOptions() {
      if (el.optionsContainer) el.optionsContainer.innerHTML = "";
    }

    function playSfx(kind) {
      if (!state.sfxOn) return;
      const a =
        kind === "correct" ? el.correctSound :
        kind === "wrong" ? el.wrongSound :
        kind === "celebration" ? el.celebrationSound :
        null;
      if (!a) return;
      try { a.currentTime = 0; a.play(); } catch (_) {}
    }

    function syncMusic() {
      if (!el.bgMusic) return;
      try {
        el.bgMusic.loop = true;
        if (state.musicOn) el.bgMusic.play().catch(() => {});
        else el.bgMusic.pause();
      } catch (_) {}
    }

    function savePrefs() {
      try {
        localStorage.setItem("future_game_prefs_v4", JSON.stringify({
          autoNext: state.autoNext,
          musicOn: state.musicOn,
          sfxOn: state.sfxOn,
          bestStreak: state.bestStreak
        }));
      } catch (_) {}
    }

    function loadPrefs() {
      try {
        const raw = localStorage.getItem("future_game_prefs_v4");
        if (!raw) return;
        const p = JSON.parse(raw);
        if (typeof p.autoNext === "boolean") state.autoNext = p.autoNext;
        if (typeof p.musicOn === "boolean") state.musicOn = p.musicOn;
        if (typeof p.sfxOn === "boolean") state.sfxOn = p.sfxOn;
        if (typeof p.bestStreak === "number") state.bestStreak = p.bestStreak;
      } catch (_) {}
    }

    function bumpWeakAreas(type, correct) {
      const key = type || "unknown";
      if (!state.weakAreas[key]) state.weakAreas[key] = { correct: 0, total: 0 };
      state.weakAreas[key].total += 1;
      if (correct) state.weakAreas[key].correct += 1;
    }

    function logAnswer({ kind, meaningType, chosen, correctAnswer, correct }) {
      const elapsedMs = Date.now() - (state.questionStartMs || Date.now());

      if (correct) {
        state.score += 1;
        state.streak += 1;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
      } else {
        state.streak = 0;
      }

      bumpWeakAreas(meaningType, correct);

      state.log.push({
        studentName: state.studentName,
        sentence: state.currentBundle?.sentence || "",
        meaningType: meaningType || "unknown",
        kind,
        studentAnswer: chosen,
        correctAnswer,
        isCorrect: !!correct,
        timeISO: nowISO(),
        elapsedMs,
        streakAfter: state.streak,
        scoreAfter: state.score
      });

      setHUD();
    }

    /* =========================================================
       OVERLAYS
    ========================================================= */
    function showFeedback(title, text, isCorrect, afterClose) {
      if (el.feedbackTitle) el.feedbackTitle.textContent = title || "Feedback";
      if (el.feedbackText) el.feedbackText.textContent = text || "";
      show(el.feedbackOverlay);
      playSfx(isCorrect ? "correct" : "wrong");

      const close = () => {
        hide(el.feedbackOverlay);
        el.closeFeedbackBtn?.removeEventListener("click", close);
        if (state.autoNext) setTimeout(() => afterClose && afterClose(), 120);
        else afterClose && afterClose();
      };

      el.closeFeedbackBtn?.addEventListener("click", close);
    }

    function showCelebration(afterClose) {
      show(el.celebrationOverlay);
      playSfx("celebration");

      const close = () => {
        hide(el.celebrationOverlay);
        el.closeCelebrationBtn?.removeEventListener("click", close);
        state.streak = 0; // reset streak to continue
        setHUD();
        afterClose && afterClose();
      };

      el.closeCelebrationBtn?.addEventListener("click", close);
    }

    function maybeCelebrateThen(next) {
      if (state.streak >= STREAK_TARGET) showCelebration(next);
      else next();
    }

    /* =========================================================
       STEP PLAN
    ========================================================= */
    function pickStepPlan() {
      const combos = [
        ["meaning", "grammar", "ordering"],
        ["meaning", "ordering", "grammar"],
        ["meaning", "grammar", "matching"],
        ["meaning", "matching", "grammar"]
      ];
      return combos[Math.floor(Math.random() * combos.length)];
    }

    /* =========================================================
       RENDER HELPERS
    ========================================================= */
    function renderOptionButtons(options, onPick) {
      clearOptions();
      const opts = shuffle(options || []).slice(0, 4);
      const frag = document.createDocumentFragment();
      opts.forEach((opt) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "optionBtn";
        btn.textContent = opt;
        btn.addEventListener("click", () => onPick(opt));
        frag.appendChild(btn);
      });
      el.optionsContainer?.appendChild(frag);
    }

    /* =========================================================
       ENGINES
    ========================================================= */
    function renderMeaning() {
      const q = state.currentBundle.meaning;
      setPrompt(q.prompt || "What is the speaker's intended meaning?");
      setStepLabel();

      renderOptionButtons(q.options, (chosen) => {
        const correct = chosen === q.correct;

        logAnswer({
          kind: "meaning",
          meaningType: q.type || "unknown",
          chosen,
          correctAnswer: q.correct,
          correct
        });

        const msg = correct ? "Correct!" : `Not quite. Correct answer: "${q.correct}"`;

        showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
          maybeCelebrateThen(advanceStepOrFinish);
        });
      });
    }

    function renderGrammar() {
      const q = state.currentBundle.grammar;
      setPrompt(q.prompt || "Which grammar label fits best?");
      setStepLabel();

      renderOptionButtons(q.options, (chosen) => {
        const correct = chosen === q.correct;

        logAnswer({
          kind: "grammar",
          meaningType: state.currentBundle.meaning?.type || "unknown",
          chosen,
          correctAnswer: q.correct,
          correct
        });

        const msg = correct ? "Correct!" : `Not quite. Correct answer: "${q.correct}"`;

        showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
          maybeCelebrateThen(advanceStepOrFinish);
        });
      });
    }

    function renderOrdering() {
      const q = state.currentBundle.ordering;
      setPrompt(q.prompt || "Order these (click in order):");
      setStepLabel();

      clearOptions();
      const picked = [];
      const correctOrder = q.correctOrder || [];

      const pickedBox = document.createElement("div");
      pickedBox.className = "pickedBox";
      pickedBox.innerHTML = `<div><strong>Your order:</strong></div><div id="pickedList"></div>`;
      el.optionsContainer?.appendChild(pickedBox);
      const pickedList = pickedBox.querySelector("#pickedList");

      const refreshPicked = () => {
        if (!pickedList) return;
        pickedList.innerHTML = picked
          .map((x, i) => `<span class="pill">${i + 1}. ${escapeHTML(x)}</span>`)
          .join(" ");
      };

      const items = shuffle(q.items || []);
      items.forEach((text) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "optionBtn";
        btn.textContent = text;

        btn.addEventListener("click", () => {
          if (picked.includes(text)) return;
          picked.push(text);
          btn.disabled = true;
          refreshPicked();

          if (picked.length === 4) {
            const correct = arraysEqual(picked, correctOrder);

            logAnswer({
              kind: "ordering",
              meaningType: state.currentBundle.meaning?.type || "unknown",
              chosen: picked.slice(),
              correctAnswer: correctOrder.slice(),
              correct
            });

            const msg = correct ? "Correct!" : `Not quite. Correct order: ${correctOrder.join(" â†’ ")}`;

            showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
              maybeCelebrateThen(advanceStepOrFinish);
            });
          }
        });

        el.optionsContainer?.appendChild(btn);
      });
    }

    function renderMatching() {
      const q = state.currentBundle.matching;
      setPrompt(q.prompt || "Match meaning â†” grammar:");
      setStepLabel();

      clearOptions();

      const pairs = q.pairs || [];
      const lefts = shuffle(pairs.map(p => p.left));
      const rights = shuffle(pairs.map(p => p.right));

      const correctMap = new Map(pairs.map(p => [p.left, p.right]));
      const chosenMap = new Map();
      let selectedLeft = null;

      const wrap = document.createElement("div");
      wrap.className = "matchWrap";

      const leftCol = document.createElement("div");
      leftCol.className = "matchCol";
      const rightCol = document.createElement("div");
      rightCol.className = "matchCol";

      wrap.appendChild(leftCol);
      wrap.appendChild(rightCol);
      el.optionsContainer?.appendChild(wrap);

      function rerender() {
        leftCol.innerHTML = `<div class="matchHead">Meaning</div>`;
        rightCol.innerHTML = `<div class="matchHead">Grammar</div>`;

        lefts.forEach((l) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "matchBtn";
          btn.textContent = l;

          if (chosenMap.has(l)) { btn.classList.add("paired"); btn.disabled = true; }
          if (selectedLeft === l) btn.classList.add("selected");

          btn.addEventListener("click", () => {
            if (chosenMap.has(l)) return;
            selectedLeft = l;
            rerender();
          });

          leftCol.appendChild(btn);
        });

        rights.forEach((r) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "matchBtn";
          btn.textContent = r;

          if ([...chosenMap.values()].includes(r)) { btn.classList.add("paired"); btn.disabled = true; }

          btn.addEventListener("click", () => {
            if (!selectedLeft) return;
            if ([...chosenMap.values()].includes(r)) return;
            chosenMap.set(selectedLeft, r);
            selectedLeft = null;
            rerender();
            if (chosenMap.size === 4) finish();
          });

          rightCol.appendChild(btn);
        });
      }

      function finish() {
        let correctCount = 0;
        for (const [l, r] of chosenMap.entries()) {
          if (correctMap.get(l) === r) correctCount++;
        }
        const correct = correctCount === 4;

        logAnswer({
          kind: "matching",
          meaningType: state.currentBundle.meaning?.type || "unknown",
          chosen: [...chosenMap.entries()],
          correctAnswer: pairs.map(p => [p.left, p.right]),
          correct
        });

        const msg = correct ? "Correct!" : `Not quite. You got ${correctCount}/4 correct.`;

        showFeedback(correct ? "Correct!" : "Not quite", msg, correct, () => {
          maybeCelebrateThen(advanceStepOrFinish);
        });
      }

      rerender();
    }

    /* =========================================================
       FLOW CONTROL
    ========================================================= */
    function renderCurrentStep() {
      state.questionStartMs = Date.now();
      setSentence(state.currentBundle?.sentence || "");
      hide(el.nextBtn);

      const stepType = state.stepPlan[state.currentStep - 1] || "meaning";
      if (stepType === "meaning") renderMeaning();
      else if (stepType === "grammar") renderGrammar();
      else if (stepType === "ordering") renderOrdering();
      else if (stepType === "matching") renderMatching();
      else renderMeaning();
    }

    function advanceStepOrFinish() {
      if (state.currentStep < 3) {
        state.currentStep += 1;
        renderCurrentStep();
        return;
      }
      showFeedback("Round complete!", "Nice work. Click Next Round to continue.", true, () => {
        show(el.nextBtn);
      });
    }

    function startNewRound() {
      if (!QUESTION_BANK.length) {
        alert("QUESTION_BANK is empty.");
        return;
      }
      state.currentBundle = QUESTION_BANK[Math.floor(Math.random() * QUESTION_BANK.length)];
      state.stepPlan = pickStepPlan();
      state.currentStep = 1;
      renderCurrentStep();
    }

    /* =========================================================
       TEACHER + STATS
    ========================================================= */
    function openTeacherLogin() {
      show(el.teacherLogin);
      if (el.teacherCodeInput) el.teacherCodeInput.value = "";
      el.teacherCodeInput?.focus();
    }
    function closeTeacherLogin() { hide(el.teacherLogin); }

    function openTeacherPanel() {
      hide(el.teacherLogin);
      show(el.teacherPanel);
      if (el.autoNextToggle) el.autoNextToggle.checked = state.autoNext;
      if (el.musicToggle) el.musicToggle.checked = state.musicOn;
      if (el.sfxToggle) el.sfxToggle.checked = state.sfxOn;
    }
    function closeTeacherPanel() { hide(el.teacherPanel); }

    function teacherSubmit() {
      const code = (el.teacherCodeInput?.value || "").trim();
      if (code === "1362") {
        openTeacherPanel();
      } else {
        el.teacherCodeInput?.classList.remove("shake");
        void el.teacherCodeInput?.offsetWidth;
        el.teacherCodeInput?.classList.add("shake");
      }
    }

    async function sendStatsNow() {
      const payload = {
        studentName: state.studentName,
        summary: {
          studentName: state.studentName,
          score: state.score,
          streak: state.streak,
          bestStreak: state.bestStreak,
          weakAreas: state.weakAreas,
          sentAt: nowISO()
        },
        log: state.log
      };

      if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("PASTE_")) {
        alert("Add your GOOGLE_SCRIPT_URL in the script before sending stats.");
        return;
      }

      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        alert("Stats sent successfully âœ…");
      } catch (err) {
        console.error(err);
        alert("Failed to send stats. Check Apps Script URL + permissions.");
      }
    }

    function resetGame() {
      state.score = 0;
      state.streak = 0;
      state.weakAreas = {};
      state.log = [];
      state.currentBundle = null;
      state.currentStep = 1;
      state.stepPlan = [];

      setHUD();
      setSentence("Sentence will appear here");
      setPrompt("What is the speaker's intended meaning?");
      if (el.stepLabel) el.stepLabel.textContent = "Step 1/3";
      clearOptions();
      hide(el.nextBtn);
    }

    /* =========================================================
       EVENTS
    ========================================================= */
    function wireEvents() {
      el.startNameBtn?.addEventListener("click", () => {
        const name = (el.studentNameInput?.value || "").trim();
        if (!name) { alert("Please enter your name."); return; }
        state.studentName = name;

        hide(el.nameScreen);
        show(el.gameScreen);

        setHUD();
        syncMusic();
        startNewRound();
      });

      el.studentNameInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") el.startNameBtn?.click();
      });

      el.nextBtn?.addEventListener("click", startNewRound);

      // Teacher
      el.teacherBtn?.addEventListener("click", openTeacherLogin);
      el.closeTeacherLogin?.addEventListener("click", closeTeacherLogin);
      el.teacherCodeBtn?.addEventListener("click", teacherSubmit);
      el.teacherCodeInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") teacherSubmit();
        if (e.key === "Escape") closeTeacherLogin();
      });

      el.teacherLogin?.addEventListener("click", (e) => {
        if (e.target === el.teacherLogin) closeTeacherLogin();
      });

      el.teacherStartBtn?.addEventListener("click", startNewRound);
      el.teacherResetBtn?.addEventListener("click", resetGame);

      el.autoNextToggle?.addEventListener("change", (e) => {
        state.autoNext = !!e.target.checked;
        savePrefs();
      });

      el.musicToggle?.addEventListener("change", (e) => {
        state.musicOn = !!e.target.checked;
        savePrefs();
        syncMusic();
      });

      el.sfxToggle?.addEventListener("change", (e) => {
        state.sfxOn = !!e.target.checked;
        savePrefs();
      });

      el.sendStatsBtn?.addEventListener("click", sendStatsNow);
      el.closeTeacherPanel?.addEventListener("click", closeTeacherPanel);

      el.teacherPanel?.addEventListener("click", (e) => {
        if (e.target === el.teacherPanel) closeTeacherPanel();
      });
    }

    /* =========================================================
       18) INIT
       Loads preferences, syncs music, sets HUD, wires events.
    ========================================================= */
    function init() {
      loadPrefs();
      if (el.autoNextToggle) el.autoNextToggle.checked = state.autoNext;
      if (el.musicToggle) el.musicToggle.checked = state.musicOn;
      if (el.sfxToggle) el.sfxToggle.checked = state.sfxOn;

      syncMusic();
      setHUD();
      wireEvents();
    }

    // Start the engine
    init();

  })();  /* closes the entire IIFE wrapper */
  </script>
</body>
</html>
